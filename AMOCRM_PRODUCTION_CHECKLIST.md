# ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ amoCRM –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

## üéØ –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (5 –º–∏–Ω—É—Ç)

### ‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º:

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
npx ts-node backend/src/scripts/test-amocrm.ts
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
- ‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- ‚úÖ OAuth credentials –µ—Å—Ç—å
- ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ amoCRM —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –í–æ—Ä–æ–Ω–∫–∏ –∏ —ç—Ç–∞–ø—ã –Ω–∞–π–¥–µ–Ω—ã

---

## üìã –ü–æ–ª–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è ‚úÖ

**–í `backend/.env` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:**

```bash
# –ë–∞–∑–æ–≤—ã–µ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
AMOCRM_SUBDOMAIN=yoursubdomain
AMOCRM_ACCESS_TOKEN=eyJ0eXAiOiJKV1Qi...
AMOCRM_PIPELINE_ID=10350882
AMOCRM_STAGE_LESSON_1=12345678  # ‚ö†Ô∏è –ù–ï –ó–ê–ì–õ–£–®–ö–ê!
AMOCRM_STAGE_LESSON_2=23456789  # ‚ö†Ô∏è –ù–ï –ó–ê–ì–õ–£–®–ö–ê!
AMOCRM_STAGE_LESSON_3=34567890  # ‚ö†Ô∏è –ù–ï –ó–ê–ì–õ–£–®–ö–ê!

# OAuth (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞!)
AMOCRM_CLIENT_ID=abc123-def456...
AMOCRM_CLIENT_SECRET=SuperSecret...
AMOCRM_REFRESH_TOKEN=def50200a1b2c3...
AMOCRM_REDIRECT_URI=https://onai.academy
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω—ã (–Ω–µ –ø—É—Å—Ç—ã–µ)
- [ ] Stage IDs –∑–∞–º–µ–Ω–µ–Ω—ã —Å –∑–∞–≥–ª—É—à–µ–∫ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ
- [ ] OAuth credentials –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ amoCRM
- [ ] –¢–æ–∫–µ–Ω—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ (–ø–æ–ª—É—á–µ–Ω—ã –Ω–µ–¥–∞–≤–Ω–æ)

---

### 2. –ú–∞–ø–ø–∏–Ω–≥ —É—Ä–æ–∫–æ–≤ ‚úÖ

**–ü—Ä–æ–≤–µ—Ä—å –≤ –ë–î:**
```sql
SELECT id, title, module_id FROM lessons WHERE id IN (67, 68, 69);
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
67 | Tripwire –£—Ä–æ–∫ 1 | 16
68 | Tripwire –£—Ä–æ–∫ 2 | 17
69 | Tripwire –£—Ä–æ–∫ 3 | 18
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Lesson IDs —Å–æ–≤–ø–∞–¥–∞—é—Ç (67, 68, 69)
- [ ] Module IDs —Å–æ–≤–ø–∞–¥–∞—é—Ç (16, 17, 18)
- [ ] –£—Ä–æ–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã (–Ω–µ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω—ã)

---

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚úÖ

**–ú–∏–Ω–∏–º—É–º 1 –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç-–∫–µ–π—Å:**

#### –¢–µ—Å—Ç: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

1. **–°–æ–∑–¥–∞–π —Å–¥–µ–ª–∫—É –≤ amoCRM:**
   - Email: `test-prod@example.com`
   - –í–æ—Ä–æ–Ω–∫–∞: "onAI Academy"
   - –≠—Ç–∞–ø: –ù–∞—á–∞–ª—å–Ω—ã–π

2. **–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ:**
   - Email: `test-prod@example.com` (–¢–û–¢ –ñ–ï!)

3. **–ó–∞–≤–µ—Ä—à–∏ –£—Ä–æ–∫ 1:**
   - –ó–∞–π–¥–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
   - –û—Ç–∫—Ä–æ–π –ú–æ–¥—É–ª—å 16 ‚Üí –£—Ä–æ–∫ 1
   - –ù–∞–∂–º–∏ "–ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫"

4. **–ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏:**
   ```bash
   pm2 logs backend --lines 50 | grep AmoCRM
   ```
   
   –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
   ```
   ‚úÖ [AmoCRM] –°–¥–µ–ª–∫–∞ XXXXX —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –Ω–∞ —ç—Ç–∞–ø XXXXXX
   ```

5. **–ü—Ä–æ–≤–µ—Ä—å –≤ amoCRM:**
   - –°–¥–µ–ª–∫–∞ –Ω–∞ —ç—Ç–∞–ø–µ "–ü–†–û–®–ï–õ –ü–ï–†–í–´–ô –£–†–û–ö" ‚úÖ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –¢–µ—Å—Ç 1: –£—Ä–æ–∫ 1 ‚Üí —Å–¥–µ–ª–∫–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∞—Å—å ‚úÖ
- [ ] –¢–µ—Å—Ç 2: –£—Ä–æ–∫ 2 ‚Üí —Å–¥–µ–ª–∫–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∞—Å—å ‚úÖ
- [ ] –¢–µ—Å—Ç 3: –£—Ä–æ–∫ 3 ‚Üí —Å–¥–µ–ª–∫–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∞—Å—å ‚úÖ
- [ ] –¢–µ—Å—Ç Refresh Token ‚Üí —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–∏–ª—Å—è ‚úÖ

---

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ‚úÖ

**–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –æ—à–∏–±–∫–∏ amoCRM –Ω–µ –ª–æ–º–∞—é—Ç UX:**

```bash
# –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ—Å—Ç–∞–≤—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω
AMOCRM_ACCESS_TOKEN=invalid_token_test

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏
pm2 restart backend

# –ó–∞–≤–µ—Ä—à–∏ —É—Ä–æ–∫ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
# –°—Ç—É–¥–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —É–≤–∏–¥–µ—Ç—å "‚úÖ –£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω" –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É amoCRM

# –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏
pm2 logs backend | grep AmoCRM
```

**–û–∂–∏–¥–∞–µ–º–æ:**
- –û—à–∏–±–∫–∞ amoCRM –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è
- –°—Ç—É–¥–µ–Ω—Ç –≤–∏–¥–∏—Ç —É—Å–ø–µ—Ö
- –¢–æ–∫–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è (–µ—Å–ª–∏ –µ—Å—Ç—å OAuth)

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –û—à–∏–±–∫–∏ amoCRM –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞ ‚úÖ
- [ ] –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–µ—Å–ª–∏ OAuth –Ω–∞—Å—Ç—Ä–æ–µ–Ω) ‚úÖ
- [ ] –õ–æ–≥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ ‚úÖ

---

### 5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ‚úÖ

**–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**

```bash
# –õ–æ–≥–∏ amoCRM
pm2 logs backend --lines 200 | grep AmoCRM

# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
pm2 logs backend --lines 500 | grep "‚ùå.*AmoCRM"

# –ü–æ–∏—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Ç–æ–∫–µ–Ω–∞
pm2 logs backend --lines 200 | grep "–¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫"

# –£—Å–ø–µ—à–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
pm2 logs backend --lines 200 | grep "‚úÖ.*AmoCRM"
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] –õ–æ–≥–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úÖ
- [ ] –£—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è ‚úÖ
- [ ] –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏ ‚úÖ

---

## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: Stage IDs –ù–ï –∑–∞–≥–ª—É—à–∫–∏

```bash
cat backend/.env | grep AMOCRM_STAGE
```

**–ù–ï –î–û–õ–ñ–ù–û –ë–´–¢–¨:**
```
AMOCRM_STAGE_LESSON_1=12345678  # ‚ùå –≠—Ç–æ –ø—Ä–∏–º–µ—Ä!
AMOCRM_STAGE_LESSON_2=23456789  # ‚ùå –≠—Ç–æ –ø—Ä–∏–º–µ—Ä!
```

**–ü—Ä–∞–≤–∏–ª—å–Ω–æ:**
```
AMOCRM_STAGE_LESSON_1=65432100  # ‚úÖ –†–µ–∞–ª—å–Ω—ã–π ID –∏–∑ amoCRM
AMOCRM_STAGE_LESSON_2=65432101  # ‚úÖ –†–µ–∞–ª—å–Ω—ã–π ID –∏–∑ amoCRM
```

**–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ ID:**
```bash
npx ts-node
const amoCrm = require('./backend/src/services/amoCrmService');
await amoCrm.listPipelines();
```

---

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: OAuth –Ω–∞—Å—Ç—Ä–æ–µ–Ω

```bash
cat backend/.env | grep -E "AMOCRM_CLIENT|AMOCRM_REFRESH"
```

**–î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å:**
```
AMOCRM_CLIENT_ID=abc123...
AMOCRM_CLIENT_SECRET=def456...
AMOCRM_REFRESH_TOKEN=ghi789...
```

**–ï—Å–ª–∏ –ù–ï–¢:**
- ‚ö†Ô∏è –¢–æ–∫–µ–Ω –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ 24 —á–∞—Å–∞!
- üìö –°–º. `AMOCRM_REFRESH_TOKEN_GUIDE.md`

---

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: Email —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ

**–°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∞:**

1. Email –≤ –∑–∞—è–≤–∫–µ –Ω–∞ –ª–µ–Ω–¥–∏–Ω–≥–µ: `student@example.com`
2. Email –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: `student@example.com` ‚Üê –¢–û–ß–ù–û –¢–ê–ö–û–ô –ñ–ï!
3. Email –≤ amoCRM: `student@example.com` ‚Üê –¢–û–ß–ù–û –¢–ê–ö–û–ô –ñ–ï!

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- [ ] Email —Å–æ–≤–ø–∞–¥–∞–µ—Ç –≤–µ–∑–¥–µ (–±–µ–∑ –æ–ø–µ—á–∞—Ç–æ–∫)
- [ ] –†–µ–≥–∏—Å—Ç—Ä –Ω–µ –≤–∞–∂–µ–Ω (amoCRM –∏—â–µ—Ç case-insensitive)
- [ ] –î–æ–º–µ–Ω —Å–æ–≤–ø–∞–¥–∞–µ—Ç (@example.com, –∞ –Ω–µ @examplecom)

---

## üî• TODO –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

#### 1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ë–î

**–ó–∞—á–µ–º:** –ß—Ç–æ–±—ã —Ç–æ–∫–µ–Ω—ã –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–ª–∏—Å—å –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ

**–ö–∞–∫:**
```typescript
// backend/src/services/amoCrmService.ts

async function saveTokens(accessToken: string, refreshToken: string) {
  // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –ø–∞–º—è—Ç–∏
  currentAccessToken = accessToken;
  currentRefreshToken = refreshToken;
  
  // üî• –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
  await supabase
    .from('system_settings')
    .upsert({
      key: 'amocrm_tokens',
      amocrm_access_token: accessToken,
      amocrm_refresh_token: refreshToken,
      updated_at: new Date().toISOString(),
    });
}

// –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
async function loadTokensFromDB() {
  const { data } = await supabase
    .from('system_settings')
    .select('*')
    .eq('key', 'amocrm_tokens')
    .single();
  
  if (data) {
    currentAccessToken = data.amocrm_access_token || currentAccessToken;
    currentRefreshToken = data.amocrm_refresh_token || currentRefreshToken;
  }
}
```

**–°—Ä–æ—á–Ω–æ—Å—Ç—å:** üü° –°—Ä–µ–¥–Ω—è—è (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ–∑–∂–µ)

---

#### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã

**–°–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –ª–æ–≥–æ–≤:**
```sql
CREATE TABLE amocrm_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_email TEXT,
  lesson_number INTEGER,
  lead_id BIGINT,
  stage_id BIGINT,
  success BOOLEAN,
  error_message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**–î–æ–±–∞–≤—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```typescript
await supabase.from('amocrm_logs').insert({
  user_email: email,
  lesson_number: lessonNumber,
  lead_id: leadId,
  success: true,
});
```

**–°—Ä–æ—á–Ω–æ—Å—Ç—å:** üü¢ –ù–∏–∑–∫–∞—è (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ–∑–∂–µ)

---

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

#### 3. Webhook –æ—Ç amoCRM (–¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ amoCRM –æ—Ç—Ä–∞–∂–∞–ª–∏—Å—å –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ

**–°—Ä–æ—á–Ω–æ—Å—Ç—å:** üü¢ –ù–∏–∑–∫–∞—è (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

---

## ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç

### –ü–µ—Ä–µ–¥ git commit:

- [ ] `.env` —Ñ–∞–π–ª—ã –ù–ï –≤ git (–ø—Ä–æ–≤–µ—Ä—å `.gitignore`)
- [ ] –í—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã –∏–ª–∏ –≤ `.gitignore`
- [ ] –õ–æ–≥–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–∫–µ–Ω—ã/–ø–∞—Ä–æ–ª–∏

### –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º:

- [ ] –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `.env` –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Å–µ—Ä–≤–µ—Ä–∞
- [ ] OAuth credentials –ø–æ–ª—É—á–µ–Ω—ã –∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [ ] Stage IDs –∑–∞–º–µ–Ω–µ–Ω—ã —Å –∑–∞–≥–ª—É—à–µ–∫ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ
- [ ] –ú–∏–Ω–∏–º—É–º 1 –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ
- [ ] Refresh Token –º–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω

### –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:

- [ ] –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏: `pm2 logs backend | grep AmoCRM`
- [ ] –°–æ–∑–¥–∞–π —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞—è–≤–∫—É –∏ –ø—Ä–æ–π–¥–∏ —É—Ä–æ–∫
- [ ] –ü—Ä–æ–≤–µ—Ä—å –≤ amoCRM, —á—Ç–æ —Å–¥–µ–ª–∫–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∞—Å—å
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä—å –ª–æ–≥–∏ –ø–µ—Ä–≤—ã–µ 24 —á–∞—Å–∞

---

## üöÄ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–µ–ø–ª–æ—è

### –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Å–µ—Ä–≤–µ—Ä–µ:

```bash
# 1. Pull –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
cd /path/to/onai-integrator-login
git pull origin main

# 2. –£—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –¥–æ–±–∞–≤–∏–ª–∏—Å—å)
cd backend
npm install

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±—ç–∫–µ–Ω–¥
pm2 restart backend

# 4. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏
pm2 logs backend --lines 50

# 5. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å
pm2 status

# 6. –¢–µ—Å—Ç amoCRM
npx ts-node src/scripts/test-amocrm.ts
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### –ü–µ—Ä–≤—ã–µ 24 —á–∞—Å–∞:

```bash
# –ö–∞–∂–¥—ã–µ 2 —á–∞—Å–∞ –ø—Ä–æ–≤–µ—Ä—è–π:
pm2 logs backend --lines 200 | grep AmoCRM

# –ò—â–∏:
# ‚úÖ –£—Å–ø–µ—à–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–¥–µ–ª–æ–∫
# üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 1 –∑–∞ —Å—É—Ç–∫–∏)
# ‚ùå –û—à–∏–±–∫–∏ (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:

```bash
# –ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —É—Ä–æ–∫–∏ —Å–µ–≥–æ–¥–Ω—è
pm2 logs backend --lines 1000 | grep "‚úÖ.*AmoCRM.*–ø–µ—Ä–µ–º–µ—â–µ–Ω–∞" | wc -l

# –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
pm2 logs backend --lines 1000 | grep "–¢–æ–∫–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"

# –û—à–∏–±–∫–∏
pm2 logs backend --lines 1000 | grep "‚ùå.*AmoCRM"
```

---

## üÜò –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

### –ü—Ä–æ–±–ª–µ–º–∞: –í—Å–µ —Å–¥–µ–ª–∫–∏ –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

**–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# 1. –ü—Ä–æ–≤–µ—Ä—å —Ç–æ–∫–µ–Ω
npx ts-node
const amoCrm = require('./backend/src/services/amoCrmService');
await amoCrm.testConnection();

# 2. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ 401 - –æ–±–Ω–æ–≤–∏ —Ç–æ–∫–µ–Ω
await amoCrm.manualRefreshToken();
```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –í Node –∫–æ–Ω—Å–æ–ª–∏
const amoCrm = require('./backend/src/services/amoCrmService');
await amoCrm.findLeadIdByEmail('problem-user@example.com');
```

**–ï—Å–ª–∏ `null`:**
- Email –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
- –ö–æ–Ω—Ç–∞–∫—Ç –Ω–µ –≤ amoCRM
- –°–¥–µ–ª–∫–∞ –Ω–µ –≤ –≤–æ—Ä–æ–Ω–∫–µ "onAI Academy"

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —Å–æ—Ö—Ä–∞–Ω–∏ —ç—Ç–∏ —Ñ–∞–π–ª—ã:

- ‚úÖ `AMOCRM_INTEGRATION_SETUP.md` - –ø–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- ‚úÖ `AMOCRM_REFRESH_TOKEN_GUIDE.md` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ OAuth
- ‚úÖ `AMOCRM_TESTING_PLAN.md` - –ø–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ `AMOCRM_PRODUCTION_CHECKLIST.md` - —ç—Ç–æ—Ç —Ñ–∞–π–ª

---

## üéâ –ì–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É?

### ‚úÖ –ï—Å–ª–∏ –≤—Å–µ –ø—É–Ω–∫—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:

1. **–°–¥–µ–ª–∞–π git commit:**
   ```bash
   git add .
   git commit -m "feat: Add amoCRM integration with auto token refresh"
   git push origin main
   ```

2. **–î–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω:**
   ```bash
   # –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
   git pull origin main
   pm2 restart backend
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞:**
   - –ü—É—Å—Ç—å –∑–∞–≤–µ—Ä—à–∏—Ç —É—Ä–æ–∫
   - –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏
   - –ü—Ä–æ–≤–µ—Ä—å amoCRM

### ‚ö†Ô∏è –ï—Å–ª–∏ –ù–ï –≤—Å–µ –ø—É–Ω–∫—Ç—ã:

**–í–µ—Ä–Ω–∏—Å—å –∫ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø—É–Ω–∫—Ç–∞–º:**
- Stage IDs –Ω–µ –∑–∞–º–µ–Ω–µ–Ω—ã ‚Üí `AMOCRM_INTEGRATION_SETUP.md`
- OAuth –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω ‚Üí `AMOCRM_REFRESH_TOKEN_GUIDE.md`
- –¢–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã ‚Üí `AMOCRM_TESTING_PLAN.md`

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ú–∏–Ω–∏–º—É–º –¥–ª—è –∑–∞–ø—É—Å–∫–∞:
1. ‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `.env`
2. ‚úÖ Stage IDs —Ä–µ–∞–ª—å–Ω—ã–µ (–Ω–µ –∑–∞–≥–ª—É—à–∫–∏)
3. ‚úÖ OAuth –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤)
4. ‚úÖ –ú–∏–Ω–∏–º—É–º 1 —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω

### –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –∑–∞–ø—É—Å–∫–∞:
- –í—Å—ë –∏–∑ "–ú–∏–Ω–∏–º—É–º" +
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ë–î
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- 3+ —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã

### –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ:
- Webhook –æ—Ç amoCRM
- –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- –î–∞—à–±–æ—Ä–¥ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-10  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

---

## ‚úÖ –ò–¢–û–ì–û: –ú–æ–∂–Ω–æ –¥–µ–ø–ª–æ–∏—Ç—å, –µ—Å–ª–∏:

- [x] –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (–æ—Å–æ–±–µ–Ω–Ω–æ Stage IDs!)
- [x] OAuth credentials –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [x] –ú–∏–Ω–∏–º—É–º 1 –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ
- [x] Refresh Token —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ï—Å–ª–∏ –≤—Å–µ ‚úÖ ‚Üí –î–ï–ü–õ–û–ô –†–ê–ó–†–ï–®–ï–ù!** üöÄ

**–ï—Å–ª–∏ –µ—Å—Ç—å ‚ùå ‚Üí –°–ù–ê–ß–ê–õ–ê –ò–°–ü–†–ê–í–¨!** ‚ö†Ô∏è
