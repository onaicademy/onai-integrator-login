#!/bin/bash

# üìß –ë–´–°–¢–†–ê–Ø –û–¢–ü–†–ê–í–ö–ê EMAIL –ß–ï–†–ï–ó BACKEND API
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π endpoint /api/tripwire/admin/mass-broadcast

echo "üìß –ú–ê–°–°–û–í–ê–Ø –†–ê–°–°–´–õ–ö–ê –°–¢–£–î–ï–ù–¢–ê–ú"
echo "================================"
echo ""

# ‚úÖ –¢–ï–ö–°–¢ –ü–ò–°–¨–ú–ê
MESSAGE='–ü—Ä–∏–≤–µ—Ç!

–•–æ—Ç–∏–º —Å–æ–æ–±—â–∏—Ç—å –≤–∞–º –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. 

üîß –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ:
–í –ø–µ—Ä–≤—ã–µ –¥–Ω–∏ –∑–∞–ø—É—Å–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∏—Å–ø—ã—Ç—ã–≤–∞–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏–∑-–∑–∞ –±–æ–ª—å—à–æ–≥–æ –Ω–∞–ø–ª—ã–≤–∞ —É—á–µ–Ω–∏–∫–æ–≤. –ú—ã —Ä–∞–¥—ã —Ç–∞–∫–æ–º—É –∏–Ω—Ç–µ—Ä–µ—Å—É –∫ –∫—É—Ä—Å—É!

‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:
–ù–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ —É—Å—Ç—Ä–∞–Ω–∏–ª–∞ –≤—Å–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã. –°–µ–π—á–∞—Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –∏ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã.

üéì –ß—Ç–æ –¥–∞–ª—å—à–µ:
–í—ã –º–æ–∂–µ—Ç–µ —Å –∫–æ–º—Ñ–æ—Ä—Ç–æ–º –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ:
- –°–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ-—É—Ä–æ–∫–∏
- –í—ã–ø–æ–ª–Ω—è—Ç—å –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å

–ï—Å–ª–∏ —É –≤–∞—Å –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –∫–∞–∫–∏–µ-–ª–∏–±–æ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ ‚Äî –ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É, –º—ã –≤—Å–µ–≥–¥–∞ –Ω–∞ —Å–≤—è–∑–∏!

–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è! üöÄ

---
–ö–æ–º–∞–Ω–¥–∞ OnAI Academy'

# ‚ö†Ô∏è –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π JWT —Ç–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∞!
# –ü–æ–ª—É—á–∏—Ç—å: https://onai.academy/integrator/admin ‚Üí –æ—Ç–∫—Ä–æ–π DevTools ‚Üí Application ‚Üí Local Storage ‚Üí tripwire_supabase_token
ADMIN_TOKEN="–í–°–¢–ê–í–¨_–°–Æ–î–ê_–¢–û–ö–ï–ù_–ê–î–ú–ò–ù–ê"

if [ "$ADMIN_TOKEN" = "–í–°–¢–ê–í–¨_–°–Æ–î–ê_–¢–û–ö–ï–ù_–ê–î–ú–ò–ù–ê" ]; then
  echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–∫–∞–∑–∞–Ω ADMIN_TOKEN!"
  echo ""
  echo "üìù –ö–ê–ö –ü–û–õ–£–ß–ò–¢–¨ –¢–û–ö–ï–ù:"
  echo "1. –ó–∞–π–¥–∏ –Ω–∞ https://onai.academy/integrator/admin"
  echo "2. –û—Ç–∫—Ä–æ–π DevTools (F12)"
  echo "3. Application ‚Üí Local Storage ‚Üí tripwire_supabase_token"
  echo "4. –°–∫–æ–ø–∏—Ä—É–π –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞"
  echo "5. –í—Å—Ç–∞–≤—å –≤ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å—Ç—Ä–æ–∫–µ 39"
  echo ""
  exit 1
fi

echo "üîë –¢–æ–∫–µ–Ω –∞–¥–º–∏–Ω–∞: ${ADMIN_TOKEN:0:20}..."
echo "üì® –¢–µ–º–∞: ‚úÖ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã"
echo "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ API: https://api.onai.academy/api/tripwire/admin/mass-broadcast"
echo ""
read -p "‚ñ∂Ô∏è  –û—Ç–ø—Ä–∞–≤–∏—Ç—å email –≤—Å–µ–º 62 —Å—Ç—É–¥–µ–Ω—Ç–∞–º? (y/n): " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"
  exit 0
fi

echo ""
echo "üìß –û—Ç–ø—Ä–∞–≤–ª—è—é..."
echo ""

# üöÄ –û–¢–ü–†–ê–í–ö–ê
RESPONSE=$(curl -s -X POST "https://api.onai.academy/api/tripwire/admin/mass-broadcast" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -d "{
    \"channel\": \"email\",
    \"subject\": \"‚úÖ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã - –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ\",
    \"message\": $(echo "$MESSAGE" | jq -Rs .),
    \"testMode\": false
  }")

# üìä –†–ï–ó–£–õ–¨–¢–ê–¢
echo "================================"
echo "üìä –†–ï–ó–£–õ–¨–¢–ê–¢:"
echo "================================"
echo "$RESPONSE" | jq .
echo ""

# ‚úÖ –ü–†–û–í–ï–†–ö–ê
if echo "$RESPONSE" | jq -e '.success == true' > /dev/null 2>&1; then
  echo "‚úÖ –£–°–ü–ï–•! Email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤—Å–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞–º!"
  echo ""
  SENT=$(echo "$RESPONSE" | jq -r '.emailsSent // 0')
  TOTAL=$(echo "$RESPONSE" | jq -r '.totalRecipients // 0')
  echo "üìß –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: $SENT / $TOTAL"
else
  echo "‚ùå –û–®–ò–ë–ö–ê! –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –≤—ã—à–µ"
  echo ""
  echo "üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
  echo "   - –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω (–ø—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ)"
  echo "   - –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ (–ø–µ—Ä–µ–ª–æ–≥–∏–Ω—å—Å—è –∏ –ø–æ–ª—É—á–∏ –Ω–æ–≤—ã–π)"
  echo "   - –ù–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞ (–ø—Ä–æ–≤–µ—Ä—å —Ä–æ–ª—å –≤ –ë–î)"
fi

echo ""
echo "================================"
