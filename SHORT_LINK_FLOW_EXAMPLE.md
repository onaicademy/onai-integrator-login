# üîó –ü–†–ò–ú–ï–† –†–ê–ë–û–¢–´ –ö–û–†–û–¢–ö–û–ô –°–°–´–õ–ö–ò - –ü–û–®–ê–ì–û–í–û

## üìß –°–¶–ï–ù–ê–†–ò–ô: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª Email –ø–æ—Å–ª–µ –ø—Ä–æ—Ñ—Ç–µ—Å—Ç–∞

---

## üé¨ –®–ê–ì –ó–ê –®–ê–ì–û–ú:

### **1Ô∏è‚É£ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ—Ñ—Ç–µ—Å—Ç**

```
–ò–º—è: –ò–≤–∞–Ω
Email: ivan@example.com
Phone: +77771234567
Lead ID: abc123-def456-ghi789
```

---

### **2Ô∏è‚É£ –°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç –∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É –¥–ª—è Email**

**–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è (–¥–ª–∏–Ω–Ω–∞—è) —Å—Å—ã–ª–∫–∞:**
```
https://onai.academy/integrator/expresscourse?utm_source=email&utm_campaign=proftest&lead_id=abc123-def456-ghi789
```
*–î–ª–∏–Ω–∞: 103 —Å–∏–º–≤–æ–ª–∞*

**–°–∏—Å—Ç–µ–º–∞ –≤—ã–∑—ã–≤–∞–µ—Ç:**
```typescript
const shortCode = await createShortLink({
  originalUrl: 'https://onai.academy/integrator/expresscourse?utm_source=email&utm_campaign=proftest&lead_id=abc123-def456-ghi789',
  leadId: 'abc123-def456-ghi789',
  campaign: 'proftest',
  source: 'email',
  expiresInDays: 90
});
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```typescript
shortCode = "aB3xY9"
```

**–ö–æ—Ä–æ—Ç–∫–∞—è —Å—Å—ã–ª–∫–∞:**
```
https://onai.academy/l/aB3xY9
```
*–î–ª–∏–Ω–∞: 31 —Å–∏–º–≤–æ–ª* ‚Üí **–≠–∫–æ–Ω–æ–º–∏—è 72 —Å–∏–º–≤–æ–ª–∞ (70%)**

---

### **3Ô∏è‚É£ –ó–∞–ø–∏—Å—å –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö**

**–¢–∞–±–ª–∏—Ü–∞: `short_links`**
```sql
INSERT INTO short_links (
  id,
  short_code,
  original_url,
  lead_id,
  campaign,
  source,
  expires_at,
  is_active,
  clicks_count,
  unique_ips
) VALUES (
  'aB3xY9',
  'aB3xY9',
  'https://onai.academy/integrator/expresscourse?utm_source=email&utm_campaign=proftest&lead_id=abc123-def456-ghi789',
  'abc123-def456-ghi789',
  'proftest',
  'email',
  '2025-03-14 20:00:00', -- expires —á–µ—Ä–µ–∑ 90 –¥–Ω–µ–π
  true,
  0, -- –∫–ª–∏–∫–∏ –ø–æ–∫–∞ 0
  []  -- –ø–æ–∫–∞ –Ω–µ—Ç IP
);
```

---

### **4Ô∏è‚É£ Email –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è**

**–¢–µ–∫—Å—Ç Email (—É–ø—Ä–æ—â—ë–Ω–Ω–æ):**
```html
<h1>–ü—Ä–∏–≤–µ—Ç, –ò–≤–∞–Ω! üëã</h1>
<p>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–ª–∏ –ø—Ä–æ—Ñ—Ç–µ—Å—Ç.</p>

<a href="https://onai.academy/l/aB3xY9" class="button">
  –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç ‚Üí
</a>

<p>–ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É:</p>
<a href="https://onai.academy/l/aB3xY9">
  https://onai.academy/l/aB3xY9
</a>
```

---

### **5Ô∏è‚É£ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ö–õ–ò–ö–ê–ï–¢ –ù–ê –°–°–´–õ–ö–£** üñ±Ô∏è

**–ö–ª–∏–∫ –Ω–∞:** `https://onai.academy/l/aB3xY9`

---

### **6Ô∏è‚É£ –ó–∞–ø—Ä–æ—Å –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä**

**HTTP Request:**
```http
GET /l/aB3xY9 HTTP/1.1
Host: onai.academy
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0
Referer: https://mail.google.com/
X-Forwarded-For: 185.123.45.67
```

---

### **7Ô∏è‚É£ Backend –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å**

**–ö–æ–¥ (–∏–∑ `backend/src/routes/short-links.ts`):**

```typescript
router.get('/:shortCode', async (req: Request, res: Response) => {
  const { shortCode } = req.params; // "aB3xY9"

  // 1Ô∏è‚É£ –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –∏–∑ –ë–î
  const originalUrl = await resolveShortLink(shortCode);
  // originalUrl = "https://onai.academy/integrator/expresscourse?utm_source=email&utm_campaign=proftest&lead_id=abc123-def456-ghi789"

  if (!originalUrl) {
    // –°—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –∏—Å—Ç–µ–∫–ª–∞ ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    return res.redirect('https://onai.academy');
  }

  // 2Ô∏è‚É£ –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∫–ª–∏–∫–µ
  const ipAddress = req.headers['x-forwarded-for']?.split(',')[0] || 'unknown';
  // ipAddress = "185.123.45.67"
  
  const userAgent = req.headers['user-agent'];
  // userAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0"
  
  const referer = req.headers['referer'] || req.headers['referrer'];
  // referer = "https://mail.google.com/"

  // 3Ô∏è‚É£ –ê–°–ò–ù–•–†–û–ù–ù–û –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∫–ª–∏–∫ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç!)
  trackShortLinkClick(shortCode, ipAddress, userAgent, referer)
    .catch(err => console.error('‚ùå Error tracking click:', err));

  // 4Ô∏è‚É£ –ù–ï–ú–ï–î–õ–ï–ù–ù–û —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  res.redirect(originalUrl);
  // –ë—Ä–∞—É–∑–µ—Ä –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞:
  // https://onai.academy/integrator/expresscourse?utm_source=email&utm_campaign=proftest&lead_id=abc123-def456-ghi789
});
```

---

### **8Ô∏è‚É£ –§—É–Ω–∫—Ü–∏—è `trackShortLinkClick()` —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ**

**–ö–æ–¥ (–∏–∑ `backend/src/services/urlShortener.ts`):**

```typescript
export async function trackShortLinkClick(
  shortCode: string,
  ipAddress: string,
  userAgent?: string,
  referer?: string
): Promise<void> {
  // 1Ô∏è‚É£ –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å—Å—ã–ª–∫–∏
  const { data: linkData } = await supabase
    .from('short_links')
    .select('clicks_count, unique_ips, first_clicked_at')
    .eq('short_code', shortCode)
    .single();

  // clicks_count = 0
  // unique_ips = []
  // first_clicked_at = null

  // 2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å IP
  const uniqueIps = linkData.unique_ips || [];
  const isUniqueClick = !uniqueIps.includes(ipAddress);
  // isUniqueClick = true (–ø–µ—Ä–≤—ã–π –∫–ª–∏–∫ —Å —ç—Ç–æ–≥–æ IP)

  // 3Ô∏è‚É£ –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
  await supabase
    .from('short_links')
    .update({
      clicks_count: 1, // –±—ã–ª–æ 0, —Å—Ç–∞–ª–æ 1
      unique_ips: ["185.123.45.67"], // –¥–æ–±–∞–≤–∏–ª–∏ IP
      first_clicked_at: new Date().toISOString(), // "2025-12-14T20:30:15Z"
      last_clicked_at: new Date().toISOString()   // "2025-12-14T20:30:15Z"
    })
    .eq('short_code', shortCode);

  // 4Ô∏è‚É£ –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–∫–µ
  await supabase
    .from('short_link_clicks')
    .insert({
      short_link_id: "aB3xY9",
      ip_address: "185.123.45.67",
      user_agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0",
      referer: "https://mail.google.com/",
      clicked_at: "2025-12-14T20:30:15Z"
    });

  console.log(`‚úÖ Click tracked: aB3xY9 (unique: true, total: 1)`);
}
```

---

### **9Ô∏è‚É£ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É**

**URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ:**
```
https://onai.academy/integrator/expresscourse?utm_source=email&utm_campaign=proftest&lead_id=abc123-def456-ghi789
```

**‚úÖ –í–°–ï UTM –ú–ï–¢–ö–ò –°–û–•–†–ê–ù–ò–õ–ò–°–¨!**

---

### **üîü Google Analytics / Facebook Pixel –ø–æ–ª—É—á–∞—é—Ç –¥–∞–Ω–Ω—ã–µ**

**UTM –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- ‚úÖ `utm_source=email` ‚Üí –∏—Å—Ç–æ—á–Ω–∏–∫: Email
- ‚úÖ `utm_campaign=proftest` ‚Üí –∫–∞–º–ø–∞–Ω–∏—è: –ü—Ä–æ—Ñ—Ç–µ—Å—Ç
- ‚úÖ `lead_id=abc123-def456-ghi789` ‚Üí ID –ª–∏–¥–∞

**Google Analytics –≤–∏–¥–∏—Ç:**
```
Source: email
Campaign: proftest
Custom Dimension: lead_id = abc123-def456-ghi789
```

**Facebook Conversion API –ø–æ–ª—É—á–∞–µ—Ç:**
```javascript
{
  event_name: "PageView",
  user_data: {
    client_user_agent: "Mozilla/5.0...",
    client_ip_address: "185.123.45.67"
  },
  custom_data: {
    source: "email",
    campaign: "proftest",
    lead_id: "abc123-def456-ghi789"
  }
}
```

---

## üìä –ß–¢–û –°–û–•–†–ê–ù–ò–õ–û–°–¨ –í –ë–ê–ó–ï –î–ê–ù–ù–´–•:

### **–¢–∞–±–ª–∏—Ü–∞: `short_links`** (–ø–æ—Å–ª–µ –∫–ª–∏–∫–∞)

```sql
SELECT * FROM short_links WHERE short_code = 'aB3xY9';
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
| short_code | original_url | clicks_count | unique_ips | first_clicked_at | last_clicked_at |
|------------|--------------|--------------|------------|------------------|-----------------|
| aB3xY9 | https://onai.academy/integrator/expresscourse?utm_source=email... | **1** | ["185.123.45.67"] | 2025-12-14 20:30:15 | 2025-12-14 20:30:15 |

---

### **–¢–∞–±–ª–∏—Ü–∞: `short_link_clicks`** (–¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)

```sql
SELECT * FROM short_link_clicks WHERE short_link_id = 'aB3xY9';
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
| id | short_link_id | ip_address | user_agent | referer | clicked_at |
|----|---------------|------------|------------|---------|------------|
| 1 | aB3xY9 | 185.123.45.67 | Mozilla/5.0... | https://mail.google.com/ | 2025-12-14 20:30:15 |

---

## üéØ –í–¢–û–†–û–ô –ö–õ–ò–ö (—Ç–æ—Ç –∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç)

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–Ω–æ–≤–∞ –∫–ª–∏–∫–∞–µ—Ç:** `https://onai.academy/l/aB3xY9`

### **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. ‚úÖ –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Ç—É –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
2. ‚úÖ `clicks_count` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è: `1 ‚Üí 2`
3. ‚ùå `unique_ips` –ù–ï –∏–∑–º–µ–Ω—è–µ—Ç—Å—è (—Ç–æ—Ç –∂–µ IP)
4. ‚úÖ `last_clicked_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
5. ‚úÖ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ `short_link_clicks`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
clicks_count = 2
unique_ips = ["185.123.45.67"] (–≤—Å—ë –µ—â—ë 1 —É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
```

---

## üéØ –¢–†–ï–¢–ò–ô –ö–õ–ò–ö (–¥—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –¥—Ä—É–≥–æ–π IP)

**–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–µ—Ç:** `https://onai.academy/l/aB3xY9`

**IP:** `92.45.78.123`

### **–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

1. ‚úÖ –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Ç—É –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
2. ‚úÖ `clicks_count` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è: `2 ‚Üí 3`
3. ‚úÖ `unique_ips` –î–û–ë–ê–í–õ–Ø–ï–¢–°–Ø –Ω–æ–≤—ã–π IP: `["185.123.45.67", "92.45.78.123"]`
4. ‚úÖ `last_clicked_at` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
5. ‚úÖ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ `short_link_clicks`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
clicks_count = 3
unique_ips = ["185.123.45.67", "92.45.78.123"] (2 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö)
```

---

## ‚úÖ –ò–¢–û–ì–û–í–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê:

### **–ü–æ—Å–ª–µ 3 –∫–ª–∏–∫–æ–≤:**

```json
{
  "shortCode": "aB3xY9",
  "originalUrl": "https://onai.academy/integrator/expresscourse?utm_source=email&utm_campaign=proftest&lead_id=abc123-def456-ghi789",
  "totalClicks": 3,
  "uniqueClicks": 2,
  "clickThroughRate": "2/100 = 2%", // –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ 100 emails
  "firstClickedAt": "2025-12-14T20:30:15Z",
  "lastClickedAt": "2025-12-14T21:15:30Z"
}
```

---

## üéâ –û–¢–í–ï–¢ –ù–ê –¢–í–û–ô –í–û–ü–†–û–°:

### **"–£–π–¥–µ—Ç –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∏–ª–∏ –Ω–µ—Ç?"**

# ‚úÖ –î–ê! –ê–ù–ê–õ–ò–¢–ò–ö–ê –†–ê–ë–û–¢–ê–ï–¢ –ù–ê 100%!

**–ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è:**

1. ‚úÖ **–ù–∞—à–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞:**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–∫–æ–≤ (–æ–±—â–µ–µ + —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ)
   - IP –∞–¥—Ä–µ—Å–∞ –≤—Å–µ—Ö –∫–ª–∏–∫–æ–≤
   - User Agent (–±—Ä–∞—É–∑–µ—Ä/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)
   - Referer (–æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à—ë–ª)
   - –í—Ä–µ–º—è –∫–ª–∏–∫–æ–≤

2. ‚úÖ **Google Analytics:**
   - UTM –º–µ—Ç–∫–∏ (source, campaign)
   - Lead ID
   - –ü—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Å–∞–π—Ç—É

3. ‚úÖ **Facebook Conversion API:**
   - –°–æ–±—ã—Ç–∏–µ PageView
   - IP –∞–¥—Ä–µ—Å –∏ User Agent
   - Custom Data (lead_id, source, campaign)

4. ‚úÖ **AmoCRM:**
   - Lead ID —Å–≤—è–∑–∞–Ω —Å AmoCRM
   - –ú–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é

---

## üöÄ –ö–ê–ö –ü–†–û–í–ï–†–ò–¢–¨:

### **1. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–æ—Ä–æ—Ç–∫–æ–π —Å—Å—ã–ª–∫–µ:**

```bash
curl https://api.onai.academy/api/short-links/stats/aB3xY9
```

### **2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Å—Å—ã–ª–∫–∏ –ª–∏–¥–∞:**

```bash
curl https://api.onai.academy/api/short-links/lead/abc123-def456-ghi789
```

### **3. –í –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏:**

```
/integrator/admin/leads ‚Üí –ù–∞–π—Ç–∏ –ª–∏–¥–∞ ‚Üí –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–ª–∏–∫–∏
```

---

**–í–°–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê –†–ê–ë–û–¢–ê–ï–¢! –ö–û–†–û–¢–ö–ê–Ø –°–°–´–õ–ö–ê = –ü–û–õ–ù–´–ô –¢–†–ï–ö–ò–ù–ì!** üéØ
