# –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Ä–µ–≤—å—é –∫–æ–¥–∞ Traffic Dashboard

## üìã –û–±–∑–æ—Ä

**–î–∞—Ç–∞:** 27 –¥–µ–∫–∞–±—Ä—è 2025  
**–ü—Ä–æ–µ–∫—Ç:** onAI Traffic Dashboard  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞, —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

---

## üéØ –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

### ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–ü–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã)**
   - ‚úÖ [`TrafficCabinetLayout`](src/components/traffic/TrafficCabinetLayout.tsx) - —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–π sidebar —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
   - ‚úÖ [`TrafficAdminPanel`](src/pages/traffic/TrafficAdminPanel.tsx) - –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å —Å –¥–∞—à–±–æ—Ä–¥–æ–º, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –∞—Ç—Ä–∏–±—É—Ü–∏–µ–π, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
   - ‚úÖ [`TrafficSettings`](src/pages/traffic/TrafficSettings.tsx) - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å Facebook –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π
   - ‚úÖ [`UTMSourcesPanel`](src/pages/traffic/UTMSourcesPanel.tsx) - –ø–∞–Ω–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞ UTM –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
   - ‚úÖ [`AttributionPanel`](src/components/traffic/AttributionPanel.tsx) - –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—Ç—Ä–∏–±—É—Ü–∏–µ–π
   - ‚úÖ [`TrafficCabinetDashboard`](src/pages/traffic/TrafficCabinetDashboard.tsx) - –¥–∞—à–±–æ—Ä–¥ –¥–ª—è —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–æ–≤
   - ‚úÖ [`TrafficTeamConstructor`](src/pages/traffic/TrafficTeamConstructor.tsx) - –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–æ–º–∞–Ω–¥ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω)
   - ‚úÖ [`TrafficSecurityPanel`](src/pages/traffic/TrafficSecurityPanel.tsx) - –ø–∞–Ω–µ–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
   - ‚úÖ [`TrafficAPIIntegrations`](src/pages/traffic/TrafficAPIIntegrations.tsx) - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ API
   - ‚úÖ [`TrafficTargetologistDashboard`](src/pages/traffic/TrafficTargetologistDashboard.tsx) - –¥–∞—à–±–æ—Ä–¥ —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∞
   - ‚úÖ [`TrafficDetailedAnalytics`](src/pages/traffic/TrafficDetailedAnalytics.tsx) - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã)**
   - ‚úÖ `traffic_teams` - —Ç–∞–±–ª–∏—Ü–∞ –∫–æ–º–∞–Ω–¥
   - ‚úÖ `traffic_users` - —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - ‚úÖ `traffic_targetologist_settings` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–æ–≤
   - ‚úÖ `traffic_sales_stats` - –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
   - ‚úÖ `traffic_fb_campaigns` - –∫–∞–º–ø–∞–Ω–∏–∏ Facebook
   - ‚úÖ `traffic_fb_ad_sets` - –≥—Ä—É–ø–ø—ã –æ–±—ä—è–≤–ª–µ–Ω–∏–π Facebook
   - ‚úÖ `traffic_fb_ads` - –æ–±—ä—è–≤–ª–µ–Ω–∏—è Facebook
   - ‚úÖ `all_sales_tracking` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–¥–∞–∂ (Landing DB)

3. **Backend API (–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)**
   - ‚úÖ [`amocrm-sales-webhook.ts`](backend/src/routes/amocrm-sales-webhook.ts) - webhook –¥–ª—è –ø—Ä–æ–¥–∞–∂ –∏–∑ AmoCRM
   - ‚úÖ [`amocrm-funnel-webhook.ts`](backend/src/routes/amocrm-funnel-webhook.ts) - webhook –¥–ª—è Express Course (—Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π)
   - ‚úÖ [`amocrm-main-product-webhook.ts`](backend/src/routes/amocrm-main-product-webhook.ts) - webhook –¥–ª—è Main Product (—Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π)
   - ‚úÖ [`traffic-facebook-api.ts`](backend/src/routes/traffic-facebook-api.ts) - API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Facebook Ads
   - ‚úÖ [`facebook-ads.ts`](backend/src/routes/facebook-ads.ts) - Facebook Ads Insights API
   - ‚úÖ [`traffic-dashboard.ts`](backend/src/routes/traffic-dashboard.ts) - API –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
   - ‚úÖ [`traffic-sales-aggregator.ts`](backend/src/services/traffic-sales-aggregator.ts) - —Å–µ—Ä–≤–∏—Å –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø—Ä–æ–¥–∞–∂

4. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞)**
   - ‚úÖ [`AuthManager`](src/lib/auth.ts) - –∫–∞—Å—Ç–æ–º–Ω–∞—è JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è Traffic Dashboard
   - ‚úÖ [`TrafficGuard`](src/components/traffic/TrafficGuard.tsx) - –∑–∞—â–∏—Ç–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–æ–≤
   - ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ Auth: Supabase (LMS) vs AuthManager (Traffic Dashboard)

---

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. **AmoCRM Webhook: –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è**

**–§–∞–π–ª:** [`amocrm-sales-webhook.ts`](backend/src/routes/amocrm-sales-webhook.ts)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –¥—Ä—É–≥–∏—Ö webhooks, —ç—Ç–æ—Ç webhook –Ω–µ –∏–º–µ–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—é –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ —Ä–µ—Ç—Ä–∞—è—Ö.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –∫–∞–∫ –≤ [`amocrm-funnel-webhook.ts`](backend/src/routes/amocrm-funnel-webhook.ts):

```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞
const webhookCache = new Map<string, number>();
const DEDUP_WINDOW_MS = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

function generateWebhookId(data: any): string {
  const leadIds = data?.leads?.status?.map((l: any) => l.id).join(',') || 'unknown';
  const timestamp = Math.floor(Date.now() / (60 * 1000)); // Round to minute
  return `${leadIds}_${timestamp}`;
}

function isDuplicate(webhookId: string): boolean {
  const exists = webhookCache.has(webhookId);
  if (!exists) {
    webhookCache.set(webhookId, Date.now());
  }
  return exists;
}

// –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ webhook:
const webhookId = generateWebhookId(data);
if (isDuplicate(webhookId)) {
  console.log('‚ö†Ô∏è Duplicate webhook detected, skipping:', webhookId);
  return res.status(200).json({ success: true, message: 'Duplicate webhook ignored' });
}
```

---

### 2. **Facebook API: –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ rate limits**

**–§–∞–π–ª:** [`facebook-ads.ts`](backend/src/routes/facebook-ads.ts)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ rate limits Facebook API –∏ retry –ª–æ–≥–∏–∫–∏.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å circuit breaker –∏ exponential backoff:

```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞
class CircuitBreaker {
  private failures = 0;
  private lastFailureTime = 0;
  private readonly threshold = 5;
  private readonly timeout = 60000; // 1 –º–∏–Ω—É—Ç–∞

  async execute<T>(fn: () => Promise<T>): Promise<T> {
    if (this.failures >= this.threshold) {
      const timeSinceLastFailure = Date.now() - this.lastFailureTime;
      if (timeSinceLastFailure < this.timeout) {
        throw new Error('Circuit breaker is OPEN');
      }
      this.failures = 0;
    }

    try {
      const result = await fn();
      this.failures = 0;
      return result;
    } catch (error: any) {
      this.failures++;
      this.lastFailureTime = Date.now();
      throw error;
    }
  }
}

const fbCircuitBreaker = new CircuitBreaker();

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö:
const insights = await fbCircuitBreaker.execute(() =>
  fetch(`https://graph.facebook.com/v19.0/${accountId}/insights?...`)
);
```

---

### 3. **–ù–µ—Ç –µ–¥–∏–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–æ–≤**

**–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∞ –ø–æ UTM –º–µ—Ç–∫–∞–º:

- [`amocrm-sales-webhook.ts`](backend/src/routes/amocrm-sales-webhook.ts):
  ```typescript
  const TARGETOLOGIST_MAPPING: Record<string, string[]> = {
    'Kenesary': ['tripwire', 'nutcab'],
    'Arystan': ['arystan'],
    'Muha': ['on ai', 'onai', '–∑–∞–ø—É—Å–∫'],
    'Traf4': ['alex', 'traf4', 'proftest'],
  };
  ```

- [`facebook-ads.ts`](backend/src/routes/facebook-ads.ts):
  ```typescript
  const AD_ACCOUNTS = {
    'Kenesary': { id: 'act_964264512447589', team: 'nutrients_kz', color: '#3b82f6' },
    'Arystan': { id: 'act_666059476005255', team: 'arystan_3_1', color: '#8b5cf6' },
    'Muha': { id: 'act_839340528712304', team: 'muha_acc3', color: '#eab308' },
    'Traf4': { id: 'act_30779210298344970', team: 'traf4_team', color: '#ef4444' },
  };
  ```

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å [`backend/src/services/targetologist-mapper.ts`](backend/src/services/targetologist-mapper.ts):

```typescript
/**
 * Targetologist Mapper Service
 * 
 * –ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∞ –ø–æ UTM –º–µ—Ç–∫–∞–º, ad accounts –∏ —Ç.–¥.
 */

interface TargetologistMapping {
  name: string;
  utmPatterns: string[];
  adAccounts: string[];
  teams: string[];
  color: string;
}

const TARGETOLOGIST_MAPPINGS: TargetologistMapping[] = [
  {
    name: 'Kenesary',
    utmPatterns: ['tripwire', 'nutcab', 'kenesary'],
    adAccounts: ['act_964264512447589'],
    teams: ['nutrients_kz'],
    color: '#3b82f6',
  },
  {
    name: 'Arystan',
    utmPatterns: ['arystan'],
    adAccounts: ['act_666059476005255'],
    teams: ['arystan_3_1'],
    color: '#8b5cf6',
  },
  {
    name: 'Muha',
    utmPatterns: ['on ai', 'onai', '–∑–∞–ø—É—Å–∫', 'muha'],
    adAccounts: ['act_839340528712304'],
    teams: ['muha_acc3'],
    color: '#eab308',
  },
  {
    name: 'Traf4',
    utmPatterns: ['alex', 'traf4', 'proftest'],
    adAccounts: ['act_30779210298344970'],
    teams: ['traf4_team'],
    color: '#ef4444',
  },
];

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∞ –ø–æ UTM source
 */
export function getTargetologistByUtmSource(utmSource: string): string | null {
  const sourceLower = utmSource.toLowerCase();
  
  for (const mapping of TARGETOLOGIST_MAPPINGS) {
    for (const pattern of mapping.utmPatterns) {
      if (sourceLower.includes(pattern.toLowerCase())) {
        return mapping.name;
      }
    }
  }
  
  return null;
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∞ –ø–æ ad account ID
 */
export function getTargetologistByAdAccount(accountId: string): string | null {
  const normalizedId = accountId.startsWith('act_') ? accountId : `act_${accountId}`;
  
  for (const mapping of TARGETOLOGIST_MAPPINGS) {
    if (mapping.adAccounts.includes(normalizedId)) {
      return mapping.name;
    }
  }
  
  return null;
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–æ–º–∞–Ω–¥—ã
 */
export function getTargetologistByTeam(teamName: string): string | null {
  const teamLower = teamName.toLowerCase();
  
  for (const mapping of TARGETOLOGIST_MAPPINGS) {
    for (const team of mapping.teams) {
      if (team.toLowerCase() === teamLower) {
        return mapping.name;
      }
    }
  }
  
  return null;
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–µ
 */
export function getTargetologistInfo(name: string): TargetologistMapping | null {
  return TARGETOLOGIST_MAPPINGS.find(m => 
    m.name.toLowerCase() === name.toLowerCase()
  ) || null;
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ—Ö —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–æ–≤
 */
export function getAllTargetologists(): TargetologistMapping[] {
  return TARGETOLOGIST_MAPPINGS;
}
```

---

### 4. **Redis –Ω–µ –∑–∞–ø—É—â–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ**

**–ü—Ä–æ–±–ª–µ–º–∞:** Backend –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Redis (`ECONNREFUSED 127.0.0.1:6379`).

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç—å Redis –ª–æ–∫–∞–ª—å–Ω–æ:

```bash
# macOS (Homebrew)
brew services start redis

# –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é
redis-server
```

–ò–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å Redis –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, –¥–æ–±–∞–≤–∏–≤ –≤ [`backend/.env`](backend/.env):

```env
REDIS_URL=
```

---

## üìä –°—Ç–∞—Ç—É—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

### AmoCRM Integration

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|--------|----------|
| Webhook –¥–ª—è –ø—Ä–æ–¥–∞–∂ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | [`amocrm-sales-webhook.ts`](backend/src/routes/amocrm-sales-webhook.ts) |
| Webhook –¥–ª—è Express Course | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | [`amocrm-funnel-webhook.ts`](backend/src/routes/amocrm-funnel-webhook.ts) |
| Webhook –¥–ª—è Main Product | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | [`amocrm-main-product-webhook.ts`](backend/src/routes/amocrm-main-product-webhook.ts) |
| –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | –ï—Å—Ç—å –≤ 2 –∏–∑ 3 webhooks |
| –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | [`traffic-sales-aggregator.ts`](backend/src/services/traffic-sales-aggregator.ts) |

### Facebook Ads Integration

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|--------|----------|
| API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | [`traffic-facebook-api.ts`](backend/src/routes/traffic-facebook-api.ts) |
| API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è insights | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | [`facebook-ads.ts`](backend/src/routes/facebook-ads.ts) |
| UI –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤ | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | [`TrafficSettings.tsx`](src/pages/traffic/TrafficSettings.tsx) |
| Rate limiting | ‚ùå –ù–µ—Ç | –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å |
| Retry logic | ‚ùå –ù–µ—Ç | –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å |

### Database Integration

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|--------|----------|
| Traffic DB (oetodaexnjcunklkdlkv) | ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω | –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã |
| Landing DB (xikaiavwqinamgolmtcy) | ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è all_sales_tracking |
| RLS Policies | ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã | –î–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü |
| –ú–∏–≥—Ä–∞—Ü–∏–∏ | ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω—ã | –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã |

---

## üé® UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–°—Ç–∞—Ç—É—Å)

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –§–∞–π–ª |
|-----------|--------|------|
| –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–π Sidebar | ‚úÖ –ì–æ—Ç–æ–≤ | [`TrafficCabinetLayout.tsx`](src/components/traffic/TrafficCabinetLayout.tsx) |
| –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å | ‚úÖ –ì–æ—Ç–æ–≤ | [`TrafficAdminPanel.tsx`](src/pages/traffic/TrafficAdminPanel.tsx) |
| –î–∞—à–±–æ—Ä–¥ –¥–ª—è —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–æ–≤ | ‚úÖ –ì–æ—Ç–æ–≤ | [`TrafficCabinetDashboard.tsx`](src/pages/traffic/TrafficCabinetDashboard.tsx) |
| –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å Facebook | ‚úÖ –ì–æ—Ç–æ–≤ | [`TrafficSettings.tsx`](src/pages/traffic/TrafficSettings.tsx) |
| –ê–Ω–∞–ª–∏–∑ UTM –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ | ‚úÖ –ì–æ—Ç–æ–≤ | [`UTMSourcesPanel.tsx`](src/pages/traffic/UTMSourcesPanel.tsx) |
| –ü–∞–Ω–µ–ª—å –∞—Ç—Ä–∏–±—É—Ü–∏–∏ | ‚úÖ –ì–æ—Ç–æ–≤ | [`AttributionPanel.tsx`](src/components/traffic/AttributionPanel.tsx) |
| –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–æ–º–∞–Ω–¥ | ‚úÖ –ì–æ—Ç–æ–≤ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω) | [`TrafficTeamConstructor.tsx`](src/pages/traffic/TrafficTeamConstructor.tsx) |
| –ü–∞–Ω–µ–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ | ‚úÖ –ì–æ—Ç–æ–≤ | [`TrafficSecurityPanel.tsx`](src/pages/traffic/TrafficSecurityPanel.tsx) |
| API –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ | ‚úÖ –ì–æ—Ç–æ–≤ | [`TrafficAPIIntegrations.tsx`](src/pages/traffic/TrafficAPIIntegrations.tsx) |
| –î–∞—à–±–æ—Ä–¥ —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∞ | ‚úÖ –ì–æ—Ç–æ–≤ | [`TrafficTargetologistDashboard.tsx`](src/pages/traffic/TrafficTargetologistDashboard.tsx) |
| –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ | ‚úÖ –ì–æ—Ç–æ–≤ | [`TrafficDetailedAnalytics.tsx`](src/pages/traffic/TrafficDetailedAnalytics.tsx) |

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|--------|----------|
| JWT –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ | [`AuthManager.ts`](src/lib/auth.ts) |
| RBAC (Role-Based Access Control) | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω | Admin vs Targetologist |
| TrafficGuard | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω | –ó–∞—â–∏—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ |
| CORS Headers | ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã | –í backend |
| Input Validation | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–∏—Ç—å |
| Audit Logging | ‚ùå –ù–µ—Ç | –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å |
| Rate Limiting | ‚ùå –ù–µ—Ç | –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å |

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É

### üî¥ –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)

1. **–î–æ–±–∞–≤–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –≤ [`amocrm-sales-webhook.ts`](backend/src/routes/amocrm-sales-webhook.ts)**
   - –ü—Ä–∏—á–∏–Ω–∞: –†–∏—Å–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–¥–∞–∂
   - –°–ª–æ–∂–Ω–æ—Å—Ç—å: –ù–∏–∑–∫–∞—è
   - –í—Ä–µ–º—è: ~30 –º–∏–Ω—É—Ç

2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å Redis –ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å**
   - –ü—Ä–∏—á–∏–Ω–∞: Backend –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ Redis
   - –°–ª–æ–∂–Ω–æ—Å—Ç—å: –ù–∏–∑–∫–∞—è
   - –í—Ä–µ–º—è: ~5 –º–∏–Ω—É—Ç

3. **–°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–æ–≤**
   - –ü—Ä–∏—á–∏–Ω–∞: –†–∞–∑–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö
   - –°–ª–æ–∂–Ω–æ—Å—Ç—å: –°—Ä–µ–¥–Ω—è—è
   - –í—Ä–µ–º—è: ~1 —á–∞—Å

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)

4. **–î–æ–±–∞–≤–∏—Ç—å rate limiting –¥–ª—è Facebook API**
   - –ü—Ä–∏—á–∏–Ω–∞: –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ API
   - –°–ª–æ–∂–Ω–æ—Å—Ç—å: –°—Ä–µ–¥–Ω—è—è
   - –í—Ä–µ–º—è: ~2 —á–∞—Å–∞

5. **–î–æ–±–∞–≤–∏—Ç—å retry logic –¥–ª—è Facebook API**
   - –ü—Ä–∏—á–∏–Ω–∞: –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
   - –°–ª–æ–∂–Ω–æ—Å—Ç—å: –°—Ä–µ–¥–Ω—è—è
   - –í—Ä–µ–º—è: ~2 —á–∞—Å–∞

6. **–î–æ–±–∞–≤–∏—Ç—å audit logging**
   - –ü—Ä–∏—á–∏–Ω–∞: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –°–ª–æ–∂–Ω–æ—Å—Ç—å: –°—Ä–µ–¥–Ω—è—è
   - –í—Ä–µ–º—è: ~3 —á–∞—Å–∞

### üü¢ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)

7. **–£–ª—É—á—à–∏—Ç—å input validation**
   - –ü—Ä–∏—á–∏–Ω–∞: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞
   - –°–ª–æ–∂–Ω–æ—Å—Ç—å: –ù–∏–∑–∫–∞—è
   - –í—Ä–µ–º—è: ~1 —á–∞—Å

8. **–î–æ–±–∞–≤–∏—Ç—å unit tests**
   - –ü—Ä–∏—á–∏–Ω–∞: –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
   - –°–ª–æ–∂–Ω–æ—Å—Ç—å: –í—ã—Å–æ–∫–∞—è
   - –í—Ä–µ–º—è: ~10+ —á–∞—Å–æ–≤

---

## üß™ –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### Phase 1: –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å Redis –ª–æ–∫–∞–ª—å–Ω–æ
2. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å backend –Ω–∞ localhost:3000
3. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å frontend –Ω–∞ localhost:8080
4. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ Team Constructor
5. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
6. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
7. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Facebook –∞–∫–∫–∞—É–Ω—Ç–æ–≤
8. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –∫–∞–º–ø–∞–Ω–∏–π

### Phase 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

9. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å webhook AmoCRM –¥–ª—è –ø—Ä–æ–¥–∞–∂
10. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ AmoCRM –ø–æ UTM –º–µ—Ç–∫–∞–º
11. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞—Ç—Ä–∏–±—É—Ü–∏—é –ø—Ä–æ–¥–∞–∂ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
12. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Facebook Ads API
13. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö

### Phase 3: –ü—Ä–æ–¥–∞–∫—à–µ–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

14. ‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ production —Å–µ—Ä–≤–µ—Ä
15. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ endpoints
16. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
17. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

1. ‚úÖ [`EXISTING_INTEGRATION_ANALYSIS.md`](plans/EXISTING_INTEGRATION_ANALYSIS.md) - –ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
2. ‚úÖ [`TRAFFIC_DASHBOARD_CODE_REVIEW_REPORT.md`](plans/TRAFFIC_DASHBOARD_CODE_REVIEW_REPORT.md) - –û—Ç—á–µ—Ç –æ —Ä–µ–≤—å—é –∫–æ–¥–∞
3. ‚úÖ [`PHASE_1_CHECKLIST.md`](plans/PHASE_1_CHECKLIST.md) - –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
4. ‚úÖ [`CLEAR_OLD_TEAMS_WITH_UTM_BACKUP.sql`](sql/CLEAR_OLD_TEAMS_WITH_UTM_BACKUP.sql) - SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–æ–º–∞–Ω–¥
5. ‚úÖ [`CORRECT_TRAFFIC_TABLES.sql`](sql/CORRECT_TRAFFIC_TABLES.sql) - SQL –º–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è —Ç–∞–±–ª–∏—Ü

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### –ß—Ç–æ –≥–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:

‚úÖ **UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã** - –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã  
‚úÖ **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** - –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã  
‚úÖ **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - JWT —Ç–æ–∫–µ–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
‚úÖ **AmoCRM Webhooks** - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è)  
‚úÖ **Facebook API** - –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç  

### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏:

‚ö†Ô∏è **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –≤ AmoCRM webhook** - –ö—Ä–∏—Ç–∏—á–Ω–æ  
‚ö†Ô∏è **Rate limiting –¥–ª—è Facebook API** - –í–∞–∂–Ω–æ  
‚ö†Ô∏è **Retry logic –¥–ª—è Facebook API** - –í–∞–∂–Ω–æ  
‚ö†Ô∏è **–ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –º–∞–ø–ø–∏–Ω–≥–∞ —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–æ–≤** - –í–∞–∂–Ω–æ  
‚ö†Ô∏è **Audit logging** - –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ  

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:** ~75%  
**–û—Ü–µ–Ω–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –¥–æ –ø–æ–ª–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** ~8-12 —á–∞—Å–æ–≤  

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–º–æ—â—å:
- Telegram: @username
- Email: email@example.com

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 27 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–ê–≤—Ç–æ—Ä:** Kilo Code Assistant
