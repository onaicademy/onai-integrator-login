# –ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ AmoCRM –∏ Facebook API

## üìä AmoCRM Webhooks

### 1. `amocrm-sales-webhook.ts` - –û—Å–Ω–æ–≤–Ω–æ–π webhook –¥–ª—è –ø—Ä–æ–¥–∞–∂

**Endpoint:** `POST /api/amocrm/sales-webhook`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç webhook –æ—Ç AmoCRM —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `all_sales_tracking` (Traffic DB)
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∞ –ø–æ UTM –º–µ—Ç–∫–∞–º (–∫–∞–º–ø–∞–Ω–∏—è –∏–ª–∏ source)
- ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
- ‚úÖ –ï—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–¥–∞–∂ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

**–ú–∞–ø–ø–∏–Ω–≥ —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–æ–≤:**
```typescript
const TARGETOLOGIST_MAPPING: Record<string, string[]> = {
  'Kenesary': ['tripwire', 'nutcab'],
  'Arystan': ['arystan'],
  'Muha': ['on ai', 'onai', '–∑–∞–ø—É—Å–∫'],
  'Traf4': ['alex', 'traf4', 'proftest'],
};
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ webhook (idempotency)
- ‚ùå –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK, –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å retry loop)

### 2. `amocrm-funnel-webhook.ts` - Webhook –¥–ª—è Express Course (5,000 KZT)

**Endpoint:** `POST /api/amocrm/funnel-sale`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç webhook –æ—Ç AmoCRM –¥–ª—è —ç–∫—Å–ø—Ä–µ—Å—Å-–∫—É—Ä—Å–∞
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `express_course_sales` (Landing DB)
- ‚úÖ –ò–∑–≤–ª–µ–∫–∞–µ—Ç UTM –º–µ—Ç–∫–∏ –∏–∑ custom fields
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∞ –ø–æ UTM
- ‚úÖ –ò–º–µ–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é webhook (idempotency) - **–û–¢–õ–ò–ß–ù–û!**
- ‚úÖ –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è retry loop - **–û–¢–õ–ò–ß–ù–û!**

**–ú–∞–ø–ø–∏–Ω–≥ —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–æ–≤:**
```typescript
const TARGETOLOGIST_PATTERNS: Record<string, string[]> = {
  'Kenesary': ['nutrients', 'nutcab', 'kenesary', 'tripwire', 'kab3', '1day', 'pb_agency', 'kenji', 'kenes'],
  'Arystan': ['arystan', 'ar_', 'ast_', 'rm almaty', 'rm_almaty'],
  'Muha': ['onai', 'on ai', '–∑–∞–ø—É—Å–∫', 'muha', 'yourmarketolog', 'maqtakyz', 'residence', 'yourteam', 'tima'],
  'Traf4': ['alex', 'traf4', 'proftest', 'pb_agency', 'smmmcwin', '3-1'],
};
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è webhook —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –Ω–∞ 5 –º–∏–Ω—É—Ç
- ‚úÖ –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è retry loop
- ‚úÖ –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ Markdown –¥–ª—è Telegram

### 3. `amocrm-main-product-webhook.ts` - Webhook –¥–ª—è Main Product (490,000 KZT)

**Endpoint:** `POST /webhook/amocrm/traffic`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç webhook –æ—Ç AmoCRM –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `main_product_sales` (Landing DB)
- ‚úÖ –ò–∑–≤–ª–µ–∫–∞–µ—Ç UTM –º–µ—Ç–∫–∏ –∏–∑ custom fields
- ‚úÖ –ò–º–µ–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é webhook (idempotency) - **–û–¢–õ–ò–ß–ù–û!**
- ‚úÖ –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è retry loop - **–û–¢–õ–ò–ß–ù–û!**

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è webhook —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –Ω–∞ 5 –º–∏–Ω—É—Ç
- ‚úÖ –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è retry loop

---

## üìò Facebook Ads API

### 1. `traffic-facebook-api.ts` - API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Facebook Ads

**Endpoints:**
- `GET /api/traffic-facebook/accounts` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö ad accounts (—Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
- `GET /api/traffic-facebook/campaigns/:accountId` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–π –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞
- `POST /api/traffic-facebook/refresh` - –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- `GET /api/traffic-facebook/health` - health check

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç service layer –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- ‚úÖ Redis –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å TTL 5 –º–∏–Ω—É—Ç
- ‚úÖ Graceful error handling
- ‚úÖ Force refresh capability

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –•–æ—Ä–æ—à–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (service layer)
- ‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- ‚úÖ Force refresh –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

### 2. `facebook-ads.ts` - Facebook Ads Insights API

**Endpoints:**
- `GET /api/facebook-ads/insights` - –ø–æ–ª—É—á–µ–Ω–∏–µ insights –∏–∑ –≤—Å–µ—Ö ad accounts —Å UTM —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
- `GET /api/facebook-ads/recommendations/:team` - –ø–æ–ª—É—á–µ–Ω–∏–µ AI —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –∫–æ–º–∞–Ω–¥—ã
- `POST /api/facebook-ads/recommendations/generate` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö AI —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç insights –∏–∑ Facebook Graph API
- ‚úÖ –§–∏–ª—å—Ç—Ä—É–µ—Ç –∫–∞–º–ø–∞–Ω–∏–∏ –ø–æ team name patterns
- ‚úÖ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç ROAS, CPA, CTR
- ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç AI —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**–ú–∞–ø–ø–∏–Ω–≥ ad accounts:**
```typescript
const AD_ACCOUNTS = {
  'Kenesary': { id: 'act_964264512447589', team: 'nutrients_kz', color: '#3b82f6' },
  'Arystan': { id: 'act_666059476005255', team: 'arystan_3_1', color: '#8b5cf6' },
  'Muha': { id: 'act_839340528712304', team: 'muha_acc3', color: '#eab308' },
  'Traf4': { id: 'act_30779210298344970', team: 'traf4_team', color: '#ef4444' },
};
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –•–æ—Ä–æ—à–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–∞–º–ø–∞–Ω–∏–π –ø–æ team patterns
- ‚úÖ –†–∞—Å—á–µ—Ç –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫ (ROAS, CPA, CTR)
- ‚úÖ AI —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –ù–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚ùå –ù–µ—Ç error handling –¥–ª—è Facebook API rate limits
- ‚ùå –ù–µ—Ç retry logic –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫

---

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### 1. AmoCRM Webhooks

**–ö—Ä–∏—Ç–∏—á–Ω–æ:**
- ‚ùå –î–æ–±–∞–≤–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é webhook –≤ `amocrm-sales-webhook.ts` (–∫–∞–∫ –≤ –¥—Ä—É–≥–∏—Ö webhooks)
- ‚ùå –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 200 OK –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è retry loop (–∫–∞–∫ –≤ –¥—Ä—É–≥–∏—Ö webhooks)
- ‚ùå –î–æ–±–∞–≤–∏—Ç—å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ Markdown –¥–ª—è Telegram (–∫–∞–∫ –≤ `amocrm-funnel-webhook.ts`)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–æ–≤ (—Å–æ–∑–¥–∞—Ç—å –æ–±—â–∏–π service)
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å retry logic –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ Supabase

### 2. Facebook Ads API

**–ö—Ä–∏—Ç–∏—á–Ω–æ:**
- ‚ùå –î–æ–±–∞–≤–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤ (prevent duplicate API calls)
- ‚ùå –î–æ–±–∞–≤–∏—Ç—å error handling –¥–ª—è Facebook API rate limits
- ‚ùå –î–æ–±–∞–≤–∏—Ç—å retry logic –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å circuit breaker –¥–ª—è Facebook API
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å exponential backoff –¥–ª—è retry logic
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (API calls, errors, rate limits)

### 3. UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å:**
- ‚ùå Main Dashboard —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –ø–æ –≤—Å–µ–º –∫–æ–º–∞–Ω–¥–∞–º
- ‚ùå Settings Panel —Å Facebook integration
- ‚ùå Collapsible Site Bar —Å Admin Panel –≤ –º–µ–Ω—é

---

## üìã –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### Phase 1: –£–ª—É—á—à–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
1. –î–æ–±–∞–≤–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é webhook –≤ `amocrm-sales-webhook.ts`
2. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–æ–≤
3. –î–æ–±–∞–≤–∏—Ç—å retry logic –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
4. –î–æ–±–∞–≤–∏—Ç—å circuit breaker –¥–ª—è Facebook API
5. –î–æ–±–∞–≤–∏—Ç—å exponential backoff –¥–ª—è retry logic

### Phase 2: –°–æ–∑–¥–∞–Ω–∏–µ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
1. –°–æ–∑–¥–∞—Ç—å Main Dashboard —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –ø–æ –≤—Å–µ–º –∫–æ–º–∞–Ω–¥–∞–º
2. –°–æ–∑–¥–∞—Ç—å Settings Panel —Å Facebook integration
3. –°–æ–∑–¥–∞—Ç—å Collapsible Site Bar —Å Admin Panel –≤ –º–µ–Ω—é

### Phase 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ webhooks
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Facebook API endpoints
3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å error handling
