<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Supabase Connection Test</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #00ff00;
    }
    .test {
      margin: 10px 0;
      padding: 10px;
      background: #2a2a2a;
      border-left: 4px solid #00ff00;
    }
    .error {
      border-left-color: #ff0000;
      color: #ff6666;
    }
    .success {
      border-left-color: #00ff00;
    }
    button {
      background: #00ff00;
      color: #000;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      font-family: monospace;
      font-weight: bold;
    }
    button:hover {
      background: #00cc00;
    }
    pre {
      background: #000;
      padding: 10px;
      overflow-x: auto;
      border: 1px solid #00ff00;
    }
  </style>
</head>
<body>
  <h1>üîç Supabase Connection Diagnostics</h1>
  <div id="results"></div>
  
  <h2>üß™ Tests:</h2>
  <button onclick="testConnection()">1. Test Connection</button>
  <button onclick="testAuth()">2. Test Auth Session</button>
  <button onclick="testProfiles()">3. Test Profiles Table</button>
  <button onclick="testStudentProfiles()">4. Test Student Profiles</button>
  <button onclick="testRLS()">5. Test RLS Policies</button>
  <button onclick="clearAll()">Clear Results</button>

  <script>
    // ‚ö†Ô∏è –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å —Å—é–¥–∞ ANON KEY –∏–∑ —Ç–≤–æ–µ–≥–æ .env —Ñ–∞–π–ª–∞
    // –ù–∞–π–¥–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ —Ñ–∞–π–ª .env –∏ —Å–∫–æ–ø–∏—Ä—É–π –∑–Ω–∞—á–µ–Ω–∏–µ VITE_SUPABASE_ANON_KEY
    const SUPABASE_URL = 'https://arqhkacellqbhjhbebfh.supabase.co';
    const SUPABASE_ANON_KEY = '–í–°–¢–ê–í–¨_–°–Æ–î–ê_ANON_KEY_–ò–ó_ENV_–§–ê–ô–õ–ê';

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –µ—Å–ª–∏ –∫–ª—é—á –Ω–µ –≤—Å—Ç–∞–≤–ª–µ–Ω
    if (SUPABASE_ANON_KEY === '–í–°–¢–ê–í–¨_–°–Æ–î–ê_ANON_KEY_–ò–ó_ENV_–§–ê–ô–õ–ê') {
      document.body.innerHTML = `
        <div style="padding: 40px; font-family: monospace; background: #1a1a1a; color: #00ff00; min-height: 100vh;">
          <h1 style="color: #ff0000;">‚ö†Ô∏è –ù–£–ñ–ù–û –í–°–¢–ê–í–ò–¢–¨ API –ö–õ–Æ–ß</h1>
          
          <h2>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h2>
          <ol style="font-size: 16px; line-height: 2;">
            <li>–û—Ç–∫—Ä–æ–π —Ñ–∞–π–ª <code style="background: #000; padding: 5px;">.env</code> –≤ –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞</li>
            <li>–ù–∞–π–¥–∏ —Å—Ç—Ä–æ–∫—É <code style="background: #000; padding: 5px;">VITE_SUPABASE_ANON_KEY=...</code></li>
            <li>–°–∫–æ–ø–∏—Ä—É–π –≤—Å—ë —á—Ç–æ –ø–æ—Å–ª–µ –∑–Ω–∞–∫–∞ <code>=</code></li>
            <li>–û—Ç–∫—Ä–æ–π —ç—Ç–æ—Ç —Ñ–∞–π–ª <code style="background: #000; padding: 5px;">test-supabase-connection.html</code> –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ</li>
            <li>–ù–∞–π–¥–∏ —Å—Ç—Ä–æ–∫—É 62: <code style="background: #000; padding: 5px;">const SUPABASE_ANON_KEY = '–í–°–¢–ê–í–¨_–°–Æ–î–ê...';</code></li>
            <li>–í—Å—Ç–∞–≤—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á –≤–º–µ—Å—Ç–æ <code style="background: #000; padding: 5px;">–í–°–¢–ê–í–¨_–°–Æ–î–ê_ANON_KEY_–ò–ó_ENV_–§–ê–ô–õ–ê</code></li>
            <li>–°–æ—Ö—Ä–∞–Ω–∏ —Ñ–∞–π–ª (Ctrl+S)</li>
            <li>–û–±–Ω–æ–≤–∏ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É (Ctrl+R)</li>
          </ol>

          <h2 style="margin-top: 40px;">üîç –ò–ª–∏ –ø—Ä–æ–≤–µ—Ä—å –Ω–∞–ø—Ä—è–º—É—é:</h2>
          <p>–û—Ç–∫—Ä–æ–π –∫–æ–Ω—Å–æ–ª—å (F12) –∏ –ø–æ—Å–º–æ—Ç—Ä–∏ –ª–æ–≥–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:</p>
          <a href="/admin/students-activity" style="color: #00ff00; font-size: 20px; text-decoration: underline;">
            üëâ https://localhost:8080/admin/students-activity
          </a>
          <p style="margin-top: 20px;">–¢–∞–º –±—É–¥—É—Ç –ª–æ–≥–∏ —Å —Ç–æ—á–Ω–æ–π –æ—à–∏–±–∫–æ–π!</p>
        </div>
      `;
    }
  </script>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const SUPABASE_URL = 'https://arqhkacellqbhjhbebfh.supabase.co';
    const SUPABASE_ANON_KEY = '–í–°–¢–ê–í–¨_–°–Æ–î–ê_ANON_KEY_–ò–ó_ENV_–§–ê–ô–õ–ê';
    
    if (SUPABASE_ANON_KEY === '–í–°–¢–ê–í–¨_–°–Æ–î–ê_ANON_KEY_–ò–ó_ENV_–§–ê–ô–õ–ê') {
      // –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É–∂–µ –∑–∞–º–µ–Ω–µ–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –≤—ã—à–µ
      throw new Error('API key not configured');
    }

    console.log('üîë Using Supabase config:', { url: SUPABASE_URL, keyLength: SUPABASE_ANON_KEY?.length });
    
    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `test ${type}`;
      div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
      document.getElementById('results').appendChild(div);
      console.log(message);
    }

    window.testConnection = async () => {
      log('üîå Testing basic Supabase connection...', 'info');
      try {
        const { data, error } = await window.supabase.from('profiles').select('count');
        if (error) throw error;
        log(`‚úÖ Connection OK! Can access database.`, 'success');
      } catch (error) {
        log(`‚ùå Connection failed: ${error.message}`, 'error');
        log(`<pre>${JSON.stringify(error, null, 2)}</pre>`, 'error');
      }
    };

    window.testAuth = async () => {
      log('üîê Testing auth session...', 'info');
      try {
        const { data: { session }, error } = await window.supabase.auth.getSession();
        if (error) throw error;
        
        if (session) {
          log(`‚úÖ Session found! User: ${session.user.email}`, 'success');
          log(`<pre>${JSON.stringify(session.user, null, 2)}</pre>`, 'success');
        } else {
          log(`‚ö†Ô∏è No active session. Please login first.`, 'error');
        }
      } catch (error) {
        log(`‚ùå Auth test failed: ${error.message}`, 'error');
      }
    };

    window.testProfiles = async () => {
      log('üë§ Testing profiles table...', 'info');
      try {
        const { data, error } = await window.supabase
          .from('profiles')
          .select('id, email, full_name, role, is_active')
          .limit(5);
        
        if (error) throw error;
        log(`‚úÖ Profiles table OK! Found ${data.length} rows`, 'success');
        log(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
      } catch (error) {
        log(`‚ùå Profiles test failed: ${error.message}`, 'error');
        log(`<pre>${JSON.stringify(error, null, 2)}</pre>`, 'error');
      }
    };

    window.testStudentProfiles = async () => {
      log('üéì Testing student_profiles table...', 'info');
      try {
        const { data, error } = await window.supabase
          .from('student_profiles')
          .select('id, email, full_name, is_active, total_xp, level')
          .limit(5);
        
        if (error) throw error;
        log(`‚úÖ Student profiles table OK! Found ${data.length} rows`, 'success');
        log(`<pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
      } catch (error) {
        log(`‚ùå Student profiles test failed: ${error.message}`, 'error');
        log(`<pre>${JSON.stringify(error, null, 2)}</pre>`, 'error');
      }
    };

    window.testRLS = async () => {
      log('üîí Testing RLS policies...', 'info');
      try {
        const { data: { session } } = await window.supabase.auth.getSession();
        
        if (!session) {
          log(`‚ö†Ô∏è Cannot test RLS without active session. Login first.`, 'error');
          return;
        }

        // Test own profile access
        const { data: ownProfile, error: ownError } = await window.supabase
          .from('profiles')
          .select('*')
          .eq('id', session.user.id)
          .single();

        if (ownError) throw ownError;
        log(`‚úÖ Can read own profile`, 'success');

        // Test all profiles access (admin only)
        const { data: allProfiles, error: allError } = await window.supabase
          .from('profiles')
          .select('id, email, role')
          .limit(10);

        if (allError && allError.code === 'PGRST301') {
          log(`‚ö†Ô∏è RLS blocking: Cannot read other profiles (expected for non-admin)`, 'info');
        } else if (allError) {
          throw allError;
        } else {
          log(`‚úÖ Can read all profiles (admin access confirmed)`, 'success');
          log(`<pre>Found ${allProfiles.length} profiles</pre>`, 'success');
        }
      } catch (error) {
        log(`‚ùå RLS test failed: ${error.message}`, 'error');
        log(`<pre>${JSON.stringify(error, null, 2)}</pre>`, 'error');
      }
    };

    window.clearAll = () => {
      document.getElementById('results').innerHTML = '';
    };

    // Auto-run basic tests on load
    setTimeout(async () => {
      log('üöÄ Auto-running basic diagnostics...', 'info');
      await testConnection();
      await testAuth();
    }, 500);
  </script>
</body>
</html>

