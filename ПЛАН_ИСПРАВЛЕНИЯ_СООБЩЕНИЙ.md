# üîß –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –†–ê–ó–î–ï–õ–ê "–°–û–û–ë–©–ï–ù–ò–Ø"

**–î–∞—Ç–∞:** 7 –Ω–æ—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º—ã:** –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–ø–∞–¥–∞–µ—Ç + –ì–æ–ª–æ—Å–æ–≤—ã–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

---

## üîç –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú

### ‚ùå **–ü–†–û–ë–õ–ï–ú–ê 1: –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ**

**–ü—Ä–∏—á–∏–Ω–∞:**
```typescript
// src/pages/Messages.tsx
// –í–°–ï –î–ê–ù–ù–´–ï - –≠–¢–û MOCK (hardcoded)
const [chats, setChats] = useState<Chat[]>([
  {
    id: "1",
    studentId: "1",
    name: "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
    lastMessage: "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?",
    // ...
  }
]);

const [messages, setMessages] = useState<Message[]>([
  {
    id: "1",
    content: "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?",
    // ...
  }
]);
```

**–ß—Ç–æ –Ω–µ —Ç–∞–∫:**
- ‚ùå –ù–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Supabase –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
- ‚ùå –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Supabase –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
- ‚ùå –¢–æ–ª—å–∫–æ mock –¥–∞–Ω–Ω—ã–µ –≤ `useState`

---

### ‚ùå **–ü–†–û–ë–õ–ï–ú–ê 2: –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç**

**–ü—Ä–∏—á–∏–Ω–∞:**
```typescript
// src/pages/Messages.tsx (—Å—Ç—Ä–æ–∫–∞ 163-199)
const handleStartRecording = () => {
  setIsRecording(true);
  // –ü—Ä–æ—Å—Ç–æ —Ç–∞–π–º–µ—Ä, –ù–ï–¢ –†–ï–ê–õ–¨–ù–û–ô –ó–ê–ü–ò–°–ò –ê–£–î–ò–û!
  recordingInterval.current = setInterval(() => {
    setRecordingTime((prev) => prev + 1);
  }, 1000);
};

const handleStopRecording = () => {
  // –°–æ–∑–¥–∞—ë–º fake —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º
  const message: Message = {
    content: `–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (${recordingTime} —Å–µ–∫)`,
    type: "voice",
    // –ù–ï–¢ –†–ï–ê–õ–¨–ù–û–ì–û –ê–£–î–ò–û –§–ê–ô–õ–ê!
  };
  setMessages([...messages, message]);
};
```

**–ß—Ç–æ –Ω–µ —Ç–∞–∫:**
- ‚ùå –ù–µ—Ç MediaRecorder API –¥–ª—è –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏–æ
- ‚ùå –ù–µ—Ç Supabase Storage bucket –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—É–¥–∏–æ
- ‚ùå –ù–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ –≤ Storage
- ‚ùå –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è URL –∞—É–¥–∏–æ –≤ –ë–î
- ‚ùå –ù–µ—Ç –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è

---

### ‚úÖ **–ß–¢–û –£–ñ–ï –ï–°–¢–¨:**

1. **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –≥–æ—Ç–æ–≤–∞:**
   - ‚úÖ `student_private_chats` - —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —á–∞—Ç–æ–≤
   - ‚úÖ `student_private_messages` - —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
   - ‚úÖ `attachment_url` - –ø–æ–ª–µ –¥–ª—è —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∞–π–ª
   - ‚úÖ `message_type` - –ø–æ–ª–µ –¥–ª—è —Ç–∏–ø–∞ ('text', 'voice', 'file')

2. **–ß–µ–≥–æ –ù–ï–¢:**
   - ‚ùå Supabase Storage bucket –¥–ª—è –∞—É–¥–∏–æ
   - ‚ùå API —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
   - ‚ùå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Messages.tsx —Å Supabase

---

## üéØ –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### **–®–ê–ì 1: –°–æ–∑–¥–∞—Ç—å Storage bucket –≤ Supabase** üóÑÔ∏è

```sql
-- –°–æ–∑–¥–∞—Ç—å bucket –¥–ª—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
INSERT INTO storage.buckets (id, name, public)
VALUES ('student-messages', 'student-messages', false);

-- –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞: —Å—Ç—É–¥–µ–Ω—Ç—ã –º–æ–≥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å/—á–∏—Ç–∞—Ç—å —Å–≤–æ–∏ —Ñ–∞–π–ª—ã
CREATE POLICY "Students can upload voice messages"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'student-messages' AND
  auth.uid()::text = (storage.foldername(name))[1]
);

CREATE POLICY "Students can read voice messages"
ON storage.objects FOR SELECT
TO authenticated
USING (
  bucket_id = 'student-messages'
);
```

---

### **–®–ê–ì 2: –°–æ–∑–¥–∞—Ç—å API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏** üì°

**–ù–æ–≤—ã–π —Ñ–∞–π–ª:** `src/lib/messages-api.ts`

```typescript
import { supabase } from "./supabase";

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ —á–∞—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
export async function getMyChats(userId: string) {
  const { data, error } = await supabase
    .from('student_private_chats')
    .select(`
      *,
      user1:user1_id(id, email, raw_user_meta_data),
      user2:user2_id(id, email, raw_user_meta_data)
    `)
    .or(`user1_id.eq.${userId},user2_id.eq.${userId}`)
    .order('updated_at', { ascending: false });
  
  return data || [];
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞
export async function getChatMessages(chatId: string) {
  const { data, error } = await supabase
    .from('student_private_messages')
    .select('*')
    .eq('chat_id', chatId)
    .eq('is_deleted', false)
    .order('created_at', { ascending: true });
  
  return data || [];
}

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
export async function sendTextMessage(
  chatId: string,
  senderId: string,
  content: string
) {
  const { data, error } = await supabase
    .from('student_private_messages')
    .insert({
      chat_id: chatId,
      sender_id: senderId,
      message_type: 'text',
      content: content,
    })
    .select()
    .single();
  
  if (error) throw error;
  return data;
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
export async function uploadVoiceMessage(
  chatId: string,
  senderId: string,
  audioBlob: Blob,
  duration: number
) {
  // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—É–¥–∏–æ –≤ Storage
  const fileName = `${senderId}/${Date.now()}.webm`;
  const { data: uploadData, error: uploadError } = await supabase.storage
    .from('student-messages')
    .upload(fileName, audioBlob, {
      contentType: 'audio/webm',
      upsert: false,
    });

  if (uploadError) throw uploadError;

  // 2. –ü–æ–ª—É—á–∞–µ–º URL –∞—É–¥–∏–æ
  const { data: urlData } = supabase.storage
    .from('student-messages')
    .getPublicUrl(fileName);

  // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –ë–î
  const { data, error } = await supabase
    .from('student_private_messages')
    .insert({
      chat_id: chatId,
      sender_id: senderId,
      message_type: 'voice',
      content: `–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (${duration} —Å–µ–∫)`,
      attachment_url: urlData.publicUrl,
      attachment_type: 'audio/webm',
    })
    .select()
    .single();

  if (error) throw error;
  return data;
}

// –°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å —á–∞—Ç –º–µ–∂–¥—É –¥–≤—É–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏
export async function getOrCreateChat(user1Id: string, user2Id: string) {
  // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç
  const { data: existing } = await supabase
    .from('student_private_chats')
    .select('*')
    .or(`and(user1_id.eq.${user1Id},user2_id.eq.${user2Id}),and(user1_id.eq.${user2Id},user2_id.eq.${user1Id})`)
    .single();

  if (existing) return existing;

  // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —á–∞—Ç
  const { data, error } = await supabase
    .from('student_private_chats')
    .insert({
      user1_id: user1Id,
      user2_id: user2Id,
    })
    .select()
    .single();

  if (error) throw error;
  return data;
}
```

---

### **–®–ê–ì 3: –û–±–Ω–æ–≤–∏—Ç—å Messages.tsx** üîÑ

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

1. **–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Supabase:**
```typescript
useEffect(() => {
  loadChatsFromSupabase();
}, [currentUser]);

const loadChatsFromSupabase = async () => {
  if (!currentUser) return;
  const chatsData = await getMyChats(currentUser.id);
  setChats(transformChats(chatsData));
};
```

2. **–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —á–∞—Ç–∞:**
```typescript
useEffect(() => {
  if (selectedChat) {
    loadMessagesFromSupabase(selectedChat);
  }
}, [selectedChat]);

const loadMessagesFromSupabase = async (chatId: string) => {
  const messagesData = await getChatMessages(chatId);
  setMessages(transformMessages(messagesData));
};
```

3. **–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:**
```typescript
const handleSendMessage = async () => {
  if (!newMessage.trim() || !selectedChat || !currentUser) return;
  
  const msg = await sendTextMessage(
    selectedChat,
    currentUser.id,
    newMessage
  );
  
  setMessages([...messages, transformMessage(msg)]);
  setNewMessage("");
};
```

4. **–†–µ–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤—ã—Ö:**
```typescript
const mediaRecorderRef = useRef<MediaRecorder | null>(null);
const audioChunksRef = useRef<Blob[]>([]);

const handleStartRecording = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream);
    
    audioChunksRef.current = [];
    
    mediaRecorder.ondataavailable = (event) => {
      audioChunksRef.current.push(event.data);
    };
    
    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
      await handleSendVoiceMessage(audioBlob);
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
      stream.getTracks().forEach(track => track.stop());
    };
    
    mediaRecorder.start();
    mediaRecorderRef.current = mediaRecorder;
    setIsRecording(true);
    
    // –¢–∞–π–º–µ—Ä –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    setRecordingTime(0);
    recordingInterval.current = setInterval(() => {
      setRecordingTime((prev) => prev + 1);
    }, 1000);
  } catch (error) {
    toast({
      title: "‚ùå –û—à–∏–±–∫–∞",
      description: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É",
      variant: "destructive",
    });
  }
};

const handleStopRecording = () => {
  if (mediaRecorderRef.current && isRecording) {
    mediaRecorderRef.current.stop();
    setIsRecording(false);
    clearInterval(recordingInterval.current);
  }
};

const handleSendVoiceMessage = async (audioBlob: Blob) => {
  if (!selectedChat || !currentUser) return;
  
  try {
    const msg = await uploadVoiceMessage(
      selectedChat,
      currentUser.id,
      audioBlob,
      recordingTime
    );
    
    setMessages([...messages, transformMessage(msg)]);
    setRecordingTime(0);
    
    toast({
      title: "‚úÖ –ì–æ–ª–æ—Å–æ–≤–æ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ",
      description: `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${recordingTime} —Å–µ–∫`,
    });
  } catch (error) {
    toast({
      title: "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏",
      description: "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
      variant: "destructive",
    });
  }
};
```

5. **–ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã—Ö:**
```typescript
const [playingMessageId, setPlayingMessageId] = useState<string | null>(null);
const audioRef = useRef<HTMLAudioElement | null>(null);

const handlePlayVoice = (messageId: string, audioUrl: string) => {
  if (playingMessageId === messageId) {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ
    audioRef.current?.pause();
    setPlayingMessageId(null);
  } else {
    // –ò–≥—Ä–∞–µ–º –Ω–æ–≤–æ–µ
    audioRef.current?.pause();
    audioRef.current = new Audio(audioUrl);
    audioRef.current.play();
    setPlayingMessageId(messageId);
    
    audioRef.current.onended = () => {
      setPlayingMessageId(null);
    };
  }
};

// –í —Ä–µ–Ω–¥–µ—Ä–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:
{msg.type === 'voice' && (
  <Button
    size="sm"
    variant="ghost"
    onClick={() => handlePlayVoice(msg.id, msg.attachment_url)}
  >
    {playingMessageId === msg.id ? (
      <StopCircle className="w-4 h-4" />
    ) : (
      <Play className="w-4 h-4" />
    )}
  </Button>
)}
```

---

### **–®–ê–ì 4: Real-time –ø–æ–¥–ø–∏—Å–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)** ‚ö°

```typescript
useEffect(() => {
  if (!selectedChat) return;

  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  const subscription = supabase
    .channel(`chat:${selectedChat}`)
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'student_private_messages',
        filter: `chat_id=eq.${selectedChat}`,
      },
      (payload) => {
        const newMsg = transformMessage(payload.new);
        setMessages((prev) => [...prev, newMsg]);
      }
    )
    .subscribe();

  return () => {
    subscription.unsubscribe();
  };
}, [selectedChat]);
```

---

## üìù –ß–ï–ö–õ–ò–°–¢ –í–´–ü–û–õ–ù–ï–ù–ò–Ø

```
‚ñ° –°–æ–∑–¥–∞—Ç—å Storage bucket –≤ Supabase
‚ñ° –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ Storage
‚ñ° –°–æ–∑–¥–∞—Ç—å src/lib/messages-api.ts
‚ñ° –û–±–Ω–æ–≤–∏—Ç—å Messages.tsx:
  ‚ñ° –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤ –∏–∑ Supabase
  ‚ñ° –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Supabase
  ‚ñ° –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  ‚ñ° –†–µ–∞–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤—ã—Ö (MediaRecorder)
  ‚ñ° –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö –≤ Storage
  ‚ñ° –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã—Ö
  ‚ñ° Real-time –ø–æ–¥–ø–∏—Å–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
‚ñ° –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ localhost
‚ñ° –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
‚ñ° –î–µ–ø–ª–æ–π
```

---

## üöÄ –ü–†–ò–û–†–ò–¢–ï–¢:

**–í–´–°–û–ö–ò–ô** - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤

---

## ‚è±Ô∏è –û–¶–ï–ù–ö–ê –í–†–ï–ú–ï–ù–ò:

- Storage bucket: ~5 –º–∏–Ω—É—Ç
- messages-api.ts: ~15 –º–∏–Ω—É—Ç
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Messages.tsx: ~30 –º–∏–Ω—É—Ç
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ~10 –º–∏–Ω—É—Ç

**–ò–¢–û–ì–û:** ~60 –º–∏–Ω—É—Ç

---

**–ù–ê–ß–ò–ù–ê–ï–ú –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï! üöÄ**

