# ‚úÖ –í–°–ï –†–ê–ë–û–¢–ê–ï–¢! Production-Ready —Å–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞! üöÄ

## üéØ –ß–¢–û –ë–´–õ–û –°–î–ï–õ–ê–ù–û:

### 1. **–ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤**
- ‚úÖ `redis-amocrm.ts` - Redis —Ç–æ–ª—å–∫–æ –¥–ª—è AmoCRM BullMQ
- ‚úÖ `telegram-service.ts` - Telegram –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–∑–∞–≤–∏—Å–∏–º –æ—Ç Redis
- ‚úÖ Telegram –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ Supabase (Landing DB)

### 2. **–ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**
- ‚úÖ `server.ts` - Background tasks –≤ IIFE (–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç HTTP)
- ‚úÖ Redis –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å `setImmediate`
- ‚úÖ Telegram –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è
- ‚úÖ Strict retry limits (3 –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è Redis)

### 3. **–†–µ–∑—É–ª—å—Ç–∞—Ç**
- ‚úÖ **–õ–∏–¥—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ Telegram!** (08:24, 08:36, 08:51)
- ‚úÖ AmoCRM —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –°–µ—Ä–≤–µ—Ä –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Redis
- ‚úÖ Graceful degradation - —Å–µ—Ä–≤–∏—Å—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã

---

## üìÅ –ö–õ–Æ–ß–ï–í–´–ï –§–ê–ô–õ–´:

### **backend/src/config/redis-amocrm.ts** (—Ä–∞–Ω–µ–µ redis.ts)
- Redis –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –¥–ª—è AmoCRM
- 3 –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –ø–æ—Ç–æ–º –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–µ—Ä–≤–µ—Ä

### **backend/src/config/telegram-service.ts**
- Telegram bot –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
- Handlers –¥–ª—è `2134` –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
- –ü–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–∑–∞–≤–∏—Å–∏–º –æ—Ç Redis
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ Supabase

### **backend/src/server.ts**
- IIFE –¥–ª—è background tasks: `(async () => { ... })()`
- –ù–µ—Ç `await` –≤ `app.listen()` callback
- Graceful shutdown –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### **backend/src/routes/telegram-leads.ts**
- –ß–∏—Å—Ç—ã–µ endpoints
- `/health`, `/active-groups`, `/test`, `/send-lead`
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç `telegram-service.ts`

---

## üéØ –ö–ê–ö –≠–¢–û –†–ê–ë–û–¢–ê–ï–¢:

### **–ê–∫—Ç–∏–≤–∞—Ü–∏—è –≥—Ä—É–ø–ø—ã:**
1. –î–æ–±–∞–≤—å –±–æ—Ç–∞ `@leadonai_express_bot` –≤ –≥—Ä—É–ø–ø—É Telegram
2. –û—Ç–ø—Ä–∞–≤—å –∫–æ–¥: `2134`
3. –ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≥—Ä—É–ø–ø—É –≤ `telegram_groups` (Landing DB)
4. –í—Å–µ –ª–∏–¥—ã —Å proftest –∏ expresscourse –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ –≥—Ä—É–ø–ø—É! ‚úÖ

### **–û—Ç–ø—Ä–∞–≤–∫–∞ –ª–∏–¥–æ–≤:**
```bash
curl -X POST http://localhost:3000/api/landing/submit \
  -H "Content-Type: application/json" \
  -d '{
    "name": "–¢–µ—Å—Ç",
    "phone": "+7 777 123 45 67",
    "email": "test@onai.academy",
    "source": "expresscourse",
    "paymentMethod": "kaspi"
  }'
```

–õ–∏–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Landing DB (Supabase)
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ Telegram –≥—Ä—É–ø–ø—ã
3. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å AmoCRM (–µ—Å–ª–∏ Redis –¥–æ—Å—Ç—É–ø–µ–Ω)

---

## üõ°Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –°–ë–û–ï–í:

### **Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω?**
- ‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Telegram —Ä–∞–±–æ—Ç–∞–µ—Ç (–Ω–µ–∑–∞–≤–∏—Å–∏–º –æ—Ç Redis)
- ‚ùå AmoCRM sync –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

### **Telegram bot —É–ø–∞–ª?**
- ‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ AmoCRM —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚ùå –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã

### **Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω?**
- ‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚ö†Ô∏è –õ–∏–¥—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞)
- ‚ö†Ô∏è Telegram –∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

---

## üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì:

### **Health Check:**
```bash
curl http://localhost:3000/api/telegram-leads/health
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "status": {
    "telegram": {
      "running": true,
      "available": true,
      "uptime_seconds": 3600
    },
    "database": {
      "connected": true,
      "active_groups_count": 1
    }
  }
}
```

### **–ê–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã:**
```bash
curl http://localhost:3000/api/telegram-leads/active-groups
```

### **–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞:**
```bash
curl -X POST http://localhost:3000/api/telegram-leads/test \
  -H "Content-Type: application/json" \
  -d '{"name":"Test","phone":"+7 777 777 77 77"}'
```

---

## üéâ –°–¢–ê–¢–£–°: PRODUCTION READY!

- ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ Graceful degradation
- ‚úÖ Error handling
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ endpoints
- ‚úÖ –õ–∏–¥—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ Telegram

**–°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!** üöÄ

---

## üìù –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò:

### **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**
1. **IIFE –≤ server.ts** - —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç HTTP
2. **setImmediate** - –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π event loop tick
3. **Promise.race —Å timeout** - –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è Supabase
4. **lazyConnect –¥–ª—è Redis** - –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
5. **Polling mode –¥–ª—è Telegram** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç webhook/SSL

### **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Landing Supabase):**
- **telegram_groups** - –∞–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **landing_leads** - –≤—Å–µ –ª–∏–¥—ã —Å –ª–µ–Ω–¥–∏–Ω–≥–æ–≤
- **error_logs** - –ª–æ–≥–∏ –æ—à–∏–±–æ–∫ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### **Environment Variables:**
```env
TELEGRAM_LEADS_BOT_TOKEN=your_token
LANDING_SUPABASE_URL=https://xikaiavwqinamgolmtcy.supabase.co
LANDING_SUPABASE_SERVICE_KEY=your_key
REDIS_URL=redis://localhost:6379
```

---

**–ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É! –í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —á–∞—Å—ã!** ‚è∞‚úÖ






