-- ===============================================
-- üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ video_analytics
-- ===============================================
-- –í—ã–ø–æ–ª–Ω–∏ –≤ Supabase SQL Editor:
-- https://supabase.com/dashboard/project/arqhkacellqbhjhbebfh/sql

-- ===============================================
-- –ü–†–û–ë–õ–ï–ú–ê:
-- 1. video_id –æ–∂–∏–¥–∞–µ—Ç UUID, –∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç —á–∏—Å–ª–æ
-- 2. Schema cache –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è (progress_percent not found)
-- ===============================================

-- ===============================================
-- –†–ï–®–ï–ù–ò–ï 1: –£–¥–∞–ª–∏—Ç—å video_id (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)
-- ===============================================
-- –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ lesson_id, video_id –Ω–µ –Ω—É–∂–µ–Ω
ALTER TABLE video_analytics
DROP COLUMN IF EXISTS video_id;

-- ===============================================
-- –†–ï–®–ï–ù–ò–ï 2 (–ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ê): –°–¥–µ–ª–∞—Ç—å video_id nullable
-- ===============================================
-- –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –Ω–∞ –±—É–¥—É—â–µ–µ
-- ALTER TABLE video_analytics
-- ALTER COLUMN video_id DROP NOT NULL;

-- ===============================================
-- –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ê SCHEMA CACHE (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)
-- ===============================================
-- –ó–∞—Å—Ç–∞–≤–ª—è–µ—Ç PostgREST –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∞–±–ª–∏—Ü–µ
NOTIFY pgrst, 'reload schema';

-- ===============================================
-- –ü–†–û–í–ï–†–ö–ê: –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã
-- ===============================================
SELECT 
  column_name,
  data_type,
  is_nullable,
  column_default
FROM information_schema.columns
WHERE table_name = 'video_analytics'
ORDER BY ordinal_position;

-- ===============================================
-- –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:
-- ===============================================
-- column_name       | data_type | is_nullable | column_default
-- ------------------+-----------+-------------+---------------
-- id                | bigint    | NO          | nextval(...)
-- user_id           | uuid      | YES         | NULL
-- lesson_id         | bigint    | YES         | NULL
-- session_id        | text      | NO          | NULL
-- event_type        | text      | NO          | NULL
-- position_seconds  | numeric   | YES         | NULL
-- playback_rate     | numeric   | YES         | NULL
-- progress_percent  | numeric   | YES         | NULL
-- created_at        | timestamp | YES         | now()
-- 
-- ‚úÖ video_id –¥–æ–ª–∂–µ–Ω –û–¢–°–£–¢–°–¢–í–û–í–ê–¢–¨ –≤ —Å–ø–∏—Å–∫–µ!

-- ===============================================
-- –¢–ï–°–¢: –í—Å—Ç–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
-- ===============================================
-- INSERT INTO video_analytics (
--   user_id,
--   lesson_id,
--   session_id,
--   event_type,
--   position_seconds,
--   playback_rate,
--   progress_percent
-- ) VALUES (
--   NULL, -- user_id –º–æ–∂–µ—Ç –±—ã—Ç—å NULL
--   20, -- lesson_id
--   'test-session-' || gen_random_uuid()::text,
--   'play',
--   0,
--   1.0,
--   0
-- ) RETURNING *;

-- ===============================================
-- –û–ß–ò–°–¢–ö–ê: –£–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
-- ===============================================
-- DELETE FROM video_analytics WHERE session_id LIKE 'test-session-%';

-- ===============================================
-- ‚úÖ –ì–û–¢–û–í–û!
-- ===============================================
-- –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ SQL:
-- 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ backend: npm run dev
-- 2. –û—Ç–∫—Ä–æ–π —É—Ä–æ–∫ —Å –≤–∏–¥–µ–æ
-- 3. –ù–∞–∂–º–∏ Play
-- 4. –ü—Ä–æ–≤–µ—Ä—å Console - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 200 OK
-- 5. –ù–ï–¢ –æ—à–∏–±–æ–∫ "invalid input syntax for type uuid"
-- 6. –ù–ï–¢ –æ—à–∏–±–æ–∫ "Could not find the 'progress_percent' column"
-- ===============================================

