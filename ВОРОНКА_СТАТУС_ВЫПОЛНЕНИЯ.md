# üìä –°–¢–ê–¢–£–° –í–´–ü–û–õ–ù–ï–ù–ò–Ø: –í–û–†–û–ù–ö–ê AMOCRM + FACEBOOK

**–î–∞—Ç–∞:** 23 –¥–µ–∫–∞–±—Ä—è 2025, 18:15 Almaty  
**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:** üü° –í –ü–†–û–¶–ï–°–°–ï (6 –∏–∑ 10 –∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–µ–Ω–æ)

---

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û (6 –∑–∞–¥–∞—á):

### 1. ‚úÖ AmoCRM —Ç–æ–∫–µ–Ω –ø—Ä–æ–≤–µ—Ä–µ–Ω
- **–°—Ç–∞—Ç—É—Å:** –¢–æ–∫–µ–Ω –µ—Å—Ç—å –≤ `backend/env.env`
- **Expiry:** 2027-12-31 (permanent)
- **–ü—Ä–æ–±–ª–µ–º–∞ 403:** –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω

### 2. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î —Å–æ–∑–¥–∞–Ω—ã –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- **–§–∞–π–ª:** `supabase/migrations/20251223153719_add_sales_tables.sql`
- **–¢–∞–±–ª–∏—Ü—ã:**
  - `main_product_sales` (–¥–ª—è Integrator Flagman 490K)
  - `express_course_sales` (–¥–ª—è Express Course 5K)
- **–°—Ç–∞—Ç—É—Å:** –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ Landing DB (__________supabase)

### 3. ‚úÖ –í–µ–±—Ö—É–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- **Express Course:** `POST /api/amocrm/funnel-sale` (–û–ë–ù–û–í–õ–Å–ù)
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Landing DB ‚Üí `express_course_sales`
  - Deduplicate logic (5 min window)
  - –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 OK
  
- **Main Product:** `POST /webhook/amocrm/traffic` (–°–û–ó–î–ê–ù)
  - –§–∞–π–ª: `backend/src/routes/amocrm-main-product-webhook.ts`
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Landing DB ‚Üí `main_product_sales`
  - Deduplicate logic
  
- **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ server.ts:** ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã BEFORE express.json()

### 4. ‚úÖ funnel-service.ts –ø–µ—Ä–µ–ø–∏—Å–∞–Ω
- **–§–∞–π–ª:** `backend/src/services/funnel-service.ts`
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** 4 —ç—Ç–∞–ø–∞ (–≤–º–µ—Å—Ç–æ 3):
  1. üí∞ –ó–∞—Ç—Ä–∞—Ç—ã (Facebook Ads)
  2. üß™ ProfTest (–ª–∏–¥—ã)
  3. üìö Express Course (5K)
  4. üèÜ Integrator Flagman (490K)
- **Features:**
  - Team —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (`?team=kenesary`)
  - ROI —Å —É—á—ë—Ç–æ–º –æ–±–µ–∏—Ö –ø—Ä–æ–¥–∞–∂
  - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (5 –º–∏–Ω TTL)

### 5. ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞
- **Backend:** `GET /api/traffic-dashboard/funnel?team=kenesary`
- **Frontend:** `<ConversionFunnel teamFilter={teamName} />`
- **Integration:** –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –≤ `TrafficCabinetDashboard.tsx`

### 6. ‚úÖ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ Main Product ‚Üí Integrator Flagman
- `src/components/traffic/SalesFunnel.tsx` ‚úÖ
- `backend/src/services/funnel-service.ts` ‚úÖ
- `backend/src/integrations/traffic-webhook.ts` ‚úÖ

---

## üî¥ –¢–ï–ö–£–©–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:

### Express Course –ø—Ä–æ–¥–∞–∂–∏ –ù–ï –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è!

**–î–∞–Ω–Ω—ã–µ –≤ –ë–î (Landing DB):**
```sql
SELECT COUNT(*) FROM express_course_sales;
-- Result: 3 –∑–∞–ø–∏—Å–∏ (kenesary x2, traf4 x1)
```

**API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
```json
{
  "express_purchases": 0,
  "express_revenue": 0
}
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ó–∞–ø—Ä–æ—Å `getThirtyDaysAgo()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é –¥–∞—Ç—É!

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```typescript
function getThirtyDaysAgo(): string {
  const date = new Date();
  date.setDate(date.getDate() - 30);
  return date.toISOString().split('T')[0] + ' 00:00:00'; // YYYY-MM-DD 00:00:00
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `date.toISOString()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç UTC! –ù—É–∂–Ω–æ –ª–æ–∫–∞–ª—å–Ω—É—é –¥–∞—Ç—É –∏–ª–∏ —É–±—Ä–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä –Ω–∞ 30 –¥–Ω–µ–π –¥–ª—è —Ç–µ—Å—Ç–∞.

---

## ‚ö†Ô∏è –û–°–¢–ê–õ–û–°–¨ –°–î–ï–õ–ê–¢–¨ (4 –∑–∞–¥–∞—á–∏):

### 7. ‚ùå –ü–æ–¥—Ç—è–Ω—É—Ç—å –≤—Å–µ Facebook –∫–∞–±–∏–Ω–µ—Ç—ã
**–ó–∞–¥–∞—á–∞:** 
- –ó–∞–ø—Ä–æ—Å–∏—Ç—å `/me/businesses` –¥–ª—è –≤—Å–µ—Ö Business Managers
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ BM –∑–∞–ø—Ä–æ—Å–∏—Ç—å `/owned_ad_accounts`
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ –ë–î
- –°–æ–∑–¥–∞—Ç—å UI –≤ —Ä–∞–∑–¥–µ–ª–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°–†–ï–î–ù–ò–ô (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ –≤–æ—Ä–æ–Ω–∫–∏)

### 8. ‚ùå –î–æ–±–∞–≤–∏—Ç—å ad_name –≤ traffic_stats
**–ó–∞–¥–∞—á–∞:**
- –ú–∏–≥—Ä–∞—Ü–∏—è: `ALTER TABLE traffic_stats ADD COLUMN ad_name`
- –û–±–Ω–æ–≤–∏—Ç—å Facebook API sync –¥–ª—è –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –æ–±—ä—è–≤–ª–µ–Ω–∏–π
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ù–ò–ó–ö–ò–ô

### 9. ‚ùå Deploy –Ω–∞ production
**–ö–æ–º–∞–Ω–¥–∞:** `./deploy.sh`

**–ë–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫–∏:**
- –ù—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å Express Course –¥–∞–Ω–Ω—ã–º–∏

### 10. ‚ùå E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ø—Ä–æ–¥–∞–∂—É –≤ AmoCRM
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤–µ–±—Ö—É–∫ —Å—Ä–∞–±–æ—Ç–∞–ª
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø–æ–ø–∞–ª–∏ –≤ –ë–î
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤–æ—Ä–æ–Ω–∫–∞ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å

---

## üîß NEXT STEPS:

### 1. –ò–°–ü–†–ê–í–ò–¢–¨ getThirtyDaysAgo()

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ä–∞–≤–Ω–µ–Ω–∏–µ TIMESTAMP WITHOUT TZ —Å UTC –¥–∞—Ç–æ–π

**–†–µ—à–µ–Ω–∏–µ A:** –£–±—Ä–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ –¥–ª—è —Ç–µ—Å—Ç–∞:
```typescript
// –í funnel-service.ts
let query = landingSupabase
  .from('express_course_sales')
  .select('id, amount, utm_source, sale_date');
  // .gte('sale_date', getThirtyDaysAgo()); // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ò–¢–¨
```

**–†–µ—à–µ–Ω–∏–µ B:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é –¥–∞—Ç—É –±–µ–∑ timezone:
```typescript
function getThirtyDaysAgo(): string {
  const date = new Date();
  date.setDate(date.getDate() - 30);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day} 00:00:00`;
}
```

### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend

### 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localhost:8080)

### 5. Deploy –Ω–∞ production

---

## üìã –ß–ï–ö–õ–ò–°–¢ –ü–õ–ê–ù–ê:

- [x] –û–±–Ω–æ–≤–∏—Ç—å AmoCRM —Ç–æ–∫–µ–Ω –≤ env.env
- [x] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É main_product_sales
- [x] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É express_course_sales
- [ ] –°–æ–∑–¥–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ VIEW funnel_analytics (–û–¢–õ–û–ñ–ï–ù–û)
- [x] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–µ–±—Ö—É–∫ /webhook/amocrm/traffic
- [x] –û–±–Ω–æ–≤–∏—Ç—å –≤–µ–±—Ö—É–∫ /api/amocrm/funnel-sale
- [x] –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å funnel-service.ts –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [x] –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä ?team=kenesary –≤ API
- [x] –ü–æ–¥–∫–ª—é—á–∏—Ç—å teamFilter –≤ ConversionFunnel.tsx
- [x] –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å "Main Product" ‚Üí "Integrator Flagman"
- [ ] –ü–æ–¥—Ç—è–Ω—É—Ç—å –≤—Å–µ Business Managers –∏ Ad Accounts
- [ ] –î–æ–±–∞–≤–∏—Ç—å ad_name –≤ traffic_stats
- [ ] –°–æ–∑–¥–∞—Ç—å UI –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Facebook –∫–∞–±–∏–Ω–µ—Ç–æ–≤
- [x] –û–±–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ä–º—É–ª—É ROI —Å —É—á–µ—Ç–æ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–¥–∞–∂–∏
- [ ] –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ production
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–µ–±—Ö—É–∫–∏ –∏ –≤–æ—Ä–æ–Ω–∫—É

**–ü—Ä–æ–≥—Ä–µ—Å—Å:** 9/16 (56%)

---

## üêõ –ò–ó–í–ï–°–¢–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:

1. **Backend –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–∞–¥–∞–µ—Ç –∏–∑-–∑–∞ Redis**
   - Redis –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ –ª–æ–∫–∞–ª–∫–µ
   - –ù—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å Redis –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
   - –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Redis: `brew install redis && brew services start redis`

2. **Express Course –ø—Ä–æ–¥–∞–∂–∏ = 0**
   - –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –¥–∞—Ç–µ
   - –ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å getThirtyDaysAgo()

3. **Frontend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ä—ã–π –¥–∏–∑–∞–π–Ω –≤–æ—Ä–æ–Ω–∫–∏**
   - –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–µ–Ω hard refresh (Cmd+Shift+R)
   - –ò–ª–∏ Vite HMR –Ω–µ –æ–±–Ω–æ–≤–∏–ª –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

---

## üíª –ö–û–ú–ê–ù–î–´ –î–õ–Ø –ü–†–û–î–û–õ–ñ–ï–ù–ò–Ø:

```bash
# 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å funnel-service.ts (—É–±—Ä–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä –¥–∞—Ç—ã)

# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend
pkill -f 'tsx'
cd /Users/miso/onai-integrator-login/backend && npm run dev

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API
curl http://localhost:3000/api/traffic-dashboard/funnel | jq '.stages[] | {id, purchases: (.metrics.express_purchases // .metrics.main_purchases // 0)}'

# 4. –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
# http://localhost:8080/traffic/cabinet/kenesary
# Hard Refresh: Cmd + Shift + R

# 5. Deploy –Ω–∞ production (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–æ)
./deploy.sh
```

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 23.12.2025 18:15:52
