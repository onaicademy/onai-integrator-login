# 🎯 ПРАВИЛЬНАЯ АРХИТЕКТУРА ВОРОНКИ

**Дата:** 23 декабря 2025, 20:25 Almaty  
**Статус:** ✅ НАЙДЕНЫ 77 СТУДЕНТОВ!

---

## ❌ НЕПРАВИЛЬНОЕ ПОНИМАНИЕ (было):

```
ProfTest (454) → Express Course (177) → Main Product (0)
```

**Проблема:** 177 - это НЕ покупки Express Course!

---

## ✅ ПРАВИЛЬНОЕ ПОНИМАНИЕ (сейчас):

### Воронка имеет 4 этапа:

```
1️⃣ Facebook Ads (Затраты)
   ↓
2️⃣ ProfTest Leads (454)
   ↓
3️⃣ Напрямую с сайта (177) - лиды БЕЗ UTM
   ↓
4️⃣ Express Course 5K (77) - реальные студенты из Tripwire DB
   ↓
5️⃣ Integrator Flagman 490K (0) - основной продукт
```

---

## 📊 ОТКУДА ДАННЫЕ

### 1. ProfTest Leads: 454
**Источник:** `Landing DB → landing_leads`
```sql
SELECT COUNT(*) 
FROM landing_leads 
WHERE source LIKE 'proftest%';
-- Результат: 454
```

### 2. Напрямую с сайта: 177
**Источник:** `Landing DB → landing_leads`
```sql
SELECT COUNT(*) 
FROM landing_leads 
WHERE source = 'expresscourse';
-- Результат: 177
-- ⚠️ НЕТ UTM! metadata->>'utm_source' = NULL
```

**Что это значит:**
- Люди пришли напрямую на сайт (без рекламы)
- Могут быть из:
  - Прямого поиска
  - Сохраненных закладок
  - Email/SMS без UTM
  - Сарафанного радио

### 3. Express Course (5K): **77 студентов**
**Источник:** `Tripwire DB → tripwire_user_profile`
```sql
-- Всего profiles: 80
-- Минус админы/sales: 3
-- Реальные студенты: 77 ✅
SELECT COUNT(*) 
FROM tripwire_user_profile tup
WHERE tup.user_id NOT IN (
  SELECT user_id FROM tripwire_users 
  WHERE email IN ('smmmcwin@gmail.com', 'rakhat@onaiacademy.kz', ...)
);
```

**Что это значит:**
- 77 человек КУПИЛИ Express Course за 5,000 KZT
- Зарегистрировались на платформе
- Получили доступ к урокам
- Это РЕАЛЬНЫЕ покупки! 🔥

### 4. Integrator Flagman (490K): 0
**Источник:** `Landing DB → main_product_sales`
```sql
SELECT COUNT(*) FROM main_product_sales;
-- Результат: 0 (ждем первую покупку через AmoCRM webhook)
```

---

## 🔄 КОНВЕРСИИ (Правильные)

### Конверсия #1: ProfTest → Напрямую
```
454 лидов → 177 перешли напрямую
Конверсия: 177 / 454 = 38.99% ✅
```

### Конверсия #2: Напрямую → Express 5K
```
177 лидов → 77 купили Express
Конверсия: 77 / 177 = 43.50% 🔥
```

### Конверсия #3: Express → Integrator Flagman
```
77 студентов → 0 купили основной
Конверсия: 0% (ждем первую покупку)
```

---

## 🎨 КАК ОТОБРАЖАТЬ В ИНТЕРФЕЙСЕ

### Старое (неправильно):
```
[ProfTest] → [Express Course] → [Main Product]
    454          177                  0
```

### Новое (правильно):
```
[$$$] → [ProfTest] → [Напрямую] → [Express 5K] → [Flagman 490K]
  ?        454          177           77              0
          
Конверсии:
- Ads → ProfTest: ? (нужны данные о затратах)
- ProfTest → Напрямую: 39%
- Напрямую → Express: 43.5% 🔥
- Express → Flagman: 0%
```

---

## 🛠️ ЧТО НУЖНО ИСПРАВИТЬ

### 1. Переименовать "Express Course" → "Напрямую с сайта"
**Файлы:**
- `backend/src/services/funnel-service.ts` (строка 209-217)
- `src/pages/traffic/TrafficDashboard.tsx` (визуальные названия)
- `backend/src/routes/lead-tracking.ts` (админ панель)

**Было:**
```typescript
console.log('[Funnel] PRODUCTION: Reading from landing_leads table (source=expresscourse)');
```

**Станет:**
```typescript
console.log('[Funnel] Fetching direct leads (no UTM) from landing_leads');
```

### 2. Добавить новый этап "Express Course 5K"
**Откуда брать:** Tripwire DB → `tripwire_user_profile`

**Новая функция:**
```typescript
async function getExpressCourseRealStudents(teamFilter?: string) {
  // 1. Получить исключенных пользователей (admin/sales)
  const { data: excludedUsers } = await tripwireSupabase
    .from('tripwire_users')
    .select('user_id')
    .in('email', EXCLUDED_EMAILS);
  
  // 2. Получить реальных студентов
  let query = tripwireSupabase
    .from('tripwire_user_profile')
    .select('user_id, modules_completed, total_modules');
  
  if (excludedUserIds.length > 0) {
    query = query.not('user_id', 'in', `(${excludedUserIds.join(',')})`);
  }
  
  const { data: students } = await query;
  
  return {
    express_students: students.length, // 77
    express_revenue: students.length * 5000, // 385,000 KZT
    active_students: students.filter(s => s.modules_completed < s.total_modules).length,
    completed_students: students.filter(s => s.modules_completed >= s.total_modules).length
  };
}
```

### 3. Пересчитать воронку
**Новая структура:**
```typescript
{
  "stages": [
    {
      "id": "ads",
      "name": "Facebook Ads",
      "metrics": {
        "spend_usd": 0, // ждем Facebook API
        "impressions": 0,
        "clicks": 0
      }
    },
    {
      "id": "proftest",
      "name": "ProfTest",
      "metrics": {
        "proftest_leads": 454
      },
      "conversionRate": 0 // spend → leads (ждем данные)
    },
    {
      "id": "direct",
      "name": "Напрямую с сайта",
      "metrics": {
        "direct_leads": 177
      },
      "conversionRate": 38.99 // proftest → direct
    },
    {
      "id": "express_5k",
      "name": "Express Course (5,000₸)",
      "metrics": {
        "express_students": 77,
        "express_revenue": 385000
      },
      "conversionRate": 43.50 // direct → express
    },
    {
      "id": "flagman_490k",
      "name": "Integrator Flagman (490,000₸)",
      "metrics": {
        "main_purchases": 0,
        "main_revenue": 0
      },
      "conversionRate": 0 // express → main
    }
  ],
  "totalRevenue": 385000,
  "roi": 0 // ждем данные о затратах
}
```

---

## 🚨 ВАЖНО: ФИЛЬТРАЦИЯ ПО КОМАНДАМ

### Проблема:
177 лидов "Напрямую" НЕ ИМЕЮТ UTM!
```sql
SELECT metadata->>'utm_source' FROM landing_leads WHERE source='expresscourse';
-- Результат: NULL
```

### Решение:
При фильтрации `?team=kenesary`:
- ProfTest: фильтруем по UTM ✅
- Напрямую: **НЕ фильтруем** (нет UTM) ⚠️
- Express 5K: фильтруем по email/phone через JOIN с ProfTest ✅

**Логика:**
```typescript
// Получить emails лидов команды kenesary из ProfTest
const teamLeads = await landingSupabase
  .from('landing_leads')
  .select('email, phone')
  .like('source', 'proftest%')
  .filter(lead => teamFilter logic);

// Найти студентов Express по этим emails
const teamStudents = await tripwireSupabase
  .from('tripwire_users')
  .select('user_id, email')
  .in('email', teamLeads.map(l => l.email));
```

---

## ✅ ИТОГО: ПРАВИЛЬНАЯ ВОРОНКА

```
💰 Затраты: $0 (ждем FB API)
    ↓ 0% (нет данных)
🧪 ProfTest: 454 лида
    ↓ 38.99%
🌐 Напрямую: 177 (без UTM)
    ↓ 43.50% 🔥
📚 Express 5K: 77 студентов (385K KZT)
    ↓ 0%
🚀 Flagman 490K: 0 покупок (0 KZT)

Общая выручка: 385,000 KZT
ROI: 0% (ждем данные о затратах)
```

**77 студентов - это РЕАЛЬНО!** 🎉
