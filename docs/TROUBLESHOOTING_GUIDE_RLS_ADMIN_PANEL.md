# üîß –ì–∞–π–¥: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–ø–∞–¥–∞—é—â–µ–π –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å—é

**–î–∞—Ç–∞:** 8 –Ω–æ—è–±—Ä—è 2025  
**–ü—Ä–æ–µ–∫—Ç:** OnAI Academy Platform  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø—Ä–æ–ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–°–∏–º–ø—Ç–æ–º—ã –ø—Ä–æ–±–ª–µ–º—ã](#—Å–∏–º–ø—Ç–æ–º—ã-–ø—Ä–æ–±–ª–µ–º—ã)
2. [–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞](#–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)
3. [–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞](#–∫–æ—Ä–Ω–µ–≤–∞—è-–ø—Ä–∏—á–∏–Ω–∞)
4. [–†–µ—à–µ–Ω–∏–µ](#—Ä–µ—à–µ–Ω–∏–µ)
5. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
6. [–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –¥–ª—è –±—É–¥—É—â–∏—Ö –ø—Ä–æ–±–ª–µ–º](#–º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è-–¥–ª—è-–±—É–¥—É—â–∏—Ö-–ø—Ä–æ–±–ª–µ–º)

---

## üö® –°–∏–º–ø—Ç–æ–º—ã –ø—Ä–æ–±–ª–µ–º—ã

### –ß—Ç–æ –Ω–∞–±–ª—é–¥–∞–ª–æ—Å—å:

1. ‚úÖ **–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ** - –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ
2. ‚ùå **–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (F5)** - –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø—Ä–æ–ø–∞–¥–∞–µ—Ç –∏–∑ –º–µ–Ω—é
3. ‚ùå **–ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Ç–∫—Ä—ã—Ç—å `/admin` –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
4. ‚ùå **–†–∞–∑–¥–µ–ª "–£—á–µ–Ω–∏–∫–∏"** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤"
5. ‚ö†Ô∏è **–ù–µ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ** - –∏–Ω–æ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∞–¥–º–∏–Ω –¥–∞—à–±–æ—Ä–¥, –∏–Ω–æ–≥–¥–∞ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–µ –º–µ–Ω—é

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã:

- Logout –Ω–µ —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–ª–∏—Å—å –≤ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" –∏ "–ü—Ä–æ—Ñ–∏–ª—å"
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ —Å–∞–π—Ç "–∫—Ä–∞—à–∏–ª—Å—è"

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –®–ê–ì 1: –ê–Ω–∞–ª–∏–∑ –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö –ª–æ–≥–æ–≤

**–ì–¥–µ —Å–º–æ—Ç—Ä–µ—Ç—å:** Developer Console (F12) ‚Üí Console Tab

**–ß—Ç–æ –∏—Å–∫–∞–ª–∏:**
```javascript
‚ùå –û—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚ùå Failed requests
‚ùå –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Ü–∏–∫–ª—ã
```

**–ß—Ç–æ –Ω–∞—à–ª–∏:**
```
‚ö†Ô∏è –†–æ–ª—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–∞–∫ "student" –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
‚ö†Ô∏è –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ auth.getUser()
```

### –®–ê–ì 2: –ê–Ω–∞–ª–∏–∑ Supabase Logs

**–ì–¥–µ —Å–º–æ—Ç—Ä–µ—Ç—å:**
```
https://supabase.com/dashboard/project/[PROJECT_ID]/logs/edge-logs
```

**–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª–∏ CSV –ª–æ–≥–∏** –∑–∞ –ø–µ—Ä–∏–æ–¥ –ø—Ä–æ–±–ª–µ–º—ã (7-8 –Ω–æ—è–±—Ä—è)

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Ö–æ–¥–∫–∞:**
```csv
GET | 500 | /rest/v1/profiles?select=*&order=created_at.desc
GET | 500 | /rest/v1/profiles?select=role&id=eq.1d063207...
```

**‚ùå –ü–†–û–ë–õ–ï–ú–ê:** –¢–∞–±–ª–∏—Ü–∞ `profiles` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **500 Internal Server Error**

### –®–ê–ì 3: –ê–Ω–∞–ª–∏–∑ RLS –ø–æ–ª–∏—Ç–∏–∫

**–ó–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**
```sql
SELECT * FROM pg_policies WHERE tablename = 'profiles';
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
```sql
-- –°—Ç–∞—Ä–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ (–†–ï–ö–£–†–°–ò–í–ù–ê–Ø!)
CREATE POLICY "Admin can view all profiles"
  ON profiles FOR SELECT
  USING (
    (SELECT role FROM profiles WHERE id = auth.uid()) = 'admin'
    -- ‚ò†Ô∏è –†–ï–ö–£–†–°–ò–Ø: profiles –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–∞–º —Å–µ–±—è!
  );
```

### –®–ê–ì 4: –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ flow –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π flow:**
```
1. User –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É /admin
2. AdminGuard ‚Üí supabase.auth.getUser() ‚úÖ
3. MainLayout ‚Üí supabase.auth.getUser() ‚úÖ (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ!)
4. MainLayout ‚Üí supabase.from('profiles').select('role') ‚ùå (500 error!)
5. MainLayout —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–æ–ª—å = "student" (fallback)
6. AppSidebar —Å–∫—Ä—ã–≤–∞–µ—Ç "–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å" –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
7. AdminGuard –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ /courses
```

---

## üí° –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

### –î–≤–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

#### 1. **–ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —Ä–µ–∫—É—Ä—Å–∏—è –≤ RLS –ø–æ–ª–∏—Ç–∏–∫–∞—Ö**

**–ü—Ä–∏—á–∏–Ω–∞:**
- RLS –ø–æ–ª–∏—Ç–∏–∫–∞ –Ω–∞ `profiles` –ø—Ä–æ–≤–µ—Ä—è–ª–∞ —Ä–æ–ª—å, –∑–∞–ø—Ä–∞—à–∏–≤–∞—è —Å–∞–º—É —Ç–∞–±–ª–∏—Ü—É `profiles`
- PostgreSQL –≤—Ö–æ–¥–∏–ª –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- –ó–∞–ø—Ä–æ—Å—ã –∫ `profiles` –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ **500 Internal Server Error**

**–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ –∫–æ–¥–∞:**
```sql
-- ‚ùå –ü–õ–û–•–û: –†–µ–∫—É—Ä—Å–∏—è
CREATE POLICY "Check role from profiles"
  ON profiles FOR SELECT
  USING (
    (SELECT role FROM profiles WHERE id = auth.uid()) = 'admin'
    -- profiles ‚Üí profiles ‚Üí profiles ‚Üí ...
  );
```

#### 2. **Race condition –∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ auth –∑–∞–ø—Ä–æ—Å–æ–≤**

**–ü—Ä–∏—á–∏–Ω–∞:**
- `AdminGuard` –∏ `MainLayout` –æ–±–∞ –¥–µ–ª–∞–ª–∏ `supabase.auth.getUser()` –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –ö–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã - **4-6 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Supabase**
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–õ–æ–≥ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:**
```
GET /auth/v1/user (AdminGuard)
GET /auth/v1/user (MainLayout)
GET /rest/v1/profiles?select=role (MainLayout) ‚Üí 500 error
GET /auth/v1/user (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏)
```

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ù–æ–≤—ã–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (–ë–ï–ó —Ä–µ–∫—É—Ä—Å–∏–∏)

**–§–∞–π–ª:** `supabase/migrations/20251108_CLEAN_AND_FIX_RLS.sql`

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

```sql
-- 1. –£–¥–∞–ª—è–µ–º –í–°–ï —Å—Ç–∞—Ä—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏
DO $$ 
DECLARE
    pol RECORD;
BEGIN
    FOR pol IN 
        SELECT policyname FROM pg_policies WHERE tablename = 'profiles'
    LOOP
        EXECUTE format('DROP POLICY IF EXISTS %I ON profiles', pol.policyname);
    END LOOP;
END $$;

-- 2. –°–æ–∑–¥–∞—ë–º –ë–ï–ó–û–ü–ê–°–ù–£–Æ —Ñ—É–Ω–∫—Ü–∏—é is_admin
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS boolean AS $$
BEGIN
  RETURN (
    SELECT email FROM auth.users  -- ‚úÖ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º auth.users (–ù–ï profiles!)
    WHERE id = auth.uid()
  ) = 'saint@onaiacademy.kz';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER STABLE;  -- STABLE = –∫–µ—à–∏—Ä—É–µ—Ç—Å—è!

-- 3. –ü—Ä–æ—Å—Ç—ã–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏
CREATE POLICY "Anyone can view profiles"
  ON profiles FOR SELECT
  USING (true);  -- ‚úÖ –í—Å–µ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å (–¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è)

CREATE POLICY "Admin can update all profiles"
  ON profiles FOR UPDATE
  USING (public.is_admin());  -- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é (–ë–ï–ó —Ä–µ–∫—É—Ä—Å–∏–∏)
```

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `is_admin()` –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç `auth.users` (–ù–ï `profiles`)
- ‚úÖ `STABLE` –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ –ù–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: sessionStorage –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏

**–§–∞–π–ª—ã:**
- `src/components/layouts/MainLayout.tsx`
- `src/components/AdminGuard.tsx`
- `src/pages/Login.tsx`
- `src/pages/ProfileSettings.tsx`

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

#### MainLayout.tsx
```typescript
async function loadUserRole() {
  // ‚úÖ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ü—Ä–æ–≤–µ—Ä—è–µ–º sessionStorage —Å–Ω–∞—á–∞–ª–∞
  const cachedRole = sessionStorage.getItem('user_role');
  const cachedEmail = sessionStorage.getItem('user_email');
  
  if (cachedRole && cachedEmail) {
    console.log('‚úÖ MainLayout: –†–æ–ª—å –∏–∑ –∫–µ—à–∞:', cachedRole);
    setUserRole(cachedRole as "admin" | "student");
    setIsLoading(false);
    return;  // ‚úÖ –í—ã—Ö–æ–¥–∏–º –ë–ï–ó –∑–∞–ø—Ä–æ—Å–∞ –∫ Supabase!
  }

  // –ï—Å–ª–∏ –Ω–µ—Ç –∫–µ—à–∞ - –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å
  const { data: { user } } = await supabase.auth.getUser();
  
  const role = user.email === 'saint@onaiacademy.kz' ? 'admin' : 'student';
  
  // ‚úÖ –ö–µ—à–∏—Ä—É–µ–º –Ω–∞ –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏
  sessionStorage.setItem('user_role', role);
  sessionStorage.setItem('user_email', user.email || '');
  
  setUserRole(role);
}
```

#### AdminGuard.tsx
```typescript
async function checkAdmin() {
  // ‚úÖ –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ü—Ä–æ–≤–µ—Ä—è–µ–º sessionStorage —Å–Ω–∞—á–∞–ª–∞
  const cachedRole = sessionStorage.getItem('user_role');
  const cachedEmail = sessionStorage.getItem('user_email');
  
  if (cachedRole === 'admin' && cachedEmail === 'saint@onaiacademy.kz') {
    console.log('‚úÖ AdminGuard: –†–æ–ª—å –∏–∑ –∫–µ—à–∞ - admin');
    setIsAdmin(true);
    setIsLoading(false);
    return;  // ‚úÖ –ù–µ—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ Supabase!
  }

  // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –∫–µ—à–∞ - –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å
  const { data: { user } } = await supabase.auth.getUser();
  const userIsAdmin = user?.email === 'saint@onaiacademy.kz';
  
  if (userIsAdmin) {
    sessionStorage.setItem('user_role', 'admin');
    sessionStorage.setItem('user_email', user.email);
    setIsAdmin(true);
  }
}
```

#### Login.tsx (–æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –ø—Ä–∏ –Ω–æ–≤–æ–º –≤—Ö–æ–¥–µ)
```typescript
if (data.user) {
  // ‚úÖ –í–ê–ñ–ù–û: –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π –∫–µ—à –ø—Ä–∏ –Ω–æ–≤–æ–º –≤—Ö–æ–¥–µ
  sessionStorage.clear();
  
  toast({ title: '‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!' });
  navigate(from, { replace: true });
}
```

#### ProfileSettings.tsx (–æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ)
```typescript
const handleLogout = async () => {
  const { error } = await supabase.auth.signOut();
  if (error) throw error;

  // ‚úÖ –í–ê–ñ–ù–û: –û—á–∏—â–∞–µ–º –∫–µ—à –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
  console.log('üëã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
  sessionStorage.clear();

  navigate("/login", { replace: true });
};
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ - 1 –∑–∞–ø—Ä–æ—Å –∫ Supabase
- ‚úÖ –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã - 0 –∑–∞–ø—Ä–æ—Å–æ–≤ (–±–µ—Ä—ë—Ç—Å—è –∏–∑ –∫–µ—à–∞)
- ‚úÖ –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ - –∫–µ—à –æ—á–∏—â–∞–µ—Ç—Å—è
- ‚úÖ –ü—Ä–∏ –Ω–æ–≤–æ–º –≤—Ö–æ–¥–µ - –∫–µ—à –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç—Å—è

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: Localhost

**–ö–æ–º–∞–Ω–¥—ã:**
```bash
# 1. –°–æ–∑–¥–∞—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è HTTPS
mkdir -p ssl
openssl req -x509 -newkey rsa:2048 -keyout ssl/key.pem -out ssl/cert.pem -days 365 -nodes

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å dev server
npm run dev

# 3. –û—Ç–∫—Ä—ã—Ç—å https://localhost:8080
```

**–ß–µ–∫-–ª–∏—Å—Ç:**
- ‚úÖ –í—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- ‚úÖ –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ (F5) - –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ù–ï –ø—Ä–æ–ø–∞–¥–∞–µ—Ç
- ‚úÖ –†–∞–∑–¥–µ–ª "–£—á–µ–Ω–∏–∫–∏" –∑–∞–≥—Ä—É–∂–∞–µ—Ç 12 —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
- ‚úÖ Logout —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –í Console –ù–ï–¢ 500 –æ—à–∏–±–æ–∫

### –¢–µ—Å—Ç 2: Production (Digital Ocean)

**–ö–æ–º–∞–Ω–¥—ã:**
```bash
# –î–µ–ø–ª–æ–π
git add -A
git commit -m "fix: –§–ò–ù–ê–õ–¨–ù–û–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RLS + sessionStorage"
git push origin main
./deploy.sh
```

**–ß–µ–∫-–ª–∏—Å—Ç:**
- ‚úÖ –í—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ https://onai.academy
- ‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Å—Ç–∞–±–∏–ª—å–Ω–∞
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (F5) x10 —Ä–∞–∑ - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –°—Ç—É–¥–µ–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
- ‚úÖ Logout ‚Üí Login ‚Üí –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç

### –¢–µ—Å—Ç 3: Console –ø—Ä–æ–≤–µ—Ä–∫–∞

**–û—Ç–∫—Ä—ã—Ç—å Console (F12):**

**‚úÖ –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
‚úÖ MainLayout: –†–æ–ª—å –∏–∑ –∫–µ—à–∞: admin
‚úÖ AdminGuard: –†–æ–ª—å –∏–∑ –∫–µ—à–∞ - admin
‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: 12
```

**‚ùå –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```
‚ùå 500 error –Ω–∞ /rest/v1/profiles
‚ùå infinite recursion detected
‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
```

---

## üìö –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –¥–ª—è –±—É–¥—É—â–∏—Ö –ø—Ä–æ–±–ª–µ–º

### 1Ô∏è‚É£ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê (–≤ —ç—Ç–æ–º –ø–æ—Ä—è–¥–∫–µ!)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. –ë—Ä–∞—É–∑–µ—Ä–Ω—ã–µ –ª–æ–≥–∏ (Console)       ‚îÇ
‚îÇ    - –û—à–∏–±–∫–∏ JS                      ‚îÇ
‚îÇ    - Failed requests                ‚îÇ
‚îÇ    - Warnings                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. Supabase Edge Logs               ‚îÇ
‚îÇ    - Status codes (500, 403, 401)   ‚îÇ
‚îÇ    - Request paths                  ‚îÇ
‚îÇ    - Error messages                 ‚îÇ
‚îÇ    - –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å CSV –∑–∞ –ø–µ—Ä–∏–æ–¥   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. Database (RLS + Policies)        ‚îÇ
‚îÇ    SELECT * FROM pg_policies        ‚îÇ
‚îÇ    WHERE tablename = 'TABLE_NAME';  ‚îÇ
‚îÇ    - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∫—É—Ä—Å–∏—é             ‚îÇ
‚îÇ    - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å permissions          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. Frontend Code                    ‚îÇ
‚îÇ    - useEffect dependencies         ‚îÇ
‚îÇ    - Auth state management          ‚îÇ
‚îÇ    - Race conditions                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2Ô∏è‚É£ –ì–î–ï –ò–°–ö–ê–¢–¨ –ü–†–û–ë–õ–ï–ú–´

#### Supabase –ø—Ä–æ–±–ª–µ–º—ã (90% —Å–ª—É—á–∞–µ–≤):

**‚úÖ –í–°–ï–ì–î–ê –ø—Ä–æ–≤–µ—Ä—è–π —Å–Ω–∞—á–∞–ª–∞:**
1. **Edge Logs** - –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ HTTP –æ—à–∏–±–∫–∏
2. **RLS Policies** - —á–∞—Å—Ç–æ –ø—Ä–∏—á–∏–Ω–∞ 500/403 –æ—à–∏–±–æ–∫
3. **Database triggers** - –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏—é
4. **Auth settings** - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ JWT –∏–ª–∏ roles

**–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏
SELECT tablename, policyname, cmd, qual 
FROM pg_policies 
ORDER BY tablename;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å triggers
SELECT * FROM pg_trigger 
WHERE tgrelid = 'profiles'::regclass;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏
SELECT proname, prosrc 
FROM pg_proc 
WHERE proname LIKE '%admin%';
```

#### Frontend –ø—Ä–æ–±–ª–µ–º—ã (10% —Å–ª—É—á–∞–µ–≤):

**–ü—Ä–æ–≤–µ—Ä—å:**
1. `useEffect` —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
2. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ auth listeners
3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
4. Race conditions –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

### 3Ô∏è‚É£ BEST PRACTICES –¥–ª—è Supabase + React

#### RLS Policies:

```sql
-- ‚úÖ –•–û–†–û–®–û: –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
CREATE POLICY "Users view own data"
  ON table_name FOR SELECT
  USING (auth.uid() = user_id);

-- ‚úÖ –•–û–†–û–®–û: –§—É–Ω–∫—Ü–∏—è —Å STABLE (–∫–µ—à–∏—Ä—É–µ—Ç—Å—è)
CREATE FUNCTION is_admin() RETURNS boolean AS $$
BEGIN
  RETURN (SELECT email FROM auth.users WHERE id = auth.uid()) = 'admin@example.com';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER STABLE;

-- ‚ùå –ü–õ–û–•–û: –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å
CREATE POLICY "Bad policy"
  ON profiles FOR SELECT
  USING (
    (SELECT role FROM profiles WHERE id = auth.uid()) = 'admin'
    -- ‚ò†Ô∏è profiles –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç profiles!
  );

-- ‚ùå –ü–õ–û–•–û: –°–ª–æ–∂–Ω—ã–π JOIN –≤ –ø–æ–ª–∏—Ç–∏–∫–µ
CREATE POLICY "Bad join policy"
  ON table_a FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM table_b 
      JOIN table_c ON ...
      WHERE ...
    )
    -- ‚ò†Ô∏è –ú–µ–¥–ª–µ–Ω–Ω–æ –∏ –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–Ω—É—Ç—å
  );
```

#### React Auth State:

```typescript
// ‚úÖ –•–û–†–û–®–û: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–∏
const cachedRole = sessionStorage.getItem('user_role');
if (cachedRole) {
  return cachedRole; // –ù–µ—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ Supabase
}

// ‚úÖ –•–û–†–û–®–û: –û–¥–∏–Ω useEffect —Å –∑–∞—â–∏—Ç–æ–π
useEffect(() => {
  let isMounted = true;
  let roleChecked = false;

  async function load() {
    if (roleChecked) return; // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
    roleChecked = true;
    
    const role = await fetchRole();
    if (isMounted) setRole(role);
  }

  load();
  return () => { isMounted = false; };
}, []); // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ = –û–î–ò–ù –†–ê–ó

// ‚ùå –ü–õ–û–•–û: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
useEffect(() => {
  supabase.auth.getUser(); // –ó–∞–ø—Ä–æ—Å 1
}, []);

useEffect(() => {
  supabase.auth.getUser(); // –ó–∞–ø—Ä–æ—Å 2 (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ!)
}, []);
```

### 4Ô∏è‚É£ –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

#### Browser DevTools:
```
F12 ‚Üí Console: –õ–æ–≥–∏ –∏ –æ—à–∏–±–∫–∏
F12 ‚Üí Network: HTTP –∑–∞–ø—Ä–æ—Å—ã (—Ñ–∏–ª—å—Ç—Ä: fetch/xhr)
F12 ‚Üí Application ‚Üí Session Storage: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–µ—à
```

#### Supabase Dashboard:
```
Logs ‚Üí Edge Logs: HTTP —Å—Ç–∞—Ç—É—Å –∫–æ–¥—ã
Database ‚Üí Tables: –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
Database ‚Üí Policies: RLS –ø–æ–ª–∏—Ç–∏–∫–∏
SQL Editor: –ó–∞–ø—Ä–æ—Å—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
```

#### Terminal:
```bash
# –õ–æ–≥–∏ production —Å–µ—Ä–≤–µ—Ä–∞ (–µ—Å–ª–∏ PM2)
ssh user@server
pm2 logs onai-app

# –õ–æ–≥–∏ Vite dev server
npm run dev 2>&1 | tee dev.log
```

---

## üìÅ –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π

### SQL –ú–∏–≥—Ä–∞—Ü–∏–∏:
- `supabase/migrations/20251108_FINAL_FIX_profiles_sync_and_secure_rls.sql`
- `supabase/migrations/20251108_CLEAN_AND_FIX_RLS.sql`

### Frontend:
- `src/components/layouts/MainLayout.tsx` - sessionStorage –∫–µ—à
- `src/components/AdminGuard.tsx` - sessionStorage –∫–µ—à
- `src/pages/Login.tsx` - –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ
- `src/pages/ProfileSettings.tsx` - –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ

---

## üéØ –ò—Ç–æ–≥–∏

### –ß—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ:

1. ‚úÖ **–ê–Ω–∞–ª–∏–∑ Supabase Edge Logs** - –Ω–∞—à–ª–∏ 500 –æ—à–∏–±–∫–∏
2. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RLS –ø–æ–ª–∏—Ç–∏–∫** - —É–±—Ä–∞–ª–∏ —Ä–µ–∫—É—Ä—Å–∏—é
3. ‚úÖ **sessionStorage –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - —É–±—Ä–∞–ª–∏ race conditions
4. ‚úÖ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ localhost** - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ –¥–µ–ø–ª–æ—è

### –ö–ª—é—á–µ–≤—ã–µ —É—Ä–æ–∫–∏:

- üîç **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π Supabase Logs –ü–ï–†–í–´–ú–ò** –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –ë–î
- üíæ **–ö–µ—à–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ** –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è —á–∞—Å—Ç–æ (—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
- üîÑ **–ò–∑–±–µ–≥–∞–π —Ä–µ–∫—É—Ä—Å–∏–∏** –≤ RLS –ø–æ–ª–∏—Ç–∏–∫–∞—Ö
- üß™ **–¢–µ—Å—Ç–∏—Ä—É–π –Ω–∞ localhost** —Å —Ç–æ–π –∂–µ Supabase –ë–î

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

**–ü—Ä–æ–µ–∫—Ç:** OnAI Academy Platform  
**GitHub:** https://github.com/onaicademy/onai-integrator-login  
**Production:** https://onai.academy

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 8 –Ω–æ—è–±—Ä—è 2025  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 8 –Ω–æ—è–±—Ä—è 2025

