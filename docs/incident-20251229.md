# ğŸš¨ Incident Report - Platform Stabilization
**Date:** 2025-12-29
**Branch:** hotfix/federation-stabilize
**Status:** IN PROGRESS

---

## ğŸ¯ OBJECTIVES

### Primary Goal
Restore platform reliability FIRST, then harden security, then finalize federation architecture.

### Success Criteria
- [ ] Student login â†’ profile loads â†’ lessons list loads
- [ ] Sales Manager login â†’ tripwire admin stats/users load
- [ ] Landing lead submit â†’ Telegram + amoCRM deal created correctly

---

## ğŸ“‹ PHASE CHECKLIST

### PHASE 0 - PRE-FLIGHT âœ…
- [x] Create hotfix/federation-stabilize branch
- [x] Create incident-20251229.md document
- [ ] Add diagnostic logging to backend
- [ ] Identify 3 golden flows
- [ ] Document current nginx reverse proxy config
- [ ] Document current Docker network topology

### PHASE 1 - STOP EMPTY UI
- [ ] **1.1** Fix multiple GoTrueClient instances
  - [ ] Audit all createClient() calls
  - [ ] Create single lib/supabase/mainClient.ts
  - [ ] Convert secondary clients to data-only mode
  - [ ] Verify: No "Multiple GoTrueClient" warning in console
- [ ] **1.2** Fix Docker runtime env mismatch
  - [ ] Create /api/config endpoint (runtime env)
  - [ ] Update frontend to fetch config on boot
  - [ ] Verify: Config matches runtime container env
- [ ] **1.3** Server-side orchestration layer
  - [ ] Create /api/tripwire/* proxy routes
  - [ ] Create /api/traffic/* proxy routes
  - [ ] Implement Main session validation
  - [ ] Use SERVICE_ROLE for secondary queries
  - [ ] Verify: UI loads even with issuer mismatch

**Rollback:** Keep old direct client calls behind feature flag

### PHASE 2 - TRIPWIRE SECURITY
- [ ] **2.1** Apply SQL migrations in order
  - [ ] Create RLS policies FIRST
  - [ ] Enable RLS on tripwire_users
  - [ ] Add NOT NULL/UNIQUE constraints
  - [ ] Create indexes
- [ ] **2.2** Password strategy
  - [ ] Decision: Invite flow vs hashed passwords
  - [ ] Implement chosen strategy
  - [ ] Verify: Anon cannot read tripwire_users

**Rollback:** Transactional migrations with SAVEPOINT

### PHASE 3 - FEDERATION (OPTIONAL)
- [ ] **Decision:** Is cross-project JWT needed after orchestration?
- [ ] If YES: Single JWT secret strategy
- [ ] If YES: Test issuer acceptance
- [ ] If NO: Skip this phase

**Rollback:** Restore previous JWT secret + keys

### PHASE 4 - DATA INTEGRITY
- [ ] Drop FK constraints to auth.users in Tripwire
- [ ] Drop FK constraints to auth.users in Traffic
- [ ] Verify: Profile operations work without FK

**Rollback:** SQL to recreate FKs

### PHASE 5 - REDIS CACHING
- [ ] Add Redis caching for Traffic stats
- [ ] Implement cache invalidation
- [ ] Verify: Cache hit ratio measurable

### PHASE 6 - LANDING PIPELINE
- [ ] Fix payment method â†’ pipeline stage mapping
- [ ] Add retries + idempotency
- [ ] Verify: 10 test leads â†’ Telegram + amoCRM

---

## ğŸ” GOLDEN FLOWS (Verification Checklist)

### Flow A: Student Login
```bash
# Step 1: Login
curl -X POST https://api.onai.academy/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@student.com","password":"test123"}'

# Expected: 200 OK, returns JWT token

# Step 2: Get profile
curl https://api.onai.academy/api/profile \
  -H "Authorization: Bearer <TOKEN>"

# Expected: 200 OK, returns user profile

# Step 3: Get lessons
curl https://api.onai.academy/api/lessons \
  -H "Authorization: Bearer <TOKEN>"

# Expected: 200 OK, returns lessons array
```

### Flow B: Sales Manager Dashboard
```bash
# Step 1: Login as sales manager
curl -X POST https://api.onai.academy/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"manager@test.com","password":"test123"}'

# Step 2: Get Tripwire stats
curl https://api.onai.academy/api/admin/tripwire/stats \
  -H "Authorization: Bearer <TOKEN>"

# Expected: 200 OK, returns stats object

# Step 3: Get users list
curl https://api.onai.academy/api/admin/tripwire/users \
  -H "Authorization: Bearer <TOKEN>"

# Expected: 200 OK, returns users array
```

### Flow C: Landing Lead Submit
```bash
curl -X POST https://api.onai.academy/api/landing/submit \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Lead",
    "email": "test@lead.com",
    "phone": "+77001234567",
    "source": "expresscourse",
    "paymentMethod": "kaspi"
  }'

# Expected: 200 OK
# Then check:
# 1. Telegram notification received
# 2. AmoCRM deal created in correct pipeline
```

---

## ğŸ³ CURRENT DOCKER ARCHITECTURE

### Network Topology
```
Internet â†’ Nginx (Host)
    â”œâ”€â”€ onai.academy â†’ main-frontend:80
    â”œâ”€â”€ traffic.onai.academy â†’ traffic-frontend:80
    â”œâ”€â”€ integrator.onai.academy â†’ tripwire-frontend:80
    â””â”€â”€ api.onai.academy
        â”œâ”€â”€ /api/main/* â†’ main-backend:3000
        â”œâ”€â”€ /api/traffic/* â†’ traffic-backend:3001
        â””â”€â”€ /api/tripwire/* â†’ tripwire-backend:3002
```

### Container List
```
- main-frontend (80)
- main-backend (3000)
- main-worker
- tripwire-frontend (82)
- tripwire-backend (3002)
- tripwire-worker
- traffic-frontend (81)
- traffic-backend (3001)
- traffic-worker
- shared-redis (6379)
```

### Current Issues
1. âŒ **Build-time vs Runtime ENV**: VITE_*/NEXT_PUBLIC_* baked at build
2. âŒ **Multiple GoTrueClient**: Browser has multiple auth instances
3. âŒ **Direct Supabase calls**: Frontend calls secondary projects directly
4. âŒ **No healthchecks**: Containers "up" but services dead
5. âŒ **RLS disabled**: tripwire_users has no RLS
6. âŒ **Plaintext passwords**: generated_password stored unencrypted

---

## ğŸ“Š DIAGNOSIS RESULTS

### Current State
- **Disk Space**: 80% (19GB/24GB)
  - Old docker images: ~20GB
  - New optimized images: ~5.5GB
- **RLS Status**: Disabled on tripwire_users (CRITICAL)
- **Auth Architecture**: Mixed (direct + JWT mismatch)

### Root Causes
1. **Docker ENV mismatch**: Frontend built with wrong env
2. **Auth fragmentation**: Multiple GoTrueClient instances
3. **Security holes**: RLS disabled, passwords in plaintext
4. **No orchestration**: Frontend â†’ Supabase direct (bypasses server logic)

---

## ğŸ› ï¸ CHANGES APPLIED

### PHASE 0 (Completed)
- âœ… Created hotfix/federation-stabilize branch
- âœ… Created incident documentation
- â³ Adding diagnostic logging...

### PHASE 1 (Pending)
- ...

---

## ğŸ“ ROLLBACK PROCEDURES

### Emergency Rollback (If Everything Breaks)
```bash
# 1. Switch back to main branch
git checkout main

# 2. Restore previous container state
cd /var/www/onai-integrator-login-main
git stash
docker compose down
docker compose up -d

# 3. Verify services
curl -I https://onai.academy
curl -I https://api.onai.academy/health
```

### Phase-Specific Rollbacks
See each phase section above.

---

## ğŸ“ ESCALATION

If issues persist after rollback:
1. Check logs: `docker compose logs -f main-backend`
2. Check disk space: `df -h`
3. Check running containers: `docker ps`
4. Contact: support@onai.academy

---

**Last Updated:** 2025-12-29 09:00 UTC
**Next Review:** After each phase completion
