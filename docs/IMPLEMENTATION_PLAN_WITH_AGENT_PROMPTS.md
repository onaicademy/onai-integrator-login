# üöÄ –ü–õ–ê–ù –í–ù–ï–î–†–ï–ù–ò–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô –ü–õ–ê–¢–§–û–†–ú–´ ONAI ACADEMY
# –ü–æ—ç—Ç–∞–ø–Ω—ã–π –ø–ª–∞–Ω —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏ –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 30 –¥–µ–∫–∞–±—Ä—è 2025
**–û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞:** DATABASE_AUDIT_REPORT_20251230.md
**–°—Ç–∞—Ç—É—Å:** –ì–û–¢–û–í–û –ö –í–´–ü–û–õ–ù–ï–ù–ò–Æ

---

## üìã –û–ì–õ–ê–í–õ–ï–ù–ò–ï

1. [–§–ê–ó–ê 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ (1-2 –¥–Ω—è)](#—Ñ–∞–∑–∞-0)
2. [–§–ê–ó–ê 1: –†–µ—à–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–≥–æ —Ä–∞–∑—Ä—ã–≤–∞ (3-5 –¥–Ω–µ–π)](#—Ñ–∞–∑–∞-1)
3. [–§–ê–ó–ê 2: –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π (5-7 –¥–Ω–µ–π)](#—Ñ–∞–∑–∞-2)
4. [–§–ê–ó–ê 3: –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (2-3 –¥–Ω—è)](#—Ñ–∞–∑–∞-3)
5. [–§–ê–ó–ê 4: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)](#—Ñ–∞–∑–∞-4)

---

<a name="—Ñ–∞–∑–∞-0"></a>
## üîç –§–ê–ó–ê 0: –ü–û–î–ì–û–¢–û–í–ö–ê –ò –ê–ù–ê–õ–ò–ó

**–¶–µ–ª—å:** –°–æ–±—Ä–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

**–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 1-2 –¥–Ω—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
**–ê–≥–µ–Ω—Ç—ã:** MCP Agent (database) + Browser MCP (verification)

---

### –ó–ê–î–ê–ß–ê 0.1: –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–ê–≥–µ–Ω—Ç:** MCP Agent (Database)

**–ü—Ä–æ–º–ø—Ç –¥–ª—è MCP –∞–≥–µ–Ω—Ç–∞:**

```markdown
–ó–ê–î–ê–ß–ê: –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Sales Manager

–¶–ï–õ–¨: –°–æ–±—Ä–∞—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫–∞–∫ Sales Manager –∞–≤—Ç–æ—Ä–∏–∑—É—é—Ç—Å—è –∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å Tripwire —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏

–î–ï–ô–°–¢–í–ò–Ø:

1. –ü–†–û–í–ï–†–ö–ê TRAFFIC DATABASE (oetodaexnjcunklkdlkv)

–ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ Traffic DB –∏ –≤—ã–ø–æ–ª–Ω–∏:

```sql
-- 1.1 –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö Sales Manager
SELECT
  id,
  email,
  full_name,
  role,
  created_at
FROM traffic_users
WHERE role IN ('sales_manager', 'sales', 'admin')
ORDER BY email;

-- 1.2 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã traffic_users
SELECT
  column_name,
  data_type,
  is_nullable,
  column_default
FROM information_schema.columns
WHERE table_name = 'traffic_users'
  AND table_schema = 'public'
ORDER BY ordinal_position;

-- 1.3 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å —Å auth.users
SELECT
  tu.id as traffic_user_id,
  tu.email,
  au.id as auth_user_id,
  au.email as auth_email
FROM traffic_users tu
LEFT JOIN auth.users au ON au.id = tu.id
WHERE tu.role IN ('sales_manager', 'sales', 'admin')
LIMIT 10;
```

2. –ü–†–û–í–ï–†–ö–ê TRIPWIRE DATABASE (pjmvxecykysfrzppdcto)

–ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ Tripwire DB –∏ –≤—ã–ø–æ–ª–Ω–∏:

```sql
-- 2.1 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ö–µ–º—É tripwire_users
SELECT
  column_name,
  data_type,
  is_nullable,
  column_default
FROM information_schema.columns
WHERE table_name = 'tripwire_users'
  AND table_schema = 'public'
ORDER BY ordinal_position;

-- 2.2 –ù–∞–π—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å granted_by
SELECT
  id,
  email,
  full_name,
  granted_by,
  manager_name,
  created_at
FROM tripwire_users
WHERE granted_by IS NOT NULL
ORDER BY created_at DESC
LIMIT 20;

-- 2.3 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏ granted_by –≤ auth.users
SELECT
  tu.email as student_email,
  tu.granted_by as manager_uuid,
  tu.manager_name,
  au.email as manager_auth_email,
  au.id as manager_auth_id
FROM tripwire_users tu
LEFT JOIN auth.users au ON au.id = tu.granted_by
WHERE tu.granted_by IS NOT NULL
LIMIT 20;

-- 2.4 –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
SELECT
  granted_by,
  manager_name,
  COUNT(*) as students_count,
  COUNT(*) * 5000 as total_revenue_kzt
FROM tripwire_users
WHERE granted_by IS NOT NULL
GROUP BY granted_by, manager_name
ORDER BY students_count DESC;
```

3. –ü–†–û–í–ï–†–ö–ê RLS –ü–û–õ–ò–¢–ò–ö

```sql
-- 3.1 Tripwire DB: RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è tripwire_users
SELECT
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual,
  with_check
FROM pg_policies
WHERE tablename = 'tripwire_users'
  AND schemaname = 'public';

-- 3.2 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∫–ª—é—á–µ–Ω –ª–∏ RLS
SELECT
  schemaname,
  tablename,
  rowsecurity
FROM pg_tables
WHERE tablename = 'tripwire_users'
  AND schemaname = 'public';
```

4. –ü–†–û–í–ï–†–ö–ê MIDDLEWARE –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò

–ü—Ä–æ—á–∏—Ç–∞–π —Ñ–∞–π–ª—ã:
- /backend/src/middleware/tripwire-auth.ts
- /backend/src/routes/tripwire-manager.ts

–ù–∞–π–¥–∏:
- –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ä–æ–ª—å sales_manager
- –û—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è user_id –¥–ª—è JWT
- –ö–∞–∫–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

–ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢:

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `/docs/PHASE0_AUTH_ARCHITECTURE_ANALYSIS.md` —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:

## –¢–ï–ö–£–©–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### Traffic Database
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ Sales Manager: X
- –°—Ö–µ–º–∞ traffic_users (–≤—Å–µ –ø–æ–ª—è)
- –°–≤—è–∑—å —Å auth.users (–µ—Å—Ç—å/–Ω–µ—Ç)

### Tripwire Database
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å granted_by: X
- –°—Ö–µ–º–∞ tripwire_users.granted_by
- –ú–µ–Ω–µ–¥–∂–µ—Ä—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ auth.users? (–¥–∞/–Ω–µ—Ç)
- –°–ø–∏—Å–æ–∫ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö UUID

### RLS –ü–æ–ª–∏—Ç–∏–∫–∏
- Tripwire DB RLS –≤–∫–ª—é—á–µ–Ω: –¥–∞/–Ω–µ—Ç
- –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è tripwire_users (—Å–ø–∏—Å–æ–∫)
- –ë–ª–æ–∫–∏—Ä—É—é—Ç –ª–∏ –¥–æ—Å—Ç—É–ø –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: –¥–∞/–Ω–µ—Ç

### Middleware
- –§–∞–π–ª –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: –ø—É—Ç—å
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: –∫–∞–∫–∞—è
- –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏: –æ–ø–∏—Å–∞–Ω–∏–µ

## –ü–†–û–ë–õ–ï–ú–´

1. [–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã 1]
2. [–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã 2]
...

## –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

[–í–∞—Ä–∏–∞–Ω—Ç A / B / C] - –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –æ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π —Ä–µ—à–µ–Ω–∏—è

---

### –ó–ê–î–ê–ß–ê 0.2: –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–∞ Sales Manager —á–µ—Ä–µ–∑ UI

**–ê–≥–µ–Ω—Ç:** Browser MCP

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Browser MCP:**

```markdown
–ó–ê–î–ê–ß–ê: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø Sales Manager –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏

–¶–ï–õ–¨: –í—ã—è—Å–Ω–∏—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –¥–æ—Å—Ç—É–ø –∫ /admin/tripwire —Å–µ–π—á–∞—Å –∏–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

–î–ï–ô–°–¢–í–ò–Ø:

1. –û—Ç–∫—Ä–æ–π https://expresscourse.onai.academy/login

2. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Å—è –∫–∞–∫ Sales Manager:
   Email: smmmcwin@gmail.com
   Password: Sales2025!

3. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø –∫ –¥–∞—à–±–æ—Ä–¥—É:
   - –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ /admin/tripwire
   - –°–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã
   - –ü—Ä–æ–≤–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ª–∏ —Å—Ç—É–¥–µ–Ω—Ç—ã –≤ —Ç–∞–±–ª–∏—Ü–µ

4. –ü—Ä–æ–≤–µ—Ä—å Stats Cards:
   - –í–∏–¥–Ω—ã –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –¥–æ—Ö–æ–¥–µ (revenue)
   - –í–∏–¥–Ω–æ –ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
   - –°–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç Stats Cards

5. –ü—Ä–æ–≤–µ—Ä—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞:
   - –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "–°–æ–∑–¥–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞"
   - –ó–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É:
     * Email: test-phase0-{timestamp}@test.com
     * Full Name: Test Phase 0 Student
     * Phone: +77001234567
   - –û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ä–º—É
   - –ü—Ä–æ–≤–µ—Ä—å –ø–æ—è–≤–∏–ª—Å—è –ª–∏ —Å—Ç—É–¥–µ–Ω—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ
   - –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - —Å–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞

6. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –±—Ä–∞—É–∑–µ—Ä–∞:
   - –û—Ç–∫—Ä–æ–π Console (F12)
   - –ù–∞–π–¥–∏ –æ—à–∏–±–∫–∏ (–∫—Ä–∞—Å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
   - –°–∫–æ–ø–∏—Ä—É–π –≤—Å–µ –æ—à–∏–±–∫–∏

–ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢:

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `/docs/PHASE0_UI_VERIFICATION_REPORT.md`:

## UI –î–û–°–¢–£–ü

- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: —É—Å–ø–µ—à–Ω–æ/–æ—à–∏–±–∫–∞
- –î–æ—Å—Ç—É–ø –∫ /admin/tripwire: –¥–∞/–Ω–µ—Ç
- –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: –¥–∞/–Ω–µ—Ç

## STATS CARDS

- Revenue –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è: –¥–∞/–Ω–µ—Ç (–∑–Ω–∞—á–µ–Ω–∏–µ)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤: –¥–∞/–Ω–µ—Ç (–∑–Ω–∞—á–µ–Ω–∏–µ)
- –°–∫—Ä–∏–Ω—à–æ—Ç: [–ø—É—Ç—å]

## –°–û–ó–î–ê–ù–ò–ï –°–¢–£–î–ï–ù–¢–ê

- –§–æ—Ä–º–∞ –æ—Ç–∫—Ä—ã–ª–∞—Å—å: –¥–∞/–Ω–µ—Ç
- –°—Ç—É–¥–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: –¥–∞/–Ω–µ—Ç
- –û—à–∏–±–∫–∏: [—Å–ø–∏—Å–æ–∫]

## –ö–û–ù–°–û–õ–¨ –ë–†–ê–£–ó–ï–†–ê

- –û—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: [—Å–ø–∏—Å–æ–∫]
- –û—à–∏–±–∫–∏ API: [—Å–ø–∏—Å–æ–∫]
- –û—à–∏–±–∫–∏ CORS: [—Å–ø–∏—Å–æ–∫]

## –í–´–í–û–î

[–†–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é / –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç / –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç] - –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û—Ç—á—ë—Ç –æ —Ä–µ–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ UI —Å —Å–∫—Ä–∏–Ω—à–æ—Ç–∞–º–∏

---

### –ó–ê–î–ê–ß–ê 0.3: –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

**–ê–≥–µ–Ω—Ç:** –¢—ã (Claude) - –∞–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ü—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç—á—ë—Ç—ã –∏–∑ –∑–∞–¥–∞—á 0.1 –∏ 0.2
2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ä–µ—à–µ–Ω–∏—è (A/B/C)
3. –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
4. –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ü—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**

```
–ù–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –æ—Ç—á—ë—Ç–æ–≤ PHASE0_AUTH_ARCHITECTURE_ANALYSIS.md –∏ PHASE0_UI_VERIFICATION_REPORT.md
—è —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Å–ª–µ–¥—É—é—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ:

[–í–ê–†–ò–ê–ù–¢ A/B/C] - –ø–æ—Ç–æ–º—É —á—Ç–æ:
1. [–ü—Ä–∏—á–∏–Ω–∞ 1]
2. [–ü—Ä–∏—á–∏–Ω–∞ 2]
3. [–ü—Ä–∏—á–∏–Ω–∞ 3]

–¢—ã —Å–æ–≥–ª–∞—Å–µ–Ω —Å —ç—Ç–∏–º —Ä–µ—à–µ–Ω–∏–µ–º –∏–ª–∏ —Ö–æ—á–µ—à—å –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç?
```

---

<a name="—Ñ–∞–∑–∞-1"></a>
## üîß –§–ê–ó–ê 1: –†–ï–®–ï–ù–ò–ï –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–û–ì–û –†–ê–ó–†–´–í–ê

**–¶–µ–ª—å:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Traffic ‚Üî Tripwire

**–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 3-5 –¥–Ω–µ–π
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
**–ê–≥–µ–Ω—Ç—ã:** MCP Agent (migrations) + Codex (code changes) + Browser MCP (testing)

**–í–ê–ñ–ù–û:** –≠—Ç–∞ —Ñ–∞–∑–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ü–û–°–õ–ï –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è –≤ –§–∞–∑–µ 0

---

### –í–ê–†–ò–ê–ù–¢ A: –£–ù–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–ê–Ø –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

#### –ó–ê–î–ê–ß–ê 1A.1: –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è auth.users –≤ Tripwire DB

**–ê–≥–µ–Ω—Ç:** MCP Agent (Database)

**–ü—Ä–æ–º–ø—Ç –¥–ª—è MCP –∞–≥–µ–Ω—Ç–∞:**

```markdown
–ó–ê–î–ê–ß–ê: –°–æ–∑–¥–∞—Ç—å Sales Manager –≤ auth.users Tripwire Database

–ö–û–ù–¢–ï–ö–°–¢:
- Sales Manager —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ Traffic DB (traffic_users)
- –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∏—Ö –∫–æ–ø–∏–∏ –≤ Tripwire DB (auth.users)
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ –∂–µ UUID –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

–î–ê–ù–ù–´–ï –ò–ó –§–ê–ó–´ 0:
[–í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–ø–∏—Å–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏–∑ –æ—Ç—á—ë—Ç–∞ PHASE0_AUTH_ARCHITECTURE_ANALYSIS.md]

–î–ï–ô–°–¢–í–ò–Ø:

1. –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ Traffic DB (oetodaexnjcunklkdlkv)

–ü–æ–ª—É—á–∏ –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö Sales Manager:

```sql
SELECT
  id,
  email,
  encrypted_password, -- –µ—Å–ª–∏ –µ—Å—Ç—å
  email_confirmed_at,
  created_at,
  updated_at
FROM auth.users
WHERE id IN (
  SELECT id FROM traffic_users
  WHERE role IN ('sales_manager', 'sales', 'admin')
);
```

2. –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ Tripwire DB (pjmvxecykysfrzppdcto)

–°–æ–∑–¥–∞–π –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –≤ auth.users:

```sql
-- 2.1 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –ª–∏ —É–∂–µ
SELECT id, email FROM auth.users
WHERE email IN ([—Å–ø–∏—Å–æ–∫ email –∏–∑ —à–∞–≥–∞ 1]);

-- 2.2 –í—Å—Ç–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ (–¢–û–õ–¨–ö–û —Ç–µ—Ö, –∫–æ–≥–æ –Ω–µ—Ç!)
INSERT INTO auth.users (
  id,
  instance_id,
  email,
  encrypted_password,
  email_confirmed_at,
  created_at,
  updated_at,
  role,
  aud
)
SELECT
  id,
  '00000000-0000-0000-0000-000000000000'::uuid as instance_id,
  email,
  encrypted_password,
  email_confirmed_at,
  created_at,
  updated_at,
  'authenticated' as role,
  'authenticated' as aud
FROM (VALUES
  -- –ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —à–∞–≥–∞ 1
  ('UUID1', 'email1@example.com', '$2a$...', '2024-01-01', ...),
  ('UUID2', 'email2@example.com', '$2a$...', '2024-01-01', ...)
) AS managers(id, email, encrypted_password, email_confirmed_at, created_at, updated_at)
ON CONFLICT (id) DO NOTHING;

-- 2.3 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–æ–∑–¥–∞–ª–∏—Å—å
SELECT id, email, created_at
FROM auth.users
WHERE email IN ([—Å–ø–∏—Å–æ–∫ email]);
```

3. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É sales_managers_metadata

```sql
CREATE TABLE IF NOT EXISTS sales_managers_metadata (
  user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  manager_name TEXT NOT NULL,
  traffic_user_id UUID, -- —Å—Å—ã–ª–∫–∞ –Ω–∞ traffic_users.id
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- –ó–∞–ø–æ–ª–Ω–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
INSERT INTO sales_managers_metadata (user_id, manager_name, traffic_user_id)
SELECT
  au.id,
  tu.full_name as manager_name,
  tu.id as traffic_user_id
FROM auth.users au
JOIN [–¥–∞–Ω–Ω—ã–µ –∏–∑ Traffic DB] tu ON tu.email = au.email
WHERE au.email IN ([—Å–ø–∏—Å–æ–∫ email –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤])
ON CONFLICT (user_id) DO UPDATE
SET manager_name = EXCLUDED.manager_name,
    traffic_user_id = EXCLUDED.traffic_user_id,
    updated_at = NOW();
```

4. –°–æ–∑–¥–∞—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è sales_managers_metadata

```sql
ALTER TABLE sales_managers_metadata ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Sales managers can read own metadata"
ON sales_managers_metadata
FOR SELECT
USING (auth.uid() = user_id);

CREATE POLICY "Service role full access to sales_managers_metadata"
ON sales_managers_metadata
FOR ALL
USING (auth.role() = 'service_role');
```

–ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢:

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `/docs/PHASE1A_AUTH_MIGRATION_REPORT.md`:

## –ú–ò–ì–†–ê–¶–ò–Ø –í–´–ü–û–õ–ù–ï–ù–ê

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –≤ auth.users
| UUID | Email | –°–æ–∑–¥–∞–Ω |
|------|-------|--------|
| ... | ... | ... |

### –¢–∞–±–ª–∏—Ü–∞ sales_managers_metadata
- –°–æ–∑–¥–∞–Ω–∞: –¥–∞/–Ω–µ—Ç
- –ó–∞–ø–∏—Å–µ–π: X
- RLS –≤–∫–ª—é—á–µ–Ω: –¥–∞

### SQL –º–∏–≥—Ä–∞—Ü–∏—è
–°–æ—Ö—Ä–∞–Ω–∏ SQL —Å–∫—Ä–∏–ø—Ç –≤ `/sql/migrations/001_create_sales_managers_in_tripwire_auth.sql`

### –ü–†–û–í–ï–†–ö–ê

```sql
-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –≤ auth.users
SELECT COUNT(*) FROM auth.users
WHERE email IN ([—Å–ø–∏—Å–æ–∫]);

-- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
SELECT * FROM sales_managers_metadata;
```

## –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì
–ó–∞–¥–∞—á–∞ 1A.2: –û–±–Ω–æ–≤–∏—Ç—å tripwire_users.granted_by –∫–∞–∫ Foreign Key
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Sales Manager —Å–æ–∑–¥–∞–Ω—ã –≤ Tripwire auth.users + —Ç–∞–±–ª–∏—Ü–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

---

#### –ó–ê–î–ê–ß–ê 1A.2: –û–±–Ω–æ–≤–∏—Ç—å Foreign Key tripwire_users.granted_by

**–ê–≥–µ–Ω—Ç:** MCP Agent (Database)

**–ü—Ä–æ–º–ø—Ç –¥–ª—è MCP –∞–≥–µ–Ω—Ç–∞:**

```markdown
–ó–ê–î–ê–ß–ê: –û–±–Ω–æ–≤–∏—Ç—å tripwire_users.granted_by –∫–∞–∫ Foreign Key –Ω–∞ auth.users

–ö–û–ù–¢–ï–ö–°–¢:
- –°–µ–π—á–∞—Å granted_by –ø—Ä–æ—Å—Ç–æ UUID –±–µ–∑ FK
- –ù—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å FK –Ω–∞ auth.users(id)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ granted_by —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ auth.users

–î–ï–ô–°–¢–í–ò–Ø:

1. –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ Tripwire DB (pjmvxecykysfrzppdcto)

–ü—Ä–æ–≤–µ—Ä—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:

```sql
-- 1.1 –ù–∞–π—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å granted_by –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ auth.users
SELECT
  tu.id,
  tu.email,
  tu.granted_by,
  tu.manager_name
FROM tripwire_users tu
LEFT JOIN auth.users au ON au.id = tu.granted_by
WHERE tu.granted_by IS NOT NULL
  AND au.id IS NULL;
```

**–ï–°–õ–ò –ù–ê–®–õ–ò–°–¨ –ù–ï–°–£–©–ï–°–¢–í–£–Æ–©–ò–ï UUID:**
- –û—Å—Ç–∞–Ω–æ–≤–∏—Å—å –∏ –æ—Ç—á–∏—Ç–∞–π—Å—è
- –ù–µ –¥–æ–±–∞–≤–ª—è–π FK –ø–æ–∫–∞ –Ω–µ –∏—Å–ø—Ä–∞–≤–∏–º –¥–∞–Ω–Ω—ã–µ

2. –î–æ–±–∞–≤–∏—Ç—å Foreign Key constraint

```sql
-- 2.1 –î–æ–±–∞–≤–∏—Ç—å FK (–µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —Ü–µ–ª–æ—Å—Ç–Ω—ã–µ)
ALTER TABLE tripwire_users
ADD CONSTRAINT fk_tripwire_users_granted_by
FOREIGN KEY (granted_by)
REFERENCES auth.users(id)
ON DELETE SET NULL;

-- 2.2 –ü—Ä–æ–≤–µ—Ä–∏—Ç—å constraint —Å–æ–∑–¥–∞–ª—Å—è
SELECT
  conname as constraint_name,
  conrelid::regclass as table_name,
  confrelid::regclass as foreign_table
FROM pg_constraint
WHERE conname = 'fk_tripwire_users_granted_by';
```

3. –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –Ω–∞ granted_by

```sql
CREATE INDEX IF NOT EXISTS idx_tripwire_users_granted_by
ON tripwire_users(granted_by)
WHERE granted_by IS NOT NULL;
```

–ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢:

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `/docs/PHASE1A_FK_MIGRATION_REPORT.md`:

## FOREIGN KEY –°–û–ó–î–ê–ù

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
- –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö UUID: X (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0)
- –ï—Å–ª–∏ > 0: [—Å–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤]

### Foreign Key Constraint
- –°–æ–∑–¥–∞–Ω: –¥–∞/–Ω–µ—Ç
- –ò–º—è: fk_tripwire_users_granted_by
- –°—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞: auth.users(id)
- ON DELETE: SET NULL

### –ò–Ω–¥–µ–∫—Å
- –°–æ–∑–¥–∞–Ω: idx_tripwire_users_granted_by
- –¢–∏–ø: B-tree
- Partial: WHERE granted_by IS NOT NULL

### SQL –º–∏–≥—Ä–∞—Ü–∏—è
–°–æ—Ö—Ä–∞–Ω–∏ –≤ `/sql/migrations/002_add_fk_tripwire_users_granted_by.sql`

## –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì
–ó–∞–¥–∞—á–∞ 1A.3: –û–±–Ω–æ–≤–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Foreign Key —Å–æ–∑–¥–∞–Ω, –¥–∞–Ω–Ω—ã–µ —Ü–µ–ª–æ—Å—Ç–Ω—ã–µ

---

#### –ó–ê–î–ê–ß–ê 1A.3: –û–±–Ω–æ–≤–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è Sales Manager

**–ê–≥–µ–Ω—Ç:** MCP Agent (Database)

**–ü—Ä–æ–º–ø—Ç –¥–ª—è MCP –∞–≥–µ–Ω—Ç–∞:**

```markdown
–ó–ê–î–ê–ß–ê: –û–±–Ω–æ–≤–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ —á—Ç–æ–±—ã Sales Manager –≤–∏–¥–µ–ª–∏ —Å–≤–æ–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤

–ö–û–ù–¢–ï–ö–°–¢:
- –¢–µ–ø–µ—Ä—å granted_by ‚Üí FK –Ω–∞ auth.users(id)
- –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∫–æ—Ç–æ—Ä—ã—Ö —Å–æ–∑–¥–∞–ª–∏
- Admin –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤

–î–ï–ô–°–¢–í–ò–Ø:

1. –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ Tripwire DB (pjmvxecykysfrzppdcto)

–û–±–Ω–æ–≤–∏ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è tripwire_users:

```sql
-- 1.1 –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
DROP POLICY IF EXISTS "Sales managers can view their students"
ON tripwire_users;

DROP POLICY IF EXISTS "Admins can view all students"
ON tripwire_users;

-- 1.2 –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è Sales Manager
CREATE POLICY "Sales managers can view their students"
ON tripwire_users
FOR SELECT
USING (
  -- –ú–µ–Ω–µ–¥–∂–µ—Ä –≤–∏–¥–∏—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∫–æ—Ç–æ—Ä—ã—Ö –æ–Ω —Å–æ–∑–¥–∞–ª
  granted_by = auth.uid()
  OR
  -- –ò–õ–ò —ç—Ç–æ admin (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ metadata)
  EXISTS (
    SELECT 1 FROM sales_managers_metadata smm
    WHERE smm.user_id = auth.uid()
      AND smm.is_active = true
  )
);

-- 1.3 –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è UPDATE (–º–µ–Ω–µ–¥–∂–µ—Ä—ã –æ–±–Ω–æ–≤–ª—è—é—Ç —Å–≤–æ–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤)
CREATE POLICY "Sales managers can update their students"
ON tripwire_users
FOR UPDATE
USING (granted_by = auth.uid())
WITH CHECK (granted_by = auth.uid());

-- 1.4 –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É –¥–ª—è INSERT (–º–µ–Ω–µ–¥–∂–µ—Ä—ã —Å–æ–∑–¥–∞—é—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤)
CREATE POLICY "Sales managers can create students"
ON tripwire_users
FOR INSERT
WITH CHECK (
  -- granted_by –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å auth.uid()
  granted_by = auth.uid()
  AND
  -- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
  EXISTS (
    SELECT 1 FROM sales_managers_metadata smm
    WHERE smm.user_id = auth.uid()
      AND smm.is_active = true
  )
);
```

2. –û–±–Ω–æ–≤–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è tripwire_user_profile

```sql
-- 2.1 –ü–æ–ª–∏—Ç–∏–∫–∞ SELECT –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π
CREATE POLICY "Sales managers can view profiles of their students"
ON tripwire_user_profile
FOR SELECT
USING (
  user_id IN (
    SELECT id FROM tripwire_users
    WHERE granted_by = auth.uid()
  )
);
```

3. –û–±–Ω–æ–≤–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∞–±–ª–∏—Ü

```sql
-- 3.1 tripwire_progress
CREATE POLICY "Sales managers can view progress of their students"
ON tripwire_progress
FOR SELECT
USING (
  tripwire_user_id IN (
    SELECT user_id FROM tripwire_users
    WHERE granted_by = auth.uid()
  )
);

-- 3.2 certificates
CREATE POLICY "Sales managers can view certificates of their students"
ON certificates
FOR SELECT
USING (
  user_id IN (
    SELECT user_id FROM tripwire_users
    WHERE granted_by = auth.uid()
  )
);
```

4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏

```sql
-- 4.1 –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª–∏—Ç–∏–∫ –¥–ª—è tripwire_users
SELECT
  policyname,
  cmd,
  qual
FROM pg_policies
WHERE tablename = 'tripwire_users'
  AND schemaname = 'public';
```

–ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢:

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `/docs/PHASE1A_RLS_POLICIES_REPORT.md`:

## RLS –ü–û–õ–ò–¢–ò–ö–ò –û–ë–ù–û–í–õ–ï–ù–´

### tripwire_users
| –ü–æ–ª–∏—Ç–∏–∫–∞ | –ö–æ–º–∞–Ω–¥–∞ | –£—Å–ª–æ–≤–∏–µ |
|----------|---------|---------|
| Sales managers can view their students | SELECT | granted_by = auth.uid() |
| Sales managers can update their students | UPDATE | granted_by = auth.uid() |
| Sales managers can create students | INSERT | granted_by = auth.uid() + metadata check |

### tripwire_user_profile
| –ü–æ–ª–∏—Ç–∏–∫–∞ | –ö–æ–º–∞–Ω–¥–∞ | –£—Å–ª–æ–≤–∏–µ |
|----------|---------|---------|
| ... | ... | ... |

### tripwire_progress
[–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ]

### certificates
[–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ]

### SQL –º–∏–≥—Ä–∞—Ü–∏—è
–°–æ—Ö—Ä–∞–Ω–∏ –≤ `/sql/migrations/003_update_rls_policies_for_sales_managers.sql`

## –¢–ï–°–¢ –ü–û–õ–ò–¢–ò–ö

```sql
-- –¢–µ—Å—Ç: –º–µ–Ω–µ–¥–∂–µ—Ä –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
SET LOCAL role TO authenticated;
SET LOCAL "request.jwt.claims" TO '{"sub":"UUID_–ú–ï–ù–ï–î–ñ–ï–†–ê"}';

SELECT COUNT(*) FROM tripwire_users; -- –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö

RESET role;
```

## –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì
–ó–∞–¥–∞—á–∞ 1A.4: –û–±–Ω–æ–≤–∏—Ç—å backend –∫–æ–¥ –¥–ª—è –Ω–æ–≤–æ–π —Å—Ö–µ–º—ã
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã, –¥–æ—Å—Ç—É–ø —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω

---

#### –ó–ê–î–ê–ß–ê 1A.4: –û–±–Ω–æ–≤–∏—Ç—å backend –∫–æ–¥

**–ê–≥–µ–Ω—Ç:** Codex (Code changes)

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Codex –∞–≥–µ–Ω—Ç–∞:**

```markdown
–ó–ê–î–ê–ß–ê: –û–±–Ω–æ–≤–∏—Ç—å backend –∫–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤–æ–π —Å—Ö–µ–º–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

–ö–û–ù–¢–ï–ö–°–¢:
- Sales Manager —Ç–µ–ø–µ—Ä—å –≤ auth.users Tripwire DB
- granted_by —Ç–µ–ø–µ—Ä—å FK –Ω–∞ auth.users(id)
- –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å middleware –∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã

–ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ö–û–î–ï:

1. –§–ê–ô–õ: /backend/src/middleware/tripwire-auth.ts

```typescript
// –î–û–ë–ê–í–ò–¢–¨ –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏ Sales Manager

export const requireTripwireSalesOrAdmin = async (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  try {
    const userId = req.user?.id; // –∏–∑ authenticateTripwireJWT

    if (!userId) {
      return res.status(401).json({ error: 'Unauthorized' });
    }

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - Sales Manager
    const { data: metadata, error } = await tripwireAdminSupabase
      .from('sales_managers_metadata')
      .select('user_id, manager_name, is_active')
      .eq('user_id', userId)
      .eq('is_active', true)
      .maybeSingle();

    if (error || !metadata) {
      return res.status(403).json({
        error: 'Access denied. Sales Manager role required.'
      });
    }

    // –î–æ–±–∞–≤–∏—Ç—å metadata –≤ request –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö
    req.salesManager = {
      userId: metadata.user_id,
      managerName: metadata.manager_name
    };

    next();
  } catch (error: any) {
    console.error('[Tripwire Auth] Error checking sales manager role:', error);
    return res.status(500).json({ error: 'Internal server error' });
  }
};
```

2. –§–ê–ô–õ: /backend/src/controllers/tripwireManagerController.ts

–û–±–Ω–æ–≤–∏ —Ñ—É–Ω–∫—Ü–∏—é createTripwireUser:

```typescript
export async function createTripwireUser(req: Request, res: Response) {
  try {
    const { email, full_name, phone } = req.body;
    const salesManagerId = req.user?.id; // –∏–∑ authenticateTripwireJWT
    const managerName = req.salesManager?.managerName; // –∏–∑ requireTripwireSalesOrAdmin

    if (!salesManagerId) {
      return res.status(401).json({ error: 'Unauthorized' });
    }

    // ... existing code ...

    // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞:
    const { data: newStudent, error: createError } = await tripwireAdminSupabase
      .from('tripwire_users')
      .insert({
        email,
        full_name,
        phone,
        granted_by: salesManagerId, // ‚úÖ –¢–µ–ø–µ—Ä—å FK –Ω–∞ auth.users(id)
        manager_name: managerName, // –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        // ... other fields ...
      })
      .select()
      .single();

    // ... rest of the code ...
  } catch (error: any) {
    // ... error handling ...
  }
}
```

3. –§–ê–ô–õ: /backend/src/services/tripwireManagerService.ts

–û–±–Ω–æ–≤–∏ —Ñ—É–Ω–∫—Ü–∏—é getTripwireUsers:

```typescript
export async function getTripwireUsers(managerId?: string) {
  try {
    let query = tripwireAdminSupabase
      .from('tripwire_users')
      .select(`
        *,
        sales_manager:sales_managers_metadata!granted_by(manager_name)
      `);

    // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω managerId - —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å
    if (managerId) {
      query = query.eq('granted_by', managerId);
    }

    const { data, error } = await query;

    if (error) throw error;

    return data;
  } catch (error: any) {
    console.error('Error fetching tripwire users:', error);
    throw error;
  }
}
```

4. –°–û–ó–î–ê–¢–¨ –ù–û–í–´–ô –§–ê–ô–õ: /backend/src/types/express.d.ts

```typescript
// –†–∞—Å—à–∏—Ä–∏—Ç—å Request type –¥–ª—è salesManager
declare global {
  namespace Express {
    interface Request {
      salesManager?: {
        userId: string;
        managerName: string;
      };
    }
  }
}

export {};
```

–¢–ï–°–¢–´:

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª /backend/tests/tripwire-auth.test.ts:

```typescript
import { describe, it, expect } from 'vitest';
import { tripwireAdminSupabase } from '../src/config/supabase-tripwire';

describe('Tripwire Auth - Sales Manager Access', () => {
  it('should have sales_managers_metadata table', async () => {
    const { data, error } = await tripwireAdminSupabase
      .from('sales_managers_metadata')
      .select('*')
      .limit(1);

    expect(error).toBeNull();
    expect(data).toBeDefined();
  });

  it('should have FK constraint on tripwire_users.granted_by', async () => {
    const { data, error } = await tripwireAdminSupabase
      .rpc('check_fk_constraint', {
        table_name: 'tripwire_users',
        column_name: 'granted_by'
      });

    expect(error).toBeNull();
    expect(data).toBe(true);
  });
});
```

–ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢:

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `/docs/PHASE1A_CODE_CHANGES_REPORT.md`:

## –ö–û–î –û–ë–ù–û–í–õ–Å–ù

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- ‚úÖ /backend/src/middleware/tripwire-auth.ts
- ‚úÖ /backend/src/controllers/tripwireManagerController.ts
- ‚úÖ /backend/src/services/tripwireManagerService.ts
- ‚úÖ /backend/src/types/express.d.ts (–Ω–æ–≤—ã–π)

### –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- requireTripwireSalesOrAdmin middleware
- –ü—Ä–æ–≤–µ—Ä–∫–∞ sales_managers_metadata
- –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π createTripwireUser

### –¢–µ—Å—Ç—ã
- ‚úÖ tripwire-auth.test.ts —Å–æ–∑–¥–∞–Ω
- –ü–æ–∫—Ä—ã—Ç–∏–µ: metadata table, FK constraint

## –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì
–ó–∞–¥–∞—á–∞ 1A.5: –î–µ–ø–ª–æ–π –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Backend –∫–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω –ø–æ–¥ –Ω–æ–≤—É—é —Å—Ö–µ–º—É

---

#### –ó–ê–î–ê–ß–ê 1A.5: –î–µ–ø–ª–æ–π –∏ E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ê–≥–µ–Ω—Ç 1:** –¢—ã (Claude) - –¥–µ–ø–ª–æ–π
**–ê–≥–µ–Ω—Ç 2:** Browser MCP - E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü—Ä–æ–º–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è (Claude):**

```markdown
–ó–ê–î–ê–ß–ê: –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ production

–î–ï–ô–°–¢–í–ò–Ø:

1. –°–æ–±—Ä–∞—Ç—å backend:
cd /Users/miso/onai-integrator-login/backend
npm run build

2. –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä:
rsync -avz backend/dist/ root@207.154.231.30:/var/www/onai-integrator-login-main/backend/dist/

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å PM2:
ssh root@207.154.231.30 "pm2 restart backend"

4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
ssh root@207.154.231.30 "pm2 logs backend --lines 50"

5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ –±—ç–∫–µ–Ω–¥–∞:
curl https://onai.academy/api/health
```

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Browser MCP (E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ):**

```markdown
–ó–ê–î–ê–ß–ê: End-to-End —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Sales Manager –¥–æ—Å—Ç—É–ø–∞

–¶–ï–õ–¨: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Sales Manager –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ –≤–∏–¥–µ—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤

–î–ï–ô–°–¢–í–ò–Ø:

1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Sales Manager
   - –û—Ç–∫—Ä–æ–π https://expresscourse.onai.academy/login
   - –í–≤–µ–¥–∏: smmmcwin@gmail.com / Sales2025!
   - –ü—Ä–æ–≤–µ—Ä—å —É—Å–ø–µ—à–Ω–∞—è –ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞—à–±–æ—Ä–¥—É
   - –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ /admin/tripwire
   - –ü—Ä–æ–≤–µ—Ä—å –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å –ª–∏ —Å—Ç—É–¥–µ–Ω—Ç—ã
   - –°–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤

3. –ü—Ä–æ–≤–µ—Ä–∫–∞ Stats Cards
   - –ü—Ä–æ–≤–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ª–∏ revenue
   - –ü—Ä–æ–≤–µ—Ä—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
   - –°–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç stats cards

4. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
   - –ù–∞–∂–º–∏ "–°–æ–∑–¥–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞"
   - –ó–∞–ø–æ–ª–Ω–∏:
     * Email: test-phase1a-{timestamp}@test.com
     * Full Name: Test Phase 1A Student
     * Phone: +77001234567
   - –û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ä–º—É
   - –ü—Ä–æ–≤–µ—Ä—å –ø–æ—è–≤–∏–ª—Å—è –ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
   - –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ granted_by = UUID –º–µ–Ω–µ–¥–∂–µ—Ä–∞

5. –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS
   - –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –≤—ã–ø–æ–ª–Ω–∏:
   ```javascript
   // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   const { data: { user } } = await window.supabaseClient.auth.getUser();
   console.log('Current user:', user);

   // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
   const { data, error } = await window.supabaseClient
     .from('tripwire_users')
     .select('*');
   console.log('Students:', data?.length, 'Error:', error);
   ```
   - –°–∫–æ–ø–∏—Ä—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
   - –û—Ç–∫—Ä–æ–π Network tab (F12)
   - –û—Ç—Ñ–∏–ª—å—Ç—Ä—É–π –ø–æ /api/admin/tripwire
   - –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–æ–≤ (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 200)
   - –ï—Å–ª–∏ –æ—à–∏–±–∫–∏ - —Å–∫—Ä–∏–Ω—à–æ—Ç

–ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢:

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `/docs/PHASE1A_E2E_TEST_REPORT.md`:

## E2E –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- –£—Å–ø–µ—à–Ω–æ: –¥–∞/–Ω–µ—Ç
- JWT token –ø–æ–ª—É—á–µ–Ω: –¥–∞/–Ω–µ—Ç

### –î–æ—Å—Ç—É–ø –∫ –¥–∞—à–±–æ—Ä–¥—É
- URL –¥–æ—Å—Ç—É–ø–µ–Ω: –¥–∞/–Ω–µ—Ç
- –°—Ç—É–¥–µ–Ω—Ç—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å: X –∑–∞–ø–∏—Å–µ–π
- –°–∫—Ä–∏–Ω—à–æ—Ç: [–ø—É—Ç—å]

### Stats Cards
- Revenue: [–∑–Ω–∞—á–µ–Ω–∏–µ]
- –°—Ç—É–¥–µ–Ω—Ç—ã: [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ]
- –°–∫—Ä–∏–Ω—à–æ—Ç: [–ø—É—Ç—å]

### –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞
- –°—Ç—É–¥–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: –¥–∞/–Ω–µ—Ç
- granted_by –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π: –¥–∞/–Ω–µ—Ç
- Email —Å—Ç—É–¥–µ–Ω—Ç–∞: [email]

### RLS –ü—Ä–æ–≤–µ—Ä–∫–∞
- User ID: [UUID]
- –°—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤–∏–¥–Ω–æ: X
- –û—à–∏–±–∫–∏ RLS: –Ω–µ—Ç/[–æ–ø–∏—Å–∞–Ω–∏–µ]

### Network Requests
- API —Å—Ç–∞—Ç—É—Å—ã: –≤—Å–µ 200 / –µ—Å—Ç—å –æ—à–∏–±–∫–∏
- –û—à–∏–±–∫–∏: [—Å–ø–∏—Å–æ–∫]

## –í–´–í–û–î
‚úÖ –§–∞–∑–∞ 1A –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
‚ùå –ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã: [—Å–ø–∏—Å–æ–∫]
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** E2E —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã, —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø –§–ê–ó–´ 1

**–ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**

```markdown
–§–ê–ó–ê 1A: –í–ï–†–ò–§–ò–ö–ê–¶–ò–Ø

‚úÖ Auth Migration
- [ ] Sales Manager —Å–æ–∑–¥–∞–Ω—ã –≤ auth.users Tripwire DB
- [ ] –¢–∞–±–ª–∏—Ü–∞ sales_managers_metadata —Å–æ–∑–¥–∞–Ω–∞
- [ ] –í—Å–µ UUID —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å Traffic DB

‚úÖ Foreign Key
- [ ] FK constraint —Å–æ–∑–¥–∞–Ω
- [ ] –ù–µ—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö UUID
- [ ] –ò–Ω–¥–µ–∫—Å –Ω–∞ granted_by —Å–æ–∑–¥–∞–Ω

‚úÖ RLS Policies
- [ ] –ü–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è tripwire_users
- [ ] –ü–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è tripwire_user_profile
- [ ] –ü–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è tripwire_progress
- [ ] –ü–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è certificates
- [ ] –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤

‚úÖ Backend Code
- [ ] Middleware –æ–±–Ω–æ–≤–ª—ë–Ω
- [ ] –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [ ] –°–µ—Ä–≤–∏—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [ ] –¢–∏–ø—ã TypeScript —Å–æ–∑–¥–∞–Ω—ã
- [ ] –¢–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã

‚úÖ Deployment
- [ ] Backend –∑–∞–¥–µ–ø–ª–æ–µ–Ω
- [ ] PM2 –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- [ ] –õ–æ–≥–∏ —á–∏—Å—Ç—ã–µ (–Ω–µ—Ç –æ—à–∏–±–æ–∫)
- [ ] Health check —É—Å–ø–µ—à–µ–Ω

‚úÖ E2E Testing
- [ ] –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –î–∞—à–±–æ—Ä–¥ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- [ ] Stats Cards –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –¥–∞–Ω–Ω—ã–µ
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] RLS –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ Network

–§–ò–ù–ê–õ–¨–ù–´–ô –°–¢–ê–¢–£–°: ‚úÖ –§–ê–ó–ê 1A –ó–ê–í–ï–†–®–ï–ù–ê
```

---

<a name="—Ñ–∞–∑–∞-2"></a>
## üìä –§–ê–ó–ê 2: –°–ò–°–¢–ï–ú–ê –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê –ò–ù–¢–ï–ì–†–ê–¶–ò–ô

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

**–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 5-7 –¥–Ω–µ–π
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üü° –°–†–ï–î–ù–ò–ô
**–ê–≥–µ–Ω—Ç—ã:** MCP Agent (database) + Codex (code) + Browser MCP (UI)

---

### –ó–ê–î–ê–ß–ê 2.1: –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É integration_logs

**–ê–≥–µ–Ω—Ç:** MCP Agent (Database)

**–ü—Ä–æ–º–ø—Ç –¥–ª—è MCP –∞–≥–µ–Ω—Ç–∞:**

```markdown
–ó–ê–î–ê–ß–ê: –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

–ë–ê–ó–ê –î–ê–ù–ù–´–•: Landing BD (xikaiavwqinamgolmtcy)

–î–ï–ô–°–¢–í–ò–Ø:

1. –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ Landing BD

2. –°–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—É integration_logs

```sql
CREATE TABLE IF NOT EXISTS integration_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  service_name TEXT NOT NULL, -- 'amocrm', 'resend', 'telegram', 'mobizon', 'whapi'
  action TEXT NOT NULL, -- 'sync_lead', 'send_email', 'send_sms', 'send_telegram'
  status TEXT NOT NULL CHECK (status IN ('success', 'failed', 'pending', 'retrying')),
  related_entity_type TEXT, -- 'lead', 'student', 'tripwire_user'
  related_entity_id UUID, -- ID —Å—É—â–Ω–æ—Å—Ç–∏
  request_payload JSONB, -- –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
  response_payload JSONB, -- –û—Ç–≤–µ—Ç API
  error_message TEXT, -- –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏
  error_code TEXT, -- –ö–æ–¥ –æ—à–∏–±–∫–∏
  duration_ms INTEGER, -- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º—Å
  retry_count INTEGER DEFAULT 0, -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–æ–≤
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX idx_integration_logs_service_name
ON integration_logs(service_name);

CREATE INDEX idx_integration_logs_status
ON integration_logs(status);

CREATE INDEX idx_integration_logs_created_at
ON integration_logs(created_at DESC);

CREATE INDEX idx_integration_logs_related_entity
ON integration_logs(related_entity_type, related_entity_id);

-- –ß–∞—Å—Ç–∏—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è failed
CREATE INDEX idx_integration_logs_failed
ON integration_logs(service_name, created_at DESC)
WHERE status = 'failed';

-- –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
CREATE INDEX idx_integration_logs_dashboard
ON integration_logs(service_name, status, created_at DESC);
```

3. –°–æ–∑–¥–∞—Ç—å VIEW –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

```sql
CREATE OR REPLACE VIEW integration_stats_hourly AS
SELECT
  service_name,
  action,
  status,
  DATE_TRUNC('hour', created_at) as hour,
  COUNT(*) as count,
  AVG(duration_ms) as avg_duration_ms,
  MAX(duration_ms) as max_duration_ms,
  SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed_count
FROM integration_logs
WHERE created_at >= NOW() - INTERVAL '24 hours'
GROUP BY service_name, action, status, DATE_TRUNC('hour', created_at);

CREATE OR REPLACE VIEW integration_stats_daily AS
SELECT
  service_name,
  action,
  status,
  DATE_TRUNC('day', created_at) as day,
  COUNT(*) as count,
  AVG(duration_ms) as avg_duration_ms,
  SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed_count
FROM integration_logs
WHERE created_at >= NOW() - INTERVAL '30 days'
GROUP BY service_name, action, status, DATE_TRUNC('day', created_at);
```

4. –°–æ–∑–¥–∞—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏

```sql
ALTER TABLE integration_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Service role full access to integration_logs"
ON integration_logs
FOR ALL
USING (auth.role() = 'service_role');

CREATE POLICY "Authenticated users can view integration_logs"
ON integration_logs
FOR SELECT
USING (auth.role() = 'authenticated');
```

5. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤

```sql
CREATE OR REPLACE FUNCTION cleanup_old_integration_logs()
RETURNS void
LANGUAGE plpgsql
AS $$
BEGIN
  DELETE FROM integration_logs
  WHERE created_at < NOW() - INTERVAL '90 days'
    AND status = 'success'; -- –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ —Å—Ç–∞—Ä—à–µ 90 –¥–Ω–µ–π

  DELETE FROM integration_logs
  WHERE created_at < NOW() - INTERVAL '180 days'; -- –í—Å–µ –ª–æ–≥–∏ —Å—Ç–∞—Ä—à–µ 180 –¥–Ω–µ–π
END;
$$;

-- –°–æ–∑–¥–∞—Ç—å scheduled job (–µ—Å–ª–∏ Supabase –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç pg_cron)
-- SELECT cron.schedule('cleanup-integration-logs', '0 2 * * *', 'SELECT cleanup_old_integration_logs()');
```

–ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢:

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `/docs/PHASE2_INTEGRATION_LOGS_TABLE_REPORT.md`:

## –¢–ê–ë–õ–ò–¶–ê integration_logs –°–û–ó–î–ê–ù–ê

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞
- –ö–æ–ª–æ–Ω–æ–∫: 14
- –ò–Ω–¥–µ–∫—Å–æ–≤: 6
- Views: 2
- Functions: 1
- RLS: –≤–∫–ª—é—á–µ–Ω

### –ò–Ω–¥–µ–∫—Å—ã
| –ò–Ω–¥–µ–∫—Å | –ü–æ–ª—è | –¢–∏–ø |
|--------|------|-----|
| idx_integration_logs_service_name | service_name | B-tree |
| idx_integration_logs_status | status | B-tree |
| ... | ... | ... |

### Views –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- integration_stats_hourly (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞)
- integration_stats_daily (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π)

### SQL –º–∏–≥—Ä–∞—Ü–∏—è
–°–æ—Ö—Ä–∞–Ω–∏ –≤ `/sql/migrations/004_create_integration_logs_table.sql`

## –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì
–ó–∞–¥–∞—á–∞ 2.2: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ AmoCRM —Å–µ—Ä–≤–∏—Å
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–∞–±–ª–∏—Ü–∞ integration_logs —Å–æ–∑–¥–∞–Ω–∞ —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ –∏ views

---

### –ó–ê–î–ê–ß–ê 2.2: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å–µ—Ä–≤–∏—Å—ã

**–ê–≥–µ–Ω—Ç:** Codex (Code changes)

**–ü—Ä–æ–º–ø—Ç –¥–ª—è Codex –∞–≥–µ–Ω—Ç–∞:**

```markdown
–ó–ê–î–ê–ß–ê: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

–ö–û–ù–¢–ï–ö–°–¢:
- –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ integration_logs –≤ Landing BD
- –ù—É–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –≤–Ω–µ—à–Ω–∏—Ö API
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å: request, response, –æ—à–∏–±–∫–∏, –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

–ò–ó–ú–ï–ù–ï–ù–ò–Ø:

1. –°–û–ó–î–ê–¢–¨ HELPER: /backend/src/services/integrationLogger.ts

```typescript
import { landingSupabase } from '../config/supabase-landing';

interface IntegrationLogData {
  serviceName: 'amocrm' | 'resend' | 'telegram' | 'mobizon' | 'whapi';
  action: string;
  status: 'success' | 'failed' | 'pending' | 'retrying';
  relatedEntityType?: 'lead' | 'student' | 'tripwire_user';
  relatedEntityId?: string;
  requestPayload?: any;
  responsePayload?: any;
  errorMessage?: string;
  errorCode?: string;
  durationMs?: number;
  retryCount?: number;
}

export class IntegrationLogger {
  /**
   * –°–æ–∑–¥–∞—Ç—å –ª–æ–≥ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
   */
  static async log(data: IntegrationLogData): Promise<void> {
    try {
      const { error } = await landingSupabase
        .from('integration_logs')
        .insert({
          service_name: data.serviceName,
          action: data.action,
          status: data.status,
          related_entity_type: data.relatedEntityType,
          related_entity_id: data.relatedEntityId,
          request_payload: data.requestPayload,
          response_payload: data.responsePayload,
          error_message: data.errorMessage,
          error_code: data.errorCode,
          duration_ms: data.durationMs,
          retry_count: data.retryCount || 0,
        });

      if (error) {
        console.error('[IntegrationLogger] Failed to log:', error);
        // –ù–ï –±—Ä–æ—Å–∞–µ–º –æ—à–∏–±–∫—É - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ª–æ–º–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–ª–æ—É
      }
    } catch (err) {
      console.error('[IntegrationLogger] Exception:', err);
    }
  }

  /**
   * –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
   */
  static async track<T>(
    serviceName: IntegrationLogData['serviceName'],
    action: string,
    operation: () => Promise<T>,
    options?: {
      relatedEntityType?: string;
      relatedEntityId?: string;
    }
  ): Promise<T> {
    const startTime = Date.now();
    let requestPayload: any;
    let responsePayload: any;
    let status: IntegrationLogData['status'] = 'success';
    let errorMessage: string | undefined;
    let errorCode: string | undefined;

    try {
      const result = await operation();
      responsePayload = result;
      return result;
    } catch (error: any) {
      status = 'failed';
      errorMessage = error.message || 'Unknown error';
      errorCode = error.code || error.status?.toString();
      throw error; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–ª—å—à–µ
    } finally {
      const durationMs = Date.now() - startTime;

      await this.log({
        serviceName,
        action,
        status,
        relatedEntityType: options?.relatedEntityType as any,
        relatedEntityId: options?.relatedEntityId,
        requestPayload,
        responsePayload,
        errorMessage,
        errorCode,
        durationMs,
      });
    }
  }
}
```

2. –û–ë–ù–û–í–ò–¢–¨: /backend/src/services/amoCrmService.ts

–î–æ–±–∞–≤—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã:

```typescript
import { IntegrationLogger } from './integrationLogger';

// –í –º–µ—Ç–æ–¥–µ syncLead
export async function syncLead(leadData: any): Promise<void> {
  return IntegrationLogger.track(
    'amocrm',
    'sync_lead',
    async () => {
      // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ syncLead
      const response = await amoCrmClient.post('/api/v4/leads', leadData);
      return response.data;
    },
    {
      relatedEntityType: 'lead',
      relatedEntityId: leadData.id,
    }
  );
}

// –í –º–µ—Ç–æ–¥–µ onTripwireStudentCreated
export async function onTripwireStudentCreated(
  studentEmail: string,
  studentName: string
): Promise<void> {
  return IntegrationLogger.track(
    'amocrm',
    'create_tripwire_deal',
    async () => {
      // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞
      const response = await amoCrmClient.post('/api/v4/leads', {
        name: `Tripwire - ${studentName}`,
        // ...
      });
      return response.data;
    },
    {
      relatedEntityType: 'tripwire_user',
    }
  );
}

// –í –º–µ—Ç–æ–¥–µ onLessonCompleted
export async function onLessonCompleted(
  userEmail: string,
  lessonNumber: number
): Promise<void> {
  return IntegrationLogger.track(
    'amocrm',
    `lesson_${lessonNumber}_completed`,
    async () => {
      // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç—Ç–∞–ø–∞
      const response = await amoCrmClient.patch(`/api/v4/leads/${leadId}`, {
        status_id: newStatusId,
      });
      return response.data;
    },
    {
      relatedEntityType: 'tripwire_user',
    }
  );
}
```

3. –û–ë–ù–û–í–ò–¢–¨: /backend/src/services/emailService.ts

```typescript
import { IntegrationLogger } from './integrationLogger';

// –í –º–µ—Ç–æ–¥–µ sendTripwireWelcomeEmail
export async function sendTripwireWelcomeEmail(
  to: string,
  studentName: string,
  loginUrl: string
): Promise<void> {
  return IntegrationLogger.track(
    'resend',
    'send_tripwire_welcome_email',
    async () => {
      const response = await resend.emails.send({
        from: 'OnAI Academy <noreply@onai.academy>',
        to,
        subject: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Tripwire!',
        html: tripwireWelcomeTemplate({ studentName, loginUrl }),
      });
      return response;
    },
    {
      relatedEntityType: 'tripwire_user',
    }
  );
}

// –í –º–µ—Ç–æ–¥–µ sendCertificateEmail
export async function sendCertificateEmail(
  to: string,
  studentName: string,
  certificateUrl: string
): Promise<void> {
  return IntegrationLogger.track(
    'resend',
    'send_certificate_email',
    async () => {
      const response = await resend.emails.send({
        from: 'OnAI Academy <noreply@onai.academy>',
        to,
        subject: '–í–∞—à —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Tripwire –≥–æ—Ç–æ–≤!',
        html: certificateTemplate({ studentName, certificateUrl }),
      });
      return response;
    },
    {
      relatedEntityType: 'tripwire_user',
    }
  );
}
```

4. –û–ë–ù–û–í–ò–¢–¨: /backend/src/services/telegramService.ts

```typescript
import { IntegrationLogger } from './integrationLogger';

// –í –º–µ—Ç–æ–¥–µ sendLeadNotification
export async function sendLeadNotification(
  leadData: any,
  groupType: string
): Promise<void> {
  return IntegrationLogger.track(
    'telegram',
    'send_lead_notification',
    async () => {
      const message = formatLeadMessage(leadData);
      const response = await telegramBot.sendMessage(chatId, message, {
        parse_mode: 'HTML',
      });
      return response;
    },
    {
      relatedEntityType: 'lead',
      relatedEntityId: leadData.id,
    }
  );
}
```

5. –û–ë–ù–û–í–ò–¢–¨: /backend/src/services/mobizon.ts

```typescript
import { IntegrationLogger } from './integrationLogger';

// –í –º–µ—Ç–æ–¥–µ sendSMS
export async function sendSMS(
  phone: string,
  message: string
): Promise<void> {
  return IntegrationLogger.track(
    'mobizon',
    'send_sms',
    async () => {
      const response = await mobizonClient.post('/service/message/sendsmsmessage', {
        recipient: phone,
        text: message,
      });
      return response.data;
    }
  );
}
```

–ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢:

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `/docs/PHASE2_LOGGING_INTEGRATION_REPORT.md`:

## –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –î–û–ë–ê–í–õ–ï–ù–û –í–û –í–°–ï –°–ï–†–í–ò–°–´

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- ‚úÖ /backend/src/services/integrationLogger.ts (–Ω–æ–≤—ã–π)

### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- ‚úÖ /backend/src/services/amoCrmService.ts
- ‚úÖ /backend/src/services/emailService.ts
- ‚úÖ /backend/src/services/telegramService.ts
- ‚úÖ /backend/src/services/mobizon.ts

### –õ–æ–≥–∏—Ä—É–µ–º—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

**AmoCRM:**
- sync_lead
- create_tripwire_deal
- lesson_X_completed

**Resend:**
- send_tripwire_welcome_email
- send_certificate_email

**Telegram:**
- send_lead_notification

**Mobizon:**
- send_sms

### –ú–µ—Ç—Ä–∏–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- Request payload: –¥–∞
- Response payload: –¥–∞
- Duration: –¥–∞ (–º—Å)
- Error handling: –¥–∞

## –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì
–ó–∞–¥–∞—á–∞ 2.3: –°–æ–∑–¥–∞—Ç—å API endpoint –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤–æ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã

---

### –ó–ê–î–ê–ß–ê 2.3: –°–æ–∑–¥–∞—Ç—å API –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–ê–≥–µ–Ω—Ç:** Codex (Code)

**–ü—Ä–æ–º–ø—Ç:**

```markdown
–ó–ê–î–ê–ß–ê: –°–æ–∑–¥–∞—Ç—å API endpoints –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

–°–û–ó–î–ê–¢–¨ –§–ê–ô–õ: /backend/src/routes/integration-monitoring.ts

```typescript
import express from 'express';
import { landingSupabase } from '../config/supabase-landing';
import { authenticateJWT } from '../middleware/auth';

const router = express.Router();

/**
 * GET /api/integration-monitoring/stats
 * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
 */
router.get('/stats', authenticateJWT, async (req, res) => {
  try {
    const { data, error } = await landingSupabase
      .from('integration_stats_hourly')
      .select('*')
      .order('hour', { ascending: false });

    if (error) throw error;

    res.json({ stats: data });
  } catch (error: any) {
    console.error('[Monitoring] Error fetching stats:', error);
    res.status(500).json({ error: error.message });
  }
});

/**
 * GET /api/integration-monitoring/failures
 * –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
 */
router.get('/failures', authenticateJWT, async (req, res) => {
  try {
    const limit = parseInt(req.query.limit as string) || 50;

    const { data, error } = await landingSupabase
      .from('integration_logs')
      .select('*')
      .eq('status', 'failed')
      .order('created_at', { ascending: false })
      .limit(limit);

    if (error) throw error;

    res.json({ failures: data });
  } catch (error: any) {
    console.error('[Monitoring] Error fetching failures:', error);
    res.status(500).json({ error: error.message });
  }
});

/**
 * GET /api/integration-monitoring/service/:serviceName
 * –ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
 */
router.get('/service/:serviceName', authenticateJWT, async (req, res) => {
  try {
    const { serviceName } = req.params;
    const limit = parseInt(req.query.limit as string) || 100;

    const { data, error } = await landingSupabase
      .from('integration_logs')
      .select('*')
      .eq('service_name', serviceName)
      .order('created_at', { ascending: false })
      .limit(limit);

    if (error) throw error;

    res.json({ logs: data, serviceName });
  } catch (error: any) {
    console.error('[Monitoring] Error fetching service logs:', error);
    res.status(500).json({ error: error.message });
  }
});

/**
 * POST /api/integration-monitoring/retry/:logId
 * –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –Ω–µ—É–¥–∞–≤—à—É—é—Å—è –æ–ø–µ—Ä–∞—Ü–∏—é
 */
router.post('/retry/:logId', authenticateJWT, async (req, res) => {
  try {
    const { logId } = req.params;

    // –ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥
    const { data: log, error: fetchError } = await landingSupabase
      .from('integration_logs')
      .select('*')
      .eq('id', logId)
      .single();

    if (fetchError || !log) {
      return res.status(404).json({ error: 'Log not found' });
    }

    // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å retry –ª–æ–≥–∏–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
    // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ 'retrying'

    const { error: updateError } = await landingSupabase
      .from('integration_logs')
      .update({
        status: 'retrying',
        retry_count: (log.retry_count || 0) + 1,
        updated_at: new Date().toISOString(),
      })
      .eq('id', logId);

    if (updateError) throw updateError;

    res.json({ message: 'Retry initiated', logId });
  } catch (error: any) {
    console.error('[Monitoring] Error retrying operation:', error);
    res.status(500).json({ error: error.message });
  }
});

export default router;
```

–ü–û–î–ö–õ–Æ–ß–ò–¢–¨ –í: /backend/src/server.ts

```typescript
import integrationMonitoringRoutes from './routes/integration-monitoring';

// ...

app.use('/api/integration-monitoring', integrationMonitoringRoutes);
```

–ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢:

–°–æ–∑–¥–∞–π —Ñ–∞–π–ª `/docs/PHASE2_MONITORING_API_REPORT.md`:

## API –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê –°–û–ó–î–ê–ù

### Endpoints

| Method | Path | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|------|----------|
| GET | /api/integration-monitoring/stats | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 24—á |
| GET | /api/integration-monitoring/failures | –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ |
| GET | /api/integration-monitoring/service/:name | –õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞ |
| POST | /api/integration-monitoring/retry/:logId | Retry –æ–ø–µ—Ä–∞—Ü–∏–∏ |

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- –¢—Ä–µ–±—É–µ—Ç—Å—è JWT token
- Middleware: authenticateJWT

### –¢–µ—Å—Ç—ã
```bash
# –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
curl -H "Authorization: Bearer <token>" \
  https://onai.academy/api/integration-monitoring/stats

# –¢–µ—Å—Ç failures
curl -H "Authorization: Bearer <token>" \
  https://onai.academy/api/integration-monitoring/failures?limit=10
```

## –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì
–ó–∞–¥–∞—á–∞ 2.4: –°–æ–∑–¥–∞—Ç—å UI –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** API endpoints —Å–æ–∑–¥–∞–Ω—ã

---

[–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –§–ê–ó–´ 2, –§–ê–ó–´ 3, –§–ê–ó–´ 4 –≤ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞...]

---

<a name="—Ñ–∞–∑–∞-3"></a>
## ‚ö° –§–ê–ó–ê 3: –ò–ù–î–ï–ö–°–ê–¶–ò–Ø –ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø

[–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –§–∞–∑—ã 3 - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –ë–î]

---

<a name="—Ñ–∞–∑–∞-4"></a>
## üìö –§–ê–ó–ê 4: –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø –ò –£–õ–£–ß–®–ï–ù–ò–Ø

[–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ - —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º]

---

## üìä –¢–†–ï–ö–ò–ù–ì –ü–†–û–ì–†–ï–°–°–ê

–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç —á–µ–∫–ª–∏—Å—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:

### –§–ê–ó–ê 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ‚úÖ
- [ ] –ó–∞–¥–∞—á–∞ 0.1: –ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- [ ] –ó–∞–¥–∞—á–∞ 0.2: UI –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
- [ ] –ó–∞–¥–∞—á–∞ 0.3: –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è

### –§–ê–ó–ê 1: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Ä–∞–∑—Ä—ã–≤ üî¥
- [ ] –ó–∞–¥–∞—á–∞ 1A.1: Auth migration
- [ ] –ó–∞–¥–∞—á–∞ 1A.2: Foreign Key
- [ ] –ó–∞–¥–∞—á–∞ 1A.3: RLS policies
- [ ] –ó–∞–¥–∞—á–∞ 1A.4: Backend code
- [ ] –ó–∞–¥–∞—á–∞ 1A.5: Deploy & E2E

### –§–ê–ó–ê 2: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ üü°
- [ ] –ó–∞–¥–∞—á–∞ 2.1: –¢–∞–±–ª–∏—Ü–∞ integration_logs
- [ ] –ó–∞–¥–∞—á–∞ 2.2: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å–µ—Ä–≤–∏—Å—ã
- [ ] –ó–∞–¥–∞—á–∞ 2.3: API –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- [ ] –ó–∞–¥–∞—á–∞ 2.4: UI –¥–∞—à–±–æ—Ä–¥

### –§–ê–ó–ê 3: –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è üü°
- [ ] –ó–∞–¥–∞—á–∞ 3.1: Tripwire –∏–Ω–¥–µ–∫—Å—ã
- [ ] –ó–∞–¥–∞—á–∞ 3.2: Landing –∏–Ω–¥–µ–∫—Å—ã
- [ ] –ó–∞–¥–∞—á–∞ 3.3: Performance —Ç–µ—Å—Ç—ã

---

**–ö–æ–Ω–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞**
**–í–µ—Ä—Å–∏—è:** 1.0
**–î–∞—Ç–∞:** 30 –¥–µ–∫–∞–±—Ä—è 2025
