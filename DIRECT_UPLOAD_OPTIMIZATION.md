# üöÄ Direct Upload to Bunny CDN - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

**–î–∞—Ç–∞:** 14 –¥–µ–∫–∞–±—Ä—è 2025  
**–¶–µ–ª—å:** –£—Å–∫–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –≤–∏–¥–µ–æ –≤ 10 —Ä–∞–∑ (—Å 20+ –º–∏–Ω—É—Ç –¥–æ 2-3 –º–∏–Ω—É—Ç –¥–ª—è —Ñ–∞–π–ª–æ–≤ 4-6GB)

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

| –ú–µ—Ç—Ä–∏–∫–∞ | –°—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ | –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ (Direct Upload) |
|---------|--------------|------------------------------|
| **–°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ 4GB** | 20+ –º–∏–Ω—É—Ç | 2-3 –º–∏–Ω—É—Ç—ã |
| **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä** | –í—ã—Å–æ–∫–∞—è (–≤–µ—Å—å —Ñ–∞–π–ª –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä) | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è (—Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î) |
| **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞** | –î–æ 17GB –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ | 0 –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ |
| **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å** | –ó–∞–≤–∏—Å–∞–µ—Ç –Ω–∞ 68-93%, —Ç—Ä–µ–±—É–µ—Ç "–ø–∏–Ω–∫–æ–≤" | –°—Ç–∞–±–∏–ª—å–Ω–∞—è –ø—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ |

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### Backend (`backend/src/routes/streamUpload.ts`)

#### 1. **–ù–æ–≤—ã–π endpoint: `/api/stream/get-upload-url`**
–°–æ–∑–¥–∞–µ—Ç –≤–∏–¥–µ–æ –≤ Bunny CDN –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL –¥–ª—è –ø—Ä—è–º–æ–π –∑–∞–≥—Ä—É–∑–∫–∏.

```typescript
POST /api/stream/get-upload-url
Body: {
  "lessonId": "123",
  "title": "–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞",
  "fileName": "video.mp4"
}

Response: {
  "success": true,
  "videoId": "abc-123-def",
  "uploadUrl": "https://video.bunnycdn.com/library/551815/videos/abc-123-def",
  "apiKey": "45c733d5-...",
  "lessonId": "123",
  "title": "–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞"
}
```

#### 2. **–ù–æ–≤—ã–π endpoint: `/api/stream/complete-upload`**
–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —É—Å–ø–µ—à–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

```typescript
POST /api/stream/complete-upload
Body: {
  "videoId": "abc-123-def",
  "lessonId": "123",
  "duration_seconds": "120",
  "fileName": "video.mp4",
  "fileSize": 4294967296
}

Response: {
  "success": true,
  "videoId": "abc-123-def"
}
```

---

### Frontend (`src/components/tripwire/TripwireLessonEditDialog.tsx`)

–û–±–Ω–æ–≤–ª–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:

**–°—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ (—á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä):**
```
Browser ‚Üí [FormData POST] ‚Üí Server ‚Üí [Temp File] ‚Üí Bunny CDN
         20+ –º–∏–Ω—É—Ç               10+ –º–∏–Ω—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏
```

**–ù–æ–≤—ã–π –º–µ—Ç–æ–¥ (Direct Upload):**
```
1. Browser ‚Üí Backend: POST /get-upload-url (–ø–æ–ª—É—á–∏—Ç—å URL)
2. Browser ‚Üí Bunny CDN: PUT {videoFile} (–∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é - 2-3 –º–∏–Ω)
3. Browser ‚Üí Backend: POST /complete-upload (–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å)
```

---

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü–æ—Ç–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ (Edit —Ä–µ–∂–∏–º)

```typescript
// –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å Upload URL –æ—Ç backend
const uploadUrlResponse = await fetch('/api/stream/get-upload-url', {
  method: 'POST',
  body: JSON.stringify({ lessonId, title, fileName })
});

// –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ –ù–ê–ü–†–Ø–ú–£–Æ –≤ Bunny CDN
const xhr = new XMLHttpRequest();
xhr.open('PUT', uploadData.uploadUrl);
xhr.setRequestHeader('AccessKey', uploadData.apiKey);
xhr.setRequestHeader('Content-Type', 'application/octet-stream');
xhr.send(videoFile); // ‚Üê –ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞!

// –®–∞–≥ 3: –£–≤–µ–¥–æ–º–∏—Ç—å backend –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
await fetch('/api/stream/complete-upload', {
  method: 'POST',
  body: JSON.stringify({ videoId, lessonId, duration_seconds, fileName, fileSize })
});
```

---

## üí° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **‚ö° –°–∫–æ—Ä–æ—Å—Ç—å:** 10x –±—ã—Å—Ç—Ä–µ–µ –∑–∞ —Å—á–µ—Ç –ø—Ä—è–º–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤ CDN
2. **üíæ –≠–∫–æ–Ω–æ–º–∏—è –¥–∏—Å–∫–∞:** –ù–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
3. **üîã –ù–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞:** –°–µ—Ä–≤–µ—Ä —Ç–æ–ª—å–∫–æ –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç, –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
4. **üõ°Ô∏è –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** –ù–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π –Ω–∞ 68-93%, —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
5. **üìä –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä:** –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ `XMLHttpRequest.upload.progress`

---

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —É—Ä–æ–∫–æ–≤

–°—Ç–∞—Ä—ã–µ —É—Ä–æ–∫–∏ —Å –≤–∏–¥–µ–æ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å. Direct Upload –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è **–Ω–æ–≤—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫**.

---

## üö® –í–∞–∂–Ω–æ

1. **–°—Ç–∞—Ä—ã–π endpoint `/api/stream/upload` –æ—Å—Ç–∞–≤–ª–µ–Ω** –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
2. **Bunny CDN credentials** –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ `env.env`:
   - `BUNNY_STREAM_API_KEY=45c733d5-8b83-45ff-ad6a503d2387-6392-439f`
   - `BUNNY_STREAM_CDN_HOSTNAME=vz-60da25d1-436.b-cdn.net`
   - `BUNNY_STREAM_LIBRARY_ID=551815`

3. **Timeout —É–≤–µ–ª–∏—á–µ–Ω –¥–æ 2 —á–∞—Å–æ–≤** –≤ `backend/src/server.ts` (–Ω–∞ —Å–ª—É—á–∞–π –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)

---

## üìù –î–µ–ø–ª–æ–π

```bash
# 1. Frontend
cd /var/www/onai-integrator-login-main
git pull origin main
npm run build

# 2. Backend
cd backend
pm2 restart onai-backend --update-env

# 3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å __dirname –¥—É–±–ª–∏–∫–∞—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
sed -i '51d' /var/www/onai-integrator-login-main/backend/dist/server.js
sed -i '45d' /var/www/onai-integrator-login-main/backend/dist/load-env.js
pm2 restart onai-backend --update-env
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

1. –û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Tripwire: `https://onai.academy/tripwire/manager`
2. –°–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —É—Ä–æ–∫
3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 100MB+ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞)
4. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º: –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "üöÄ –ü—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: X MB / Y MB (Z%)"
5. –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ –¥–æ–ª–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —É—Ä–æ–∫–∞

---

## üêõ Troubleshooting

### –û—à–∏–±–∫–∞: "Failed to get upload URL"
**–ü—Ä–∏—á–∏–Ω–∞:** Backend –Ω–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –≤–∏–¥–µ–æ –≤ Bunny CDN  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `BUNNY_STREAM_API_KEY` –≤ `env.env`

### –û—à–∏–±–∫–∞: "Direct upload failed with status 401"
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π API key  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `BUNNY_STREAM_API_KEY`

### –í–∏–¥–µ–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
**–ü—Ä–∏—á–∏–Ω–∞:** Bunny CDN –µ—â–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–∏–¥–µ–æ  
**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

- **Bunny CDN Stream API:** https://docs.bunny.net/docs/stream
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:** 8GB (–Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ `server.ts`)
- **Timeout:** 2 —á–∞—Å–∞ (7200000 –º—Å)
- **–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:** –ö–∞–∂–¥—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ —á–µ—Ä–µ–∑ XMLHttpRequest events

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 14 –¥–µ–∫–∞–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω
