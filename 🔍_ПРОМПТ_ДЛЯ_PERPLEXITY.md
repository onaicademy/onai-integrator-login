# üîç –ü–†–û–ú–ü–¢ –î–õ–Ø PERPLEXITY AI

## –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
- Node.js + Express.js + TypeScript
- Telegram Bot API (node-telegram-bot-api)
- Supabase (PostgreSQL)
- BullMQ –¥–ª—è –æ—á–µ—Ä–µ–¥–µ–π (—Ç—Ä–µ–±—É–µ—Ç Redis)
- ioredis –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis
- pino –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
- Backend API –Ω–∞ Express
- Telegram –±–æ—Ç –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ª–∏–¥–∞—Ö
- –ë–î –≤ Supabase (–¥–≤–µ –±–∞–∑—ã: –æ—Å–Ω–æ–≤–Ω–∞—è + Landing DB)
- Redis –¥–ª—è –æ—á–µ—Ä–µ–¥–µ–π BullMQ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## –ü–†–û–ë–õ–ï–ú–´

### 1. üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø: Redis –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–µ—Å—å —Å–µ—Ä–≤–µ—Ä

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ Redis –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ `redis://localhost:6379`
- Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ –∑–∞–ø—É—â–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ)
- ioredis –¥–µ–ª–∞–µ—Ç –ë–ï–°–ö–û–ù–ï–ß–ù–´–ï –ø–æ–ø—ã—Ç–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –ö–∞–∂–¥–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç 2 —Å–µ–∫—É–Ω–¥—ã
- Event loop Node.js **–ø–æ–ª–Ω–æ—Å—Ç—å—é –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è**
- –°–µ—Ä–≤–µ—Ä –ù–ï –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ HTTP –∑–∞–ø—Ä–æ—Å—ã (timeout –Ω–∞ –≤—Å–µ—Ö endpoints)
- –ü–æ—Ä—Ç 3000 –æ—Ç–∫—Ä—ã—Ç, –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã

**–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Redis:**
```typescript
import Redis from 'ioredis';

export const redis = new Redis(REDIS_URL, {
  maxRetriesPerRequest: null, // Required for BullMQ
  enableReadyCheck: false,
  lazyConnect: true,
  retryStrategy: (times) => {
    if (times > 10) {
      return null; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏
    }
    return Math.min(times * 100, 2000);
  },
});

// –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
redis.connect().catch((err) => {
  logger.warn('Redis not available');
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–∞–∂–µ —Å `lazyConnect: true` –∏ `retryStrategy` —Å –ª–∏–º–∏—Ç–æ–º –≤ 10 –ø–æ–ø—ã—Ç–æ–∫, Redis –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –ø—ã—Ç–∞—Ç—å—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∏ **–±–ª–æ–∫–∏—Ä—É–µ—Ç event loop**.

**–ß—Ç–æ –ø—Ä–æ–±–æ–≤–∞–ª–∏:**
- ‚úÖ `lazyConnect: true`
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –≤ `retryStrategy`
- ‚úÖ –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π `.connect().catch()`
- ‚ùå –°–µ—Ä–≤–µ—Ä –≤—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–≤–∏—Å–∞–µ—Ç

### 2. üêõ Supabase –∑–∞–ø—Ä–æ—Å—ã –∑–∞–≤–∏—Å–∞—é—Ç

**–°–∏–º–ø—Ç–æ–º—ã:**
- API endpoint `/api/telegram-leads/health` –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Supabase
- –ó–∞–ø—Ä–æ—Å: `landingSupabase.from('telegram_groups').select('count').eq('is_active', true).single()`
- –ó–∞–ø—Ä–æ—Å –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è (–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ)
- Endpoint –∑–∞–≤–∏—Å–∞–µ—Ç –∏ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase:**
```typescript
const landingSupabase = createClient(
  LANDING_SUPABASE_URL, 
  LANDING_SUPABASE_SERVICE_KEY, 
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false
    }
  }
);
```

**–ß—Ç–æ –ø—Ä–æ–±–æ–≤–∞–ª–∏:**
- ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ `Promise.race()` —Å timeout 3 —Å–µ–∫—É–Ω–¥—ã
- ‚ùå –í—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–≤–∏—Å–∞–µ—Ç

### 3. ‚ö†Ô∏è pino-pretty —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–û—à–∏–±–∫–∞:**
```
Error: unable to determine transport target for "pino-pretty"
```

**–ß—Ç–æ —Å–¥–µ–ª–∞–ª–∏:**
- ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ try-catch –∏ fallback –Ω–∞ –±–∞–∑–æ–≤—ã–π `pino()`
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ –∫—Ä–∞—Å–∏–≤–æ

## –ß–¢–û –ù–£–ñ–ù–û –ù–ê–ô–¢–ò

### –ì–ª–∞–≤–Ω—ã–π –≤–æ–ø—Ä–æ—Å:
**–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫, —á—Ç–æ–±—ã ioredis –ù–ï –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª Node.js event loop –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–∞—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–º—É Redis, –∏ —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–¥–æ–ª–∂–∞–ª –Ω–æ—Ä–º–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å?**

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ—à–µ–Ω–∏—é:

1. **Redis –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º:**
   - –ï—Å–ª–∏ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –Ω–µ–≥–æ
   - BullMQ –æ—á–µ—Ä–µ–¥–∏ –æ—Ç–∫–ª—é—á–∞—é—Ç—Å—è, –Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–∞–±–æ—Ç–∞–µ—Ç
   - –ù–∏–∫–∞–∫–∏—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ event loop

2. **Supabase –∑–∞–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å timeout:**
   - –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ –≤–µ—Ä–Ω—É–ª—Å—è –∑–∞ N —Å–µ–∫—É–Ω–¥ ‚Üí abort
   - Endpoint –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ—Ç–≤–µ—Ç, –¥–∞–∂–µ –µ—Å–ª–∏ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

3. **Graceful degradation:**
   - –°–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –í–°–ï–ì–î–ê
   - –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (Redis, –ë–î) –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
   - –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ –ª–æ–º–∞—é—Ç —Ä–∞–±–æ—Ç—É

4. **Production-ready:**
   - –†–∞–±–æ—Ç–∞–µ—Ç –∏ –≤ development (polling mode –±–æ—Ç–∞)
   - –†–∞–±–æ—Ç–∞–µ—Ç –∏ –≤ production (webhook mode –±–æ—Ç–∞)

## –ö–û–ù–ö–†–ï–¢–ù–´–ï –í–û–ü–†–û–°–´

1. **–ï—Å—Ç—å –ª–∏ —Å–ø–æ—Å–æ–± –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å ioredis –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å/worker?**

2. **–ú–æ–∂–µ—Ç –ª–∏ `maxRetriesPerRequest: null` (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è BullMQ) –±—ã—Ç—å –ø—Ä–∏—á–∏–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏?**

3. **–ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `lazyConnect: true` —Å `.connect().catch()`?**

4. **–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å timeout –¥–ª—è Supabase SDK –∑–∞–ø—Ä–æ—Å–æ–≤?** (Supabase JS SDK –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–∞—Ç–∏–≤–Ω—ã–π timeout)

5. **–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è optional Redis –≤ Node.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:**
   - –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Redis –ë–ï–ó –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏?
   - –ö–∞–∫ –æ—Ç–∫–ª—é—á–∏—Ç—å BullMQ –µ—Å–ª–∏ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω?
   - –ü–∞—Ç—Ç–µ—Ä–Ω—ã graceful degradation

6. **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã BullMQ/Redis –¥–ª—è –æ—á–µ—Ä–µ–¥–µ–π:**
   - –ú–æ–∂–µ—Ç –±—ã—Ç—å –µ—Å—Ç—å in-memory –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è fallback?
   - –ò–ª–∏ PostgreSQL-based –æ—á–µ—Ä–µ–¥–∏ (pgboss)?

## –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø

**–û–∫—Ä—É–∂–µ–Ω–∏–µ:**
- macOS (development)
- Node.js v22.17.0
- TypeScript
- Redis –ù–ï —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ (–∏ –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è development)

**–õ–æ–≥ –æ—à–∏–±–∫–∏:**
```
Redis retry 105/10 in 2000ms
‚ö†Ô∏è Redis connection closed
üîÑ Redis reconnecting...
[–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è]
```

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞:**
```bash
$ lsof -i :3000 -sTCP:LISTEN
node    60303  ...  TCP *:hbci (LISTEN)  # –ü–æ—Ä—Ç –æ—Ç–∫—Ä—ã—Ç

$ curl http://localhost:3000/api/telegram-leads/health
[timeout after 30 seconds, no response]  # –ù–µ –æ—Ç–≤–µ—á–∞–µ—Ç
```

**–í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω—ã –∑–∞–ø—Ä–æ—Å—ã, –Ω–æ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤:**
```
GET /api/telegram-leads/health
GET /api/telegram-leads/active-groups
[no response logs]
```

## –ñ–ï–õ–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

**–ò–¥–µ–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
```typescript
// Redis –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ, –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç–∞—Ä—Ç
const redis = initRedisOptional();

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (–±—ã—Å—Ç—Ä–∞—è, –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è)
const redisReady = await checkRedis(); // < 100ms

if (redisReady) {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º BullMQ –æ—á–µ—Ä–µ–¥–∏
  setupQueues();
} else {
  // –†–∞–±–æ—Ç–∞–µ–º –±–µ–∑ –æ—á–µ—Ä–µ–¥–µ–π
  logger.info('Working without Redis queues');
}

// –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã
app.listen(3000); // ‚úÖ –í—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
```

## –ü–û–ñ–ê–õ–£–ô–°–¢–ê, –ù–ê–ô–î–ò:

1. **Working examples** ioredis —Å –ø–æ–ª–Ω—ã–º graceful degradation
2. **Best practices** –¥–ª—è optional Redis –≤ Node.js
3. **Production solutions** –æ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
4. **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã** –∫ –æ—á–µ—Ä–µ–¥—è–º –±–µ–∑ Redis
5. **Code snippets** –≥–æ—Ç–æ–≤—ã–µ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

---

**–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:**
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è —Å –∫–æ–¥–æ–º
- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ—á–µ–º—É —Ç–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- Best practices –∏–∑ production –ø—Ä–æ–µ–∫—Ç–æ–≤
- –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é/–ø—Ä–∏–º–µ—Ä—ã
