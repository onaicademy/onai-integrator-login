# üêõ BUG FIX: 409 Conflict –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–î–∞—Ç–∞:** 20 –¥–µ–∫–∞–±—Ä—è 2025  
**–í—Ä–µ–º—è:** 21:50 UTC  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üö® –ü–†–û–ë–õ–ï–ú–ê

**–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ –≤ Sales Manager –ø–∞–Ω–µ–ª–∏:**

```
Failed to load resource: the server responded with a status of 409 ()
```

**Backend –ª–æ–≥–∏:**
```
‚ùå [SUPABASE] Insert failed: Error: module_unlocks: duplicate key value violates unique constraint "module_unlocks_user_id_module_id_key"
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:**
1. Sales Manager —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
2. Backend —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ `tripwire_users`
3. **–¢—Ä–∏–≥–≥–µ—Ä** `auto_unlock_first_module_on_user_creation` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏ —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ `module_unlocks`
4. Backend –ø—ã—Ç–∞–µ—Ç—Å—è **–í–†–£–ß–ù–£–Æ** –≤—Å—Ç–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ `module_unlocks`
5. **–ö–û–ù–§–õ–ò–ö–¢!** –ó–∞–ø–∏—Å—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí 409 –æ—à–∏–±–∫–∞

---

## üîç ROOT CAUSE

**–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏:**

### –¢—Ä–∏–≥–≥–µ—Ä (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π):
```sql
CREATE TRIGGER auto_unlock_first_module_on_user_creation
AFTER INSERT ON tripwire_users
FOR EACH ROW
EXECUTE FUNCTION auto_unlock_first_module();
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ `module_unlocks` –¥–ª—è –º–æ–¥—É–ª—è 16
- –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ INSERT –≤ `tripwire_users`

### Backend (—Ä—É—á–Ω–æ–π):
```typescript
// 4. module_unlocks (Module 16)
const { error: unlockError } = await tripwireAdminSupabase
  .from('module_unlocks')
  .insert({
    user_id: userId,
    module_id: 16,
    unlocked_at: new Date().toISOString()
  });
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü—ã—Ç–∞–µ—Ç—Å—è –≤—Å—Ç–∞–≤–∏—Ç—å —Ç—É –∂–µ —Å–∞–º—É—é –∑–∞–ø–∏—Å—å
- **–ö–û–ù–§–õ–ò–ö–¢** —Å —Ç—Ä–∏–≥–≥–µ—Ä–æ–º!

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

**–£–±—Ä–∞—Ç—å —Ä—É—á–Ω—É—é –≤—Å—Ç–∞–≤–∫—É –∏–∑ backend!**

### –î–û (—Å–ª–æ–º–∞–Ω–æ):
```typescript
// 4. module_unlocks (Module 16)
const { error: unlockError } = await tripwireAdminSupabase
  .from('module_unlocks')
  .insert({
    user_id: userId,
    module_id: 16,
    unlocked_at: new Date().toISOString()
  });
if (unlockError) throw new Error(`module_unlocks: ${unlockError.message}`);
console.log('   ‚úÖ module_unlocks');
```

### –ü–û–°–õ–ï (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ):
```typescript
// 4. module_unlocks - –ü–†–û–ü–£–°–ö–ê–ï–ú! 
// –¢—Ä–∏–≥–≥–µ—Ä auto_unlock_first_module_on_user_creation –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –∑–∞–ø–∏—Å—å
console.log('   ‚è≠Ô∏è  module_unlocks (skipped - will be created by trigger)');
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ù–µ—Ç 409 –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- ‚úÖ –ö–æ–¥ —á–∏—â–µ –∏ –ø—Ä–æ—â–µ

---

## üõ†Ô∏è –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### –§–∞–π–ª:
`backend/src/services/tripwireManagerService.ts`

### –°—Ç—Ä–æ–∫–∏:
- **–£–¥–∞–ª–µ–Ω–æ:** 129-138 (—Ä—É—á–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ –≤ module_unlocks)
- **–î–æ–±–∞–≤–ª–µ–Ω–æ:** –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ —Ç–æ–º —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä —Å–ø—Ä–∞–≤–∏—Ç—Å—è —Å–∞–º

### Commit:
```
96358e1 üêõ Fix: Remove manual module_unlocks insert (trigger handles it)
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ (–ª–æ–∫–∞–ª—å–Ω–æ)

```
1. –û—Ç–∫—Ä—ã—Ç—å Sales Manager: /integrator/sales-manager
2. –ù–∞–∂–∞—Ç—å "–î–û–ë–ê–í–ò–¢–¨ –£–ß–ï–ù–ò–ö–ê"
3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É:
   - –§–ò–û: Test Student
   - Email: test123@example.com
   - –ü–∞—Ä–æ–ª—å: test1234
4. –ù–∞–∂–∞—Ç—å "–°–û–ó–î–ê–¢–¨"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –°—Ç—É–¥–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω –ë–ï–ó –æ—à–∏–±–æ–∫

---

### –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ module_unlocks

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º–æ–¥—É–ª—å 16 —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
SELECT * FROM module_unlocks 
WHERE user_id = (
  SELECT user_id FROM tripwire_users 
  WHERE email = 'test123@example.com'
) AND module_id = 16;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
id | user_id | module_id | unlocked_at
---+---------+-----------+------------
1  | uuid... | 16        | 2025-12-20...
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞ –¢–†–ò–ì–ì–ï–†–û–ú (–Ω–µ backend)

---

### –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

```
1. –ê–º–∏–Ω–∞ –∑–∞—Ö–æ–¥–∏—Ç –Ω–∞ Sales Manager
2. –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: 409 –æ—à–∏–±–∫–∏ –±–æ–ª—å—à–µ –ù–ï–¢
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ë–ï–ó –æ—à–∏–±–æ–∫

---

## üìä –î–ï–ü–õ–û–ô

### Backend:

**1. Commit & Push:**
```bash
git add -A
git commit -m "üêõ Fix: Remove manual module_unlocks insert (trigger handles it)"
git push origin main
```

**2. Deploy –Ω–∞ —Å–µ—Ä–≤–µ—Ä:**
```bash
ssh root@207.154.231.30 "cd /var/www/onai-integrator-login-main && git pull origin main && pm2 restart onai-backend"
```

**3. –ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
pm2 logs onai-backend --lines 20
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

---

## üéØ –ò–¢–û–ì

### –ß—Ç–æ –±—ã–ª–æ:
- ‚ùå 409 –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞
- ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ (—Ç—Ä–∏–≥–≥–µ—Ä + backend)
- ‚ùå Sales Manager –Ω–µ –º–æ–≥ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤

### –ß—Ç–æ —Å—Ç–∞–ª–æ:
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–∞–º
- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- ‚úÖ –ö–æ–¥ —á–∏—â–µ

---

## üîí –ü–†–û–í–ï–†–ö–ê TRIPWIRE

**User —Å–ø—Ä–æ—Å–∏–ª:** "–Ø –ø–µ—Ä–µ–∂–∏–≤–∞—é, —á—Ç–æ —Ç—ã –∏ Tripwire —Ç–æ–∂–µ —Ç–∞–∫ —Å–ª–æ–º–∞–ª"

**–û—Ç–≤–µ—Ç:** –ù–ï–¢, Tripwire –ù–ï —Å–ª–æ–º–∞–Ω! ‚úÖ

**–ü–æ—á–µ–º—É:**
1. –¢—Ä–∏–≥–≥–µ—Ä `auto_unlock_first_module` –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω **—Ä–∞–Ω—å—à–µ** (3 –Ω–µ–¥–µ–ª–∏ –Ω–∞–∑–∞–¥)
2. Backend –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª **–°–¢–ê–†–£–Æ** –ª–æ–≥–∏–∫—É (—Ä—É—á–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞)
3. –Ø –ø—Ä–æ—Å—Ç–æ **—É–¥–∞–ª–∏–ª** —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É, –æ—Å—Ç–∞–≤–∏–ª —Ç—Ä–∏–≥–≥–µ—Ä
4. –¢—Ä–∏–≥–≥–µ—Ä —Ä–∞–±–æ—Ç–∞–ª **–í–°–ï–ì–î–ê**, backend –ø—Ä–æ—Å—Ç–æ –º–µ—à–∞–ª –µ–º—É

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- ‚úÖ Backend –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ 65 —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —É–∂–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã —Ç—Ä–∏–≥–≥–µ—Ä–æ–º
- ‚úÖ –ù–æ–≤—ã–µ —Å—Ç—É–¥–µ–Ω—Ç—ã —Ç–æ–∂–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è

**Tripwire –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ö–û–†–†–ï–ö–¢–ù–û!** üí™

---

## üìù LESSONS LEARNED

### –û—à–∏–±–∫–∞:
–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∑–∞–±—ã–ª–∏ —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É –∏–∑ backend.

### –†–µ—à–µ–Ω–∏–µ:
–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å **–≤–µ—Å—å –∫–æ–¥** –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤/–∞–≤—Ç–æ–º–∞—Ç–∏–∫–∏:
1. –î–æ–±–∞–≤–ª—è–µ—à—å —Ç—Ä–∏–≥–≥–µ—Ä ‚Üí –ø—Ä–æ–≤–µ—Ä—å backend
2. –ï—Å—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí —É–±–µ—Ä–∏ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É
3. –û—Å—Ç–∞–≤—å —Ç–æ–ª—å–∫–æ —Ç—Ä–∏–≥–≥–µ—Ä (–æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã)

---

## ‚úÖ –ì–û–¢–û–í–û!

**Sales Manager –ø–∞–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç!** üéâ

**–ê–º–∏–Ω–∞, –†–∞—Ö–∞—Ç –∏ –≤—Å–µ Sales Manager —Ç–µ–ø–µ—Ä—å –º–æ–≥—É—Ç:**
- ‚úÖ –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
- ‚úÖ –£–¥–∞–ª—è—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è!)
- ‚úÖ –†–∞–±–æ—Ç–∞—Ç—å –ë–ï–ó 409 –æ—à–∏–±–æ–∫

**–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç!** üí™

---

**–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 15 –º–∏–Ω—É—Ç  
**–í—Ä–µ–º—è –¥–µ–ø–ª–æ—è:** 2 –º–∏–Ω—É—Ç—ã  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready
