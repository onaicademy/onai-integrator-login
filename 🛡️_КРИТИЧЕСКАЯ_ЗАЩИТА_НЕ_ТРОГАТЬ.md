# üõ°Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–ê–©–ò–¢–ê - –ù–ï –¢–†–û–ì–ê–¢–¨ –ë–ï–ó –¢–ï–°–¢–û–í!

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –°–¢–£–î–ï–ù–¢–´ –ù–ï –ú–û–ì–£–¢ –ó–ê–í–ï–†–®–ò–¢–¨ –£–†–û–ö–ò –ï–°–õ–ò –≠–¢–û –°–õ–û–ú–ê–ù–û!

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–¶–ï–°–°–´ (–ù–ï –¢–†–û–ì–ê–¢–¨!)

### 1Ô∏è‚É£ **–ó–ê–í–ï–†–®–ï–ù–ò–ï –£–†–û–ö–ê** (`/api/tripwire/complete`)

#### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê:

```typescript
// ‚ùå –ù–ò–ö–û–ì–î–ê –ù–ï –ú–ï–ù–Ø–ô –≠–¢–û:
const main_user_id = '...';        // auth.users.id (–∏–∑ JWT)
const tripwire_user_id = '...';    // tripwire_users.id (–∏–∑ –ë–î)

// ‚úÖ –ü–†–ê–í–ò–õ–û #1: tripwire_progress –∏—Å–ø–æ–ª—å–∑—É–µ—Ç auth.users.id
await tripwireAdminSupabase
  .from('tripwire_progress')
  .upsert({
    tripwire_user_id: main_user_id,  // ‚úÖ –í–°–ï–ì–î–ê auth.users.id!
    lesson_id,
    module_id,
    is_completed: true
  });

// ‚úÖ –ü–†–ê–í–ò–õ–û #2: tripwire_user_profile –∏—Å–ø–æ–ª—å–∑—É–µ—Ç auth.users.id
await tripwireAdminSupabase
  .from('tripwire_user_profile')
  .update({ modules_completed })
  .eq('user_id', main_user_id);  // ‚úÖ –í–°–ï–ì–î–ê auth.users.id!
```

#### üî¥ –ü–û–ß–ï–ú–£ –≠–¢–û –ö–†–ò–¢–ò–ß–ù–û:

**Foreign Key Constraints:**
```sql
-- tripwire_progress.tripwire_user_id ‚Üí auth.users.id
ALTER TABLE tripwire_progress 
  ADD CONSTRAINT tripwire_progress_tripwire_user_id_fkey 
  FOREIGN KEY (tripwire_user_id) REFERENCES auth.users(id);

-- tripwire_user_profile.user_id ‚Üí auth.users.id  
ALTER TABLE tripwire_user_profile 
  ADD CONSTRAINT tripwire_user_profile_user_id_fkey 
  FOREIGN KEY (user_id) REFERENCES auth.users(id);
```

**‚ùå –ï–°–õ–ò –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ tripwire_users.id –í–ú–ï–°–¢–û auth.users.id:**
```
ERROR: Key (tripwire_user_id)=(xxx) is not present in table "users"
Foreign key constraint violation!
```

#### üìã CHECKLIST –ü–ï–†–ï–î –ò–ó–ú–ï–ù–ï–ù–ò–ï–ú:

- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `main_user_id` (auth.users.id)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª —á—Ç–æ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `tripwire_user_id` (tripwire_users.id) –¥–ª—è FK
- [ ] –ó–∞–ø—É—Å—Ç–∏–ª —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ Foreign Key
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª —Å —Ä–µ–∞–ª—å–Ω—ã–º —Å—Ç—É–¥–µ–Ω—Ç–æ–º

---

### 2Ô∏è‚É£ **ID MAPPING (–ö–†–ò–¢–ò–ß–ù–û!)**

#### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û–ï –ü–û–õ–£–ß–ï–ù–ò–ï ID:

```typescript
// FILE: backend/src/routes/tripwire-lessons.ts

// –®–ê–ì–ò:
// 1. –ü–æ–ª—É—á–∏—Ç—å email –∏–∑ JWT
const decodedToken = jwt.verify(token, JWT_SECRET);
const userEmail = decodedToken.email;

// 2. –ü–æ–ª—É—á–∏—Ç—å main_user_id (auth.users.id)
const { data: authUser } = await tripwireSupabase
  .from('users')
  .select('id')
  .eq('email', userEmail)
  .single();
const main_user_id = authUser.id;  // ‚úÖ auth.users.id

// 3. –ü–æ–ª—É—á–∏—Ç—å tripwire_user_id (tripwire_users.id)
const { data: tripwireUser } = await tripwireSupabase
  .from('tripwire_users')
  .select('id')
  .eq('user_id', main_user_id)  // join by auth.users.id
  .single();
const tripwire_user_id = tripwireUser.id;  // ‚úÖ tripwire_users.id

// ‚úÖ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
// - tripwire_progress ‚Üí main_user_id (auth.users.id)
// - tripwire_user_profile ‚Üí main_user_id (auth.users.id)
// - module_unlocks ‚Üí main_user_id (auth.users.id)
// - user_achievements ‚Üí main_user_id (auth.users.id)
```

#### üî¥ –ü–†–ê–í–ò–õ–û:

**–í–°–ï –¢–ê–ë–õ–ò–¶–´ –ü–†–û–ì–†–ï–°–°–ê –ò–°–ü–û–õ–¨–ó–£–Æ–¢ `auth.users.id`!**

–¢–æ–ª—å–∫–æ `tripwire_users` —Ç–∞–±–ª–∏—Ü–∞ –∏–º–µ–µ—Ç —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π `id`!

---

### 3Ô∏è‚É£ **–†–ê–ó–ë–õ–û–ö–ò–†–û–í–ö–ê –ú–û–î–£–õ–ï–ô** (`/api/tripwire/module-unlocks`)

#### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê:

```typescript
// ‚ùå –ù–ò–ö–û–ì–î–ê –ù–ï –ú–ï–ù–Ø–ô:
await tripwireAdminSupabase
  .from('module_unlocks')
  .insert({
    user_id: main_user_id,  // ‚úÖ –í–°–ï–ì–î–ê auth.users.id!
    module_id: nextModuleId,
    unlocked_at: new Date()
  });
```

#### üî¥ FOREIGN KEY:
```sql
ALTER TABLE module_unlocks 
  ADD CONSTRAINT module_unlocks_user_id_fkey 
  FOREIGN KEY (user_id) REFERENCES auth.users(id);
```

---

### 4Ô∏è‚É£ **–î–û–°–¢–ò–ñ–ï–ù–ò–Ø** (`user_achievements`)

#### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê:

```typescript
// ‚ùå –ù–ò–ö–û–ì–î–ê –ù–ï –ú–ï–ù–Ø–ô:
await tripwireAdminSupabase
  .from('user_achievements')
  .insert({
    user_id: main_user_id,  // ‚úÖ –í–°–ï–ì–î–ê auth.users.id!
    achievement_type: 'module_completed',
    module_id,
    earned_at: new Date()
  });
```

---

## üìä DATABASE SCHEMA (–°–ü–†–ê–í–ö–ê)

### **–¢–∞–±–ª–∏—Ü—ã –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ auth.users.id:**

| –¢–∞–±–ª–∏—Ü–∞ | FK –ö–æ–ª–æ–Ω–∫–∞ | –°—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ |
|---------|-----------|--------------|
| `tripwire_users` | `user_id` | `auth.users.id` ‚úÖ |
| `tripwire_progress` | `tripwire_user_id` | `auth.users.id` ‚úÖ |
| `tripwire_user_profile` | `user_id` | `auth.users.id` ‚úÖ |
| `module_unlocks` | `user_id` | `auth.users.id` ‚úÖ |
| `user_achievements` | `user_id` | `auth.users.id` ‚úÖ |
| `lesson_homework` | `user_id` | `auth.users.id` ‚úÖ |

### **–¢–∞–±–ª–∏—Ü—ã —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ ID:**

| –¢–∞–±–ª–∏—Ü–∞ | –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π ID | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è |
|---------|----------------|------------------|
| `tripwire_users` | `id` (UUID) | –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –≤ –∫–æ–¥–µ |

---

## üß™ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –¢–ï–°–¢–´ –ü–ï–†–ï–î COMMIT

### **TEST 1: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Ä–æ–∫–∞**

```bash
# 1. –ó–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è –∫–∞–∫ —Å—Ç—É–¥–µ–Ω—Ç
# 2. –û—Ç–∫—Ä—ã—Ç—å —É—Ä–æ–∫ 67
# 3. –î–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ 80%+
# 4. –ù–∞–∂–∞—Ç—å "–ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫"
# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —É—Ä–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω
# 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–µ—Ç –æ—à–∏–±–æ–∫ –≤ backend logs
```

### **TEST 2: –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –º–æ–¥—É–ª—è**

```bash
# 1. –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ —É—Ä–æ–∫–∏ –º–æ–¥—É–ª—è 1
# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º–æ–¥—É–ª—å 2 —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª—Å—è
# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –º–æ–¥—É–ª—å 3 –µ—â–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ Foreign Key –æ—à–∏–±–∫–∏
```

### **TEST 3: –ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–æ—Ñ–∏–ª—è**

```bash
# 1. –ó–∞–≤–µ—Ä—à–∏—Ç—å –º–æ–¥—É–ª—å
# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ tripwire_user_profile –æ–±–Ω–æ–≤–∏–ª—Å—è
# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ modules_completed —É–≤–µ–ª–∏—á–∏–ª—Å—è
# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ completion_percentage –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
```

---

## üö® –ê–õ–ï–†–¢–´ –ü–†–ò –ò–ó–ú–ï–ù–ï–ù–ò–ò

### **–ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç—Ç–∏ –æ—à–∏–±–∫–∏ - –û–¢–ö–ê–¢–´–í–ê–ô –ö–û–î:**

```
‚ùå Foreign key constraint violation
‚ùå Key (tripwire_user_id)=(xxx) is not present in table "users"
‚ùå insert or update on table "tripwire_progress" violates foreign key
‚ùå Failed to mark lesson complete
```

### **–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:**

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å backend logs
ssh root@207.154.231.30 "pm2 logs onai-backend --err --lines 50"

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Foreign Key –æ—à–∏–±–∫–∏
ssh root@207.154.231.30 "pm2 logs onai-backend | grep 'foreign key'"

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–æ–≤
ssh root@207.154.231.30 "pm2 logs onai-backend | grep 'mark lesson complete'"
```

---

## üìù PROTOCOL –î–õ–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô

### **–ü–ï–†–ï–î –õ–Æ–ë–´–ú –ò–ó–ú–ï–ù–ï–ù–ò–ï–ú –í –≠–¢–ò–• –§–ê–ô–õ–ê–•:**

- `backend/src/routes/tripwire-lessons.ts`
- `backend/src/routes/tripwire.ts`
- `src/pages/tripwire/TripwireLesson.tsx`
- `src/pages/tripwire/TripwireProductPage.tsx`

### **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:**

1. ‚úÖ –ü—Ä–æ—á–∏—Ç–∞–π —ç—Ç–æ—Ç —Ñ–∞–π–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –ø–æ–Ω–∏–º–∞–µ—à—å —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É:
   - `main_user_id` (auth.users.id)
   - `tripwire_user_id` (tripwire_users.id)
3. ‚úÖ –ó–∞–ø–æ–º–Ω–∏: **–í–°–ï –ü–†–û–ì–†–ï–°–° –¢–ê–ë–õ–ò–¶–´ ‚Üí auth.users.id**
4. ‚úÖ –°–¥–µ–ª–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏—è
5. ‚úÖ –ó–∞–ø—É—Å—Ç–∏ –≤—Å–µ 3 —Ç–µ—Å—Ç–∞
6. ‚úÖ –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
7. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π —Å —Ä–µ–∞–ª—å–Ω—ã–º —Å—Ç—É–¥–µ–Ω—Ç–æ–º
8. ‚úÖ –¢–æ–ª—å–∫–æ –ø–æ—Ç–æ–º commit

---

## üîí LOCK FILES (–ù–ï –¢–†–û–ì–ê–¢–¨ –ë–ï–ó –ü–†–ò–ß–ò–ù–´!)

### **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã:**

```
backend/src/routes/tripwire-lessons.ts    [LOCKED] ‚ö†Ô∏è
  ‚îî‚îÄ /api/tripwire/complete                [CRITICAL]
  ‚îî‚îÄ /api/tripwire/progress/:lessonId      [CRITICAL]

backend/src/routes/tripwire.ts             [LOCKED] ‚ö†Ô∏è
  ‚îî‚îÄ /api/tripwire/module-unlocks/:userId  [CRITICAL]

src/hooks/useHonestVideoTracking.tsx       [LOCKED] ‚ö†Ô∏è
  ‚îî‚îÄ handleComplete()                       [CRITICAL]
  ‚îî‚îÄ saveProgress()                         [CRITICAL]
```

### **–ï—Å–ª–∏ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å:**

1. –°–æ–∑–¥–∞–π feature branch
2. –°–¥–µ–ª–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. –ó–∞–ø—É—Å—Ç–∏ –í–°–ï —Ç–µ—Å—Ç—ã
4. –ü–æ–ø—Ä–æ—Å–∏ code review —É senior
5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π –Ω–∞ staging —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
6. –¢–æ–ª—å–∫–æ –ø–æ—Ç–æ–º merge –≤ main

---

## üéØ SUMMARY (–ö–û–†–û–¢–ö–ê–Ø –í–ï–†–°–ò–Ø)

### ‚úÖ **–î–ê:**
```typescript
tripwire_user_id: main_user_id  // auth.users.id ‚úÖ
user_id: main_user_id           // auth.users.id ‚úÖ
```

### ‚ùå **–ù–ï–¢:**
```typescript
tripwire_user_id: tripwire_user_id  // tripwire_users.id ‚ùå
user_id: tripwire_user_id           // tripwire_users.id ‚ùå
```

### üîë **–ü–†–ê–í–ò–õ–û:**

**–í–°–ï –¢–ê–ë–õ–ò–¶–´ –ü–†–û–ì–†–ï–°–°–ê –ò–°–ü–û–õ–¨–ó–£–Æ–¢ `auth.users.id`!**

**–¢–û–õ–¨–ö–û `tripwire_users.id` –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –î–õ–Ø –í–ù–£–¢–†–ï–ù–ù–ò–• –°–°–´–õ–û–ö!**

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï

**–ï–°–õ–ò –°–¢–£–î–ï–ù–¢–´ –ù–ï –ú–û–ì–£–¢ –ó–ê–í–ï–†–®–ò–¢–¨ –£–†–û–ö–ò:**

1. –ü—Ä–æ–≤–µ—Ä—å Foreign Key –æ—à–∏–±–∫–∏
2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `main_user_id` –∞ –Ω–µ `tripwire_user_id`
3. –û—Ç–∫–∞—Ç—ã–≤–∞–π –∫–æ–¥ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
4. –î–µ–ø–ª–æ–π hotfix
5. –¢–µ—Å—Ç–∏—Ä—É–π —Å —Ä–µ–∞–ª—å–Ω—ã–º —Å—Ç—É–¥–µ–Ω—Ç–æ–º

**–°–¢–£–î–ï–ù–¢–´ = –î–ï–ù–¨–ì–ò = –ü–†–ò–û–†–ò–¢–ï–¢ #1!** üî•

---

## üìû –ö–û–ù–¢–ê–ö–¢–´ –ü–†–ò –ü–†–û–ë–õ–ï–ú–ê–•

**–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å:**

1. **–ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏:** `pm2 logs onai-backend --err`
2. **–û—Ç–∫–∞—Ç—ã–≤–∞–π:** `git reset --hard [last_working_commit]`
3. **–î–µ–ø–ª–æ–π:** `pm2 restart onai-backend`
4. **–¢–µ—Å—Ç–∏—Ä—É–π:** –ü–æ–ø—Ä–æ–±—É–π –∑–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫
5. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π:** –ó–∞–ø–∏—à–∏ —á—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å

**–ù–ï –≠–ö–°–ü–ï–†–ò–ú–ï–ù–¢–ò–†–£–ô –ù–ê –ü–†–û–î–ê–ö–®–ï–ù–ï!** üö®

---

**–≠–¢–û–¢ –§–ê–ô–õ –°–û–ó–î–ê–ù –ü–û–°–õ–ï –ö–†–ò–¢–ò–ß–ï–°–ö–û–ô –û–®–ò–ë–ö–ò 19.12.2024**

**–ü–†–ò–ß–ò–ù–ê:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `tripwire_user_id` –≤–º–µ—Å—Ç–æ `main_user_id`

**–†–ï–ó–£–õ–¨–¢–ê–¢:** –°—Ç—É–¥–µ–Ω—Ç—ã –Ω–µ –º–æ–≥–ª–∏ –∑–∞–≤–µ—Ä—à–∞—Ç—å —É—Ä–æ–∫–∏ (500 error)

**–£–†–û–ö:** –í–°–ï–ì–î–ê –ò–°–ü–û–õ–¨–ó–£–ô `auth.users.id` –î–õ–Ø –ü–†–û–ì–†–ï–°–°–ê!
