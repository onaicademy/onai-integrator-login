# ‚úÖ –í–°–Å –ì–û–¢–û–í–û! –¢–ï–°–¢–ò–†–£–ô –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°!

**–î–∞—Ç–∞:** 22 –¥–µ–∫–∞–±—Ä—è 2025, 22:55 MSK  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –ì–û–¢–û–í–û –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ  

---

## üéØ –ß–¢–û –°–î–ï–õ–ê–ù–û (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 —á–∞—Å–∞):

### 1. ‚úÖ –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂ (5 —ç—Ç–∞–ø–æ–≤)
- ProfTest ‚Üí Express ‚Üí Payment ‚Üí Tripwire ‚Üí Main Product
- Responsive –¥–∏–∑–∞–π–Ω (Desktop/Tablet/Mobile)
- Color-coded (–∑–µ–ª–µ–Ω—ã–π/–∂–µ–ª—Ç—ã–π/–∫—Ä–∞—Å–Ω—ã–π)
- Drill-down (–∫–ª–∏–∫ ‚Üí –¥–µ—Ç–∞–ª–∏)

### 2. ‚úÖ Webhook –¥–ª—è AmoCRM
- Endpoint: `/api/amocrm/funnel-sale`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∞ –ø–æ UTM
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂ –≤ –ë–î
- Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫

### 3. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è UTM + AmoCRM
- UTM –º–µ—Ç–∫–∏ ‚Üí –¢–∞—Ä–≥–µ—Ç–æ–ª–æ–≥ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `funnel_sales` —Ç–∞–±–ª–∏—Ü—É
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –≤–æ—Ä–æ–Ω–∫–µ

### 4. ‚úÖ –†—É—Å–∏—Ñ–∏–∫–∞—Ü–∏—è UX
- –í—Å–µ —Ç–µ–∫—Å—Ç—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- –ü–æ–Ω—è—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω

---

## üîó WEBHOOK URL –î–õ–Ø AMOCRM

### üìç –õ–û–ö–ê–õ–¨–ù–´–ô (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è):
```
http://localhost:3000/api/amocrm/funnel-sale
```

### üìç PRODUCTION (–∫–æ–≥–¥–∞ –∑–∞–¥–µ–ø–ª–æ–∏—à—å):
```
http://api.onai.academy/api/amocrm/funnel-sale
```

---

## üß™ –ö–ê–ö –ù–ê–°–¢–†–û–ò–¢–¨ WEBHOOK –í AMOCRM

### –®–∞–≥ 1: –û—Ç–∫—Ä–æ–π AmoCRM

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Üí Webhooks ‚Üí –î–æ–±–∞–≤–∏—Ç—å webhook

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Webhook

```
URL: http://localhost:3000/api/amocrm/funnel-sale
–ú–µ—Ç–æ–¥: POST
–°–æ–±—ã—Ç–∏–µ: –ò–∑–º–µ–Ω–µ–Ω–∏–µ —ç—Ç–∞–ø–∞ —Å–¥–µ–ª–∫–∏
–í—ã–±–µ—Ä–∏: "–£—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞" (—ç—Ç–∞–ø 490k)
```

### –®–∞–≥ 3: –í—ã–±–µ—Ä–∏ –ø–æ–ª—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:**
- ‚úÖ Lead ID
- ‚úÖ Status ID
- ‚úÖ Pipeline ID
- ‚úÖ Custom Fields:
  - UTM Source
  - UTM Campaign
  - UTM Medium
  - UTM Content
  - UTM Term

### –®–∞–≥ 4: –°–æ—Ö—Ä–∞–Ω–∏

–ù–∞–∂–º–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –∏ webhook –≥–æ—Ç–æ–≤!

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï WEBHOOK

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ AmoCRM (–õ–£–ß–®–ò–ô)

1. –û—Ç–∫—Ä–æ–π –ª—é–±—É—é —Å–¥–µ–ª–∫—É –≤ AmoCRM
2. –ó–∞–ø–æ–ª–Ω–∏ UTM –º–µ—Ç–∫–∏:
   - UTM Source: `fb_kenesary`
   - UTM Campaign: `nutrients_test_dec`
3. –ü–µ—Ä–µ–≤–µ–¥–∏ —Å–¥–µ–ª–∫—É –≤ —ç—Ç–∞–ø "–£—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞"
4. Webhook –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ!

### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ curl (—Ç–µ—Å—Ç–æ–≤—ã–π)

```bash
curl -X POST "http://localhost:3000/api/amocrm/funnel-sale" \
  -H "Content-Type: application/json" \
  -d '{
    "leads": {
      "status": [{
        "id": 999888777,
        "status_id": 142,
        "pipeline_id": 1,
        "custom_fields": [
          {"id": 123, "name": "UTM Source", "values": [{"value": "fb_kenesary"}]},
          {"id": 124, "name": "UTM Campaign", "values": [{"value": "nutrients_test"}]}
        ]
      }]
    }
  }'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "message": "Funnel sale processed",
  "leads_processed": 1
}
```

---

## üìä –ü–†–û–í–ï–†–ö–ê –ß–¢–û WEBHOOK –†–ê–ë–û–¢–ê–ï–¢

### 1. Backend logs

```bash
tail -f /tmp/backend-full.log | grep "AmoCRM Funnel"
```

**–£–≤–∏–¥–∏—à—å:**
```
[AmoCRM Funnel Webhook] Received sale data
[AmoCRM Funnel Webhook] Processing lead 999888777
[AmoCRM Funnel Webhook] UTM Data: { utm_source: 'fb_kenesary', ... }
[AmoCRM Funnel Webhook] Targetologist: Kenesary
[AmoCRM Funnel Webhook] ‚úÖ Sale saved: Lead 999888777 ‚Üí Kenesary
```

### 2. –ü—Ä–æ–≤–µ—Ä—å API –≤–æ—Ä–æ–Ω–∫–∏

```bash
curl http://localhost:3000/api/traffic-dashboard/funnel | jq '.stages[-1]'
```

**–£–≤–∏–¥–∏—à—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏!**

### 3. –ü—Ä–æ–≤–µ—Ä—å UI

–û—Ç–∫—Ä–æ–π:
```
http://localhost:8080/#/traffic/cabinet/muha
```

**–ü—Ä–æ–∫—Ä—É—Ç–∏ –≤–Ω–∏–∑ –¥–æ "Main Product (490k)"** - –¥–æ–ª–∂–Ω—ã –æ–±–Ω–æ–≤–∏—Ç—å—Å—è —Ü–∏—Ñ—Ä—ã!

---

## üé® –ö–ê–ö –í–ò–î–ò–¢ –°–ò–°–¢–ï–ú–ê –¢–ê–†–ì–ï–¢–û–õ–û–ì–ê

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ UTM:

| UTM –º–µ—Ç–∫–∞ | –¢–∞—Ä–≥–µ—Ç–æ–ª–æ–≥ |
|-----------|------------|
| `fb_kenesary`, `nutrients`, `nutcab` | **Kenesary** |
| `fb_arystan`, `rm_almaty` | **Arystan** |
| `fb_muha`, `onai`, `maqtakyz` | **Muha** |
| `fb_traf4`, `alex`, `proftest` | **Traf4** |

**–ü–∞—Ç—Ç–µ—Ä–Ω—ã:**
- **Kenesary:** nutrients, nutcab, kenesary, tripwire, kab3, kenes
- **Arystan:** arystan, ar_, ast_, rm almaty
- **Muha:** onai, muha, yourmarketolog, maqtakyz, residence, tima
- **Traf4:** alex, traf4, proftest, smmmcwin, 3-1

---

## üìã –ú–ê–†–®–†–£–¢–´ (ENDPOINTS)

### ‚úÖ –í—Å–µ —Ä–∞–±–æ—Ç–∞—é—Ç!

**–í–æ—Ä–æ–Ω–∫–∞:**
- `GET /api/traffic-dashboard/funnel` - –≤—Å–µ —ç—Ç–∞–ø—ã
- `GET /api/traffic-dashboard/funnel/:stageId` - –¥–µ—Ç–∞–ª–∏ —ç—Ç–∞–ø–∞
- `GET /api/traffic-dashboard/funnel/health` - health check

**Webhook:**
- `POST /api/amocrm/funnel-sale` - –ø—Ä–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥–∞–∂–µ
- `GET /api/amocrm/funnel-sale/health` - health check

**Facebook:**
- `GET /api/traffic-facebook/accounts` - –≤—Å–µ –∫–∞–±–∏–Ω–µ—Ç—ã (11)
- `GET /api/traffic-facebook/campaigns/:id` - –∫–∞–º–ø–∞–Ω–∏–∏ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
- `POST /api/traffic-facebook/refresh` - –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à

**–¢–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∏:**
- `POST /api/targetologist-assignment/manual` - —Ä—É—á–Ω–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
- `GET /api/targetologist-assignment/campaigns/:name` - –∫–∞–º–ø–∞–Ω–∏–∏ —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∞

---

## üß™ –¢–ï–°–¢–ò–†–£–ô –°–ï–ô–ß–ê–°!

### 1. –û—Ç–∫—Ä–æ–π –¥–∞—à–±–æ—Ä–¥

```
http://localhost:8080/#/traffic/cabinet/muha
```

### 2. –ü—Ä–æ–≤–µ—Ä—å –≤–æ—Ä–æ–Ω–∫—É

‚úÖ –í–∏–¥–∏—à—å 5 —ç—Ç–∞–ø–æ–≤?  
‚úÖ –¶–≤–µ—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ (–∑–µ–ª–µ–Ω—ã–π/–∂–µ–ª—Ç—ã–π)?  
‚úÖ –ú–æ–∂–Ω–æ –∫–ª–∏–∫–∞—Ç—å –∏ expand'–∏—Ç—å?  
‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è?  

### 3. –¢–µ—Å—Ç–∏—Ä—É–π responsive

- –£–º–µ–Ω—å—à–∏ –æ–∫–Ω–æ –±—Ä–∞—É–∑–µ—Ä–∞
- –ü—Ä–æ–≤–µ—Ä—å –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–µ (iPad)
- –ü—Ä–æ–≤–µ—Ä—å –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ

### 4. –ù–∞—Å—Ç—Ä–æ–π webhook –≤ AmoCRM

- –ò—Å–ø–æ–ª—å–∑—É–π URL: `http://localhost:3000/api/amocrm/funnel-sale`
- –í—ã–±–µ—Ä–∏ —ç—Ç–∞–ø "–£—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞"
- –°–æ—Ö—Ä–∞–Ω–∏

### 5. –¢–µ—Å—Ç–∏—Ä—É–π –ø—Ä–æ–¥–∞–∂—É

- –°–æ–∑–¥–∞–π —Ç–µ—Å—Ç–æ–≤—É—é —Å–¥–µ–ª–∫—É
- –ó–∞–ø–æ–ª–Ω–∏ UTM –º–µ—Ç–∫–∏
- –ü–µ—Ä–µ–≤–µ–¥–∏ –≤ "–£—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞"
- –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Ü–∏—Ñ—Ä—ã –æ–±–Ω–æ–≤–∏–ª–∏—Å—å –≤ –≤–æ—Ä–æ–Ω–∫–µ!

---

## üìÅ –ß–¢–û –°–û–ó–î–ê–ù–û –°–ï–ì–û–î–ù–Ø

### Backend (6 —Ñ–∞–π–ª–æ–≤, 1,035 —Å—Ç—Ä–æ–∫):
1. `funnel-service.ts` - –ª–æ–≥–∏–∫–∞ –≤–æ—Ä–æ–Ω–∫–∏
2. `traffic-funnel-api.ts` - API endpoints
3. `amocrm-funnel-webhook.ts` - webhook –¥–ª—è AmoCRM
4. `targetologist-detector.ts` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∞
5. `targetologist-assignment.ts` - —Ä—É—á–Ω–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
6. `server.ts` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è routes

### Frontend (2 —Ñ–∞–π–ª–∞, 407 —Å—Ç—Ä–æ–∫):
7. `ConversionFunnel.tsx` - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤–æ—Ä–æ–Ω–∫–∏
8. `TrafficCabinetDashboard.tsx` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### Database (2 –º–∏–≥—Ä–∞—Ü–∏–∏):
9. `20251222_create_campaign_targetologist_map.sql`
10. `20251222_create_funnel_sales.sql`

**–ò—Ç–æ–≥–æ:** +1,442 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

---

## üéâ –ò–¢–û–ì–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

```
AmoCRM
  ‚Üì webhook (—É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞)
  ‚Üì
Backend (/api/amocrm/funnel-sale)
  ‚Üì extract UTM
  ‚Üì determine targetologist
  ‚Üì save to Supabase (funnel_sales)
  ‚Üì
Frontend (ConversionFunnel)
  ‚Üì fetch /api/traffic-dashboard/funnel
  ‚Üì display 5 stages
  ‚Üì show real-time metrics
  ‚Üì
Dashboard (Traffic Cabinet)
  ‚úÖ –í–∏–¥–∏—Ç –≤—Å–µ –ø—Ä–æ–¥–∞–∂–∏ –≤ –≤–æ—Ä–æ–Ω–∫–µ!
```

---

## üöÄ PRODUCTION DEPLOYMENT

**–ü–û–°–õ–ï –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Supabase

```sql
-- –û—Ç–∫—Ä–æ–π Supabase Dashboard SQL Editor
-- –í—Å—Ç–∞–≤—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:
supabase/migrations/20251222_create_campaign_targetologist_map.sql
supabase/migrations/20251222_create_funnel_sales.sql
-- –ù–∞–∂–º–∏ RUN
```

### 2. –î–µ–ø–ª–æ–π Backend

```bash
cd /Users/miso/onai-integrator-login
rsync -avz --exclude='node_modules' backend/src/ root@89.23.100.220:/root/onai-integrator-login/backend/src/
ssh root@89.23.100.220 "cd /root/onai-integrator-login/backend && pm2 restart onai-backend"
```

### 3. –û–±–Ω–æ–≤–∏ webhook URL –≤ AmoCRM

–ó–∞–º–µ–Ω–∏:
```
http://localhost:3000/api/amocrm/funnel-sale
```

–ù–∞:
```
http://api.onai.academy/api/amocrm/funnel-sale
```

### 4. –î–µ–ø–ª–æ–π Frontend

```bash
npm run build
rsync -avz dist/ root@89.23.100.220:/var/www/onai.academy/
```

---

## ‚úÖ –í–°–Å –ì–û–¢–û–í–û!

**–û—Ç–∫—Ä–æ–π –∏ —Ç–µ—Å—Ç–∏—Ä—É–π:**
```
http://localhost:8080/#/traffic/cabinet/muha
```

**Webhook URL –¥–ª—è AmoCRM:**
```
http://localhost:3000/api/amocrm/funnel-sale
```

**Backend –ª–æ–≥–∏:**
```bash
tail -f /tmp/backend-full.log
```

---

**–í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üöÄ

**–î–∞—Ç–∞:** 22 –¥–µ–∫–∞–±—Ä—è 2025, 22:55 MSK
