# üî• –ü–†–û–ë–õ–ï–ú–ê –ò –†–ï–®–ï–ù–ò–ï

**–î–∞—Ç–∞:** 22 –¥–µ–∫–∞–±—Ä—è 2025, 23:30 MSK

---

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê:

**Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç**, **—Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç**, –Ω–æ **–ù–ï –°–û–•–†–ê–ù–Ø–ï–¢** –≤ –ë–î!

**–û—à–∏–±–∫–∞:**
```
Code: PGRST205
Message: Could not find the table 'public.funnel_sales' in the schema cache
```

**–ü—Ä–∏—á–∏–Ω–∞:**
PostgREST (Supabase REST API layer) –Ω–µ –æ–±–Ω–æ–≤–∏–ª schema cache –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ü–∏—é.

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï 1: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å PostgREST (–ë–´–°–¢–†–û)

### –ß–µ—Ä–µ–∑ Supabase Dashboard:

1. –û—Ç–∫—Ä–æ–π: https://supabase.com/dashboard/project/oetodaexnjcunklkdlkv/settings/api

2. **–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "Restart PostgREST"** (–µ—Å–ª–∏ –µ—Å—Ç—å)

3. –ò–ª–∏ –ø–µ—Ä–µ–π–¥–∏ –≤ Settings ‚Üí API ‚Üí Reload schema

**–ò–õ–ò:**

1. –û—Ç–∫—Ä–æ–π SQL Editor
2. –í—ã–ø–æ–ª–Ω–∏:
```sql
NOTIFY pgrst, 'reload schema';
SELECT pg_notify('pgrst', 'reload schema');
```

3. –ü–æ–¥–æ–∂–¥–∏ 10 —Å–µ–∫—É–Ω–¥

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï 2: –ü–æ–¥–æ–∂–¥–∞—Ç—å 5-10 –º–∏–Ω—É—Ç

PostgREST –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç schema cache –∫–∞–∂–¥—ã–µ 5-10 –º–∏–Ω—É—Ç.

**–ü—Ä–æ—Å—Ç–æ –ø–æ–¥–æ–∂–¥–∏ –∏ –ø–æ–≤—Ç–æ—Ä–∏ —Ç–µ—Å—Ç:**

```bash
curl -X POST "https://onai.academy/api/amocrm/funnel-sale" \
  -H "Content-Type: application/json" \
  -d '{"leads":{"status":[{"id":12345,"status_id":142,"pipeline_id":10350882,"custom_fields":[{"id":1127149,"name":"UTM Source","values":[{"value":"fb_kenesary"}]},{"id":1127151,"name":"UTM Campaign","values":[{"value":"test"}]}]}]}}'
```

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï 3: –ü—Ä—è–º–æ–π SQL –∑–∞–ø—Ä–æ—Å (WORKAROUND)

**–Ø –£–ñ–ï –°–û–ó–î–ê–õ** `traffic-pg-direct.ts` –Ω–æ connection string –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π!

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
error: Tenant or user not found
```

**–ù—É–∂–Ω–æ:**
1. –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π connection string –∏–∑ Supabase Dashboard
2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π trafficAdminSupabase –Ω–æ —á–µ—Ä–µ–∑ raw SQL

---

## üß™ –ß–¢–û –£–ñ–ï –†–ê–ë–û–¢–ê–ï–¢:

‚úÖ **Webhook endpoint:** `https://onai.academy/api/amocrm/funnel-sale`  
‚úÖ **Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ AmoCRM** (ID: 46476042)  
‚úÖ **–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ** –æ—Ç AmoCRM  
‚úÖ **–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–∞** (nutrients ‚Üí Kenesary, maqtakyz ‚Üí Muha)  
‚úÖ **–¢–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞** –≤ –ë–î  
‚ùå **–ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç** –∏–∑-–∑–∞ PostgREST schema cache  

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:

**–°–ê–ú–û–ï –ë–´–°–¢–†–û–ï –†–ï–®–ï–ù–ò–ï:**

1. –û—Ç–∫—Ä–æ–π Supabase Dashboard
2. Settings ‚Üí Database ‚Üí Schema
3. –ù–∞–∂–º–∏ "Reload" –∏–ª–∏ –ø–æ–¥–æ–∂–¥–∏ 5-10 –º–∏–Ω—É—Ç
4. –ü–æ–≤—Ç–æ—Ä–∏ —Ç–µ—Å—Ç

**–ü–æ—Å–ª–µ reload schema:**
```bash
curl -X POST "https://onai.academy/api/amocrm/funnel-sale" \
  -H "Content-Type: application/json" \
  -d '{"leads":{"status":[{"id":99999,"status_id":142,"pipeline_id":10350882,"custom_fields":[{"id":1127149,"name":"UTM Source","values":[{"value":"fb_muha"}]},{"id":1127151,"name":"UTM Campaign","values":[{"value":"onai_test"}]}]}]}}'

# –ü—Ä–æ–≤–µ—Ä—å:
# SELECT * FROM funnel_sales;
# –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å–∏!
```

---

## üìä –°–¢–ê–¢–£–° –°–ï–ô–ß–ê–°:

**–í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –ö–†–û–ú–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î –∏–∑-–∑–∞ schema cache!**

**–ü–æ—Å–ª–µ reload schema - –≤—Å—ë –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é! ‚úÖ**
