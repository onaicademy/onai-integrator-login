# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•

## üìä –¢–ï–ö–£–©–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:

```
auth.users (Supabase Authentication)
   ‚Üì
   ‚ùå –ù–ï–¢ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò
   ‚Üì
public.users (–ù–ï –°–£–©–ï–°–¢–í–£–ï–¢)
public.achievements (–ù–ï –°–£–©–ï–°–¢–í–£–ï–¢)
public.user_progress (–ù–ï –°–£–©–ï–°–¢–í–£–ï–¢)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°—Ç—É–¥–µ–Ω—Ç—ã –º–æ–≥—É—Ç –≤–æ–π—Ç–∏, –Ω–æ —É –Ω–∏—Ö –ù–ï–¢ –ø—Ä–æ—Ñ–∏–ª–µ–π, –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏!

---

## ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê:

```
auth.users (Supabase Authentication)
   ‚Üì
   üîÑ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø (Database Trigger)
   ‚Üì
public.users (–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
   ‚Üì
public.user_achievements (–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è)
public.user_progress (–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫—É—Ä—Å–∞–º)
public.user_stats (–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
public.user_xp (XP –∏ —É—Ä–æ–≤–Ω–∏)
```

---

## üóÑÔ∏è –°–¢–†–£–ö–¢–£–†–ê –¢–ê–ë–õ–ò–¶:

### **1Ô∏è‚É£ `public.users` - –ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

```sql
id              UUID PRIMARY KEY (—Å–≤—è–∑—å —Å auth.users)
email           TEXT UNIQUE
full_name       TEXT
avatar_url      TEXT
role            TEXT DEFAULT 'student' (student/teacher/admin)
is_ceo          BOOLEAN DEFAULT false
total_xp        INTEGER DEFAULT 0
level           INTEGER DEFAULT 1
created_at      TIMESTAMP
updated_at      TIMESTAMP
last_login_at   TIMESTAMP
```

### **2Ô∏è‚É£ `public.user_achievements` - –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è**

```sql
id              UUID PRIMARY KEY
user_id         UUID REFERENCES public.users(id)
achievement_id  UUID REFERENCES public.achievements(id)
earned_at       TIMESTAMP
xp_earned       INTEGER
```

### **3Ô∏è‚É£ `public.user_progress` - –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫—É—Ä—Å–∞–º**

```sql
id              UUID PRIMARY KEY
user_id         UUID REFERENCES public.users(id)
course_id       TEXT
module_id       TEXT
lesson_id       TEXT
completed       BOOLEAN DEFAULT false
completed_at    TIMESTAMP
time_spent      INTEGER (—Å–µ–∫—É–Ω–¥—ã)
```

### **4Ô∏è‚É£ `public.user_stats` - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**

```sql
id              UUID PRIMARY KEY
user_id         UUID REFERENCES public.users(id)
lessons_completed INTEGER DEFAULT 0
study_time      INTEGER DEFAULT 0 (–º–∏–Ω—É—Ç—ã)
streak_days     INTEGER DEFAULT 0
last_activity   TIMESTAMP
```

---

## üîÑ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø:

### **–°–ø–æ—Å–æ–± 1: Database Trigger (–õ–£–ß–®–ï)**

–°–æ–∑–¥–∞—ë–º —Ç—Ä–∏–≥–≥–µ—Ä –∫–æ—Ç–æ—Ä—ã–π **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ `auth.users`:

```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.users (id, email, full_name, role, created_at)
  VALUES (
    new.id,
    new.email,
    COALESCE(new.raw_user_meta_data->>'full_name', ''),
    COALESCE(new.raw_user_meta_data->>'role', 'student'),
    now()
  );
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- –¢—Ä–∏–≥–≥–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ auth.users
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–µ—Ä–µ–∑ Dashboard
- ‚úÖ –ù–µ –Ω—É–∂–µ–Ω –∫–æ–¥ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ

### **–°–ø–æ—Å–æ–± 2: Frontend —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**

–í `src/lib/supabase.ts` –¥–æ–±–∞–≤–ª—è–µ–º:

```typescript
supabase.auth.onAuthStateChange(async (event, session) => {
  if (event === 'SIGNED_IN' && session?.user) {
    const { id, email, user_metadata } = session.user
    
    // –°–æ–∑–¥–∞—ë–º –ø—Ä–æ—Ñ–∏–ª—å –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    const { error } = await supabase.from('users').upsert({
      id,
      email,
      full_name: user_metadata.full_name || '',
      role: user_metadata.role || 'student',
      last_login_at: new Date().toISOString(),
    }, { onConflict: 'id' })
  }
})
```

**–ú–∏–Ω—É—Å—ã:**
- ‚ùå –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—Ö–æ–¥–µ —á–µ—Ä–µ–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
- ‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–µ—Ä–µ–∑ Dashboard

---

## üéØ –ß–¢–û –î–ï–õ–ê–¢–¨ –î–ê–õ–¨–®–ï:

### **–í–∞—Ä–∏–∞–Ω—Ç A: –ë—ã—Å—Ç—Ä—ã–π (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)**

1. –°–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—É `public.users` –≤—Ä—É—á–Ω—É—é
2. –î–æ–±–∞–≤—å —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
3. –°—Ç—É–¥–µ–Ω—Ç—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏

### **–í–∞—Ä–∏–∞–Ω—Ç B: –ü–æ–ª–Ω—ã–π (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)**

1. –°–æ–∑–¥–∞–π –í–°–ï —Ç–∞–±–ª–∏—Ü—ã (users, achievements, progress, stats)
2. –ù–∞—Å—Ç—Ä–æ–π —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ RLS –ø–æ–ª–∏—Ç–∏–∫–∏
3. –û–±–Ω–æ–≤–∏ –∫–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏

---

## üìù –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:

–í—ã–±–µ—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç –∏ —è –ø–æ–º–æ–≥—É:

**A) –ë—ã—Å—Ç—Ä–æ** ‚Üí –°–æ–∑–¥–∞–º SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è `public.users` + —Ç—Ä–∏–≥–≥–µ—Ä  
**B) –ü–æ–ª–Ω–æ—Å—Ç—å—é** ‚Üí –°–æ–∑–¥–∞–º –í–°–Æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ë–î —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏

–ß—Ç–æ –≤—ã–±–∏—Ä–∞–µ—à—å?

