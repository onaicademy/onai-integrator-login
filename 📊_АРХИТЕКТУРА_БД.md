# üìä –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ë–ê–ó–´ –î–ê–ù–ù–´–• ONAI ACADEMY

## üéØ –ì–õ–ê–í–ù–ê–Ø –°–•–ï–ú–ê

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   auth.users    ‚îÇ  ‚Üê Supabase Auth (—Å–∫—Ä—ã—Ç–∞ –≤ UI)
‚îÇ  (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è)   ‚îÇ
‚îÇ                 ‚îÇ
‚îÇ - id (UUID)     ‚îÇ
‚îÇ - email         ‚îÇ
‚îÇ - password      ‚îÇ
‚îÇ - confirmed_at  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ Foreign Key
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  public.users   ‚îÇ  ‚Üê –ü—Ä–æ—Ñ–∏–ª–∏ (–≤–∏–¥–Ω–∞ –≤ Table Editor)
‚îÇ                 ‚îÇ
‚îÇ - id (FK)       ‚îÇ‚îÄ‚îÄ‚îê
‚îÇ - email         ‚îÇ  ‚îÇ
‚îÇ - full_name     ‚îÇ  ‚îÇ
‚îÇ - avatar_url    ‚îÇ  ‚îÇ
‚îÇ - role          ‚îÇ  ‚îÇ  –°–≤—è–∑—å —á–µ—Ä–µ–∑ user_id
‚îÇ - is_ceo        ‚îÇ  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
                     ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ                       ‚îÇ
         ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     courses      ‚îÇ    ‚îÇ    progress      ‚îÇ
‚îÇ   (–∫—É—Ä—Å—ã)        ‚îÇ    ‚îÇ   (–ø—Ä–æ–≥—Ä–µ—Å—Å)     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ - id             ‚îÇ    ‚îÇ - user_id (FK)   ‚îÇ
‚îÇ - title          ‚îÇ    ‚îÇ - course_id      ‚îÇ
‚îÇ - description    ‚îÇ    ‚îÇ - completed      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     modules      ‚îÇ
‚îÇ   (–º–æ–¥—É–ª–∏)       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ - id             ‚îÇ
‚îÇ - course_id (FK) ‚îÇ
‚îÇ - title          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     lessons      ‚îÇ
‚îÇ   (—É—Ä–æ–∫–∏)        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ - id             ‚îÇ
‚îÇ - module_id (FK) ‚îÇ
‚îÇ - title          ‚îÇ
‚îÇ - content        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìã –û–°–ù–û–í–ù–´–ï –¢–ê–ë–õ–ò–¶–´

### 1. **auth.users** (–≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è Supabase)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

**–ù–µ –≤–∏–¥–Ω–∞ –≤ Table Editor!** –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑:
- Authentication ‚Üí Users (Dashboard UI)
- SQL: `SELECT * FROM auth.users`

**–°–æ–∑–¥–∞—ë—Ç—Å—è –∫–æ–≥–¥–∞:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è
- –õ–æ–≥–∏–Ω–∏—Ç—Å—è —á–µ—Ä–µ–∑ Google OAuth
- –ê–¥–º–∏–Ω —Å–æ–∑–¥–∞—ë—Ç —á–µ—Ä–µ–∑ Dashboard

---

### 2. **public.users** (–∫–∞—Å—Ç–æ–º–Ω–∞—è)
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Ä–æ–ª–∏, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```sql
CREATE TABLE public.users (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  email TEXT UNIQUE NOT NULL,
  full_name TEXT,
  avatar_url TEXT,
  role TEXT DEFAULT 'student',  -- 'student' | 'admin' | 'teacher'
  is_ceo BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**–°–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** —á–µ—Ä–µ–∑ –∫–æ–¥ –≤ `src/lib/supabase.ts`:
```typescript
supabase.auth.onAuthStateChange(async (event, session) => {
  if (event === 'SIGNED_IN' && session?.user) {
    await supabase.from('users').upsert({
      id: session.user.id,
      email: session.user.email,
      full_name: session.user.user_metadata.full_name,
      // role: 'student' –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    })
  }
})
```

---

### 3. **courses** (–∫—É—Ä—Å—ã)
**–°–≤—è–∑—å:** –ù–µ–∑–∞–≤–∏—Å–∏–º–∞—è —Ç–∞–±–ª–∏—Ü–∞

```sql
- id: UUID
- title: TEXT
- description: TEXT
- thumbnail_url: TEXT
- level: TEXT
- duration: TEXT
```

---

### 4. **modules** (–º–æ–¥—É–ª–∏ –∫—É—Ä—Å–∞)
**–°–≤—è–∑—å:** `course_id` ‚Üí `courses.id`

```sql
- id: UUID
- course_id: UUID (FK)
- title: TEXT
- description: TEXT
- order_index: INTEGER
```

---

### 5. **lessons** (—É—Ä–æ–∫–∏)
**–°–≤—è–∑—å:** `module_id` ‚Üí `modules.id`

```sql
- id: UUID
- module_id: UUID (FK)
- title: TEXT
- content: TEXT
- video_url: TEXT
- duration: INTEGER
- order_index: INTEGER
```

---

### 6. **progress** (–ø—Ä–æ–≥—Ä–µ—Å—Å —Å—Ç—É–¥–µ–Ω—Ç–∞)
**–°–≤—è–∑—å:** `user_id` ‚Üí `public.users.id`

```sql
- id: UUID
- user_id: UUID (FK)
- lesson_id: UUID (FK)
- completed: BOOLEAN
- completed_at: TIMESTAMPTZ
- video_progress: INTEGER (—Å–µ–∫—É–Ω–¥—ã)
```

---

### 7. **user_achievements** (–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è)
**–°–≤—è–∑—å:** `user_id` ‚Üí `public.users.id`

```sql
- id: UUID
- user_id: UUID (FK)
- achievement_type: TEXT
- title: TEXT
- description: TEXT
- earned_at: TIMESTAMPTZ
```

---

### 8. **ai_curator_threads** (—á–∞—Ç—ã —Å AI –∫—É—Ä–∞—Ç–æ—Ä–æ–º)
**–°–≤—è–∑—å:** `user_id` ‚Üí `public.users.id`

```sql
- id: UUID
- user_id: UUID (FK)
- thread_id: TEXT (OpenAI thread ID)
- title: TEXT
- created_at: TIMESTAMPTZ
- last_message_at: TIMESTAMPTZ
```

---

### 9. **student_group_chats** (–≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã)
**–°–≤—è–∑—å:** –ú–Ω–æ–≥–∏–µ –∫–æ –º–Ω–æ–≥–∏–º —á–µ—Ä–µ–∑ `student_group_members`

```sql
- id: UUID
- name: TEXT
- avatar_url: TEXT
- created_by: UUID (FK ‚Üí users.id)
- created_at: TIMESTAMPTZ
```

**–£—á–∞—Å—Ç–Ω–∏–∫–∏:**
```sql
CREATE TABLE student_group_members (
  chat_id: UUID (FK ‚Üí student_group_chats.id)
  user_id: UUID (FK ‚Üí users.id)
  joined_at: TIMESTAMPTZ
)
```

---

### 10. **student_private_chats** (–ª–∏—á–Ω—ã–µ —á–∞—Ç—ã)
**–°–≤—è–∑—å:** 2 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```sql
- id: UUID
- user1_id: UUID (FK ‚Üí users.id)
- user2_id: UUID (FK ‚Üí users.id)
- created_at: TIMESTAMPTZ
```

---

### 11. **user_activity** (–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞)
**–°–≤—è–∑—å:** `user_id` ‚Üí `public.users.id`

```sql
- id: UUID
- user_id: UUID (FK)
- activity_type: TEXT
- activity_data: JSONB
- created_at: TIMESTAMPTZ
```

---

### 12. **user_statistics** (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
**–°–≤—è–∑—å:** `user_id` ‚Üí `public.users.id`

```sql
- id: UUID
- user_id: UUID (FK)
- total_study_time: INTEGER (–º–∏–Ω—É—Ç—ã)
- lessons_completed: INTEGER
- courses_completed: INTEGER
- ai_messages_sent: INTEGER
- updated_at: TIMESTAMPTZ
```

---

## üîó –ö–ê–ö –í–°–Å –°–í–Ø–ó–ê–ù–û

### –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ª–æ–≥–∏–Ω–∏—Ç—Å—è:

1. **–°–æ–∑–¥–∞—ë—Ç—Å—è/–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `auth.users`**
   - Email, –ø–∞—Ä–æ–ª—å, OAuth —Ç–æ–∫–µ–Ω—ã

2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è `public.users`**
   - –ß–µ—Ä–µ–∑ `onAuthStateChange` –≤ –∫–æ–¥–µ
   - –° —Ä–æ–ª—å—é `student` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

3. **–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ `public.users.id`:**
   - `progress.user_id`
   - `user_achievements.user_id`
   - `ai_curator_threads.user_id`
   - `student_group_members.user_id`
   - –ò —Ç.–¥.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∞:

```typescript
// –í ProtectedRoute.tsx
const { data: userData } = await supabase
  .from('users')  // ‚Üê –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ public.users
  .select('role, is_ceo')
  .eq('id', user.id)
  .single();

const isAdmin = userData?.role === 'admin' || userData?.is_ceo === true;
```

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –ü–†–ê–í–ò–õ–¨–ù–û–ô –ù–ê–°–¢–†–û–ô–ö–ò

### –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:

1. ‚úÖ –ó–∞–ø–∏—Å—å –≤ `auth.users` (email, password)
2. ‚úÖ –ó–∞–ø–∏—Å—å –≤ `public.users` (id —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å auth.users.id)
3. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–æ–ª—å –≤ `public.users.role` ('admin' –¥–ª—è –∞–¥–º–∏–Ω–∞)

### –î–ª—è –∞–¥–º–∏–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:

4. ‚úÖ `is_ceo = true` –≤ `public.users`
5. ‚úÖ –î–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (`/admin/*` –º–∞—Ä—à—Ä—É—Ç—ã)

---

## üêõ –¢–ò–ü–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### –ü—Ä–æ–±–ª–µ–º–∞ 1: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å, –Ω–æ –Ω–µ—Ç —Ä–æ–ª–∏"
**–†–µ—à–µ–Ω–∏–µ:**
```sql
UPDATE public.users 
SET role = 'admin', is_ceo = true 
WHERE email = '—Ç–≤–æ–π@email.com';
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ auth.users, –Ω–æ –Ω–µ—Ç –≤ public.users"
**–†–µ—à–µ–Ω–∏–µ:**
```sql
INSERT INTO public.users (id, email, role, is_ceo)
SELECT id, email, 'admin', true
FROM auth.users
WHERE email = '—Ç–≤–æ–π@email.com';
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏"
**–ü—Ä–æ–≤–µ—Ä—å:**
1. –†–æ–ª—å –≤ –ë–î: `SELECT role FROM public.users WHERE id = 'USER_ID'`
2. –ö–æ–¥ –≤ `ProtectedRoute.tsx` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–æ–ª—å
3. RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –¥–æ—Å—Ç—É–ø

---

## üéØ –ò–¢–û–ì

**–í—Å—ë —Å–≤—è–∑–∞–Ω–æ —á–µ—Ä–µ–∑ `public.users`:**
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è ‚Üí `auth.users`
- –ü—Ä–æ—Ñ–∏–ª—å –∏ —Ä–æ–ª–∏ ‚Üí `public.users`
- –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Üí —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ `public.users.id`

**–î–ª—è –∞–¥–º–∏–Ω–∞ –Ω—É–∂–Ω–æ:**
1. –°–æ–∑–¥–∞—Ç—å –≤ `auth.users` (Dashboard UI –∏–ª–∏ SQL)
2. –û–±–Ω–æ–≤–∏—Ç—å `public.users` —Å `role = 'admin'`
3. –í–æ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç –∏ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω–∫–µ!

---

**–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å —Ç—ã –ø–æ–Ω–∏–º–∞–µ—à—å –∫–∞–∫ –≤—Å—ë —É—Å—Ç—Ä–æ–µ–Ω–æ! üöÄ**

