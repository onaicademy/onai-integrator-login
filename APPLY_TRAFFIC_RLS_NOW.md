# üîí –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ RLS –¥–ª—è Traffic Dashboard - –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –®–ê–ì

## üéØ –ü–æ—á–µ–º—É —ç—Ç–æ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –≤–∞–∂–Ω–æ

**–ë–µ–∑ RLS –ª—é–±–æ–π —Å anon key –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ Traffic DB!**

–°–µ–π—á–∞—Å Traffic Dashboard —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ **–ù–ï –ó–ê–©–ò–©–ï–ù** - –ª—é–±–æ–π —á–µ–ª–æ–≤–µ–∫ —Å anon key –º–æ–∂–µ—Ç:
- ‚ùå –ß–∏—Ç–∞—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚ùå –ß–∏—Ç–∞—Ç—å –≤—Å–µ –ª–∏–¥—ã
- ‚ùå –ß–∏—Ç–∞—Ç—å –≤—Å–µ –ø—Ä–æ–¥–∞–∂–∏
- ‚ùå –ß–∏—Ç–∞—Ç—å –≤—Å—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å RLS (5 –º–∏–Ω—É—Ç)

### –®–∞–≥ 1: –û—Ç–∫—Ä–æ–π Supabase Dashboard

```
https://supabase.com/dashboard/project/oetodaexnjcunklkdlkv/sql
```

### –®–∞–≥ 2: –°–∫–æ–ø–∏—Ä—É–π SQL

–û—Ç–∫—Ä–æ–π —Ñ–∞–π–ª: [`scripts/apply-traffic-rls-production.sql`](scripts/apply-traffic-rls-production.sql)

–°–∫–æ–ø–∏—Ä—É–π –≤–µ—Å—å SQL –∫–æ–¥.

### –®–∞–≥ 3: –í—ã–ø–æ–ª–Ω–∏ SQL –≤ Supabase Dashboard

1. –í—Å—Ç–∞–≤—å SQL –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä SQL –≤ Supabase Dashboard
2. –ù–∞–∂–º–∏ "Run" (–∏–ª–∏ "Execute")
3. –ü–æ–¥–æ–∂–¥–∏ 1-2 –º–∏–Ω—É—Ç—ã

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–í–Ω–∏–∑—É —É–≤–∏–¥–∏—à—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
```
‚úÖ GOVNO! RLS –ø—Ä–∏–º–µ–Ω–µ–Ω!
```

## ‚úÖ –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç SQL

### 1. –í–∫–ª—é—á–∞–µ—Ç RLS –Ω–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö Traffic
- `traffic_users`
- `traffic_leads`
- `traffic_sales`
- `traffic_analytics`
- `traffic_daily_reports`

### 2. –°–æ–∑–¥–∞–µ—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

#### –î–ª—è Admin (role: 'admin')
- ‚úÖ –ú–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ
- ‚úÖ –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å/–æ–±–Ω–æ–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ

#### –î–ª—è Targetologist (role: 'targetologist')
- ‚úÖ –ú–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ –¢–û–õ–¨–ö–û —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã
- ‚úÖ –ú–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã
- ‚úÖ –ú–æ–∂–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã
- ‚ùå –ù–ï –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö –∫–æ–º–∞–Ω–¥

#### –î–ª—è Anon (–Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ)
- ‚ùå –ù–ï –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
- ‚ùå –ù–ï –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ

### 3. –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ (–µ—Å–ª–∏ –±—ã–ª–∏)

## üîí –ü—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è RLS

### Admin (role: 'admin', team: null)
```sql
-- –ú–æ–∂–µ—Ç –¥–µ–ª–∞—Ç—å –í–°–Å
SELECT * FROM traffic_users;        -- ‚úÖ –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
SELECT * FROM traffic_leads;         -- ‚úÖ –í—Å–µ –ª–∏–¥—ã
SELECT * FROM traffic_sales;         -- ‚úÖ –í—Å–µ –ø—Ä–æ–¥–∞–∂–∏
SELECT * FROM traffic_analytics;      -- ‚úÖ –í—Å—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
SELECT * FROM traffic_daily_reports;  -- ‚úÖ –í—Å–µ –æ—Ç—á–µ—Ç—ã

INSERT INTO traffic_leads ...;    -- ‚úÖ –°–æ–∑–¥–∞–≤–∞—Ç—å –ª–∏–¥—ã
UPDATE traffic_leads ...;         -- ‚úÖ –û–±–Ω–æ–≤–ª—è—Ç—å –ª–∏–¥—ã
DELETE FROM traffic_leads ...;      -- ‚úÖ –£–¥–∞–ª—è—Ç—å –ª–∏–¥—ã
```

### Targetologist (role: 'targetologist', team: 'team_name')
```sql
-- –ú–æ–∂–µ—Ç –¥–µ–ª–∞—Ç—å –¢–û–õ–¨–ö–û —Å —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥–æ–π
SELECT * FROM traffic_leads WHERE team = 'team_name';         -- ‚úÖ –õ–∏–¥—ã —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã
SELECT * FROM traffic_sales WHERE team = 'team_name';         -- ‚úÖ –ü—Ä–æ–¥–∞–∂–∏ —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã
SELECT * FROM traffic_analytics WHERE team = 'team_name';      -- ‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã

INSERT INTO traffic_leads (team, ...) VALUES ('team_name', ...);  -- ‚úÖ –°–æ–∑–¥–∞–≤–∞—Ç—å –ª–∏–¥—ã –¥–ª—è —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã
UPDATE traffic_leads SET ... WHERE team = 'team_name';           -- ‚úÖ –û–±–Ω–æ–≤–ª—è—Ç—å –ª–∏–¥—ã —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã

-- –ù–ï –º–æ–∂–µ—Ç –¥–µ–ª–∞—Ç—å
SELECT * FROM traffic_leads WHERE team = 'other_team';  -- ‚ùå –õ–∏–¥—ã –¥—Ä—É–≥–æ–π –∫–æ–º–∞–Ω–¥—ã
DELETE FROM traffic_leads WHERE team = 'other_team';      -- ‚ùå –£–¥–∞–ª—è—Ç—å –ª–∏–¥—ã –¥—Ä—É–≥–æ–π –∫–æ–º–∞–Ω–¥—ã
```

### Anon (–Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ)
```sql
-- –ù–ï –º–æ–∂–µ—Ç –¥–µ–ª–∞—Ç—å –ù–ò–ß–ï–ì–û
SELECT * FROM traffic_users;        -- ‚ùå –û—à–∏–±–∫–∞: permission denied
SELECT * FROM traffic_leads;         -- ‚ùå –û—à–∏–±–∫–∞: permission denied
SELECT * FROM traffic_sales;         -- ‚ùå –û—à–∏–±–∫–∞: permission denied
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä—å –≤ Supabase Dashboard

–û—Ç–∫—Ä–æ–π: `https://supabase.com/dashboard/project/oetodaexnjcunklkdlkv/auth/policies`

–¢–∞–º –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü:
- `admin_select_all_traffic_users`
- `targetologist_select_team_traffic_users`
- `admin_select_all_traffic_leads`
- `targetologist_select_team_traffic_leads`
- –∏ —Ç.–¥.

### 2. –ü—Ä–æ–≤–µ—Ä—å –≤ Traffic Dashboard

–û—Ç–∫—Ä–æ–π: `https://traffic.onai.academy`

1. –ó–∞–ª–æ–≥–∏–Ω—å—Å—è –∫–∞–∫ Admin
   - ‚úÖ –î–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ

2. –ó–∞–ª–æ–≥–∏–Ω—å—Å—è –∫–∞–∫ Targetologist (team: 'team1')
   - ‚úÖ –î–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ –¢–û–õ–¨–ö–û –∫–æ–º–∞–Ω–¥—ã 'team1'
   - ‚ùå –ù–ï –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö –∫–æ–º–∞–Ω–¥

3. –ü–æ–ø—Ä–æ–±—É–π –∑–∞–π—Ç–∏ –∫–∞–∫ Anon (–±–µ–∑ –ª–æ–≥–∏–Ω–∞)
   - ‚ùå –ù–ï –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ
   - ‚ùå –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ login

### 3. –ü—Ä–æ–≤–µ—Ä—å —á–µ—Ä–µ–∑ SQL

–í—ã–ø–æ–ª–Ω–∏ —ç—Ç–æ—Ç SQL –≤ Supabase Dashboard –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ RLS –≤–∫–ª—é—á–µ–Ω
SELECT
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual
FROM pg_policies
WHERE schemaname = 'public'
  AND tablename IN ('traffic_users', 'traffic_leads', 'traffic_sales', 'traffic_analytics', 'traffic_daily_reports')
ORDER BY tablename, policyname;
```

–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏.

## üêõ –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ SQL

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ SQL —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é
2. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –Ω–µ—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
3. –ü–æ–ø—Ä–æ–±—É–π –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ —á–∞—Å—Ç—è–º (—Å–Ω–∞—á–∞–ª–∞ –≤–∫–ª—é—á–µ–Ω–∏–µ RLS, –ø–æ—Ç–æ–º –ø–æ–ª–∏—Ç–∏–∫–∏)

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–ª–∏—Ç–∏–∫–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å Auth Policies –≤ Supabase Dashboard
2. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
3. –ü–æ–ø—Ä–æ–±—É–π –≤—ã–ø–æ–ª–Ω–∏—Ç—å SQL –µ—â–µ —Ä–∞–∑

### –ü—Ä–æ–±–ª–µ–º–∞: Traffic Dashboard –ø–µ—Ä–µ—Å—Ç–∞–ª —Ä–∞–±–æ—Ç–∞—Ç—å

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ backend: `docker-compose logs -f traffic-backend`
2. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ backend –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π auth (traffic-auth.ts)
3. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ JWT —Ç–æ–∫–µ–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç role –∏ team

## üéØ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–í–°–ï–ì–î–ê** –ø—Ä–∏–º–µ–Ω—è–π RLS –ø–µ—Ä–µ–¥ production –¥–µ–ø–ª–æ–µ–º
2. **–í–°–ï–ì–î–ê** –ø—Ä–æ–≤–µ—Ä—è–π, —á—Ç–æ –ø–æ–ª–∏—Ç–∏–∫–∏ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å
3. **–í–°–ï–ì–î–ê** –ø—Ä–æ–≤–µ—Ä—è–π –¥–æ—Å—Ç—É–ø—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–æ–ª–µ–π
4. **–ù–ò–ö–û–ì–î–ê** –Ω–µ –¥–µ–ø–ª–æ–π –±–µ–∑ RLS –Ω–∞ Traffic DB

## üéâ –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è RLS

Traffic Dashboard –±—É–¥–µ—Ç **–ó–ê–©–ò–©–ï–ù**:

‚úÖ Admin –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –¥–∞–Ω–Ω—ã–º
‚úÖ Targetologist –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥–µ
‚úÖ Anon –ù–ï –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –º–µ–∂–¥—É –∫–æ–º–∞–Ω–¥–∞–º–∏
‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [`scripts/apply-traffic-rls-production.sql`](scripts/apply-traffic-rls-production.sql) - SQL —Å–∫—Ä–∏–ø—Ç
- [`backend/src/middleware/auth.ts`](backend/src/middleware/auth.ts) - Auth middleware
- [`backend/src/routes/admin/transcriptions.ts`](backend/src/routes/admin/transcriptions.ts) - –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

---

## üö® –°–†–û–ß–ù–û!

–ü—Ä–∏–º–µ–Ω–∏—Ç—å RLS –°–ï–ô–ß–ê–°! –ë–µ–∑ –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã–µ —É—è–∑–≤–∏–º—ã!

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 5 –º–∏–Ω—É—Ç**
**–°–ª–æ–∂–Ω–æ—Å—Ç—å: –ù–∏–∑–∫–∞—è**
**–†–∏—Å–∫: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π**
