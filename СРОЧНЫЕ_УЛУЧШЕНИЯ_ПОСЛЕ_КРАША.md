# üö® –°–†–û–ß–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø –ü–û–°–õ–ï –ö–†–ê–®–ê BACKEND

## üìä –ö–†–ê–¢–ö–ê–Ø –°–£–¢–¨

**–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å:** Backend –±—ã–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ~2-3 —á–∞—Å–∞ –∏–∑-–∑–∞ crash loop (106 —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤)

**–ü–æ—á–µ–º—É –Ω–µ –∑–∞–º–µ—Ç–∏–ª–∏:** –ù–ï–¢ –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê! ‚ùå

**–ö–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã:** –ü–∞–ø–∫–∞ `dist/` –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª–∞ —Å TypeScript –∏—Å—Ö–æ–¥–Ω–∏–∫–∞–º–∏

---

## üî• –ö–†–ò–¢–ò–ß–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø (–°–ï–ì–û–î–ù–Ø!)

### 1. –ú–û–ù–ò–¢–û–†–ò–ù–ì (30 –º–∏–Ω—É—Ç)

**–ù–∞—Å—Ç—Ä–æ–π UptimeRobot –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°:**

```
1. –ó–∞–π–¥–∏ –Ω–∞ https://uptimerobot.com (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
2. Add New Monitor:
   - Type: HTTP(s)
   - URL: https://api.onai.academy/health
   - Name: OnAI Backend API
   - Interval: 2 minutes
   
3. Alert Contacts:
   - Telegram: @rakhat (–∏–ª–∏ —Ç–≤–æ–π username)
   - SMS: —Ç–≤–æ–π –Ω–æ–º–µ—Ä
   
4. Thresholds:
   - Down for 2 checks = ALERT
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë—É–¥–µ—à—å –∑–Ω–∞—Ç—å –æ –ø–∞–¥–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ 2-4 –º–∏–Ω—É—Ç—ã –≤–º–µ—Å—Ç–æ 3 —á–∞—Å–æ–≤!

---

### 2. –ò–°–ü–†–ê–í–¨ PM2 –ö–û–ù–§–ò–ì (5 –º–∏–Ω—É—Ç)

```bash
ssh root@207.154.231.30
cd /var/www/onai-integrator-login-main/backend
nano ecosystem.config.js
```

**–ò–∑–º–µ–Ω–∏:**
```js
// –ë–´–õ–û:
max_restarts: 15,  // ‚ùå –°–õ–ò–®–ö–û–ú –ú–ù–û–ì–û
min_uptime: '5s',  // ‚ùå –°–õ–ò–®–ö–û–ú –ú–ê–õ–û

// –°–¢–ê–õ–û:
max_restarts: 3,   // ‚úÖ –ü–æ—Å–ª–µ 3 –∫—Ä–∞—à–µ–π - STOP
min_uptime: '30s', // ‚úÖ –ú–∏–Ω–∏–º—É–º 30 —Å–µ–∫—É–Ω–¥ —Ä–∞–±–æ—Ç—ã
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** PM2 –Ω–µ –±—É–¥–µ—Ç –º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–º–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–∞–º–∏

---

### 3. –í–ö–õ–Æ–ß–ò SENTRY (2 –º–∏–Ω—É—Ç—ã)

```bash
ssh root@207.154.231.30
cd /var/www/onai-integrator-login-main/backend
nano env.env
```

**–î–æ–±–∞–≤—å:**
```env
SENTRY_ENABLED=true
SENTRY_DSN=<—Ç–≤–æ–π Sentry DSN>
```

**–ü–æ–ª—É—á–∏ DSN:**
1. https://sentry.io (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –¥–æ 5k events/–º–µ—Å—è—Ü)
2. Create Project ‚Üí Node.js
3. Copy DSN

```bash
pm2 restart onai-backend
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥—É—Ç –≤ Sentry —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

---

### 4. –ò–°–ü–†–ê–í–¨ DEPLOY –°–ö–†–ò–ü–¢–´ (10 –º–∏–Ω—É—Ç)

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
- `deploy-backend-final.sh`
- `scripts/deploy-backend.sh`
- `deploy-production.sh`

**–ß—Ç–æ —É–¥–∞–ª–∏—Ç—å:**
```bash
# ‚ùå –£–î–ê–õ–ò —ç—Ç–∏ —Å—Ç—Ä–æ–∫–∏:
npm run build
tar -czf dist.tar.gz dist/
pm2 start dist/server.js
```

**–ß—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å (–≤ –∫–æ–Ω–µ—Ü —Å–∫—Ä–∏–ø—Ç–∞):**
```bash
# ‚úÖ –î–û–ë–ê–í–¨ –ø—Ä–æ–≤–µ—Ä–∫—É:
echo "üßπ Cleaning artifacts..."
rm -rf dist/ dist.tar.gz

echo "‚úÖ Checking for unwanted files..."
if [ -d "dist/" ]; then
    echo "‚ùå ERROR: dist/ folder exists! Something went wrong."
    exit 1
fi

echo "üöÄ Restarting backend..."
pm2 restart onai-backend

echo "‚è≥ Waiting 10 seconds for startup..."
sleep 10

echo "üß™ Running smoke test..."
HEALTH=$(curl -sf http://localhost:3000/health)
if [ $? -ne 0 ]; then
    echo "‚ùå HEALTH CHECK FAILED!"
    echo "Rolling back..."
    # Rollback logic here
    exit 1
fi

echo "‚úÖ Smoke test passed!"
echo "$HEALTH"
```

---

## ‚ö†Ô∏è –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–≠–¢–ê –ù–ï–î–ï–õ–Ø)

### 5. ROLLBACK MECHANISM

**Blue-Green Setup:**
```bash
ssh root@207.154.231.30

# –°–æ–∑–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É
mkdir -p /var/www/backend-releases
cd /var/www/backend-releases

# Current = symlink
ln -s /var/www/onai-integrator-login-main/backend /var/www/backend-current

# PM2 –∫–æ–Ω—Ñ–∏–≥ –ø–æ–º–µ–Ω—è–π –Ω–∞:
exec_cwd: '/var/www/backend-current',
```

**Rollback —Å–∫—Ä–∏–ø—Ç:**
```bash
#!/bin/bash
# rollback.sh
echo "üîÑ Rolling back to previous version..."
CURRENT=$(readlink /var/www/backend-current)
PREVIOUS=$(ls -t /var/www/backend-releases | head -2 | tail -1)

ln -sfn /var/www/backend-releases/$PREVIOUS /var/www/backend-current
pm2 restart onai-backend

echo "‚úÖ Rolled back from $CURRENT to $PREVIOUS"
```

---

### 6. CI/CD PIPELINE

**GitHub Actions:** `.github/workflows/deploy.yml`

```yaml
name: Deploy Backend

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm install
      - run: npm run lint || true
      - run: npm run test || true  # –∫–æ–≥–¥–∞ –±—É–¥—É—Ç —Ç–µ—Å—Ç—ã

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: 207.154.231.30
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/onai-integrator-login-main
            git pull origin main
            cd backend
            npm install
            rm -rf dist/
            pm2 restart onai-backend
            sleep 10
            curl -f http://localhost:3000/health || exit 1

      - name: Notify Telegram
        if: always()
        run: |
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=üöÄ Backend deployed: ${{ job.status }}"
```

---

### 7. PRE-DEPLOYMENT CHECKLIST

**–°–æ–∑–¥–∞–π —Ñ–∞–π–ª:** `DEPLOY_CHECKLIST.md`

```markdown
# üöÄ Pre-Deployment Checklist

–ü–µ—Ä–µ–¥ –ö–ê–ñ–î–´–ú –¥–µ–ø–ª–æ–µ–º –ø—Ä–æ–≤–µ—Ä—å:

## –õ–æ–∫–∞–ª—å–Ω–æ
- [ ] Backend –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] `npm run dev` —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ù–µ—Ç TypeScript –æ—à–∏–±–æ–∫
- [ ] .gitignore –∞–∫—Ç—É–∞–ª–µ–Ω (dist/ –≤ ignore)

## –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (staging/preview)
- [ ] Git pull –ø—Ä–æ—à—ë–ª –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- [ ] npm install –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ
- [ ] –ü–∞–ø–∫–∞ dist/ –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- [ ] ecosystem.config.js –∞–∫—Ç—É–∞–ª–µ–Ω
- [ ] env.env —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω—É–∂–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

## –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
- [ ] PM2 status –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "online"
- [ ] Uptime > 30 —Å–µ–∫—É–Ω–¥
- [ ] Health check –æ—Ç–≤–µ—á–∞–µ—Ç HTTP 200
- [ ] –õ–æ–≥–∏ —á–∏—Å—Ç—ã–µ (–Ω–µ—Ç –æ—à–∏–±–æ–∫)
- [ ] UptimeRobot –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç UP

## –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫
- [ ] ROLLBACK –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
- [ ] –ù–ï –ø—ã—Ç–∞–π—Å—è "–ø–æ—á–∏–Ω–∏—Ç—å –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ"
- [ ] –ß–∏–Ω–∏ –ª–æ–∫–∞–ª—å–Ω–æ ‚Üí —Ç–µ—Å—Ç–∏—Ä—É–π ‚Üí –¥–µ–ø–ª–æ–π —Å–Ω–æ–≤–∞
```

---

## üìä –°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (2 –ù–ï–î–ï–õ–ò)

### 8. Structured Logging
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Winston –∏–ª–∏ Pino
- –õ–æ–≥–∏ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Loki –∏–ª–∏ CloudWatch

### 9. Automated Tests
- Unit tests –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
- Integration tests –¥–ª—è API endpoints
- E2E tests –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–ª–æ—É

### 10. Documentation
- Runbook –¥–ª—è —á–∞—Å—Ç—ã—Ö –ø—Ä–æ–±–ª–µ–º
- Architecture Decision Records (ADR)
- Incident Response playbook

---

## üéØ –ú–ï–¢–†–ò–ö–ò –£–°–ü–ï–•–ê

**–î–æ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞:**
- ‚ùå MTTD (Mean Time To Detect): 2-3 —á–∞—Å–∞
- ‚ùå Monitoring: –ù–ï–¢
- ‚ùå Alerting: –ù–ï–¢
- ‚ùå Rollback: –ù–ï–¢

**–ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:**
- ‚úÖ MTTD: < 5 –º–∏–Ω—É—Ç (—Å UptimeRobot)
- ‚úÖ MTTR: < 10 –º–∏–Ω—É—Ç (—Å rollback)
- ‚úÖ Monitoring: 24/7
- ‚úÖ Alerting: Telegram + SMS
- ‚úÖ Auto-rollback: On smoke test failure

---

## üí∞ –°–¢–û–ò–ú–û–°–¢–¨

**–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- ‚úÖ UptimeRobot (50 monitors –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
- ‚úÖ Sentry (5k events/–º–µ—Å—è—Ü –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
- ‚úÖ GitHub Actions (2000 –º–∏–Ω—É—Ç/–º–µ—Å—è—Ü –±–µ—Å–ø–ª–∞—Ç–Ω–æ)

**–ü–ª–∞—Ç–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
- Better Uptime ($10/–º–µ—Å—è—Ü) - –±–æ–ª–µ–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- Datadog ($15/–º–µ—Å—è—Ü) - –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è observability

**–ò—Ç–æ–≥–æ:** $0-25/–º–µ—Å—è—Ü –∑–∞ –ö–†–ò–¢–ò–ß–ù–£–Æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É!

---

## ‚è±Ô∏è –í–†–ï–ú–Ø –ù–ê –í–ù–ï–î–†–ï–ù–ò–ï

| –ó–∞–¥–∞—á–∞ | –í—Ä–µ–º—è | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|--------|-------|-----------|
| UptimeRobot setup | 30 –º–∏–Ω | üî• P0 |
| Fix PM2 config | 5 –º–∏–Ω | üî• P0 |
| Enable Sentry | 10 –º–∏–Ω | üî• P0 |
| Fix deploy scripts | 20 –º–∏–Ω | üî• P0 |
| Rollback mechanism | 2 —á–∞—Å–∞ | ‚ö†Ô∏è P1 |
| CI/CD pipeline | 4 —á–∞—Å–∞ | ‚ö†Ô∏è P1 |
| Smoke tests | 1 —á–∞—Å | ‚ö†Ô∏è P1 |

**–ò—Ç–æ–≥–æ P0:** ~1 —á–∞—Å  
**–ò—Ç–æ–≥–æ P1:** ~7 —á–∞—Å–æ–≤  

---

## üîó –ü–û–õ–ï–ó–ù–´–ï –°–°–´–õ–ö–ò

- [Postmortem (–ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è)](./POSTMORTEM_BACKEND_CRASH_2025-12-22.md)
- [UptimeRobot](https://uptimerobot.com)
- [Sentry](https://sentry.io)
- [Better Uptime](https://betteruptime.com)
- [PM2 Best Practices](https://pm2.keymetrics.io/docs/usage/process-management/)

---

**–ù–ê–ß–ù–ò –° P0 –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°!** üöÄ

–≠—Ç–∏ —É–ª—É—á—à–µ–Ω–∏—è –∑–∞–π–º—É—Ç ~1 —á–∞—Å –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç—è—Ç 99% –ø–æ–¥–æ–±–Ω—ã—Ö –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤.
