# üìù –ò–ó–í–ï–°–¢–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (P2 - –ú–û–ñ–ù–û –û–¢–õ–û–ñ–ò–¢–¨)

**–î–∞—Ç–∞:** 14 –¥–µ–∫–∞–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –±—É–¥—É—â–∏—Ö —Ñ–∏–∫—Å–æ–≤

---

## üü¢ –ù–ï–ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. Facebook Pixel - –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã: 5% üìä

**–°—Ç–∞—Ç—É—Å:** –ö–æ–¥ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –≤–æ–∑–º–æ–∂–Ω–æ browser-side issue

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑–∞–ª–∞:**
- ‚úÖ ProfTest: —Å–æ–±—ã—Ç–∏–µ `trackLead` –≤–Ω—É—Ç—Ä–∏ `if (response.ok)`
- ‚úÖ CheckoutForm: —Å–æ–±—ã—Ç–∏–µ `trackLead` –ü–û–°–õ–ï –ø—Ä–æ–≤–µ—Ä–∫–∏ `!response.ok`
- ‚úÖ Conversion API –Ω–∞ backend —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–§–∞–π–ª—ã:**
- `src/pages/tripwire/ProfTest.tsx` (—Å—Ç—Ä–æ–∫–∏ 437-444)
- `src/components/landing/CheckoutForm.tsx` (—Å—Ç—Ä–æ–∫–∏ 231-244)
- `backend/src/routes/facebook-conversion.ts`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å Facebook Events Manager
- –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π —Å –ª–∏–¥–∞–º–∏ –≤ –ë–î
- –ï—Å–ª–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ > 10% ‚Üí –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å browser console

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 (–Ω–∏–∑–∫–∏–π)

---

### 2. Backend Stability - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –ø–∞–¥–µ–Ω–∏—è üîÑ

**–°—Ç–∞—Ç—É—Å:** –†–µ–¥–∫–∏–µ —Å–ª—É—á–∞–∏ –ø–æ—Å–ª–µ `git reset --hard`

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ `git reset --hard` –ø–∞–¥–∞–µ—Ç backend
- –ü—Ä–∏—á–∏–Ω–∞: –∑–∞–±—ã–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å `npm install --legacy-peer-deps`
- –û—à–∏–±–∫–∞: `tsx: not found` –∏–ª–∏ `nodemon: not found`

**–†–µ—à–µ–Ω–∏–µ:**
- ‚úÖ Deploy script `deploy-production.sh` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç `npm install`
- ‚úÖ –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ nodemon –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `./deploy-production.sh` –¥–ª—è –¥–µ–ø–ª–æ—è
- –ù–ï –¥–µ–ª–∞—Ç—å —Ä—É—á–Ω–æ–π `git reset --hard` –±–µ–∑ –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ `npm install`

**–§–∞–π–ª—ã:**
- `deploy-production.sh` (—Å—Ç—Ä–æ–∫–∏ 52-74)
- `backend/ecosystem.config.js`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 (–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)

---

### 3. CORS Configuration - –ú–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∂–µ üîí

**–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```typescript
app.use(cors({
  origin: (origin, callback) => {
    // –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ origin (Postman, curl, server-to-server)
    if (!origin) {
      return callback(null, true);
    }
    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
  }
}));
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `if (!origin)` —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ origin (Postman, curl)
- –ù–∞ –ø—Ä–æ–¥–µ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –¥—ã—Ä–æ–π

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
// –£–±—Ä–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `if (!origin)` –Ω–∞ –ø—Ä–æ–¥–µ
if (process.env.NODE_ENV === 'production' && !origin) {
  return callback(new Error('Origin required in production'), false);
}
```

**–§–∞–π–ª—ã:**
- `backend/src/server.ts` (—Å—Ç—Ä–æ–∫–∏ 178-248)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ, —Ä–∞–±–æ—Ç–∞–µ—Ç)

---

### 4. Tripwire Modules - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É—Ä–æ–∫–æ–≤ ‚úÖ

**–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ (—É—Ä–æ–∫–∏ 67, 68, 69 —Ä–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω—ã)

**–ß—Ç–æ –±—ã–ª–æ:**
- –£—Ä–æ–∫–∏ 67, 68, 69 –±—ã–ª–∏ –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω—ã
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥–ª–∏ –∏—Ö –æ—Ç–∫—Ä—ã—Ç—å

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
```sql
UPDATE lessons 
SET is_archived = false, updated_at = now() 
WHERE id IN (67, 68, 69);
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û (13 –¥–µ–∫–∞–±—Ä—è 2025)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 (—É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

---

### 5. Rate Limiting - –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–ª—è `/api/landing` üõ°Ô∏è

**–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è `/api/auth`, `/api/tripwire`, `/api/admin`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
// –í backend/src/server.ts
import { landingLimiter } from './middleware/rate-limit';

// –î–æ–±–∞–≤–∏—Ç—å –ª–∏–º–∏—Ç –¥–ª—è landing endpoints
app.use('/api/landing/', landingLimiter); // 50 req/15min
```

**–ó–∞—á–µ–º:**
- –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ –Ω–∞ —Ñ–æ—Ä–º–∞—Ö ProfTest/Landing
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ DDoS –∞—Ç–∞–∫ –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–µ endpoints

**–§–∞–π–ª—ã:**
- `backend/src/server.ts` (—Å—Ç—Ä–æ–∫–∏ 254-259)
- `backend/src/middleware/rate-limit.ts`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 (–Ω–µ–∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ)

---

### 6. Environment Variables - –ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ üìä

**–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º

**–¢–µ–∫—É—â–µ–µ:**
```typescript
console.log(`  ${process.env.AMOCRM_ACCESS_TOKEN ? '‚úÖ' : '‚ö†Ô∏è '} AmoCRM: YES/NO`);
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
console.log(`  ${process.env.AMOCRM_ACCESS_TOKEN ? '‚úÖ' : '‚ö†Ô∏è '} AmoCRM: ${process.env.AMOCRM_ACCESS_TOKEN ? 'YES (' + process.env.AMOCRM_DOMAIN + ')' : 'NO'}`);
```

**–ó–∞—á–µ–º:**
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–æ–º–µ–Ω AmoCRM –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
- –ë—ã—Å—Ç—Ä–µ–µ –æ—Ç–ª–∞–≤–ª–∏–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–§–∞–π–ª—ã:**
- `backend/src/config/env.ts` (—Å—Ç—Ä–æ–∫–∏ 55-56)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 (–∫–æ—Å–º–µ—Ç–∏–∫–∞)

---

### 7. Recovery Script - –î–æ–±–∞–≤–∏—Ç—å dry-run —Ä–µ–∂–∏–º üîß

**–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
// –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ --dry-run
const isDryRun = process.argv.includes('--dry-run');

if (isDryRun) {
  console.log('üîç DRY RUN MODE: No changes will be made');
  // –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ, –Ω–æ –Ω–µ –¥–µ–ª–∞—Ç—å
}
```

**–ó–∞—á–µ–º:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –Ω–∞–π–¥–µ—Ç –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
- –ë–µ–∑–æ–ø–∞—Å–Ω–µ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

**–§–∞–π–ª—ã:**
- `backend/src/scripts/recover-lost-leads.ts`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 (—É–ª—É—á—à–µ–Ω–∏–µ UX)

---

### 8. PM2 Logs Rotation - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫—É üìù

**–°—Ç–∞—Ç—É—Å:** –õ–æ–≥–∏ —Ä–∞—Å—Ç—É—Ç, –Ω—É–∂–Ω–∞ —Ä–æ—Ç–∞—Ü–∏—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```javascript
// –í backend/ecosystem.config.js
{
  log_date_format: 'YYYY-MM-DD HH:mm:ss',
  max_size: '100M', // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ª–æ–≥–∞
  retain: 7,        // –•—Ä–∞–Ω–∏—Ç—å 7 –¥–Ω–µ–π
}
```

**–ó–∞—á–µ–º:**
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏—Å–∫–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤

**–§–∞–π–ª—ã:**
- `backend/ecosystem.config.js`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ–∑–∂–µ)

---

## üîç –ö–ê–ö –í–ï–†–ù–£–¢–¨–°–Ø –ö –≠–¢–ò–ú –ü–†–û–ë–õ–ï–ú–ê–ú

–ö–æ–≥–¥–∞ –±—É–¥–µ—à—å –≥–æ—Ç–æ–≤ —Ñ–∏–∫—Å–∏—Ç—å P2 –ø—Ä–æ–±–ª–µ–º—ã:

1. –û—Ç–∫—Ä–æ–π —ç—Ç–æ—Ç —Ñ–∞–π–ª: `üìù_KNOWN_ISSUES_P2.md`
2. –í—ã–±–µ—Ä–∏ –ø—Ä–æ–±–ª–µ–º—É –¥–ª—è —Ñ–∏–∫—Å–∞
3. –ü—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª—ã –≤ —Å–µ–∫—Ü–∏–∏ "–§–∞–π–ª—ã"
4. –ü—Ä–∏–º–µ–Ω–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é
5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π
6. –ó–∞–¥–µ–ø–ª–æ–π
7. –û—Ç–º–µ—Ç—å –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ

---

## üìä –ü–†–ò–û–†–ò–¢–ò–ó–ê–¶–ò–Ø P2 –§–ò–ö–°–û–í (–ö–û–ì–î–ê –í–ï–†–ù–ï–ú–°–Ø)

**–ü–æ—Ä—è–¥–æ–∫ —Ñ–∏–∫—Å–∞ (–ø–æ –≤–∞–∂–Ω–æ—Å—Ç–∏):**

1. **Rate Limiting** –¥–ª—è `/api/landing` (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞)
2. **CORS** —Å—Ç—Ä–æ–∂–µ –Ω–∞ –ø—Ä–æ–¥–µ (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
3. **PM2 Logs Rotation** (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è)
4. **Recovery Script dry-run** (—É–¥–æ–±—Å—Ç–≤–æ)
5. **Environment Variables** –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–∫–æ—Å–º–µ—Ç–∏–∫–∞)
6. **Facebook Pixel** –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—Å—è)

---

**–≠—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã –ù–ï –ö–†–ò–¢–ò–ß–ù–´. –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ.**

**–í–µ—Ä–Ω–µ–º—Å—è –∫ –Ω–∏–º –ø–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ñ–∏–∫—Å–æ–≤.**
