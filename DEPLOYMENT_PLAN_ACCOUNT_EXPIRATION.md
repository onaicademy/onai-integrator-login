# üöÄ –ü–õ–ê–ù –î–ï–ü–õ–û–Ø: –°–∏—Å—Ç–µ–º–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∏ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤

## ‚úÖ –ß–¢–û –†–ï–ê–õ–ò–ó–û–í–ê–ù–û:

### 1Ô∏è‚É£ **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (SQL –º–∏–≥—Ä–∞—Ü–∏—è)**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –≤ `profiles`:
  - `deleted_at` - –¥–∞—Ç–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
  - `account_expires_at` - —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
  - `deactivation_reason` - –ø—Ä–∏—á–∏–Ω–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `deactivate_expired_accounts()` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
- ‚úÖ –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å—Ä–æ–∫ 12 –º–µ—Å—è—Ü–µ–≤

### 2Ô∏è‚É£ **–î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è**
- ‚úÖ `handleDeleteStudent()` —Ç–µ–ø–µ—Ä—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç, –∞ –Ω–µ —É–¥–∞–ª—è–µ—Ç
- ‚úÖ –ö–Ω–æ–ø–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∞: üóëÔ∏è ‚Üí ‚õî "–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å"
- ‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è (–¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö —Ü–µ–ª–µ–π)

### 3Ô∏è‚É£ **–§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —É—á–µ–Ω–∏–∫–∞**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–±–æ—Ä —Å—Ä–æ–∫–∞: **3 / 6 / 12 –º–µ—Å—è—Ü–µ–≤**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç `account_expires_at`
- ‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ —Å—Ä–æ–∫–∞ –≤ Edge Function `create-student`

### 4Ô∏è‚É£ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ**
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `is_active = false` ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–ê–∫–∫–∞—É–Ω—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `account_expires_at < now()` ‚Üí –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–°—Ä–æ–∫ –∏—Å—Ç—ë–∫"
- ‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å < 7 –¥–Ω–µ–π
- ‚úÖ –†–∞–∑–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∏—á–∏–Ω—ã (`manual` / `expired`)

---

## üìã –ß–¢–û –ù–£–ñ–ù–û –°–î–ï–õ–ê–¢–¨:

### **–®–ê–ì 1: –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é** ‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ù–û!**

```bash
1. –û—Ç–∫—Ä–æ–π Supabase SQL Editor:
   https://supabase.com/dashboard/project/arqhkacellqbhjhbebfh/sql/new

2. –°–∫–æ–ø–∏—Ä—É–π –∏ –≤—ã–ø–æ–ª–Ω–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:
   supabase/migrations/20251108_add_account_expiration.sql

3. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ:
   - –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ profiles
   - –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è deactivate_expired_accounts()
   - –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å—Ä–æ–∫ 12 –º–µ—Å—è—Ü–µ–≤
```

### **–®–ê–ì 2: –û–±–Ω–æ–≤–∏—Ç—å Edge Function `create-student`** ‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ù–û!**

–¢–µ–ø–µ—Ä—å —Ñ–æ—Ä–º–∞ –ø–µ—Ä–µ–¥–∞—ë—Ç `account_expires_at`, –Ω—É–∂–Ω–æ —á—Ç–æ–±—ã Edge Function:
1. –ü—Ä–∏–Ω–∏–º–∞–ª–∞ —ç—Ç–æ –ø–æ–ª–µ
2. –°–æ—Ö—Ä–∞–Ω—è–ª–∞ –µ–≥–æ –≤ `profiles` –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–í–ê–†–ò–ê–ù–¢–´:**

**A. –ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ Supabase Functions:**
```typescript
// supabase/functions/create-student/index.ts

// –î–æ–±–∞–≤—å –≤ body:
const { 
  email, 
  full_name, 
  phone, 
  password, 
  role, 
  account_expires_at // ‚Üê –ù–û–í–û–ï
} = await req.json();

// –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è:
await supabaseAdmin
  .from('profiles')
  .insert({
    id: user.id,
    email,
    full_name,
    role,
    account_expires_at, // ‚Üê –ù–û–í–û–ï
    is_active: true
  });
```

**B. –ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Functions:**
–°–∫–∞–∂–∏ –º–Ω–µ, —è –ø–æ–º–æ–≥—É!

### **–®–ê–ì 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ localhost** ‚úÖ

```bash
1. –ó–∞–ø—É—Å—Ç–∏ SQL –º–∏–≥—Ä–∞—Ü–∏—é –≤ Supabase

2. –û—Ç–∫—Ä–æ–π https://localhost:8080/admin/students-activity

3. –¢–ï–°–¢ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ —Å–æ —Å—Ä–æ–∫–æ–º
   - –ù–∞–∂–º–∏ "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
   - –ó–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É
   - –í—ã–±–µ—Ä–∏ "3 –º–µ—Å—è—Ü–∞"
   - –°–æ–∑–¥–∞–π
   ‚Üí –ü—Ä–æ–≤–µ—Ä—å –≤ Supabase —á—Ç–æ account_expires_at —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

4. –¢–ï–°–¢ 2: –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è
   - –ù–∞–∂–º–∏ ‚õî –Ω–∞ –ª—é–±–æ–º —Å—Ç—É–¥–µ–Ω—Ç–µ
   - –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—é
   ‚Üí –°—Ç—É–¥–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –∏—Å—á–µ–∑–Ω—É—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞
   ‚Üí –í Supabase: is_active = false, deleted_at —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

5. –¢–ï–°–¢ 3: –õ–æ–≥–∏–Ω –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ü–æ–ø—Ä–æ–±—É–π –≤–æ–π—Ç–∏ email'–æ–º –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
   ‚Üí –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–ê–∫–∫–∞—É–Ω—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"
   ‚Üí –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /login

6. –¢–ï–°–¢ 4: –õ–æ–≥–∏–Ω —Å –∏—Å—Ç—ë–∫—à–∏–º —Å—Ä–æ–∫–æ–º
   - –í Supabase –∏–∑–º–µ–Ω–∏ account_expires_at –Ω–∞ –≤—á–µ—Ä–∞—à–Ω—é—é –¥–∞—Ç—É
   - –ü–æ–ø—Ä–æ–±—É–π –≤–æ–π—Ç–∏
   ‚Üí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∏—Å—Ç—ë–∫"
   ‚Üí –ê–∫–∫–∞—É–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
```

### **–®–ê–ì 4: –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä** (–¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤!)

```bash
git add -A
git commit -m "feat: —Å–∏—Å—Ç–µ–º–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∏ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤

- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è deleted_at, account_expires_at, deactivation_reason
- –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ)
- –í—ã–±–æ—Ä —Å—Ä–æ–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ (3/6/12 –º–µ—Å—è—Ü–µ–≤)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –∏—Å—Ç—ë–∫—à–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤"

git push origin main
./deploy.sh
```

---

## üîß –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

### **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è (Cron Job)**

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç—ë–∫—à–∏–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∫–∞–∂–¥—ã–π –¥–µ–Ω—å:

```sql
-- –í—ã–ø–æ–ª–Ω–∏ –≤ Supabase SQL Editor:
SELECT cron.schedule(
  'deactivate-expired-accounts',
  '0 0 * * *', -- –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å
  'SELECT deactivate_expired_accounts()'
);
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:**
```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:
SELECT * FROM cron.job;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
SELECT * FROM cron.job_run_details ORDER BY start_time DESC LIMIT 10;
```

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê (–ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è):

```sql
-- –í—ã–ø–æ–ª–Ω–∏ –≤ Supabase —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
SELECT 
  COUNT(*) FILTER (WHERE role = 'student') AS total_students,
  COUNT(*) FILTER (WHERE role = 'student' AND is_active = true) AS active_students,
  COUNT(*) FILTER (WHERE role = 'student' AND account_expires_at < NOW()) AS expired_students,
  COUNT(*) FILTER (WHERE role = 'student' AND account_expires_at BETWEEN NOW() AND NOW() + INTERVAL '7 days') AS expiring_soon
FROM profiles;
```

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø:

1. **–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞:** –í—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
2. **–ù–µ—Ç –ø—É—Ç–∏ –Ω–∞–∑–∞–¥:** –ü–æ—Å–ª–µ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –°–ú–û–ñ–ï–¢ –≤–æ–π—Ç–∏
3. **–†–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è:** –ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –≤—Ä—É—á–Ω—É—é –∏–∑–º–µ–Ω–∏—Ç—å `is_active = true` –≤ Supabase
4. **Edge Function:** –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å `create-student` —á—Ç–æ–±—ã –ø—Ä–∏–Ω–∏–º–∞—Ç—å `account_expires_at`

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:

1. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é
2. ‚ö†Ô∏è –û–±–Ω–æ–≤–∏—Ç—å Edge Function `create-student`
3. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ localhost
4. ‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
5. ‚úÖ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Cron Job

---

**–ì–û–¢–û–í –ö –î–ï–ü–õ–û–Æ!** üöÄ

