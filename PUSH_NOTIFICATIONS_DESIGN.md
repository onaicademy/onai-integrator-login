# üîî –î–ò–ó–ê–ô–ù –°–ò–°–¢–ï–ú–´ –ü–£–®-–£–í–ï–î–û–ú–õ–ï–ù–ò–ô –î–õ–Ø AI-–ù–ê–°–¢–ê–í–ù–ò–ö–ê

**–î–∞—Ç–∞:** 21 –Ω–æ—è–±—Ä—è 2025
**–ü—Ä–æ–µ–∫—Ç:** onAI Academy - –ü—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

---

## üéØ –¶–ï–õ–¨ –°–ò–°–¢–ï–ú–´

AI-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω **–∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥** —Å —Å—Ç—É–¥–µ–Ω—Ç–æ–º –∫–æ–≥–¥–∞:
- –°—Ç—É–¥–µ–Ω—Ç –º–Ω–æ–≥–æ —Ä–∞–∑ –ø–µ—Ä–µ–º–∞—Ç—ã–≤–∞–µ—Ç –≤–∏–¥–µ–æ (—Å–ª–æ–∂–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª)
- –°—Ç—É–¥–µ–Ω—Ç –¥–æ–ª–≥–æ –Ω–µ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
- –°—Ç—É–¥–µ–Ω—Ç –±–ª–∏–∑–æ–∫ –∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é
- Streak –ø–æ–¥ —É–≥—Ä–æ–∑–æ–π
- –ï—Å—Ç—å –Ω–æ–≤–∞—è –º–∏—Å—Å–∏—è

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–ò–°–¢–ï–ú–´

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    BACKEND (–¢—Ä–∏–≥–≥–µ—Ä—ã)                    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  –°–æ–±—ã—Ç–∏–µ: –°—Ç—É–¥–µ–Ω—Ç –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ–ª —É—Ä–æ–∫ 5 —Ä–∞–∑          ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Üì                                                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –§—É–Ω–∫—Ü–∏—è: detect_video_struggle()                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Üì                                                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ ai_mentor_tasks                 ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Üì                                                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ push_notifications         ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì Supabase Realtime
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  FRONTEND (React)                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: NotificationCenter                      ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Üì                                                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ push_notifications (Realtime)         ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Üì                                                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –ü–æ–ª—É—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è                             ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Üì                                                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –ü–æ–∫–∞–∑ Toast + Badge + –ó–≤—É–∫                        ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  ‚Üì                                                  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  –ö–ª–∏–∫ ‚Üí –û—Ç–∫—Ä—ã—Ç–∏–µ NeuroHub + –ß–∞—Ç —Å AI              ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä –¢–ê–ë–õ–ò–¶–ê –ë–î: push_notifications

```sql
CREATE TABLE IF NOT EXISTS public.push_notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,

  -- –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  notification_type TEXT NOT NULL CHECK (notification_type IN (
    'video_struggle',      -- –°—Ç—É–¥–µ–Ω—Ç –ø–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç —É—Ä–æ–∫
    'inactivity_alert',    -- –î–æ–ª–≥–æ –Ω–µ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
    'achievement_near',    -- –ë–ª–∏–∑–∫–æ –∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é
    'streak_warning',      -- Streak –ø–æ–¥ —É–≥—Ä–æ–∑–æ–π
    'new_mission',         -- –ù–æ–≤–∞—è –º–∏—Å—Å–∏—è
    'ai_mentor_message'    -- –û–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞
  )),

  -- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  icon TEXT, -- Emoji –∏–ª–∏ URL

  -- –î–µ–π—Å—Ç–≤–∏–µ
  action_type TEXT CHECK (action_type IN ('open_chat', 'open_lesson', 'open_achievements', 'none')),
  action_url TEXT, -- URL –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, /neurohub?chat=open)

  -- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
  priority TEXT DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high', 'urgent')),

  -- –°—Ç–∞—Ç—É—Å
  is_read BOOLEAN DEFAULT false,
  is_dismissed BOOLEAN DEFAULT false,
  read_at TIMESTAMPTZ,
  dismissed_at TIMESTAMPTZ,

  -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  context_data JSONB, -- { lesson_id, achievement_id, etc }
  ai_mentor_task_id UUID REFERENCES ai_mentor_tasks(id),

  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  expires_at TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '7 days')
);

CREATE INDEX idx_push_notifications_user ON push_notifications(user_id);
CREATE INDEX idx_push_notifications_unread ON push_notifications(user_id, is_read) WHERE is_read = false;
CREATE INDEX idx_push_notifications_created ON push_notifications(user_id, created_at DESC);

-- RLS –ø–æ–ª–∏—Ç–∏–∫–∏
ALTER TABLE push_notifications ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Users can view own notifications" ON push_notifications;
CREATE POLICY "Users can view own notifications"
  ON push_notifications FOR SELECT
  USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can update own notifications" ON push_notifications;
CREATE POLICY "Users can update own notifications"
  ON push_notifications FOR UPDATE
  USING (auth.uid() = user_id);
```

---

## üîß BACKEND: –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ —Å–æ–±—ã—Ç–∏–∏

### SQL –§—É–Ω–∫—Ü–∏—è: create_push_notification

```sql
CREATE OR REPLACE FUNCTION create_push_notification(
  p_user_id UUID,
  p_type TEXT,
  p_title TEXT,
  p_message TEXT,
  p_action_type TEXT DEFAULT 'open_chat',
  p_action_url TEXT DEFAULT '/neurohub',
  p_priority TEXT DEFAULT 'medium',
  p_context_data JSONB DEFAULT NULL,
  p_task_id UUID DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
  v_notification_id UUID;
BEGIN
  INSERT INTO push_notifications (
    user_id,
    notification_type,
    title,
    message,
    action_type,
    action_url,
    priority,
    context_data,
    ai_mentor_task_id
  )
  VALUES (
    p_user_id,
    p_type,
    p_title,
    p_message,
    p_action_type,
    p_action_url,
    p_priority,
    p_context_data,
    p_task_id
  )
  RETURNING id INTO v_notification_id;

  RAISE NOTICE '–°–æ–∑–¥–∞–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: %', v_notification_id;
  RETURN v_notification_id;
END;
$$ LANGUAGE plpgsql;
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ detect_video_struggle:

```sql
CREATE OR REPLACE FUNCTION detect_video_struggle()
RETURNS TRIGGER AS $$
DECLARE
  v_task_id UUID;
  v_notification_id UUID;
  v_lesson_title TEXT;
BEGIN
  -- –ï—Å–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç –ø–µ—Ä–µ–º–æ—Ç–∞–ª –Ω–∞–∑–∞–¥ 5+ —Ä–∞–∑
  IF NEW.seeks_count >= 5 THEN
    -- –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞
    SELECT title INTO v_lesson_title
    FROM lessons
    WHERE id = NEW.lesson_id;

    -- –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è AI-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞
    v_task_id := create_mentor_task_from_video_struggle(
      NEW.user_id,
      NEW.lesson_id,
      NEW.seeks_count,
      NEW.max_second_reached
    );

    -- –°–æ–∑–¥–∞–µ–º –ø—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    v_notification_id := create_push_notification(
      p_user_id := NEW.user_id,
      p_type := 'video_struggle',
      p_title := 'üí° –í–∏–∂—É, —É—Ä–æ–∫ –∫–∞–∂–µ—Ç—Å—è —Å–ª–æ–∂–Ω—ã–º?',
      p_message := format(
        '–¢—ã –ø–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞–ª "%s" –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑. –î–∞–≤–∞–π —è –ø–æ–º–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è! ü§ù',
        v_lesson_title
      ),
      p_action_type := 'open_chat',
      p_action_url := '/neurohub?chat=open&context=video_struggle',
      p_priority := CASE
        WHEN NEW.seeks_count >= 10 THEN 'high'
        WHEN NEW.seeks_count >= 7 THEN 'medium'
        ELSE 'low'
      END,
      p_context_data := jsonb_build_object(
        'lesson_id', NEW.lesson_id,
        'lesson_title', v_lesson_title,
        'seeks_count', NEW.seeks_count,
        'struggling_at_second', NEW.max_second_reached
      ),
      p_task_id := v_task_id
    );

    RAISE NOTICE '–°–æ–∑–¥–∞–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —É—Ä–æ–∫–∞: %', v_notification_id;
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

---

## ‚öõÔ∏è FRONTEND: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç NotificationCenter

### 1. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç: NotificationCenter.tsx

```typescript
// src/components/NotificationCenter.tsx
import { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabase';
import { useAuth } from '@/hooks/useAuth';
import { Bell } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { useNavigate } from 'react-router-dom';
import { useToast } from '@/hooks/use-toast';

interface PushNotification {
  id: string;
  notification_type: string;
  title: string;
  message: string;
  icon?: string;
  action_type: string;
  action_url: string;
  priority: 'low' | 'medium' | 'high' | 'urgent';
  is_read: boolean;
  context_data?: any;
  created_at: string;
}

export const NotificationCenter = () => {
  const { user } = useAuth();
  const navigate = useNavigate();
  const { toast } = useToast();

  const [notifications, setNotifications] = useState<PushNotification[]>([]);
  const [unreadCount, setUnreadCount] = useState(0);
  const [isOpen, setIsOpen] = useState(false);

  useEffect(() => {
    if (!user?.id) return;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    loadNotifications();

    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ Realtime
    const subscription = supabase
      .channel('push_notifications_changes')
      .on(
        'postgres_changes',
        {
          event: 'INSERT',
          schema: 'public',
          table: 'push_notifications',
          filter: `user_id=eq.${user.id}`
        },
        (payload) => {
          const newNotification = payload.new as PushNotification;

          // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫
          setNotifications(prev => [newNotification, ...prev]);
          setUnreadCount(prev => prev + 1);

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast
          showNotificationToast(newNotification);

          // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
          playNotificationSound(newNotification.priority);
        }
      )
      .subscribe();

    return () => {
      subscription.unsubscribe();
    };
  }, [user?.id]);

  const loadNotifications = async () => {
    if (!user?.id) return;

    const { data, error } = await supabase
      .from('push_notifications')
      .select('*')
      .eq('user_id', user.id)
      .eq('is_dismissed', false)
      .order('created_at', { ascending: false })
      .limit(20);

    if (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
      return;
    }

    setNotifications(data || []);
    setUnreadCount(data?.filter(n => !n.is_read).length || 0);
  };

  const showNotificationToast = (notification: PushNotification) => {
    toast({
      title: (
        <div className="flex items-center gap-2">
          <span className="text-2xl">{notification.icon || 'üîî'}</span>
          <span>{notification.title}</span>
        </div>
      ),
      description: notification.message,
      action: notification.action_type === 'open_chat' ? (
        <Button
          size="sm"
          variant="outline"
          onClick={() => handleNotificationClick(notification)}
        >
          –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
        </Button>
      ) : undefined,
      duration: notification.priority === 'urgent' ? 10000 : 5000,
    });
  };

  const playNotificationSound = (priority: string) => {
    const audio = new Audio('/sounds/notification.mp3');
    audio.volume = priority === 'urgent' ? 0.8 : 0.5;
    audio.play().catch(err => console.log('–ó–≤—É–∫ –æ—Ç–∫–ª—é—á–µ–Ω:', err));
  };

  const handleNotificationClick = async (notification: PushNotification) => {
    // –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
    await supabase
      .from('push_notifications')
      .update({ is_read: true, read_at: new Date().toISOString() })
      .eq('id', notification.id);

    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    setNotifications(prev =>
      prev.map(n => n.id === notification.id ? { ...n, is_read: true } : n)
    );
    setUnreadCount(prev => Math.max(0, prev - 1));

    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ —Å—Å—ã–ª–∫–µ
    if (notification.action_url) {
      navigate(notification.action_url);
    }

    setIsOpen(false);
  };

  const markAllAsRead = async () => {
    if (!user?.id) return;

    await supabase
      .from('push_notifications')
      .update({ is_read: true, read_at: new Date().toISOString() })
      .eq('user_id', user.id)
      .eq('is_read', false);

    setNotifications(prev => prev.map(n => ({ ...n, is_read: true })));
    setUnreadCount(0);
  };

  return (
    <div className="relative">
      {/* –ö–Ω–æ–ø–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */}
      <Button
        variant="ghost"
        size="icon"
        onClick={() => setIsOpen(!isOpen)}
        className="relative"
      >
        <Bell className="h-5 w-5" />
        {unreadCount > 0 && (
          <motion.div
            initial={{ scale: 0 }}
            animate={{ scale: 1 }}
            className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center"
          >
            {unreadCount > 9 ? '9+' : unreadCount}
          </motion.div>
        )}
      </Button>

      {/* –ü–∞–Ω–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */}
      <AnimatePresence>
        {isOpen && (
          <motion.div
            initial={{ opacity: 0, y: -10 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -10 }}
            className="absolute right-0 mt-2 w-96 bg-zinc-900 border-2 border-[#00ff00]/30 rounded-xl shadow-2xl z-50 max-h-[500px] overflow-hidden"
          >
            {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
            <div className="p-4 border-b border-zinc-800 flex items-center justify-between">
              <h3 className="text-white font-bold">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
              {unreadCount > 0 && (
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={markAllAsRead}
                  className="text-xs"
                >
                  –ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ
                </Button>
              )}
            </div>

            {/* –°–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */}
            <div className="overflow-y-auto max-h-96">
              {notifications.length === 0 ? (
                <div className="p-8 text-center text-gray-400">
                  <Bell className="h-12 w-12 mx-auto mb-2 opacity-50" />
                  <p>–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
                </div>
              ) : (
                notifications.map((notification) => (
                  <motion.div
                    key={notification.id}
                    initial={{ opacity: 0, x: -20 }}
                    animate={{ opacity: 1, x: 0 }}
                    onClick={() => handleNotificationClick(notification)}
                    className={`p-4 border-b border-zinc-800 cursor-pointer hover:bg-zinc-800/50 transition-colors ${
                      !notification.is_read ? 'bg-[#00ff00]/5' : ''
                    }`}
                  >
                    <div className="flex items-start gap-3">
                      <span className="text-2xl">
                        {notification.icon || 'üîî'}
                      </span>
                      <div className="flex-1">
                        <div className="flex items-center justify-between mb-1">
                          <h4 className="text-white font-semibold text-sm">
                            {notification.title}
                          </h4>
                          {!notification.is_read && (
                            <div className="w-2 h-2 bg-[#00ff00] rounded-full" />
                          )}
                        </div>
                        <p className="text-gray-400 text-xs mb-2">
                          {notification.message}
                        </p>
                        <span className="text-xs text-gray-500">
                          {formatTime(notification.created_at)}
                        </span>
                      </div>
                    </div>
                  </motion.div>
                ))
              )}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
};

function formatTime(dateString: string): string {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60000);

  if (diffMins < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
  if (diffMins < 60) return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
  if (diffMins < 1440) return `${Math.floor(diffMins / 60)} —á –Ω–∞–∑–∞–¥`;
  return `${Math.floor(diffMins / 1440)} –¥–Ω –Ω–∞–∑–∞–¥`;
}
```

---

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Layout

```typescript
// src/components/Layout.tsx
import { NotificationCenter } from '@/components/NotificationCenter';

export const Layout = ({ children }) => {
  return (
    <div>
      <header className="flex items-center justify-between p-4">
        <Logo />
        <div className="flex items-center gap-4">
          <NotificationCenter /> {/* ‚Üê –î–æ–±–∞–≤–ª—è–µ–º —Å—é–¥–∞ */}
          <UserMenu />
        </div>
      </header>
      <main>{children}</main>
    </div>
  );
};
```

---

## üé® –î–ò–ó–ê–ô–ù –£–í–ï–î–û–ú–õ–ï–ù–ò–ô

### –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å –∏–∫–æ–Ω–∫–∞–º–∏:

| –¢–∏–ø | –ò–∫–æ–Ω–∫–∞ | –ó–∞–≥–æ–ª–æ–≤–æ–∫ | –ü—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è |
|-----|--------|-----------|------------------|
| **video_struggle** | üí° | –í–∏–∂—É, —É—Ä–æ–∫ –∫–∞–∂–µ—Ç—Å—è —Å–ª–æ–∂–Ω—ã–º? | –¢—ã –ø–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞–ª "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–∞" –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑. –î–∞–≤–∞–π —è –ø–æ–º–æ–≥—É! |
| **inactivity_alert** | üò¢ | –ú—ã —Å–∫—É—á–∞–µ–º! | –¢—ã –Ω–µ –∑–∞—Ö–æ–¥–∏–ª —É–∂–µ 3 –¥–Ω—è. –ö–∞–∫ –¥–µ–ª–∞? –ú–æ–≥—É –ø–æ–º–æ—á—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—É—á–µ–Ω–∏—é! |
| **achievement_near** | üèÜ | –ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ! | –û—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ 2 —É—Ä–æ–∫–∞ –¥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è "–ú–∞—Ä–∞—Ñ–æ–Ω–µ—Ü"! –î–∞–≤–∞–π —Ñ–∏–Ω–∏—à–∏—Ä—É–µ–º! |
| **streak_warning** | üî• | –ù–µ –ø–æ—Ç–µ—Ä—è–π —Å–≤–æ–π streak! | –°–µ–≥–æ–¥–Ω—è –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å! –ü—Ä–æ–π–¥–∏ —Ö–æ—Ç—è –±—ã 1 —É—Ä–æ–∫, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å 7-–¥–Ω–µ–≤–Ω—ã–π streak. |
| **new_mission** | üéØ | –ù–æ–≤–∞—è –º–∏—Å—Å–∏—è! | –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –º–∏—Å—Å–∏—è "–ó–∞–≤–µ—Ä—à–∏—Ç—å –º–æ–¥—É–ª—å 2" (+150 XP). –ü–æ–µ—Ö–∞–ª–∏! |
| **ai_mentor_message** | ü§ñ | –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞ | –ü—Ä–∏–≤–µ—Ç! –ó–∞–º–µ—Ç–∏–ª —á—Ç–æ —Ç—ã –æ—Ç–ª–∏—á–Ω–æ —Å–ø—Ä–∞–≤–ª—è–µ—à—å—Å—è. –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ! |

---

## üîä –ó–í–£–ö–ò

–î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª—ã –∑–≤—É–∫–æ–≤ –≤ `public/sounds/`:

- `notification.mp3` - –û–±—ã—á–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- `urgent.mp3` - –°—Ä–æ—á–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–¥–ª—è streak_warning)
- `achievement.mp3` - –ü—Ä–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è

---

## üìä –ü–†–ò–ú–ï–†–´ –¢–†–ò–ì–ì–ï–†–û–í

### 1. –°—Ç—É–¥–µ–Ω—Ç –Ω–µ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω 3 –¥–Ω—è

```sql
-- Cron –∑–∞–¥–∞—á–∞ (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ä–∞–∑ –≤ –¥–µ–Ω—å)
CREATE OR REPLACE FUNCTION check_inactive_students()
RETURNS VOID AS $$
DECLARE
  v_user RECORD;
BEGIN
  FOR v_user IN
    SELECT id, full_name, last_activity_at
    FROM profiles
    WHERE last_activity_at < NOW() - INTERVAL '3 days'
      AND last_activity_at > NOW() - INTERVAL '4 days' -- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
  LOOP
    PERFORM create_push_notification(
      p_user_id := v_user.id,
      p_type := 'inactivity_alert',
      p_title := 'üò¢ –ú—ã —Å–∫—É—á–∞–µ–º!',
      p_message := format('–ü—Ä–∏–≤–µ—Ç, %s! –¢—ã –Ω–µ –∑–∞—Ö–æ–¥–∏–ª —É–∂–µ 3 –¥–Ω—è. –ö–∞–∫ –¥–µ–ª–∞? –ú–æ–≥—É –ø–æ–º–æ—á—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—É—á–µ–Ω–∏—é!', v_user.full_name),
      p_priority := 'medium'
    );
  END LOOP;
END;
$$ LANGUAGE plpgsql;
```

### 2. –°—Ç—É–¥–µ–Ω—Ç –±–ª–∏–∑–æ–∫ –∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é

```sql
CREATE OR REPLACE FUNCTION check_near_achievements()
RETURNS VOID AS $$
DECLARE
  v_achievement RECORD;
BEGIN
  FOR v_achievement IN
    SELECT
      ua.user_id,
      ua.achievement_id,
      ua.current_value,
      ua.required_value
    FROM user_achievements ua
    WHERE ua.is_completed = false
      AND ua.current_value >= (ua.required_value * 0.9) -- 90% –ø—Ä–æ–≥—Ä–µ—Å—Å
      AND ua.current_value < ua.required_value
  LOOP
    PERFORM create_push_notification(
      p_user_id := v_achievement.user_id,
      p_type := 'achievement_near',
      p_title := 'üèÜ –ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ!',
      p_message := format(
        '–û—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ %s –¥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è "%s"! –î–∞–≤–∞–π —Ñ–∏–Ω–∏—à–∏—Ä—É–µ–º!',
        v_achievement.required_value - v_achievement.current_value,
        v_achievement.achievement_id
      ),
      p_priority := 'high',
      p_action_url := '/neurohub#achievements'
    );
  END LOOP;
END;
$$ LANGUAGE plpgsql;
```

---

## ‚úÖ –ò–¢–û–ì–û–í–´–ô –ß–ï–ö–õ–ò–°–¢

### Backend:
- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `push_notifications`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `detect_video_struggle()`
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `check_inactive_students()`
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `check_near_achievements()`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron –∑–∞–¥–∞—á–∏

### Frontend:
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `NotificationCenter.tsx`
- [ ] –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ Layout
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∑–≤—É–∫–∏ –≤ `public/sounds/`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Supabase Realtime –ø–æ–¥–ø–∏—Å–∫—É
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- [ ] –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å —É—Ä–æ–∫ 5+ —Ä–∞–∑ ‚Üí –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–∞—Ç
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–≤—É–∫
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å badge —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º

---

## üéâ –ì–û–¢–û–í–û!

–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π! üöÄ
