name: üìä Deploy Traffic Dashboard

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ Traffic Dashboard
on:
  push:
    branches:
      - main
    paths:
      - 'src/pages/traffic/**'
      - 'src/components/traffic/**'
      - 'src/hooks/useTraffic*.tsx'
      - '.github/workflows/deploy-traffic-dashboard.yml'
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  deploy-traffic:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üî® Build frontend
        run: npm run build
        env:
          # Main Supabase (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è Traffic Dashboard —Ç–æ–∂–µ)
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          # Tripwire
          VITE_TRIPWIRE_SUPABASE_URL: ${{ secrets.VITE_TRIPWIRE_SUPABASE_URL }}
          VITE_TRIPWIRE_SUPABASE_ANON_KEY: ${{ secrets.VITE_TRIPWIRE_SUPABASE_ANON_KEY }}
          # Landing
          VITE_LANDING_SUPABASE_URL: ${{ secrets.VITE_LANDING_SUPABASE_URL }}
          VITE_LANDING_SUPABASE_ANON_KEY: ${{ secrets.VITE_LANDING_SUPABASE_ANON_KEY }}
          VITE_API_URL: https://api.onai.academy

      - name: üì¶ Create deployment archive
        run: |
          tar -czf deploy-traffic-$(date +%Y%m%d-%H%M%S).tar.gz dist/

      - name: üöÄ Upload to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 207.154.231.30
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          source: "deploy-traffic-*.tar.gz"
          target: "/tmp/"
          rm: false

      - name: üîÑ Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 207.154.231.30
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -e
            echo "üöÄ –î–µ–ø–ª–æ–π Traffic Dashboard..."

            # Backup —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏
            cd /var/www/traffic.onai.academy
            tar -czf /tmp/traffic-backup-$(date +%Y%m%d-%H%M%S).tar.gz assets/ index.html 2>/dev/null || true

            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
            rm -rf assets/*
            rm -f index.html

            # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π build
            LATEST_ARCHIVE=$(ls -t /tmp/deploy-traffic-*.tar.gz | head -1)
            tar -xzf "$LATEST_ARCHIVE" --strip-components=1

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
            chown -R www-data:www-data /var/www/traffic.onai.academy
            chmod -R 755 /var/www/traffic.onai.academy

            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx
            systemctl reload nginx

            # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
            ls -t /tmp/deploy-traffic-*.tar.gz | tail -n +6 | xargs rm -f 2>/dev/null || true

            echo "‚úÖ Traffic Dashboard –∑–∞–¥–µ–ø–ª–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
            echo "üåê URL: https://traffic.onai.academy"

      - name: ‚úÖ Verify deployment
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è..."
          sleep 3
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://traffic.onai.academy/)
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Traffic Dashboard –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º (HTTP $HTTP_CODE)"
            exit 1
          fi
