name: Deploy Frontend to Vercel

# Frontend –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ø–ª–æ–∏—Ç—Å—è —á–µ—Ä–µ–∑ Vercel –ø—Ä–∏ push –≤ main
# –≠—Ç–æ—Ç workflow –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è —á–µ—Ä–µ–∑ Vercel API

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'vite.config.ts'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  check-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Check build output
        run: |
          if [ -d "dist" ]; then
            echo "‚úÖ Frontend build —É—Å–ø–µ—à–µ–Ω"
            ls -la dist/ | head -10
          else
            echo "‚ùå Build –Ω–µ —Å–æ–∑–¥–∞–ª dist/"
            exit 1
          fi

      - name: Check Vercel deployment status
        if: env.VERCEL_TOKEN != ''
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è Vercel..."
          
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "‚ö†Ô∏è VERCEL_TOKEN –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É"
            echo "‚ÑπÔ∏è Frontend –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—Å—è —á–µ—Ä–µ–∑ Vercel"
            exit 0
          fi
          
          # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–ø–ª–æ–π
          DEPLOYMENT=$(curl -s \
            -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v6/deployments?projectId=$VERCEL_PROJECT_ID&limit=1" \
            | jq -r '.deployments[0] // empty')
          
          if [ -z "$DEPLOYMENT" ]; then
            echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–µ–ø–ª–æ–µ"
            exit 0
          fi
          
          STATE=$(echo "$DEPLOYMENT" | jq -r '.state // "unknown"')
          URL=$(echo "$DEPLOYMENT" | jq -r '.url // "unknown"')
          CREATED=$(echo "$DEPLOYMENT" | jq -r '.createdAt // "unknown"')
          
          echo "üìä –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–ø–ª–æ—è:"
          echo "   State: $STATE"
          echo "   URL: $URL"
          echo "   Created: $CREATED"
          
          if [ "$STATE" = "READY" ]; then
            echo "‚úÖ Vercel –¥–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω!"
            echo "üåê Production URL: https://onai.academy"
          elif [ "$STATE" = "BUILDING" ] || [ "$STATE" = "QUEUED" ]; then
            echo "‚è≥ Vercel –¥–µ–ø–ª–æ–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ..."
            echo "üìä –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: https://vercel.com/dashboard"
          elif [ "$STATE" = "ERROR" ] || [ "$STATE" = "CANCELED" ]; then
            echo "‚ùå Vercel –¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
            echo "üìä –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: https://vercel.com/dashboard"
            exit 1
          else
            echo "‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è: $STATE"
            echo "üìä –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: https://vercel.com/dashboard"
          fi

      - name: Info about Vercel (fallback)
        if: env.VERCEL_TOKEN == ''
        run: |
          echo "‚ÑπÔ∏è Frontend –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—Å—è —á–µ—Ä–µ–∑ Vercel"
          echo "üìä –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: https://vercel.com/dashboard"
          echo "üåê Production URL: https://onai.academy"
          echo ""
          echo "üí° –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –¥–æ–±–∞–≤—å—Ç–µ –≤ GitHub Secrets:"
          echo "   - VERCEL_TOKEN (–∏–∑ Vercel Dashboard ‚Üí Settings ‚Üí Tokens)"
          echo "   - VERCEL_ORG_ID (–∏–∑ Vercel Dashboard ‚Üí Settings)"
          echo "   - VERCEL_PROJECT_ID (–∏–∑ Vercel Dashboard ‚Üí Project Settings)"
