name: Deploy to DigitalOcean Droplet

# Автодеплой ОТКЛЮЧЕН - запускается только вручную через GitHub UI
on:
  workflow_dispatch:  # Ручной запуск через Actions -> Run workflow
  # push:
  #   branches:
  #     - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Deploy to Droplet via SSH
        uses: appleboy/ssh-action@master
        with:
          host: 178.128.203.40
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            cd /var/www/onai-integrator-login
            git pull origin main
            npm install
            # Update .env with all required variables
            echo "Updating .env file..."
            cat > .env <<EOF
            # Supabase
            VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}
            VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}
            
            # OpenAI
            VITE_OPENAI_API_KEY=${{ secrets.VITE_OPENAI_API_KEY }}
            VITE_ASSISTANT_ID=${{ secrets.VITE_ASSISTANT_ID }}
            
            # Telegram Bots
            VITE_TELEGRAM_AI_MENTOR_TOKEN=${{ secrets.VITE_TELEGRAM_AI_MENTOR_TOKEN }}
            VITE_TELEGRAM_AI_ANALYST_TOKEN=${{ secrets.VITE_TELEGRAM_AI_ANALYST_TOKEN }}
            
            # Feature Flags
            VITE_AI_MENTOR_ENABLED=false
            VITE_AI_ANALYST_ENABLED=false
            
            # App Config
            VITE_APP_URL=https://onai.academy
            EOF
            echo "✅ .env file updated"
            npm run build
            # Setup Nginx with SSL support
            echo "Configuring Nginx (with SSL if available)..."
            if [ -f "/etc/letsencrypt/live/onai.academy/fullchain.pem" ]; then
                echo "✅ SSL certificate found, creating HTTPS config..."
                cat > /etc/nginx/sites-available/onai-integrator-login.conf <<'NGINX_EOF'
            # HTTP -> HTTPS redirect
            server {
                listen 80;
                listen [::]:80;
                server_name onai.academy www.onai.academy;
                return 301 https://$server_name$request_uri;
            }
            
            # HTTPS server
            server {
                listen 443 ssl http2;
                listen [::]:443 ssl http2;
                server_name onai.academy www.onai.academy;
            
                ssl_certificate /etc/letsencrypt/live/onai.academy/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/onai.academy/privkey.pem;
                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_prefer_server_ciphers off;
                
                add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
            
                root /var/www/onai-integrator-login/dist;
                index index.html;
            
                location / {
                    try_files $uri $uri/ /index.html;
                }
            
                location ~* \.(?:js|css|png|jpg|jpeg|gif|svg|ico|woff2?|ttf)$ {
                    try_files $uri =404;
                    access_log off;
                    add_header Cache-Control "public, max-age=31536000, immutable";
                }
            }
            NGINX_EOF
            else
                echo "⚠️ SSL certificate not found, creating HTTP config..."
                cat > /etc/nginx/sites-available/onai-integrator-login.conf <<'NGINX_EOF'
            server {
                listen 80;
                server_name onai.academy www.onai.academy;
                root /var/www/onai-integrator-login/dist;
                index index.html;
                location / {
                    try_files $uri $uri/ /index.html;
                }
            }
            NGINX_EOF
            fi
            ln -sf /etc/nginx/sites-available/onai-integrator-login.conf /etc/nginx/sites-enabled/
            nginx -t && systemctl reload nginx
            echo "✅ Nginx configured"
            pm2 restart onai-app || pm2 start npm --name "onai-app" -- run serve
            pm2 save
            echo "✅ Deployed successfully to DigitalOcean!"

