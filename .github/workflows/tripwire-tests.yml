name: ğŸ›¡ï¸ Tripwire Critical Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/src/routes/tripwire-lessons.ts'
      - 'backend/src/routes/tripwire.ts'
      - 'src/pages/tripwire/**'
      - 'src/hooks/useHonestVideoTracking.tsx'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/src/routes/tripwire-lessons.ts'
      - 'backend/src/routes/tripwire.ts'
      - 'src/pages/tripwire/**'
      - 'src/hooks/useHonestVideoTracking.tsx'

jobs:
  critical-tests:
    runs-on: ubuntu-latest
    name: âš ï¸ Critical ID Usage Tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd backend
          npm install
      
      - name: ğŸ›¡ï¸ Run Critical Tests
        run: |
          cd backend
          npm test -- __tests__/tripwire-complete.test.ts
      
      - name: âœ… Validate ID Usage in Code
        run: |
          echo "ğŸ” Checking for incorrect ID usage..."
          
          # âŒ BAD: tripwire_user_id used for FK operations
          if grep -r "tripwire_user_id: tripwire_user_id" backend/src/routes/tripwire-lessons.ts; then
            echo "âŒ CRITICAL: Found incorrect tripwire_user_id usage!"
            echo "âŒ Use main_user_id (auth.users.id) instead!"
            exit 1
          fi
          
          # âœ… GOOD: main_user_id used for FK operations
          if grep -q "tripwire_user_id: main_user_id" backend/src/routes/tripwire-lessons.ts; then
            echo "âœ… Correct ID usage detected"
          else
            echo "âš ï¸ Warning: Cannot verify correct ID usage"
          fi
      
      - name: ğŸ“Š Check for Foreign Key Errors
        run: |
          echo "ğŸ” Checking for FK constraint references..."
          
          if grep -r "foreign key constraint" backend/src/routes/; then
            echo "âš ï¸ Found FK constraint mentions"
          fi
          
          echo "âœ… FK validation complete"
      
      - name: âœ… All Critical Tests Passed
        run: |
          echo "ğŸ‰ All critical tests passed!"
          echo "âœ… ID usage is correct"
          echo "âœ… No FK constraint violations"
