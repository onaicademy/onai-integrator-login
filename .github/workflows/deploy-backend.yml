name: Deploy Backend to DigitalOcean

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –ø—Ä–∏ push –≤ main
on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:  # –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy to DigitalOcean via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 207.154.231.30
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            echo "üöÄ –ù–∞—á–∏–Ω–∞—é –¥–µ–ø–ª–æ–π backend..."
            
            cd /var/www/onai-integrator-login-main/backend
            
            echo "üì¶ Git pull..."
            git stash
            git pull origin main
            
            echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
            npm install --production
            
            echo "üî® –°–±–æ—Ä–∫–∞ TypeScript..."
            npm run build || echo "‚ö†Ô∏è Build –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)"
            
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2..."
            pm2 reload onai-backend --update-env
            
            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
            pm2 status onai-backend
            
            echo "üè• Health check..."
            sleep 3
            curl -f http://localhost:3000/api/health || echo "‚ö†Ô∏è Health check failed"
            
            echo "‚úÖ –î–µ–ø–ª–æ–π backend –∑–∞–≤–µ—Ä—à—ë–Ω!"

