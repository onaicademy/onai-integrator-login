name: Deploy Backend to DigitalOcean

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –ø—Ä–∏ push –≤ main
on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:  # –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy to DigitalOcean via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 207.154.231.30
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -e
            echo "üöÄ –ù–∞—á–∏–Ω–∞—é –¥–µ–ø–ª–æ–π backend..."

            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            cd /var/www/onai-integrator-login-main

            echo "üì¶ Git pull..."
            git fetch origin main
            git reset --hard origin/main

            echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π backend..."
            cd backend
            npm install --production

            echo "üî® –°–±–æ—Ä–∫–∞ TypeScript..."
            npm run build

            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ env.env..."
            if [ ! -f "env.env" ]; then
              echo "‚ö†Ô∏è –§–∞–π–ª env.env –Ω–µ –Ω–∞–π–¥–µ–Ω!"
              exit 1
            fi

            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2..."
            pm2 restart onai-backend --update-env || pm2 start dist/index.js --name onai-backend

            echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ PM2..."
            pm2 status onai-backend
            pm2 save

            echo "üè• Health check..."
            sleep 5
            curl -f http://localhost:3001/api/health || echo "‚ö†Ô∏è Health check failed (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs onai-backend)"

            echo "‚úÖ –î–µ–ø–ª–æ–π backend –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ!"

