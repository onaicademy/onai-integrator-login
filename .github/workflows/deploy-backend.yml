name: Deploy Backend to DigitalOcean

# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ñ€Ð¸ push Ð² main
on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:  # Ð¢Ð°ÐºÐ¶Ðµ Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DO_SSH_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 207.154.231.30 >> ~/.ssh/known_hosts

      - name: Deploy to DigitalOcean
        run: |
          ssh root@207.154.231.30 'bash -s' << 'ENDSSH'
          set -e
          echo "ðŸš€ Starting backend deployment at $(date)"

          # Navigate to project directory
          cd /var/www/onai-integrator-login-main
          echo "ðŸ“ Directory: $(pwd)"

          # Pull latest code
          echo "ðŸ“¦ Git pull..."
          git fetch origin main
          git reset --hard origin/main

          # Install backend dependencies (including devDependencies for TypeScript build)
          echo "ðŸ“¥ Installing backend dependencies..."
          cd backend
          npm install

          # Build TypeScript
          echo "ðŸ”¨ Building TypeScript..."
          npm run build

          # Check env file exists
          if [ ! -f "env.env" ]; then
            echo "âš ï¸ env.env file not found!"
            exit 1
          fi

          # Restart PM2 service
          echo "ðŸ”„ Restarting PM2..."
          pm2 restart backend --update-env || pm2 start dist/server.js --name backend

          # Save PM2 config
          pm2 save

          # Health check (port 3000 for main backend)
          echo "ðŸ¥ Health check..."
          sleep 5
          curl -sf http://localhost:3000/api/health && echo "âœ… Health check passed!" || echo "âš ï¸ Health check failed - check logs: pm2 logs backend"

          echo "âœ… Backend deployment completed at $(date)"
          pm2 list
          ENDSSH

      - name: Deployment Status
        if: success()
        run: echo "âœ… Deployment successful!"

      - name: Deployment Failed
        if: failure()
        run: echo "âŒ Deployment failed! Check logs above."
