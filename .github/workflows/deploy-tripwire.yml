name: üéØ Deploy Tripwire

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ Tripwire
on:
  push:
    branches:
      - main
    paths:
      - 'src/pages/tripwire/**'
      - 'backend/src/routes/tripwire*.ts'
      - 'src/hooks/useHonestVideoTracking.tsx'
      - '.github/workflows/deploy-tripwire.yml'
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  deploy-tripwire:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üî® Build frontend
        run: npm run build
        env:
          # Main Supabase
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          # Tripwire
          VITE_TRIPWIRE_SUPABASE_URL: ${{ secrets.VITE_TRIPWIRE_SUPABASE_URL }}
          VITE_TRIPWIRE_SUPABASE_ANON_KEY: ${{ secrets.VITE_TRIPWIRE_SUPABASE_ANON_KEY }}
          # Landing
          VITE_LANDING_SUPABASE_URL: ${{ secrets.VITE_LANDING_SUPABASE_URL }}
          VITE_LANDING_SUPABASE_ANON_KEY: ${{ secrets.VITE_LANDING_SUPABASE_ANON_KEY }}
          VITE_API_URL: https://api.onai.academy

      - name: üì¶ Create deployment archive
        run: |
          # –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ Tripwire —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          tar -czf deploy-tripwire-$(date +%Y%m%d-%H%M%S).tar.gz dist/

      - name: üöÄ Upload to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 207.154.231.30
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          source: "deploy-tripwire-*.tar.gz"
          target: "/tmp/"
          rm: false

      - name: üîÑ Deploy Tripwire Frontend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 207.154.231.30
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -e
            echo "üöÄ –î–µ–ø–ª–æ–π Tripwire Frontend..."

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ–¥–¥–æ–º–µ–Ω)
            TRIPWIRE_DIR="/var/www/tripwire.onai.academy"

            # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            mkdir -p "$TRIPWIRE_DIR"

            # Backup —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏
            cd "$TRIPWIRE_DIR"
            tar -czf /tmp/tripwire-backup-$(date +%Y%m%d-%H%M%S).tar.gz . 2>/dev/null || true

            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
            rm -rf assets/* index.html 2>/dev/null || true

            # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—ã–π build
            LATEST_ARCHIVE=$(ls -t /tmp/deploy-tripwire-*.tar.gz | head -1)
            tar -xzf "$LATEST_ARCHIVE" --strip-components=1

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
            chown -R www-data:www-data "$TRIPWIRE_DIR"
            chmod -R 755 "$TRIPWIRE_DIR"

            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º Nginx
            systemctl reload nginx

            # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
            ls -t /tmp/deploy-tripwire-*.tar.gz | tail -n +6 | xargs rm -f 2>/dev/null || true

            echo "‚úÖ Tripwire Frontend –∑–∞–¥–µ–ø–ª–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
            echo "üåê URL: https://tripwire.onai.academy"

      - name: üîÑ Deploy Tripwire Backend (–µ—Å–ª–∏ –∏–∑–º–µ–Ω—ë–Ω)
        uses: appleboy/ssh-action@v1.0.3
        if: contains(github.event.head_commit.modified, 'backend/src/routes/tripwire')
        with:
          host: 207.154.231.30
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -e
            echo "üöÄ –î–µ–ø–ª–æ–π Tripwire Backend..."

            cd /var/www/onai-integrator-login-main
            git fetch origin main
            git reset --hard origin/main

            cd backend
            npm install --production
            npm run build

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º PM2
            pm2 restart onai-backend --update-env

            echo "‚úÖ Tripwire Backend –æ–±–Ω–æ–≤–ª—ë–Ω!"

      - name: ‚úÖ Verify deployment
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è..."
          sleep 3
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://tripwire.onai.academy/ || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Tripwire –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $HTTP_CODE)"
          else
            echo "‚ö†Ô∏è Tripwire –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –æ—Ç–¥–µ–ª—å–Ω–æ (HTTP $HTTP_CODE)"
            echo "‚ÑπÔ∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx –¥–ª—è tripwire.onai.academy"
          fi
