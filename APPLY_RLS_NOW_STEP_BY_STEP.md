# üîí –ü–†–ò–ú–ï–ù–ò RLS –°–ï–ô–ß–ê–° - –ü–û–®–ê–ì–û–í–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø

## üéØ –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

–ü—Ä–∏–º–µ–Ω–∏—Ç—å RLS (Row Level Security) –≤ Supabase –¥–ª—è Traffic Dashboard.

**–í—Ä–µ–º—è: 5 –º–∏–Ω—É—Ç**
**–°–ª–æ–∂–Ω–æ—Å—Ç—å: –ù–∏–∑–∫–∞—è**
**–†–∏—Å–∫: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (–±–µ–∑ –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã–µ —É—è–∑–≤–∏–º—ã)**

---

## üìã –®–∞–≥ 1: –û—Ç–∫—Ä–æ–π Supabase SQL Editor

### 1.1 –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ URL
```
https://supabase.com/dashboard/project/oetodaexnjcunklkdlkv/sql
```

### 1.2 –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç
–í URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: `oetodaexnjcunklkdlkv` (Traffic Dashboard)

–ï—Å–ª–∏ –¥—Ä—É–≥–æ–π –ø—Ä–æ–µ–∫—Ç - –Ω–∞–∂–º–∏ "Switch project" –∏ –≤—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π.

---

## üìã –®–∞–≥ 2: –°–∫–æ–ø–∏—Ä—É–π SQL –∫–æ–¥

### 2.1 –û—Ç–∫—Ä–æ–π —Ñ–∞–π–ª
–û—Ç–∫—Ä–æ–π —Ñ–∞–π–ª: [`scripts/apply-traffic-rls-production.sql`](scripts/apply-traffic-rls-production.sql)

### 2.2 –°–∫–æ–ø–∏—Ä—É–π –≤–µ—Å—å –∫–æ–¥
–í—ã–¥–µ–ª–∏ –≤–µ—Å—å SQL –∫–æ–¥ (Ctrl+A) –∏ —Å–∫–æ–ø–∏—Ä—É–π (Ctrl+C)

–ò–ª–∏ –æ—Ç–∫—Ä–æ–π —Ñ–∞–π–ª –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –∏ —Å–∫–æ–ø–∏—Ä—É–π –æ—Ç—Ç—É–¥–∞.

---

## üìã –®–∞–≥ 3: –í—Å—Ç–∞–≤—å SQL –≤ Supabase

### 3.1 –í—Å—Ç–∞–≤—å SQL –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
–í Supabase SQL Editor –≤—Å—Ç–∞–≤—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥:
- –ù–∞–∂–º–∏ –≤ –ø–æ–ª–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ SQL
- –í—Å—Ç–∞–≤—å –∫–æ–¥ (Ctrl+V)

### 3.2 –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –∫–æ–¥ –≤—Å—Ç–∞–≤–ª–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é
–£–±–µ–¥–∏—Å—å, —á—Ç–æ:
- ‚úÖ –í–µ—Å—å –∫–æ–¥ –≤—Å—Ç–∞–≤–ª–µ–Ω (–Ω–µ –æ–±—Ä–µ–∑–∞–Ω)
- ‚úÖ –ù–µ—Ç –∫—Ä–∞—Å–Ω—ã—Ö –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–π (–æ—à–∏–±–æ–∫)
- ‚úÖ –ö–æ–¥ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `-- ============================================`

---

## üìã –®–∞–≥ 4: –í—ã–ø–æ–ª–Ω–∏ SQL

### 4.1 –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "Run"
–í –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É **"Run"** (–∏–ª–∏ "Execute")

### 4.2 –ü–æ–¥–æ–∂–¥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
–ü–æ–¥–æ–∂–¥–∏ 1-2 –º–∏–Ω—É—Ç—ã. –í–Ω–∏–∑—É –ø–æ—è–≤–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

### 4.3 –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
```
Success. No rows returned
```

–ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ - —Å–º. —Ä–∞–∑–¥–µ–ª "–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –æ—à–∏–±–∫–∏" –Ω–∏–∂–µ.

---

## üìã –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ RLS

### 5.1 –û—Ç–∫—Ä–æ–π Auth Policies
–ü–µ—Ä–µ–π–¥–∏ –ø–æ —Å—Å—ã–ª–∫–µ:
```
https://supabase.com/dashboard/project/oetodaexnjcunklkdlkv/auth/policies
```

### 5.2 –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –ø–æ–ª–∏—Ç–∏–∫–∏ —Å–æ–∑–¥–∞–Ω—ã
–¢–∞–º –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü:
- ‚úÖ `traffic_users` - 3+ –ø–æ–ª–∏—Ç–∏–∫–∏
- ‚úÖ `traffic_leads` - 5+ –ø–æ–ª–∏—Ç–∏–∫–∏
- ‚úÖ `traffic_sales` - 5+ –ø–æ–ª–∏—Ç–∏–∫–∏
- ‚úÖ `traffic_analytics` - 2+ –ø–æ–ª–∏—Ç–∏–∫–∏
- ‚úÖ `traffic_daily_reports` - 2+ –ø–æ–ª–∏—Ç–∏–∫–∏

–ï—Å–ª–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –µ—Å—Ç—å - RLS –ø—Ä–∏–º–µ–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ! ‚úÖ

---

## üìã –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä—å –≤ Traffic Dashboard

### 6.1 –û—Ç–∫—Ä–æ–π Traffic Dashboard
```
https://traffic.onai.academy
```

### 6.2 –ó–∞–ª–æ–≥–∏–Ω—å—Å—è –∫–∞–∫ Admin
–ò—Å–ø–æ–ª—å–∑—É–π admin credentials:
- Email: —Ç–≤–æ–π admin email
- Password: —Ç–≤–æ–π admin password

### 6.3 –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø
–ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞:
- ‚úÖ –î–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ (–≤—Å–µ –∫–æ–º–∞–Ω–¥—ã)
- ‚úÖ –î–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –î–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –≤—Å–µ –ª–∏–¥—ã
- ‚úÖ –î–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –≤—Å–µ –ø—Ä–æ–¥–∞–∂–∏

### 6.4 –í—ã–π–¥–∏ –∏ –∑–∞–ª–æ–≥–∏–Ω—å—Å—è –∫–∞–∫ Targetologist
1. –ù–∞–∂–º–∏ "Logout"
2. –ó–∞–ª–æ–≥–∏–Ω—å—Å—è –∫–∞–∫ targetologist (team: 'team_name')
3. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø:
   - ‚úÖ –î–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ –¢–û–õ–¨–ö–û —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥—ã
   - ‚ùå –ù–ï –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö –∫–æ–º–∞–Ω–¥

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –í Supabase Dashboard
–û—Ç–∫—Ä–æ–π: `https://supabase.com/dashboard/project/oetodaexnjcunklkdlkv/auth/policies`

–¢–∞–º –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏:
- `admin_select_all_traffic_users`
- `targetologist_select_team_traffic_users`
- `admin_select_all_traffic_leads`
- `targetologist_select_team_traffic_leads`
- `admin_manage_traffic_leads`
- `targetologist_insert_team_traffic_leads`
- `targetologist_update_team_traffic_leads`
- –∏ —Ç.–¥. –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –í Traffic Dashboard
–û—Ç–∫—Ä–æ–π: `https://traffic.onai.academy`

1. –ó–∞–ª–æ–≥–∏–Ω—å—Å—è –∫–∞–∫ Admin
   - ‚úÖ –í–∏–¥–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ

2. –ó–∞–ª–æ–≥–∏–Ω—å—Å—è –∫–∞–∫ Targetologist (team: 'team1')
   - ‚úÖ –í–∏–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã 'team1'
   - ‚ùå –ù–ï –≤–∏–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏—Ö –∫–æ–º–∞–Ω–¥

3. –ü–æ–ø—Ä–æ–±—É–π –∑–∞–π—Ç–∏ –∫–∞–∫ Anon (–±–µ–∑ –ª–æ–≥–∏–Ω–∞)
   - ‚ùå –ù–ï –≤–∏–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ
   - ‚ùå –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ login

---

## üêõ –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –æ—à–∏–±–∫–∏

### –û—à–∏–±–∫–∞: "relation does not exist"
**–ü—Ä–∏—á–∏–Ω–∞:** –¢–∞–±–ª–∏—Ü—ã –Ω–µ —Å–æ–∑–¥–∞–Ω—ã

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ Supabase Dashboard
2. –ï—Å–ª–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞–π –∏—Ö —Å–Ω–∞—á–∞–ª–∞
3. –ü–æ—Ç–æ–º –≤—ã–ø–æ–ª–Ω–∏ SQL –µ—â–µ —Ä–∞–∑

### –û—à–∏–±–∫–∞: "policy already exists"
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ª–∏—Ç–∏–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
1. –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - SQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `DROP POLICY IF EXISTS`
2. –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∞–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
3. –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–æ–Ω—Ü–µ

### –û—à–∏–±–∫–∞: "permission denied"
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Ç—ã –∑–∞–ª–æ–≥–∏–Ω–µ–Ω –∫–∞–∫ admin –≤ Supabase
2. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –ø—Ä–æ–µ–∫—Ç
3. –ü–æ–ø—Ä–æ–±—É–π –≤—ã–π—Ç–∏ –∏ –∑–∞–π—Ç–∏ —Å–Ω–æ–≤–∞

### –û—à–∏–±–∫–∞: "syntax error"
**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ –≤ SQL –∫–æ–¥–µ

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤–µ—Å—å –∫–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω
2. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –Ω–µ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
3. –ü–æ–ø—Ä–æ–±—É–π –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ —á–∞—Å—Ç—è–º

---

## üéØ –ö—Ä–∞—Ç–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (1 –º–∏–Ω—É—Ç–∞)

### –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
–í—ã–ø–æ–ª–Ω–∏ —ç—Ç–æ—Ç SQL –≤ Supabase –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ RLS –≤–∫–ª—é—á–µ–Ω
SELECT
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual
FROM pg_policies
WHERE schemaname = 'public'
  AND tablename IN ('traffic_users', 'traffic_leads', 'traffic_sales', 'traffic_analytics', 'traffic_daily_reports')
ORDER BY tablename, policyname;
```

–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏.

---

## üéâ –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

Traffic Dashboard –±—É–¥–µ—Ç **–ó–ê–©–ò–©–ï–ù**:

‚úÖ Admin –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –¥–∞–Ω–Ω—ã–º
‚úÖ Targetologist –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–µ–π –∫–æ–º–∞–Ω–¥–µ
‚úÖ Anon –ù–ï –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
‚úÖ –î–∞–Ω–Ω—ã–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –º–µ–∂–¥—É –∫–æ–º–∞–Ω–¥–∞–º–∏
‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [`scripts/apply-traffic-rls-production.sql`](scripts/apply-traffic-rls-production.sql) - SQL —Å–∫—Ä–∏–ø—Ç
- [`APPLY_TRAFFIC_RLS_NOW.md`](APPLY_TRAFFIC_RLS_NOW.md) - –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

---

## üö® –°–†–û–ß–ù–û!

–ü—Ä–∏–º–µ–Ω–∏—Ç—å RLS –°–ï–ô–ß–ê–°! –ë–µ–∑ –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã–µ —É—è–∑–≤–∏–º—ã!

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: 5 –º–∏–Ω—É—Ç**
**–°–ª–æ–∂–Ω–æ—Å—Ç—å: –ù–∏–∑–∫–∞—è**
**–†–∏—Å–∫: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π**

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º

- [ ] –û—Ç–∫—Ä—ã—Ç Supabase SQL Editor
- [ ] –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω SQL –∫–æ–¥
- [ ] SQL –≤—Å—Ç–∞–≤–ª–µ–Ω –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
- [ ] SQL –≤—ã–ø–æ–ª–Ω–µ–Ω (–Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "Run")
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ Auth Policies
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω –¥–æ—Å—Ç—É–ø –≤ Traffic Dashboard (Admin)
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω –¥–æ—Å—Ç—É–ø –≤ Traffic Dashboard (Targetologist)
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω –¥–æ—Å—Ç—É–ø –≤ Traffic Dashboard (Anon)

---

## üéØ –ì–æ—Ç–æ–≤–æ!

–°–ª–µ–¥—É–π –ø–æ—à–∞–≥–æ–≤–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤—ã—à–µ –∏ –ø—Ä–∏–º–µ–Ω–∏ RLS –∑–∞ 5 –º–∏–Ω—É—Ç!
