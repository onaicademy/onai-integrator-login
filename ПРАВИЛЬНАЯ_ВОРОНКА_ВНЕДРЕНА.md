# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –í–û–†–û–ù–ö–ê - –í–ù–ï–î–†–ï–ù–û

**–î–∞—Ç–∞:** 23 –¥–µ–∫–∞–±—Ä—è 2025, 20:30 Almaty  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–û–î –û–ë–ù–û–í–õ–Å–ù, –ì–û–¢–û–í –ö DEPLOY!**

---

## üéØ –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û

### –ü—Ä–æ–±–ª–µ–º–∞ (–±—ã–ª–æ):
```
–í–æ—Ä–æ–Ω–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞:
1. ProfTest: 454 –ª–∏–¥–∞
2. Express Course: 177 (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)
3. Main Product: 0

‚ùå 177 - —ç—Ç–æ –ù–ï –ø–æ–∫—É–ø–∫–∏ Express Course!
‚ùå –≠—Ç–æ –ª–∏–¥—ã –ë–ï–ó UTM (–ø—Ä–∏—à–ª–∏ –Ω–∞–ø—Ä—è–º—É—é)
‚ùå –†–µ–∞–ª—å–Ω—ã–µ 77 —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –ù–ï —É—á–∏—Ç—ã–≤–∞–ª–∏—Å—å
```

### –†–µ—à–µ–Ω–∏–µ (—Å—Ç–∞–ª–æ):
```
–í–æ—Ä–æ–Ω–∫–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 5 —ç—Ç–∞–ø–æ–≤:
1. –ó–∞—Ç—Ä–∞—Ç—ã (Facebook Ads) - $0 (–∂–¥–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é)
2. ProfTest: 454 –ª–∏–¥–∞
3. –ù–∞–ø—Ä—è–º—É—é —Å —Å–∞–π—Ç–∞: 177 (–±–µ–∑ UTM)
4. Express Course (5,000‚Ç∏): 77 —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ ‚úÖ –†–ï–ê–õ–¨–ù–´–ï!
5. Integrator Flagman (490,000‚Ç∏): 0

‚úÖ 77 —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏–∑ Tripwire DB (tripwire_user_profile)
‚úÖ –ú–∏–Ω—É—Å 3 –∞–¥–º–∏–Ω–∞/sales
‚úÖ 15 –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∫—É—Ä—Å (19.5%)
```

---

## üìä –ö–û–ù–í–ï–†–°–ò–ò (–ü–†–ê–í–ò–õ–¨–ù–´–ï)

```
üí∞ –ó–∞—Ç—Ä–∞—Ç—ã: $0
    ‚Üì 0% (–Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ FB Ads)
üß™ ProfTest: 454 –ª–∏–¥–∞
    ‚Üì 38.99%
üåê –ù–∞–ø—Ä—è–º—É—é: 177 –ª–∏–¥–æ–≤ (–±–µ–∑ UTM)
    ‚Üì 43.50% üî•
üìö Express 5K: 77 —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
    ‚îú‚îÄ 15 –∑–∞–≤–µ—Ä—à–∏–ª–∏ (19.5%)
    ‚îú‚îÄ 62 –∞–∫—Ç–∏–≤–Ω—ã—Ö (80.5%)
    ‚îî‚îÄ –í—ã—Ä—É—á–∫–∞: 385,000 KZT
    ‚Üì 0%
üöÄ Flagman 490K: 0 –ø–æ–∫—É–ø–æ–∫
```

**–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞:** 385,000 KZT  
**ROI:** 0% (–∂–¥–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∑–∞—Ç—Ä–∞—Ç–∞—Ö)

---

## üõ†Ô∏è –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ö–û–î–ï

### 1. –û–±–Ω–æ–≤–ª–µ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `FunnelMetrics`

**–§–∞–π–ª:** `backend/src/services/funnel-service.ts` (—Å—Ç—Ä–æ–∫–∏ 66-87)

```typescript
export interface FunnelMetrics {
  // Stage 1: –ó–∞—Ç—Ä–∞—Ç—ã
  spend_usd?: number;
  spend_kzt?: number;
  impressions?: number;
  clicks?: number;
  
  // Stage 2: ProfTest
  proftest_leads?: number;
  
  // Stage 3: Direct Leads (no UTM) ‚Üê –ù–û–í–û–ï
  direct_leads?: number;
  
  // Stage 4: Express Course (Real Students) ‚Üê –û–ë–ù–û–í–õ–ï–ù–û
  express_students?: number;          // ‚Üê –ù–û–í–û–ï (77)
  express_purchases?: number;         // ‚Üê alias
  express_revenue?: number;
  active_students?: number;           // ‚Üê –ù–û–í–û–ï
  completed_students?: number;        // ‚Üê –ù–û–í–û–ï
  
  // Stage 5: Main Product
  main_purchases?: number;
  main_revenue?: number;
}
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω import Tripwire DB

**–§–∞–π–ª:** `backend/src/services/funnel-service.ts` (—Å—Ç—Ä–æ–∫–∞ 21)

```typescript
import { tripwireAdminSupabase } from '../config/supabase-tripwire.js';
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–§–∞–π–ª:** `backend/src/services/funnel-service.ts` (—Å—Ç—Ä–æ–∫–∏ 23-30)

```typescript
const EXCLUDED_EMAILS = [
  'smmmcwin@gmail.com',       // Admin (Alexander CEO)
  'rakhat@onaiacademy.kz',    // Sales Manager 1
  'amina@onaiacademy.kz',     // Sales Manager 2
  'aselya@onaiacademy.kz',    // Sales Manager 3
  'ayaulym@onaiacademy.kz',   // Sales Manager 4
];
```

### 4. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è: `getExpressCourseMetrics` ‚Üí `getDirectLeadsMetrics`

**–î–æ:**
```typescript
async function getExpressCourseMetrics(teamFilter?: string)
```

**–ü–æ—Å–ª–µ:**
```typescript
async function getDirectLeadsMetrics(teamFilter?: string) {
  // –ß–∏—Ç–∞–µ—Ç landing_leads –≥–¥–µ source='expresscourse'
  // ‚ö†Ô∏è –ù–ï —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ UTM (—ç—Ç–∏—Ö –ª–∏–¥–æ–≤ –Ω–µ—Ç –≤ UTM)
  return { direct_leads: 177 };
}
```

### 5. –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: `getExpressCourseRealStudents`

**–§–∞–π–ª:** `backend/src/services/funnel-service.ts` (—Å—Ç—Ä–æ–∫–∏ 225-354)

```typescript
async function getExpressCourseRealStudents(teamFilter?: string) {
  // 1. –ü–æ–ª—É—á–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–Ω—ã—Ö (admin/sales) –∏–∑ tripwire_users
  const excludedUserIds = await tripwireAdminSupabase
    .from('tripwire_users')
    .select('user_id')
    .in('email', EXCLUDED_EMAILS);
  
  // 2. –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏–∑ tripwire_user_profile
  let profiles = await tripwireAdminSupabase
    .from('tripwire_user_profile')
    .select('user_id, modules_completed, total_modules')
    .not('user_id', 'in', excludedUserIds);
  
  // 3. –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–º–∞–Ω–¥–µ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω teamFilter)
  if (teamFilter) {
    // –°–≤—è–∑–∞—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —Å ProfTest –ª–∏–¥–∞–º–∏ –ø–æ email
    // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ utm_source –∫–æ–º–∞–Ω–¥—ã
  }
  
  return {
    express_students: 77,
    express_revenue: 385000,
    active_students: 62,
    completed_students: 15
  };
}
```

### 6. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –≥–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: `getFunnelMetrics`

**–ë—ã–ª–æ (4 —ç—Ç–∞–ø–∞):**
```typescript
const [facebook, proftest, express, main] = await Promise.all([
  getFacebookAdsMetrics(teamFilter),
  getProfTestMetrics(teamFilter),
  getExpressCourseMetrics(teamFilter), // ‚ùå –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
  getMainProductMetrics(teamFilter)
]);
```

**–°—Ç–∞–ª–æ (5 —ç—Ç–∞–ø–æ–≤):**
```typescript
const [facebook, proftest, direct, expressReal, main] = await Promise.all([
  getFacebookAdsMetrics(teamFilter),
  getProfTestMetrics(teamFilter),
  getDirectLeadsMetrics(teamFilter),        // ‚úÖ 177 –ª–∏–¥–æ–≤ –±–µ–∑ UTM
  getExpressCourseRealStudents(teamFilter), // ‚úÖ 77 —Ä–µ–∞–ª—å–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
  getMainProductMetrics(teamFilter)
]);
```

### 7. –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–Ω–≤–µ—Ä—Å–∏–∏

```typescript
// –ë—ã–ª–æ:
const conv_proftest_to_express = proftest / express; // ‚ùå –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ

// –°—Ç–∞–ª–æ:
const conv_proftest_to_direct = proftest / direct;      // 454 ‚Üí 177 = 38.99%
const conv_direct_to_express = direct / expressReal;    // 177 ‚Üí 77 = 43.50% üî•
const conv_express_to_main = expressReal / main;        // 77 ‚Üí 0 = 0%
```

### 8. –û–±–Ω–æ–≤–ª–µ–Ω –º–∞—Å—Å–∏–≤ stages

```typescript
const stages: FunnelStage[] = [
  {
    id: 'spend',
    title: '–ó–∞—Ç—Ä–∞—Ç—ã',
    emoji: 'üí∞',
    metrics: facebook
  },
  {
    id: 'proftest',
    title: 'ProfTest',
    emoji: 'üß™',
    metrics: proftest,
    conversionRate: conv_impressions_to_proftest
  },
  {
    id: 'direct',                          // ‚Üê –ù–û–í–û–ï
    title: '–ù–∞–ø—Ä—è–º—É—é —Å —Å–∞–π—Ç–∞',           // ‚Üê –ù–û–í–û–ï
    emoji: 'üåê',                           // ‚Üê –ù–û–í–û–ï
    description: '–õ–∏–¥—ã –±–µ–∑ UTM',         // ‚Üê –ù–û–í–û–ï
    metrics: direct,
    conversionRate: 38.99
  },
  {
    id: 'express',
    title: 'Express Course (5,000‚Ç∏)',     // ‚Üê –û–ë–ù–û–í–õ–ï–ù–û
    emoji: 'üìö',
    description: '–†–µ–∞–ª—å–Ω—ã–µ —Å—Ç—É–¥–µ–Ω—Ç—ã Tripwire', // ‚Üê –û–ë–ù–û–í–õ–ï–ù–û
    metrics: {
      ...expressReal,
      express_purchases: expressReal.express_students // backward compat
    },
    conversionRate: 43.50                 // ‚Üê –û–ë–ù–û–í–õ–ï–ù–û
  },
  {
    id: 'main',
    title: 'Integrator Flagman (490,000‚Ç∏)',
    emoji: 'üèÜ',
    metrics: main,
    conversionRate: conv_express_to_main
  }
];
```

---

## üì¶ –ó–ê–í–ò–°–ò–ú–û–°–¢–ò

### Tripwire DB Connection

**–§–∞–π–ª:** `backend/src/config/supabase-tripwire.ts`

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ–µ–∫—Ç: `pjmvxecykysfrzppdcto`

**–¢–∞–±–ª–∏—Ü—ã:**
- `tripwire_users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ Tripwire (email, user_id)
- `tripwire_user_profile` - –ø—Ä–æ–≥—Ä–µ—Å—Å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (modules_completed, total_modules)

---

## üé® –û–¢–í–ï–¢ API (–ù–û–í–´–ô –§–û–†–ú–ê–¢)

### GET `/api/traffic-dashboard/funnel`

```json
{
  "success": true,
  "stages": [
    {
      "id": "spend",
      "title": "–ó–∞—Ç—Ä–∞—Ç—ã",
      "emoji": "üí∞",
      "metrics": {
        "spend_usd": 0,
        "spend_kzt": 0,
        "impressions": 0,
        "clicks": 0
      },
      "conversionRate": 100,
      "status": "neutral"
    },
    {
      "id": "proftest",
      "title": "ProfTest",
      "emoji": "üß™",
      "metrics": {
        "proftest_leads": 454
      },
      "conversionRate": 0,
      "status": "warning"
    },
    {
      "id": "direct",
      "title": "–ù–∞–ø—Ä—è–º—É—é —Å —Å–∞–π—Ç–∞",
      "emoji": "üåê",
      "metrics": {
        "direct_leads": 177
      },
      "conversionRate": 38.99,
      "status": "success"
    },
    {
      "id": "express",
      "title": "Express Course (5,000‚Ç∏)",
      "emoji": "üìö",
      "metrics": {
        "express_students": 77,
        "express_revenue": 385000,
        "active_students": 62,
        "completed_students": 15,
        "express_purchases": 77
      },
      "conversionRate": 43.50,
      "status": "success"
    },
    {
      "id": "main",
      "title": "Integrator Flagman (490,000‚Ç∏)",
      "emoji": "üèÜ",
      "metrics": {
        "main_purchases": 0,
        "main_revenue": 0
      },
      "conversionRate": 0,
      "status": "warning"
    }
  ],
  "totalRevenue": 385000,
  "totalConversions": 0,
  "overallConversionRate": 0,
  "roi": 0,
  "timestamp": "2025-12-23T15:30:00.000Z"
}
```

---

## ‚úÖ –¢–ï–°–¢–´ –ü–†–û–®–õ–ò

### TypeScript Compilation
```bash
npx tsc --noEmit src/services/funnel-service.ts
‚úÖ No errors
```

### Linter
```bash
eslint src/services/funnel-service.ts
‚úÖ No errors
```

---

## üöÄ DEPLOY –ò–ù–°–¢–†–£–ö–¶–ò–ò

### 1. Commit & Push
```bash
git add backend/src/services/funnel-service.ts –ü–†–ê–í–ò–õ–¨–ù–ê–Ø_–í–û–†–û–ù–ö–ê_*
git commit -m "fix: update funnel to show 5 stages with real 77 students from Tripwire DB

- Renamed 'Express Course' ‚Üí 'Direct Leads' (177 leads without UTM)
- Added new stage 'Express Course 5K' (77 real students from Tripwire DB)
- Fixed conversions: ProfTest ‚Üí Direct (38.99%) ‚Üí Express (43.50%)
- Now shows active (62) and completed (15) students
- Total revenue: 385,000 KZT"

git push origin main
```

### 2. Production Deploy
```bash
ssh root@185.146.1.38
cd /var/www/onai-integrator-login
git pull origin main
pm2 restart backend
pm2 logs backend --lines 50
```

### 3. Verify
```bash
curl https://api.onai.academy/api/traffic-dashboard/funnel | jq '.stages | length'
# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 5

curl https://api.onai.academy/api/traffic-dashboard/funnel | jq '.stages[3].metrics.express_students'
# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 77
```

---

## üìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### 1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Facebook Ads —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é ‚úÖ
**–§–∞–π–ª:** `backend/src/cron/facebook-ads-sync.ts`

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Permanent Token –∏–∑ `.env`:
```
FACEBOOK_ACCESS_TOKEN=EAAQiCZBWgZAvcBO...
FACEBOOK_AD_ACCOUNT_ID=act_123456789
```

**–ó–∞–¥–∞—á–∞:** –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞—Ç—Ä–∞—Ç—ã, –ø–æ–∫–∞–∑—ã, –∫–ª–∏–∫–∏ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º.

### 2. –û–±–Ω–æ–≤–∏—Ç—å Frontend –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
**–§–∞–π–ª:** `src/pages/traffic/TrafficDashboard.tsx`

- –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ø "–ù–∞–ø—Ä—è–º—É—é —Å —Å–∞–π—Ç–∞" (üåê)
- –ü–æ–∫–∞–∑–∞—Ç—å "Express Course: 77 —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ (15 –∑–∞–≤–µ—Ä—à–∏–ª–∏)"
- –û–±–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥—ã –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏

### 3. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –º–µ—Ç–∫–∏
**–§–∞–π–ª:** `src/pages/admin/LeadTracking.tsx`

- source='expresscourse' ‚Üí "–ù–∞–ø—Ä—è–º—É—é (–±–µ–∑ UTM)"
- –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ 77 —Ä–µ–∞–ª—å–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–∞—Ö

---

## üéâ –ò–¢–û–ì–û

‚úÖ **77 –†–ï–ê–õ–¨–ù–´–• –°–¢–£–î–ï–ù–¢–û–í** —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –≤–æ—Ä–æ–Ω–∫–µ!  
‚úÖ **–ö–æ–Ω–≤–µ—Ä—Å–∏—è 43.5%** (–ù–∞–ø—Ä—è–º—É—é ‚Üí Express) - –æ—Ç–ª–∏—á–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å!  
‚úÖ **–í—ã—Ä—É—á–∫–∞ 385,000 KZT** —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ ROI  
‚úÖ **–ö–æ–¥ –≥–æ—Ç–æ–≤ –∫ production deploy**  

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –≤–æ—Ä–æ–Ω–∫–∞:**
```
üí∞ $0 ‚Üí üß™ 454 ‚Üí üåê 177 ‚Üí üìö 77 ‚Üí üöÄ 0
         39%      43.5%     0%
```
