-- ========================================
-- –ü–†–û–í–ï–†–ö–ê: –ö–∞–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã?
-- –¶–µ–ª—å: –ù–∞–π—Ç–∏ –ª–∏—à–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
-- ========================================

-- 1. –í–°–ï –ü–†–ò–ú–ï–ù–Å–ù–ù–´–ï –ú–ò–ì–†–ê–¶–ò–ò
SELECT 
    'üìä –ü–†–ò–ú–ï–ù–Å–ù–ù–´–ï –ú–ò–ì–†–ê–¶–ò–ò' as info,
    version,
    name,
    executed_at
FROM supabase_migrations.schema_migrations
ORDER BY executed_at DESC;

-- ========================================
-- 2. –ö–û–õ–ò–ß–ï–°–¢–í–û –ú–ò–ì–†–ê–¶–ò–ô
-- ========================================

SELECT 
    'üìà –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ú–ò–ì–†–ê–¶–ò–ô' as info,
    COUNT(*) as total_migrations,
    MIN(executed_at) as first_migration,
    MAX(executed_at) as last_migration
FROM supabase_migrations.schema_migrations;

-- ========================================
-- 3. –ê–ù–ê–õ–ò–ó: –ö–∞–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ù–£–ñ–ù–´?
-- ========================================

/*
–ù–£–ñ–ù–´–ï –ú–ò–ì–†–ê–¶–ò–ò (–ù–ï –£–î–ê–õ–Ø–¢–¨):

‚úÖ –ë–ê–ó–û–í–´–ï –¢–ê–ë–õ–ò–¶–´:
- –°–æ–∑–¥–∞–Ω–∏–µ profiles
- –°–æ–∑–¥–∞–Ω–∏–µ courses, modules, lessons
- –°–æ–∑–¥–∞–Ω–∏–µ video_content, lesson_materials
- –°–æ–∑–¥–∞–Ω–∏–µ student_progress, module_progress
- –°–æ–∑–¥–∞–Ω–∏–µ video_analytics

‚úÖ –ò–ì–†–û–§–ò–ö–ê–¶–ò–Ø (–ù–û–í–´–ï):
- 20251115_add_gamification - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ level, xp, streak
- user_achievements, user_goals, user_missions

‚ùå –í–û–ó–ú–û–ñ–ù–û –õ–ò–®–ù–ò–ï:
- –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (TEST_DATA.sql, TEST_DATA_FIXED.sql)
- –°—Ç–∞—Ä—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ video analytics (–µ—Å–ª–∏ –±—ã–ª–∏ –ø–µ—Ä–µ–¥–µ–ª–∞–Ω—ã)
- –î—É–±–ª–∏–∫–∞—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–π course structure
- –ú–∏–≥—Ä–∞—Ü–∏–∏ —Å –æ—à–∏–±–∫–∞–º–∏ (–∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å)

‚ùå –¢–û–ß–ù–û –£–î–ê–õ–ò–¢–¨:
- –õ—é–±—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å "—ç–Ω–µ—Ä–≥–∏–µ–π" (energy)
- –õ—é–±—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å "–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º" (mood, sentiment)
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ/—Ç–µ—Å—Ç–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
*/

-- ========================================
-- 4. –ü–û–ò–°–ö –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–û –õ–ò–®–ù–ò–• –ú–ò–ì–†–ê–¶–ò–ô
-- ========================================

-- –ò—â–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ —Å –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
SELECT 
    '‚ö†Ô∏è –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–û –õ–ò–®–ù–ò–ï –ú–ò–ì–†–ê–¶–ò–ò' as warning,
    version,
    name
FROM supabase_migrations.schema_migrations
WHERE 
    name ILIKE '%test%' 
    OR name ILIKE '%temp%'
    OR name ILIKE '%energy%'
    OR name ILIKE '%mood%'
    OR name ILIKE '%old%'
    OR name ILIKE '%deprecated%'
ORDER BY executed_at DESC;

-- ========================================
-- 5. –ü–û–ò–°–ö –î–£–ë–õ–ò–ö–ê–¢–û–í –ú–ò–ì–†–ê–¶–ò–ô
-- ========================================

-- –ò—â–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ —Å –ø–æ—Ö–æ–∂–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
SELECT 
    'üîç –í–û–ó–ú–û–ñ–ù–´–ï –î–£–ë–õ–ò–ö–ê–¢–´' as info,
    SUBSTRING(name FROM 1 FOR 30) as migration_prefix,
    COUNT(*) as count,
    STRING_AGG(version::TEXT, ', ' ORDER BY version) as versions
FROM supabase_migrations.schema_migrations
GROUP BY SUBSTRING(name FROM 1 FOR 30)
HAVING COUNT(*) > 1
ORDER BY count DESC;

-- ========================================
-- 6. –ö–û–ú–ê–ù–î–´ –î–õ–Ø –£–î–ê–õ–ï–ù–ò–Ø –ú–ò–ì–†–ê–¶–ò–ô
-- ========================================

/*
‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –£–î–ê–õ–Ø–ô –¢–û–õ–¨–ö–û –¢–û, –ß–¢–û –¢–û–ß–ù–û –õ–ò–®–ù–ï–ï!

-- –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π:
DELETE FROM supabase_migrations.schema_migrations 
WHERE version = '–í–ï–†–°–ò–Ø_–ú–ò–ì–†–ê–¶–ò–ò';

-- –ü—Ä–∏–º–µ—Ä:
DELETE FROM supabase_migrations.schema_migrations 
WHERE version = '20251115000000';

-- –£–¥–∞–ª–∏—Ç—å –í–°–ï —Ç–µ—Å—Ç–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
DELETE FROM supabase_migrations.schema_migrations 
WHERE name ILIKE '%test%';

-- –£–¥–∞–ª–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ø–æ —Ç–æ—á–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é:
DELETE FROM supabase_migrations.schema_migrations 
WHERE name = 'TEST_DATA_FIXED';

‚ö†Ô∏è –í–ê–ñ–ù–û: 
- –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –º–∏–≥—Ä–∞—Ü–∏–∏, –¢–ê–ë–õ–ò–¶–´ –ù–ï –£–î–ê–õ–Ø–Æ–¢–°–Ø!
- –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –æ —Ç–æ–º —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –±—ã–ª–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –¢–ê–ë–õ–ò–¶–´ - –¥–µ–ª–∞–π —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ (DROP TABLE)
*/

-- ========================================
-- 7. –°–ü–ò–°–û–ö –í–°–ï–• –¢–ê–ë–õ–ò–¶ (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)
-- ========================================

SELECT 
    'üìã –í–°–ï –¢–ê–ë–õ–ò–¶–´ –í –ë–î' as info,
    schemaname,
    tablename,
    CASE 
        WHEN tablename ILIKE '%test%' THEN '‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤–∞—è?'
        WHEN tablename ILIKE '%temp%' THEN '‚ö†Ô∏è –í—Ä–µ–º–µ–Ω–Ω–∞—è?'
        WHEN tablename ILIKE '%old%' THEN '‚ö†Ô∏è –°—Ç–∞—Ä–∞—è?'
        ELSE '‚úÖ –†–∞–±–æ—á–∞—è'
    END as status
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY tablename;

-- ========================================
-- –ì–û–¢–û–í–û! üéâ
-- ========================================

/*
üìã –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:

1. –ü–æ—Å–º–æ—Ç—Ä–∏ —Ä–∞–∑–¥–µ–ª "–ü–†–ò–ú–ï–ù–Å–ù–ù–´–ï –ú–ò–ì–†–ê–¶–ò–ò" - —É–≤–∏–¥–∏—à—å –í–°–ï –º–∏–≥—Ä–∞—Ü–∏–∏
2. –ü–æ—Å–º–æ—Ç—Ä–∏ —Ä–∞–∑–¥–µ–ª "–ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–û –õ–ò–®–ù–ò–ï" - –Ω–∞–π–¥–µ—à—å —Ç–µ—Å—Ç–æ–≤—ã–µ/–≤—Ä–µ–º–µ–Ω–Ω—ã–µ
3. –ü–æ—Å–º–æ—Ç—Ä–∏ —Ä–∞–∑–¥–µ–ª "–í–û–ó–ú–û–ñ–ù–´–ï –î–£–ë–õ–ò–ö–ê–¢–´" - –Ω–∞–π–¥–µ—à—å –ø–æ–≤—Ç–æ—Ä—ã
4. –ï—Å–ª–∏ –Ω–∞—à—ë–ª –ª–∏—à–Ω–∏–µ - –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—ã –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ 6

–ù–ï –£–î–ê–õ–Ø–ô –±–µ–∑ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏! –õ—É—á—à–µ —Å–ø—Ä–æ—Å–∏ –º–µ–Ω—è –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º.
*/

