-- ============================================
-- ะฃะะะะะะะ ะะะขะะะะขะะงะะกะะะะ ะขะะะะะะะ ะกะะะะะะะฏ PROFILES
-- ============================================
-- 
-- ะะะะงะะะ: Edge Function create-student ัะฐะผะฐ ัะพะทะดะฐัั ะฟัะพัะธะปะธ
-- ั ะฟัะฐะฒะธะปัะฝัะผะธ ะดะฐะฝะฝัะผะธ (role, account_expires_at, phone ะธ ั.ะด.)
-- 
-- ะขัะธะณะณะตั ัะพะทะดะฐะฒะฐะป ะดัะฑะปะธะบะฐัั ะธ ะฒัะทัะฒะฐะป ะพัะธะฑะบั "duplicate key"
-- ============================================

-- 1. ะฃะดะฐะปัะตะผ ััะธะณะณะตั
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;

-- 2. ะฃะดะฐะปัะตะผ ััะฝะบัะธั
DROP FUNCTION IF EXISTS public.handle_new_user();

-- 3. ะัะพะฒะตัะบะฐ
DO $$
BEGIN
  -- ะัะพะฒะตััะตะผ ััะพ ััะธะณะณะตั ัะดะฐะปัะฝ
  IF EXISTS (
    SELECT 1 FROM pg_trigger 
    WHERE tgname = 'on_auth_user_created'
  ) THEN
    RAISE EXCEPTION 'ะขัะธะณะณะตั ะฒัั ะตัั ัััะตััะฒัะตั!';
  ELSE
    RAISE NOTICE 'โ ะขัะธะณะณะตั on_auth_user_created ัะดะฐะปัะฝ';
  END IF;
  
  -- ะัะพะฒะตััะตะผ ััะพ ััะฝะบัะธั ัะดะฐะปะตะฝะฐ
  IF EXISTS (
    SELECT 1 FROM pg_proc 
    WHERE proname = 'handle_new_user'
  ) THEN
    RAISE EXCEPTION 'ะคัะฝะบัะธั ะฒัั ะตัั ัััะตััะฒัะตั!';
  ELSE
    RAISE NOTICE 'โ ะคัะฝะบัะธั handle_new_user ัะดะฐะปะตะฝะฐ';
  END IF;
  
  RAISE NOTICE 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
  RAISE NOTICE '๐ฏ ะะะขะะะ! Edge Function ัะตะฟะตัั ะตะดะธะฝััะฒะตะฝะฝัะน ัะพะทะดะฐัะตะปั profiles';
  RAISE NOTICE 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
END $$;

-- ============================================
-- ะะะะะ:
-- ะขะตะฟะตัั ะขะะะฌะะ Edge Function create-student ัะพะทะดะฐัั profiles
-- ะญัะพ ะดะฐัั ะฟะพะปะฝัะน ะบะพะฝััะพะปั ะฝะฐะด:
-- - role (admin/curator/tech_support/student)
-- - account_expires_at (ััะพะบ ะดะตะนััะฒะธั)
-- - phone (ะฒ student_profiles)
-- - course_ids (ะฝะฐะทะฝะฐัะตะฝะธะต ะบัััะพะฒ)
-- ============================================

