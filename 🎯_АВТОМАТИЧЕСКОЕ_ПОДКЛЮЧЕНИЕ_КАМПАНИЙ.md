# 🎯 АВТОМАТИЧЕСКОЕ ПОДКЛЮЧЕНИЕ НОВЫХ КАМПАНИЙ

> **Версия:** 1.0.0  
> **Дата:** 16 декабря 2025  
> **Цель:** Создание новых страниц для трафик-команд с автоматическим подключением ко всем системам

---

## 📋 СОДЕРЖАНИЕ

1. [Обзор архитектуры](#обзор-архитектуры)
2. [Что подключается автоматически](#что-подключается-автоматически)
3. [Инструкция по созданию новой кампании](#инструкция-по-созданию-новой-кампании)
4. [Проверка работы](#проверка-работы)
5. [Troubleshooting](#troubleshooting)

---

## 🏗️ ОБЗОР АРХИТЕКТУРЫ

### Текущая система (УЖЕ АВТОМАТИЗИРОВАНА! ✅)

```
┌─────────────────────────────────────────────────────────────┐
│  FRONTEND: /proftest/:slug                                   │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  1. Пользователь заполняет форму                    │    │
│  │  2. Facebook Pixel отслеживает (browser-side)       │    │
│  │  3. UTM параметры собираются                        │    │
│  │  4. Отправка на /api/landing/proftest               │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  BACKEND: /api/landing/proftest (ЕДИНЫЙ ENDPOINT!)          │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  АВТОМАТИЧЕСКИ ВЫПОЛНЯЕТ:                           │    │
│  │                                                      │    │
│  │  1. ✅ Сохранение в БД (Supabase)                   │    │
│  │     ├─ landing_leads таблица                        │    │
│  │     └─ lead_journey (timeline событий)              │    │
│  │                                                      │    │
│  │  2. ✅ Telegram Bot уведомление                     │    │
│  │     └─ sendLeadNotification()                       │    │
│  │                                                      │    │
│  │  3. ✅ AmoCRM синхронизация                         │    │
│  │     ├─ createOrUpdateLead()                         │    │
│  │     ├─ Дедупликация по email                        │    │
│  │     └─ Обновление amocrm_lead_id в БД               │    │
│  │                                                      │    │
│  │  4. ✅ Facebook Conversion API                      │    │
│  │     └─ sendConversionApiEvent()                     │    │
│  │                                                      │    │
│  │  5. ✅ Email + SMS планирование                     │    │
│  │     ├─ scheduleProftestNotifications()              │    │
│  │     ├─ Email через 10 мин                           │    │
│  │     └─ SMS через 10 мин                             │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  АДМИН ПАНЕЛЬ: /integrator/admin/leads                      │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  ✅ Автоматическое отображение лидов                │    │
│  │  ✅ Фильтрация по источникам (динамическая)         │    │
│  │  ✅ Статистика по кампаниям                         │    │
│  │  ✅ Timeline событий (journey)                      │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### Ключевая особенность: ОДИН ENDPOINT ДЛЯ ВСЕХ КАМПАНИЙ

Все кампании используют **ОДИН** backend endpoint: `/api/landing/proftest`

Это означает:
- ✅ Не нужно создавать новые API endpoints
- ✅ Не нужно дублировать логику интеграций
- ✅ Все изменения применяются ко всем кампаниям сразу
- ✅ Централизованное логирование и мониторинг

---

## 🔄 ЧТО ПОДКЛЮЧАЕТСЯ АВТОМАТИЧЕСКИ

При создании новой кампании (например, `/proftest/traf5`) **АВТОМАТИЧЕСКИ** подключается:

### 1. 💾 База данных (Supabase)
- **Таблица:** `landing_leads`
- **Поля:** name, email, phone, source, metadata, answers
- **Journey:** `lead_journey` (timeline событий)
- **Статус:** ✅ **АВТОМАТИЧЕСКИ** - не требует настройки

### 2. 📱 Telegram Bot
- **Функция:** `sendLeadNotification()`
- **Когда:** Сразу после отправки формы (первым делом!)
- **Формат:** 
  ```
  🎓 Новая заявка: ProfTest
  👤 Имя: {name}
  📧 Email: {email}
  📞 Телефон: {phone}
  📊 Источник: {source}
  ```
- **Статус:** ✅ **АВТОМАТИЧЕСКИ** - работает из коробки

### 3. 💼 AmoCRM
- **Функция:** `createOrUpdateLead()`
- **Дедупликация:** По email (если лид есть - обновляется, если нет - создается)
- **Поля:**
  - Имя, Email, Телефон
  - UTM параметры
  - Ответы на вопросы теста
  - Campaign slug
- **ID сохранение:** `amocrm_lead_id` в БД
- **Статус:** ✅ **АВТОМАТИЧЕСКИ** - не требует настройки

### 4. 📊 Facebook Conversion API
- **Функция:** `sendConversionApiEvent()`
- **Событие:** Lead
- **Данные:** email, phone, name, user_agent, IP, fbp, fbc
- **Требует:** Pixel ID и Conversion API Token (настраивается в конфиге)
- **Статус:** ✅ **АВТОМАТИЧЕСКИ** - после добавления в конфиг

### 5. 📧 Email + SMS уведомления
- **Функция:** `scheduleProftestNotifications()`
- **Задержка:** 10 минут после отправки формы
- **Email:** Результаты теста + ссылка на курс (с UTM отслеживанием)
- **SMS:** Короткая ссылка на курс (через короткие ссылки)
- **Статус:** ✅ **АВТОМАТИЧЕСКИ** - работает из коробки

### 6. 🎛️ Админ панель
- **Страница:** `/integrator/admin/leads`
- **Фильтры:** Динамические (по источникам из БД)
- **Статистика:** 
  - Общее количество лидов
  - Email/SMS отправлено
  - Email/SMS клики
  - Конверсия по кампаниям
- **Timeline:** Journey events (proftest_submitted, email_sent, sms_sent, etc.)
- **Статус:** ✅ **АВТОМАТИЧЕСКИ** - новый источник появляется сразу

---

## 📝 ИНСТРУКЦИЯ ПО СОЗДАНИЮ НОВОЙ КАМПАНИИ

### Пример: Создание кампании `/proftest/traf5`

#### ШАГ 1: Добавить конфигурацию Facebook Pixel

**Файл:** `src/config/pixels.ts`

```typescript
export const PIXEL_CONFIGS: Record<string, PixelConfig> = {
  // ... существующие конфиги
  
  // ✅ НОВАЯ КАМПАНИЯ
  traf5: {
    id: 'traf5',
    name: 'Traf5 Campaign',
    pixelId: 'YOUR_PIXEL_ID',                    // 👈 Получить от клиента
    conversionApiToken: 'YOUR_CONVERSION_TOKEN',  // 👈 Получить от клиента
    slug: 'traf5',
  },
};
```

**Где взять данные:**
- **Pixel ID:** Facebook Ads Manager → Events Manager → Data Sources → Pixel
- **Conversion API Token:** Facebook Ads Manager → Events Manager → Settings → Conversions API → Generate Access Token

#### ШАГ 2: Добавить роут в приложении

**Файл:** `src/App.tsx`

```typescript
{/* Public: Professional Test pages (no auth required) */}
<Route path="/integrator/proftest" element={<ProfTest />} />
<Route path="/integrator/proftest/:slug" element={<ProfTest />} />
<Route path="/proftest/:slug" element={<ProfTest />} />  {/* ✅ УЖЕ ЕСТЬ! */}
```

**Готово!** Роут `/proftest/traf5` уже работает, потому что используется динамический параметр `:slug`

#### ШАГ 3: (Опционально) Настроить кастомный источник в админ панели

Если хочешь, чтобы в админ панели источник отображался с красивым именем и эмодзи:

**Файл:** `src/pages/tripwire/admin/LeadsAdmin.tsx`

```typescript
const getSourceDisplay = (source: string): { name: string; emoji: string; color: string } => {
  const sourceMap: Record<string, { name: string; emoji: string; color: string }> = {
    // ... существующие источники
    
    // ✅ НОВЫЙ ИСТОЧНИК (если используется кастомное имя)
    'TF5': { name: 'Траф5', emoji: '🔥', color: 'green' },
  };
  
  return sourceMap[source] || { name: source, emoji: '📌', color: 'gray' };
};
```

**Примечание:** Если не добавить в маппинг, источник всё равно отобразится, просто с серым цветом и эмодзи 📌

#### ШАГ 4: (Опционально) Настроить кастомное имя источника

По умолчанию источник будет `proftest_traf5`. Если нужно кастомное имя (например, просто `TF5`):

**Файл:** `src/pages/tripwire/ProfTest.tsx`

```typescript
// 4. Determine source based on campaign
const campaignSlug = pixelConfig?.slug || 'unknown';
let sourceLabel: string;

// Special mapping for specific campaigns
if (campaignSlug === 'traf4') {
  sourceLabel = 'TF4';
} else if (campaignSlug === 'traf5') {
  sourceLabel = 'TF5';  // ✅ ДОБАВИТЬ ДЛЯ НОВОЙ КАМПАНИИ
} else {
  sourceLabel = `proftest_${campaignSlug}`;
}
```

#### ШАГ 5: Собрать и задеплоить

```bash
# 1. Собрать frontend
npm run build

# 2. Закоммитить изменения
git add -A
git commit -m "Add /proftest/traf5 campaign"

# 3. Запушить на GitHub (Vercel деплоит автоматически)
git push origin main

# 4. Дождаться деплоя (1-2 минуты)
# Проверить статус: https://vercel.com/dashboard
```

---

## ✅ ПРОВЕРКА РАБОТЫ

### 1. Проверка страницы

```bash
# Production URL
https://onai.academy/proftest/traf5
```

**Что проверить:**
- ✅ Страница загружается
- ✅ Facebook Pixel инициализируется (проверить в Facebook Pixel Helper)
- ✅ Форма отправляется успешно
- ✅ Показывается Success Modal

### 2. Проверка Telegram Bot

**Где смотреть:** Telegram Bot для лидов

**Что проверить:**
- ✅ Пришло уведомление сразу после отправки формы
- ✅ Все данные корректны (имя, email, телефон, источник)

### 3. Проверка AmoCRM

**Где смотреть:** AmoCRM → Сделки

**Что проверить:**
- ✅ Сделка создана
- ✅ Контакт создан/обновлен
- ✅ UTM параметры сохранены
- ✅ Ответы на вопросы сохранены в примечаниях

### 4. Проверка Admin панели

**Где смотреть:** `/integrator/admin/leads`

**Что проверить:**
- ✅ Лид отображается в списке
- ✅ Источник правильный (например, "TF5" или "proftest_traf5")
- ✅ Статистика обновилась
- ✅ Timeline событий показывает "proftest_submitted"

### 5. Проверка Email + SMS (через 10 минут)

**Где смотреть:** 
- Email клиента
- SMS клиента
- Admin панель → колонки "Email Sent" и "SMS Sent"

**Что проверить:**
- ✅ Email пришёл через 10 минут
- ✅ SMS пришла через 10 минут
- ✅ Ссылки работают
- ✅ UTM отслеживание работает (клики записываются)

### 6. Проверка Facebook Conversion API

**Где смотреть:** Facebook Events Manager → Test Events

**Что проверить:**
- ✅ Событие "Lead" отправлено
- ✅ Event Match Quality > 5.0 (хорошо)
- ✅ Данные пользователя захешированы

---

## 🎯 CHECKLIST: БЫСТРОЕ СОЗДАНИЕ КАМПАНИИ

Используй этот чеклист для создания новой кампании за 5 минут:

### Минимальный вариант (только Pixel)
```
[ ] Получить Pixel ID от клиента
[ ] Получить Conversion API Token от клиента
[ ] Добавить в src/config/pixels.ts
[ ] npm run build
[ ] git add -A && git commit -m "Add /proftest/NEW_SLUG" && git push
[ ] Дождаться деплоя (1-2 мин)
[ ] Отправить URL клиенту: https://onai.academy/proftest/NEW_SLUG
```

### Полный вариант (с кастомным источником)
```
[ ] Получить Pixel ID от клиента
[ ] Получить Conversion API Token от клиента
[ ] Добавить в src/config/pixels.ts
[ ] Добавить кастомный источник в src/pages/tripwire/ProfTest.tsx
[ ] Добавить в маппинг источников в src/pages/tripwire/admin/LeadsAdmin.tsx
[ ] npm run build
[ ] git add -A && git commit -m "Add /proftest/NEW_SLUG" && git push
[ ] Дождаться деплоя (1-2 мин)
[ ] Тестовая отправка формы
[ ] Проверить Telegram Bot
[ ] Проверить AmoCRM
[ ] Проверить Admin панель
[ ] Отправить URL клиенту
```

---

## 🔧 TROUBLESHOOTING

### Проблема: Лид не появляется в AmoCRM

**Причины:**
1. Не установлен `AMOCRM_ACCESS_TOKEN` в backend env
2. Токен истёк (нужно обновить)
3. Неправильный формат email

**Решение:**
```bash
# 1. Проверить backend логи
cd backend
node dist/routes/landing.js  # Должен быть запущен

# 2. Проверить env переменные
echo $AMOCRM_ACCESS_TOKEN

# 3. Обновить токен (если истёк)
# См. документацию по AmoCRM
```

### Проблема: Telegram уведомление не приходит

**Причины:**
1. Не установлен `TELEGRAM_BOT_TOKEN` или `TELEGRAM_LEADS_CHAT_ID`
2. Бот не добавлен в чат

**Решение:**
```bash
# 1. Проверить env переменные
echo $TELEGRAM_BOT_TOKEN
echo $TELEGRAM_LEADS_CHAT_ID

# 2. Проверить, что бот в чате
# Telegram → Чат → Участники → Должен быть бот
```

### Проблема: Facebook Conversion API не работает

**Причины:**
1. Неправильный Pixel ID
2. Истёкший Conversion API Token
3. Неправильный формат данных

**Решение:**
```bash
# 1. Проверить в Facebook Events Manager → Test Events
# Должны приходить события "Lead"

# 2. Проверить backend логи
# Должна быть строка: "✅ Facebook Conversion API: Lead event sent"

# 3. Обновить токен (если истёк)
# Facebook Ads Manager → Events Manager → Settings → Generate new token
```

### Проблема: Email/SMS не приходят

**Причины:**
1. Неправильный email/телефон
2. Email в спаме
3. SMS провайдер не работает

**Решение:**
```bash
# 1. Проверить scheduled_notifications таблицу в Supabase
# SELECT * FROM scheduled_notifications WHERE lead_id = 'LEAD_ID'

# 2. Проверить статус отправки
# status = 'pending' | 'sent' | 'failed'

# 3. Проверить error_message если status = 'failed'
```

---

## 📊 МОНИТОРИНГ И АНАЛИТИКА

### Где смотреть статистику

1. **Admin панель** → `/integrator/admin/leads`
   - Лиды по источникам
   - Email/SMS конверсия
   - Timeline событий

2. **Facebook Ads Manager**
   - Events Manager → Data Sources → Your Pixel
   - Conversion API events
   - Event Match Quality

3. **AmoCRM**
   - Сделки → Фильтр по источнику
   - Аналитика → Воронка продаж

4. **Supabase Dashboard**
   - landing_leads таблица
   - lead_journey таблица
   - scheduled_notifications таблица

### Ключевые метрики

```
┌──────────────────────────────────────────────┐
│  МЕТРИКИ ДЛЯ ОТСЛЕЖИВАНИЯ                    │
├──────────────────────────────────────────────┤
│  1. Conversion Rate (форма)                  │
│     → Посетители / Отправки формы            │
│                                              │
│  2. Email Open Rate                          │
│     → Email отправлено / Email открыто       │
│                                              │
│  3. Email Click Rate                         │
│     → Email открыто / Email клики            │
│                                              │
│  4. SMS Click Rate                           │
│     → SMS отправлено / SMS клики             │
│                                              │
│  5. AmoCRM Sync Rate                         │
│     → Лиды в БД / Лиды в AmoCRM              │
│                                              │
│  6. Facebook Event Match Quality             │
│     → Должно быть > 5.0                      │
└──────────────────────────────────────────────┘
```

---

## 🚀 NEXT STEPS: УЛУЧШЕНИЯ СИСТЕМЫ

### Идеи для автоматизации

1. **🤖 Auto-deployment скрипт**
   ```bash
   # Создать скрипт для одной команды:
   ./scripts/create-campaign.sh traf6 PIXEL_ID TOKEN
   ```

2. **📊 Webhook для AmoCRM**
   - Двусторонняя синхронизация
   - Обновление статусов сделок в админ панели

3. **🔔 Уведомления о проблемах**
   - Telegram уведомления, если AmoCRM sync failed
   - Email уведомления для админа

4. **📈 A/B тестирование**
   - Разные варианты страниц для одного slug
   - Автоматическое распределение трафика

5. **🎯 Ретаргетинг**
   - Автоматический custom audience в Facebook
   - На основе данных из AmoCRM

---

## ✅ ЗАКЛЮЧЕНИЕ

### Что у нас есть СЕЙЧАС

✅ **Полностью автоматизированная система интеграций**
- Один endpoint для всех кампаний
- Автоматическое подключение к AmoCRM, Telegram, Email, SMS
- Динамическая админ панель
- Централизованное логирование

✅ **Быстрое создание новых кампаний**
- 3 простых шага (Pixel Config → Build → Deploy)
- Всё остальное работает автоматически
- 5 минут от идеи до работающей страницы

✅ **Масштабируемость**
- Добавление новых интеграций не требует изменения всех кампаний
- Централизованное управление логикой
- Легко поддерживать и обновлять

### Следующий шаг

Теперь можешь создавать неограниченное количество кампаний без беспокойства об интеграциях - **всё работает автоматически!** 🚀

---

**Документ обновлён:** 16 декабря 2025  
**Автор:** OnAI Development Team  
**Версия системы:** Production v2.0











