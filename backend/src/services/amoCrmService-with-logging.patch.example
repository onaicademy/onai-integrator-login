/**
 * –ü–ê–¢–ß –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø –í amoCrmService.ts
 *
 * –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:
 * 1. –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç IntegrationLogger –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞
 * 2. –û–±–µ—Ä–Ω—É—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ IntegrationLogger.track()
 */

// ========================================
// 1. –î–û–ë–ê–í–ò–¢–¨ –ò–ú–ü–û–†–¢ (–ø–æ—Å–ª–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤)
// ========================================
import { IntegrationLogger } from './integrationLogger';

// ========================================
// 2. –û–ë–ù–û–í–ò–¢–¨ –§–£–ù–ö–¶–ò–Æ onLessonCompleted
// ========================================

// –ë–´–õ–û:
export async function onLessonCompleted(userEmail: string, lessonNumber: number): Promise<void> {
  try {
    console.log(`[AmoCRM] üéì –£—Ä–æ–∫ ${lessonNumber} –∑–∞–≤–µ—Ä—à—ë–Ω –¥–ª—è ${userEmail}`);

    // ... existing code ...

    const updateResponse = await amoCrmClient.patch(
      `/api/v4/leads/${leadId}`,
      {
        status_id: newStatusId,
        pipeline_id: AMO_PIPELINE_ID,
      }
    );

    console.log(`‚úÖ [AmoCRM] –°–¥–µ–ª–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞`);
  } catch (error) {
    console.error(`‚ùå [AmoCRM] –û—à–∏–±–∫–∞:`, error);
    throw error;
  }
}

// –°–¢–ê–õ–û:
export async function onLessonCompleted(userEmail: string, lessonNumber: number): Promise<void> {
  const startTime = Date.now();

  try {
    console.log(`[AmoCRM] üéì –£—Ä–æ–∫ ${lessonNumber} –∑–∞–≤–µ—Ä—à—ë–Ω –¥–ª—è ${userEmail}`);

    // ... existing code –¥–ª—è –ø–æ–∏—Å–∫–∞ –ª–∏–¥–∞ ...

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∏ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    const updateResponse = await IntegrationLogger.track(
      'amocrm',
      `lesson_${lessonNumber}_completed`,
      async () => {
        return await amoCrmClient.patch(
          `/api/v4/leads/${leadId}`,
          {
            status_id: newStatusId,
            pipeline_id: AMO_PIPELINE_ID,
          }
        );
      },
      {
        relatedEntityType: 'tripwire_user',
        includeResponse: true,
      }
    );

    console.log(`‚úÖ [AmoCRM] –°–¥–µ–ª–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞, —Å—Ç–∞—Ç—É—Å: ${updateResponse.status}`);
  } catch (error: any) {
    console.error(`‚ùå [AmoCRM] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —É—Ä–æ–∫–∞ ${lessonNumber}:`, error);

    // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
    await IntegrationLogger.logError(
      'amocrm',
      `lesson_${lessonNumber}_completed`,
      error,
      {
        relatedEntityType: 'tripwire_user',
        durationMs: Date.now() - startTime,
      }
    );

    throw error;
  }
}

// ========================================
// 3. –î–û–ë–ê–í–ò–¢–¨ –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –í refreshAccessToken
// ========================================

// –ù–∞–π—Ç–∏ —Ñ—É–Ω–∫—Ü–∏—é refreshAccessToken –∏ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
async function refreshAccessToken(): Promise<boolean> {
  const startTime = Date.now();

  try {
    console.log('üîÑ [AmoCRM] –û–±–Ω–æ–≤–ª—è–µ–º access token...');

    const result = await IntegrationLogger.track(
      'amocrm',
      'refresh_token',
      async () => {
        const response = await axios.post(
          `https://${process.env.AMOCRM_SUBDOMAIN}.amocrm.ru/oauth2/access_token`,
          {
            client_id: process.env.AMOCRM_CLIENT_ID,
            client_secret: process.env.AMOCRM_CLIENT_SECRET,
            grant_type: 'refresh_token',
            refresh_token: currentRefreshToken,
            redirect_uri: process.env.AMOCRM_REDIRECT_URI,
          }
        );

        return response.data;
      },
      {
        includeResponse: false, // –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω—ã –≤ –ª–æ–≥–∞—Ö
      }
    );

    await saveTokens(result.access_token, result.refresh_token);

    console.log('‚úÖ [AmoCRM] –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω');
    return true;
  } catch (error: any) {
    console.error('‚ùå [AmoCRM] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', error);

    await IntegrationLogger.logError(
      'amocrm',
      'refresh_token',
      error,
      {
        durationMs: Date.now() - startTime,
      }
    );

    return false;
  }
}

// ========================================
// 4. –î–û–ë–ê–í–ò–¢–¨ –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –í —Å–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏
// ========================================

// –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–¥–µ–ª–∫–∏ Tripwire, –¥–æ–±–∞–≤–∏—Ç—å:
export async function createTripwireDeal(
  studentEmail: string,
  studentName: string
): Promise<void> {
  return IntegrationLogger.track(
    'amocrm',
    'create_tripwire_deal',
    async () => {
      const response = await amoCrmClient.post('/api/v4/leads', {
        name: `Tripwire - ${studentName}`,
        pipeline_id: AMO_PIPELINE_ID,
        // ... other fields ...
      });

      return response.data;
    },
    {
      relatedEntityType: 'tripwire_user',
    }
  );
}

// ========================================
// 5. –≠–ö–°–ü–û–†–¢ –°–¢–ê–¢–ò–°–¢–ò–ö–ò (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
// ========================================

/**
 * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É AmoCRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
 */
export async function getAmoCrmStats(): Promise<any> {
  return IntegrationLogger.getServiceLogs('amocrm', 100);
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ AmoCRM
 */
export async function getAmoCrmFailures(): Promise<any> {
  const allFailures = await IntegrationLogger.getRecentFailures(100);
  return allFailures.filter((log: any) => log.service_name === 'amocrm');
}
