/**
 * ğŸ¤– GROQ AI - Ğ£ĞœĞĞ«Ğ• ĞĞ¢Ğ§Ğ•Ğ¢Ğ« Ğ”Ğ›Ğ¯ Ğ¢ĞĞ Ğ“Ğ•Ğ¢ĞĞ›ĞĞ“ĞĞ’
 * 
 * Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ñ‹ Ñ AI-Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ¼:
 * - ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
 * - ĞšĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
 * - ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ñ€Ğ°ÑÑ‡ĞµÑ‚ KPI (+10% Ğ¾Ñ‚ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ñ… Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²)
 * - ĞÑ†ĞµĞ½ĞºĞ° Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ¸ Ğ¿Ğ»Ğ°Ğ½ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹
 */

import Groq from 'groq-sdk';
import axios from 'axios';

const groq = new Groq({
  apiKey: process.env.GROQ_API_KEY,
});

const API_URL = process.env.API_URL || 'http://localhost:3000';

interface TeamData {
  team: string;
  spend: number;
  revenue: number;
  roas: number;
  sales: number;
  cpa: number;
  ctr: number;
  impressions: number;
  clicks: number;
}

interface AnalyticsData {
  teams: TeamData[];
  totals: {
    spend: number;
    revenue: number;
    roas: number;
    sales: number;
  };
}

// ğŸ“Š ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· API
async function fetchAnalytics(preset: string = '24h'): Promise<AnalyticsData | null> {
  try {
    const response = await axios.get(`${API_URL}/api/traffic/combined-analytics?preset=${preset}`);
    return response.data;
  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¸:', error);
    return null;
  }
}

// ğŸ¤– Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· Groq AI
async function generateAIReport(
  data: AnalyticsData,
  reportType: '10:00' | '16:00' | '22:00' | 'weekly',
  previousWeekData?: AnalyticsData
): Promise<string> {
  const reportConfig = {
    '10:00': {
      title: 'ğŸŒ… ĞĞ¢Ğ§Ğ•Ğ¢ Ğ—Ğ Ğ’Ğ§Ğ•Ğ Ğ',
      focus: 'ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ·Ğ° Ğ²Ñ‡ĞµÑ€Ğ°, Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ»Ğ¸Ğ´ĞµÑ€Ğ¾Ğ², Ğ¿Ğ»Ğ°Ğ½ Ğ½Ğ° Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ',
      tone: 'Ğ­Ğ½ĞµÑ€Ğ³Ğ¸Ñ‡Ğ½Ñ‹Ğ¹, Ğ´ĞµĞ»Ğ¾Ğ²Ğ¾Ğ¹'
    },
    '16:00': {
      title: 'ğŸ“Š ĞĞ‘Ğ•Ğ”Ğ•ĞĞĞ«Ğ™ Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡',
      focus: 'Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ, Ğ¿Ñ€Ğ¾Ğ¼ĞµĞ¶ÑƒÑ‚Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹, ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸',
      tone: 'Ğ”ĞµĞ»Ğ¾Ğ²Ğ¾Ğ¹, Ñ Ğ°ĞºÑ†ĞµĞ½Ñ‚Ğ¾Ğ¼ Ğ½Ğ° Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸'
    },
    '22:00': {
      title: 'ğŸŒ™ Ğ’Ğ•Ğ§Ğ•Ğ ĞĞ˜Ğ™ ĞĞ¢Ğ§Ğ•Ğ¢',
      focus: 'Ğ˜Ñ‚Ğ¾Ğ³Ğ¸ Ğ´Ğ½Ñ, Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ, Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°, KPI Ğ½Ğ° ÑĞ»ĞµĞ´ÑƒÑÑ‰ÑƒÑ Ğ½ĞµĞ´ĞµĞ»Ñ',
      tone: 'ĞŸĞ¾Ğ´Ğ²Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹ Ğ¸Ñ‚Ğ¾Ğ³Ğ¸, Ñ Ğ±Ğ»Ğ°Ğ³Ğ¾Ğ´Ğ°Ñ€Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸ Ğ¿Ğ»Ğ°Ğ½Ğ°Ğ¼Ğ¸'
    },
    'weekly': {
      title: 'ğŸ“… ĞĞ•Ğ”Ğ•Ğ›Ğ¬ĞĞ«Ğ™ ĞĞ¢Ğ§Ğ•Ğ¢',
      focus: 'Ğ˜Ñ‚Ğ¾Ğ³Ğ¸ Ğ½ĞµĞ´ĞµĞ»Ğ¸, Ñ‚Ğ¾Ğ¿ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´, Ğ½Ğ¾Ğ²Ñ‹Ğµ KPI (+10% Ğ¾Ñ‚ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ñ…)',
      tone: 'Ğ¢Ğ¾Ñ€Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹, Ğ´ĞµĞ»Ğ¾Ğ²Ğ¾Ğ¹'
    }
  };

  const config = reportConfig[reportType];
  
  // ĞŸĞ¾ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ´Ğ»Ñ Groq AI
  const prompt = buildGroqPrompt(data, config, reportType, previousWeekData);
  
  try {
    console.log(`ğŸ¤– [Groq] Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ${reportType} Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°...`);
    
    const response = await groq.chat.completions.create({
      model: 'llama-3.3-70b-versatile',
      messages: [
        {
          role: 'system',
          content: `Ğ¢Ñ‹ Ğ¿Ğ¸ÑˆĞµÑˆÑŒ Ğ¿Ñ€ĞµĞ¼Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ñ‹ Ğ´Ğ»Ñ Ñ‚Ğ°Ñ€Ğ³ĞµÑ‚Ğ¾Ğ»Ğ¾Ğ³Ğ¾Ğ². 

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ğ¤ĞĞ ĞœĞĞ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ• (Ğ’ĞĞ–ĞĞ!):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. Ğ—ĞĞ“ĞĞ›ĞĞ’ĞšĞ˜ - Ğ²ÑĞµĞ³Ğ´Ğ° *Ğ–Ğ˜Ğ ĞĞ«Ğœ*
2. Ğ’ĞĞ–ĞĞ«Ğ• Ğ¦Ğ˜Ğ¤Ğ Ğ« - *Ğ¶Ğ¸Ñ€Ğ½Ñ‹Ğ¼* (ROAS, Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸, Ñ‚Ñ€Ğ°Ñ‚Ñ‹)
3. ĞĞĞ—Ğ’ĞĞĞ˜Ğ¯ ĞšĞĞœĞĞĞ” - *Ğ¶Ğ¸Ñ€Ğ½Ñ‹Ğ¼*
4. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ¿ÑƒÑÑ‚Ñ‹Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ´Ğ»Ñ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿Ğ¾Ğ²
5. Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ±Ğ»Ğ¾ĞºĞ°Ğ¼Ğ¸

ĞŸĞ Ğ˜ĞœĞ•Ğ  Ğ¤ĞĞ ĞœĞĞ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯:
*ğŸ’° ĞĞ‘Ğ©Ğ˜Ğ™ Ğ˜Ğ¢ĞĞ“*
ĞŸĞ¾Ñ‚Ñ€Ğ°Ñ‚Ğ¸Ğ»Ğ¸: *$1200* (*â‚¸540,000*)
Ğ—Ğ°Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ¸: *â‚¸2,500,000* (*$5555*)
ROAS: *2.1x* ğŸŸ¢

*ğŸ† ĞšĞĞœĞĞĞ”Ğ«*
â€¢ *Kenesary* ğŸ†
  ROAS *2.5x* | ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸ *15 ÑˆÑ‚* | CPA *$80*
  Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: ĞĞ³Ğ¾Ğ½ÑŒ! ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞ¹

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ğ’ĞĞ›Ğ®Ğ¢Ğ«:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ğ’Ğ¡Ğ•Ğ“Ğ”Ğ ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ğ¹ Ğ¾Ğ±Ğµ Ğ²Ğ°Ğ»ÑÑ‚Ñ‹:
- Ğ¢Ñ€Ğ°Ñ‚Ñ‹: *$XXX* (*â‚¸XXX,XXX*)
- Ğ”Ğ¾Ñ…Ğ¾Ğ´: *â‚¸XXX,XXX* (*$XXX*)
- CPA: *$XX* (*â‚¸XX,XXX*)

ĞšÑƒÑ€Ñ: Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ¾ 1$ = 450â‚¸

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ğ¡Ğ¢Ğ Ğ£ĞšĞ¢Ğ£Ğ Ğ:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. *Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°* (Ğ¶Ğ¸Ñ€Ğ½Ñ‹Ğ¹)
2. ĞŸÑƒÑÑ‚Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ°
3. *ĞĞ‘Ğ©Ğ˜Ğ™ Ğ˜Ğ¢ĞĞ“* (Ğ±Ğ»Ğ¾Ğº Ñ Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¼Ğ¸ Ñ†Ğ¸Ñ„Ñ€Ğ°Ğ¼Ğ¸)
4. ĞŸÑƒÑÑ‚Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ°
5. *ĞšĞĞœĞĞĞ”Ğ«* (ĞºĞ°Ğ¶Ğ´Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾ Ñ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿Ğ¾Ğ¼)
6. ĞŸÑƒÑÑ‚Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ°  
7. *Ğ§Ğ¢Ğ Ğ”ĞĞ›Ğ¬Ğ¨Ğ•* (ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ğ¡Ğ¢Ğ˜Ğ›Ğ¬:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- ĞšĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ (4-6 ÑĞ»Ğ¾Ğ²)
- ĞŸÑ€Ğ¾ÑÑ‚Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ°
- ĞšĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ñ†Ğ¸Ñ„Ñ€Ñ‹
- Ğ‘ĞµĞ· Ğ²Ğ¾Ğ´Ñ‹

Ğ­ĞœĞĞ”Ğ—Ğ˜ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´:
ğŸ† Kenesary, âš”ï¸ Arystan, ğŸ¯ Muha, ğŸš€ Traf4

Ğ¢ĞĞ (ĞœĞ¯Ğ“ĞšĞ, ĞŸĞĞ”Ğ”Ğ•Ğ Ğ–Ğ˜Ğ’ĞĞ®Ğ©Ğ•!):
- ROAS < 0.5 â†’ "Ğ•ÑÑ‚ÑŒ Ğ½Ğ°Ğ´ Ñ‡ĞµĞ¼ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ. Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ"
- ROAS 0.5-1.0 â†’ "ĞŸĞ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ» Ğ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹. ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼"
- ROAS 1.0-1.5 â†’ "ĞĞºÑƒĞ¿Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ ĞµÑÑ‚ÑŒ. Ğ£ÑĞ¸Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼"
- ROAS 1.5-2.0 â†’ "Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾ Ğ¸Ğ´Ñ‘Ñ‚. ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼"
- ROAS > 2.0 â†’ "ĞĞ³Ğ¾Ğ½ÑŒ! ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼"

Ğ—ĞĞŸĞ Ğ•Ğ©Ğ•ĞĞ: "ĞŸĞ»Ğ¾Ñ…Ğ¾", "Ğ¡Ğ»Ğ°Ğ±Ğ¾", "ĞŸÑ€Ğ¾Ğ²Ğ°Ğ»", "Ğ¤ĞµĞ¹Ğ»"
Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ™: "ĞŸĞ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»", "Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµĞ¼", "Ğ£Ğ»ÑƒÑ‡ÑˆĞ°ĞµĞ¼"

${reportType === 'weekly' ? `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ĞĞ•Ğ”Ğ•Ğ›Ğ¬ĞĞ«Ğ™ ĞĞ¢Ğ§Ğ•Ğ¢:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- ĞŸĞ¾ÑÑ‡Ğ¸Ñ‚Ğ°Ğ¹ *ĞĞĞ’Ğ«Ğ• KPI* Ğ½Ğ° Ğ½ĞµĞ´ĞµĞ»Ñ (+10%)
- Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ÑƒĞºĞ°Ğ¶Ğ¸:
  â€¢ Ğ¦ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶: *XX ÑˆÑ‚* (Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ +10%)
  â€¢ Ğ¦ĞµĞ»ĞµĞ²Ğ¾Ğ¹ ROAS: *X.Xx* (Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ +10%)
  â€¢ Ğ‘ÑĞ´Ğ¶ĞµÑ‚: *$XXX* (Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ +10%)
- ĞŸĞ¸ÑˆĞ¸ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾ Ğ¸ Ğ¶Ğ¸Ñ€Ğ½Ñ‹Ğ¼
` : ''}

${reportType === '22:00' ? `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Ğ’Ğ•Ğ§Ğ•Ğ ĞĞ˜Ğ™ ĞĞ¢Ğ§Ğ•Ğ¢:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- Ğ˜Ñ‚Ğ¾Ğ³Ğ¸ Ğ´Ğ½Ñ
- Ğ›ÑƒÑ‡ÑˆĞ¸Ğµ Ğ¸ Ñ…ÑƒĞ´ÑˆĞ¸Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
- *ĞšĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸* Ğ½Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
` : ''}

Ğ¯Ğ—Ğ«Ğš: Ğ ÑƒÑÑĞºĞ¸Ğ¹
ĞœĞĞšĞ¡Ğ˜ĞœĞ£Ğœ: 16-18 ÑÑ‚Ñ€Ğ¾Ğº (Ñ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿Ğ°Ğ¼Ğ¸)`
        },
        {
          role: 'user',
          content: prompt
        }
      ],
      temperature: 0.7,
      max_tokens: 1500,
    });
    
    const report = response.choices[0]?.message?.content || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°';
    
    console.log(`âœ… [Groq] ĞÑ‚Ñ‡ĞµÑ‚ ${reportType} ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½`);
    
    return report;
    
  } catch (error: any) {
    console.error(`âŒ [Groq] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°:`, error.message);
    
    // Fallback: Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ±ĞµĞ· AI
    return generateSimpleReport(data, config.title);
  }
}

// ğŸ“ ĞŸĞ¾ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ´Ğ»Ñ Groq AI
function buildGroqPrompt(
  data: AnalyticsData,
  config: any,
  reportType: string,
  previousWeekData?: AnalyticsData
): string {
  const rankedTeams = [...data.teams].sort((a, b) => b.roas - a.roas);
  
  let prompt = `${config.title}\n\n`;
  prompt += `Ğ¤Ğ¾ĞºÑƒÑ: ${config.focus}\n`;
  prompt += `Ğ¢Ğ¾Ğ½: ${config.tone}\n\n`;
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  prompt += `ğŸ“Š Ğ”ĞĞĞĞ«Ğ•:\n`;
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  // ĞĞ±Ñ‰Ğ¸Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»Ğ¸ (Ğ¾Ğ±Ğµ Ğ²Ğ°Ğ»ÑÑ‚Ñ‹!)
  const exchangeRate = 450; // 1 USD = 450 KZT
  const spendKzt = Math.round(data.totals.spend * exchangeRate);
  const revenueUsd = Math.round(data.totals.revenue / exchangeRate);
  
  prompt += `ğŸ’° ĞĞ‘Ğ©Ğ˜Ğ• Ğ˜Ğ¢ĞĞ“Ğ˜:\n`;
  prompt += `- Ğ—Ğ°Ñ‚Ñ€Ğ°Ñ‚Ñ‹: $${data.totals.spend.toFixed(0)} (â‚¸${spendKzt.toLocaleString()})\n`;
  prompt += `- Ğ”Ğ¾Ñ…Ğ¾Ğ´: â‚¸${Math.round(data.totals.revenue).toLocaleString()} ($${revenueUsd})\n`;
  prompt += `- ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸: ${data.totals.sales} ÑˆÑ‚\n`;
  prompt += `- ROAS: ${data.totals.roas.toFixed(2)}x ${getRoasEmoji(data.totals.roas)}\n`;
  prompt += `- ĞšÑƒÑ€Ñ: 1$ = ${exchangeRate}â‚¸\n\n`;
  
  // Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ¿Ğ¾ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°Ğ¼
  prompt += `ğŸ‘¥ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢Ğ« ĞšĞĞœĞĞĞ”:\n\n`;
  
  rankedTeams.forEach((team, idx) => {
    const medal = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : 'â­';
    const cpaKzt = Math.round(team.cpa * exchangeRate);
    const spendKzt = Math.round(team.spend * exchangeRate);
    
    prompt += `${medal} ${team.team}:\n`;
    prompt += `   - ROAS: ${team.roas.toFixed(2)}x ${getRoasEmoji(team.roas)}\n`;
    prompt += `   - ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸: ${team.sales} ÑˆÑ‚\n`;
    prompt += `   - CPA: $${team.cpa.toFixed(0)} (â‚¸${cpaKzt.toLocaleString()})\n`;
    prompt += `   - CTR: ${team.ctr.toFixed(2)}%\n`;
    prompt += `   - Ğ¢Ñ€Ğ°Ñ‚Ñ‹: $${team.spend.toFixed(0)} (â‚¸${spendKzt.toLocaleString()})\n\n`;
  });
  
  // Ğ”Ğ»Ñ Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ°: Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ¹ Ğ½ĞµĞ´ĞµĞ»Ğ¸
  if (reportType === 'weekly' && previousWeekData) {
    prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    prompt += `ğŸ“ˆ Ğ”Ğ˜ĞĞĞœĞ˜ĞšĞ (Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ°Ñ Ğ½ĞµĞ´ĞµĞ»Ñ):\n`;
    prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
    
    rankedTeams.forEach(team => {
      const prevTeam = previousWeekData.teams.find(t => t.team === team.team);
      if (prevTeam) {
        const roasChange = ((team.roas - prevTeam.roas) / prevTeam.roas * 100).toFixed(0);
        const salesChange = team.sales - prevTeam.sales;
        
        prompt += `${team.team}:\n`;
        prompt += `   - ROAS: ${prevTeam.roas.toFixed(2)}x â†’ ${team.roas.toFixed(2)}x (${roasChange > '0' ? '+' : ''}${roasChange}%)\n`;
        prompt += `   - ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸: ${prevTeam.sales} â†’ ${team.sales} (${salesChange > 0 ? '+' : ''}${salesChange})\n\n`;
      }
    });
  }
  
  // ĞĞ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸ Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹
  const problems: string[] = [];
  const achievements: string[] = [];
  
  rankedTeams.forEach(team => {
    if (team.roas < 1.0) {
      problems.push(`${team.team}: ROAS ${team.roas.toFixed(2)}x - Ğ£Ğ‘Ğ«Ğ¢ĞĞ§ĞĞ! Ğ¡Ñ€Ğ¾Ñ‡Ğ½Ğ¾ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ`);
    }
    if (team.ctr < 0.5) {
      problems.push(`${team.team}: CTR ${team.ctr.toFixed(2)}% - Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ½Ğ¸Ğ·ĞºĞ¸Ğ¹, Ğ½ÑƒĞ¶Ğ½Ñ‹ Ğ½Ğ¾Ğ²Ñ‹Ğµ ĞºÑ€ĞµĞ°Ñ‚Ğ¸Ğ²Ñ‹`);
    }
    if (team.roas >= 3.0) {
      achievements.push(`${team.team}: ROAS ${team.roas.toFixed(2)}x - ĞĞ¢Ğ›Ğ˜Ğ§ĞĞ«Ğ™ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚! ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ!`);
    }
    if (team.sales >= 10 && team.roas >= 2.0) {
      achievements.push(`${team.team}: ${team.sales} Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶ Ğ¿Ñ€Ğ¸ ROAS ${team.roas.toFixed(2)}x - ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ°Ñ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ!`);
    }
  });
  
  if (problems.length > 0) {
    prompt += `\nâš ï¸ Ğ¢Ğ Ğ•Ğ‘Ğ£Ğ®Ğ¢ Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ¯:\n`;
    problems.forEach(p => prompt += `- ${p}\n`);
  }
  
  if (achievements.length > 0) {
    prompt += `\nğŸ”¥ Ğ”ĞĞ¡Ğ¢Ğ˜Ğ–Ğ•ĞĞ˜Ğ¯:\n`;
    achievements.forEach(a => prompt += `- ${a}\n`);
  }
  
  prompt += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  prompt += `ğŸ¯ Ğ¢Ğ’ĞĞ¯ Ğ—ĞĞ”ĞĞ§Ğ:\n`;
  prompt += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  
  prompt += `Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹ ĞŸĞ Ğ•ĞœĞ˜ĞĞ›Ğ¬ĞĞ«Ğ™ Ğ¾Ñ‚Ñ‡ĞµÑ‚:\n\n`;
  
  if (reportType === 'weekly') {
    prompt += `1. Ğ˜Ñ‚Ğ¾Ğ³Ğ¸ Ğ½ĞµĞ´ĞµĞ»Ğ¸ (2-3 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ)\n`;
    prompt += `2. Ğ›ÑƒÑ‡ÑˆĞ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¸ Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ\n`;
    prompt += `3. *ĞĞĞ’Ğ«Ğ• KPI ĞĞ ĞĞ•Ğ”Ğ•Ğ›Ğ® (+10%)*:\n`;
    prompt += `   Ğ”Ğ»Ñ ĞšĞĞ–Ğ”ĞĞ™ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ¿Ğ¾ÑÑ‡Ğ¸Ñ‚Ğ°Ğ¹ Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸:\n`;
    prompt += `   â€¢ ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸: *XX ÑˆÑ‚* (Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ +10%)\n`;
    prompt += `   â€¢ ROAS: *X.Xx* (Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ +10%)\n`;
    prompt += `   â€¢ Ğ‘ÑĞ´Ğ¶ĞµÑ‚: *$XXX* (*â‚¸XXX,XXX*) (Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ +10%)\n`;
    prompt += `4. Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ°Ğ±Ğ·Ğ°Ñ† Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ (Ğ‘Ğ•Ğ— Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°)\n`;
  } else if (reportType === '22:00') {
    prompt += `1. ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¸Ñ‚Ğ¾Ğ³ Ğ´Ğ½Ñ (2 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ)\n`;
    prompt += `2. Ğ”Ğ»Ñ ĞšĞĞ–Ğ”ĞĞ™ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸:\n`;
    prompt += `   â€¢ ĞÑ†ĞµĞ½ĞºÑƒ: "ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾" / "Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾" / "ĞŸĞ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ» ĞµÑÑ‚ÑŒ" / "Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµĞ¼ Ğ½Ğ°Ğ´ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸ĞµĞ¼"\n`;
    prompt += `   â€¢ Ğ§Ñ‚Ğ¾ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°\n`;
    prompt += `3. Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ°Ğ±Ğ·Ğ°Ñ† Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ (Ğ‘Ğ•Ğ— Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°)\n`;
  } else if (reportType === '16:00') {
    prompt += `1. Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ (2 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ)\n`;
    prompt += `2. Ğ”Ğ»Ñ ĞšĞĞ–Ğ”ĞĞ™ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:\n`;
    prompt += `   â€¢ Ğ˜Ğ´Ñ‘Ñ‚ Ğ½Ğ¾Ñ€Ğ¼ / ĞĞ°Ğ´Ğ¾ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ\n`;
    prompt += `   â€¢ Ğ§Ñ‚Ğ¾ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ”Ğ ĞšĞĞĞ¦Ğ Ğ”ĞĞ¯\n`;
  } else { // 10:00
    prompt += `1. Ğ’Ñ‡ĞµÑ€Ğ°ÑˆĞ½Ğ¸Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ (2 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ)\n`;
    prompt += `2. Ğ›Ğ¸Ğ´ĞµÑ€ Ğ¸ Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ\n`;
    prompt += `3. Ğ”Ğ»Ñ ĞšĞĞ–Ğ”ĞĞ™ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:\n`;
    prompt += `   â€¢ ĞÑ†ĞµĞ½ĞºĞ° Ğ²Ñ‡ĞµÑ€Ğ°ÑˆĞ½ĞµĞ³Ğ¾ Ğ´Ğ½Ñ\n`;
    prompt += `   â€¢ Ğ§Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ\n`;
    prompt += `4. Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ°Ğ±Ğ·Ğ°Ñ† (Ğ‘Ğ•Ğ— Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°)\n`;
  }
  
  prompt += `\nĞ¤ĞĞ ĞœĞĞ¢:\n`;
  prompt += `- Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸: *Ğ–Ğ˜Ğ ĞĞ«Ğœ*\n`;
  prompt += `- Ğ¦Ğ¸Ñ„Ñ€Ñ‹: *Ğ¶Ğ¸Ñ€Ğ½Ñ‹Ğ¼*\n`;
  prompt += `- ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹: *Ğ¶Ğ¸Ñ€Ğ½Ñ‹Ğ¼*\n`;
  prompt += `- Ğ’Ğ¡Ğ• Ğ²Ğ°Ğ»ÑÑ‚Ñ‹: $ Ğ˜ â‚¸\n`;
  prompt += `- ĞŸÑƒÑÑ‚Ñ‹Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ±Ğ»Ğ¾ĞºĞ°Ğ¼Ğ¸\n`;
  prompt += `- ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 18 ÑÑ‚Ñ€Ğ¾Ğº\n`;
  prompt += `- Ğ‘Ğ•Ğ— Ğ’ĞĞ”Ğ«, ĞšĞĞĞšĞ Ğ•Ğ¢ĞĞ\n`;
  
  return prompt;
}

// ğŸ¨ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ´Ğ»Ñ ROAS (ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞĞ¯ Ğ›ĞĞ“Ğ˜ĞšĞ!)
function getRoasEmoji(roas: number): string {
  if (roas >= 2.5) return 'ğŸ”¥'; // ĞĞ³Ğ¾Ğ½ÑŒ!
  if (roas >= 1.5) return 'ğŸŸ¢'; // ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾
  if (roas >= 1.0) return 'ğŸŸ¡'; // ĞĞºÑƒĞ¿Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ
  if (roas >= 0.5) return 'ğŸŸ '; // Ğ£Ğ±Ñ‹Ñ‚Ğ¾Ğº, Ğ½Ğ¾ Ğ½Ğµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹
  return 'ğŸ”´'; // Ğ–Ğ¾Ğ¿Ğ°!
}

// ğŸ“„ ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚ (fallback Ğ±ĞµĞ· AI)
function generateSimpleReport(data: AnalyticsData, title: string): string {
  const rankedTeams = [...data.teams].sort((a, b) => b.roas - a.roas);
  
  let report = `${title}\n`;
  report += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
  report += `ğŸ’° *Ğ˜Ğ¢ĞĞ“Ğ˜:*\n`;
  report += `Ğ—Ğ°Ñ‚Ñ€Ğ°Ñ‚Ñ‹: $${data.totals.spend.toFixed(0)} | Ğ”Ğ¾Ñ…Ğ¾Ğ´: â‚¸${Math.round(data.totals.revenue).toLocaleString()}\n`;
  report += `ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ¸: ${data.totals.sales} ÑˆÑ‚ | ROAS: ${data.totals.roas.toFixed(2)}x\n\n`;
  report += `ğŸ† *Ğ Ğ•Ğ™Ğ¢Ğ˜ĞĞ“:*\n`;
  
  rankedTeams.forEach((team, idx) => {
    const medal = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : 'â­';
    report += `${medal} ${team.team}: ROAS ${team.roas.toFixed(2)}x | ${team.sales} Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶\n`;
  });
  
  return report;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“¤ ĞŸĞ£Ğ‘Ğ›Ğ˜Ğ§ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ğŸŒ… 10:00 - Ğ’Ñ‡ĞµÑ€Ğ°ÑˆĞ½Ğ¸Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚
export async function generateYesterdayReportAI(): Promise<string> {
  const data = await fetchAnalytics('24h');
  if (!data) return 'âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ';
  
  return await generateAIReport(data, '10:00');
}

// ğŸ“Š 16:00 - Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ
export async function generateCurrentStatusReportAI(): Promise<string> {
  const data = await fetchAnalytics('today');
  if (!data) return 'âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ';
  
  return await generateAIReport(data, '16:00');
}

// ğŸŒ™ 22:00 - Ğ”Ğ½ĞµĞ²Ğ½Ğ¾Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚
export async function generateDailyReportAI(): Promise<string> {
  const data = await fetchAnalytics('today');
  if (!data) return 'âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ';
  
  return await generateAIReport(data, '22:00');
}

// ğŸ“… ĞŸĞ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº 10:00 - ĞĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ KPI
export async function generateWeeklyReportAI(): Promise<string> {
  const thisWeek = await fetchAnalytics('7d');
  const previousWeek = await fetchAnalytics('14d'); // Ğ”Ğ»Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ
  
  if (!thisWeek) return 'âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ';
  
  return await generateAIReport(thisWeek, 'weekly', previousWeek || undefined);
}

export default {
  generateYesterdayReportAI,
  generateCurrentStatusReportAI,
  generateDailyReportAI,
  generateWeeklyReportAI,
};
