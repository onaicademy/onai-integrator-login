#!/bin/bash

# ๐ ะะะะะะะกะขะะะ ะะฃะะะะะะขะะ: ะัะพะฒะตัะบะฐ ัะบะพะปัะบะพ ะฟัะพัะตััะพะฒ ัะฐะฑะพัะฐะตั
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./scripts/check-duplicates.sh

echo "๐ ะะะะะะะกะขะะะ: ะัะพะฒะตัะบะฐ ะดัะฑะปะธะบะฐัะพะฒ ะฟัะพัะตััะพะฒ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# 1. ะัะพะฒะตััะตะผ ะฒัะต ะฟัะพัะตััั Node
NODE_PROCESSES=$(ps aux | grep -E "[n]ode.*server|[n]odemon" | wc -l | tr -d ' ')
echo "๐ ะัะตะณะพ Node ะฟัะพัะตััะพะฒ: $NODE_PROCESSES"

if [ "$NODE_PROCESSES" -gt 3 ]; then
  echo "โ ะะะะะะะะ! ะกะปะธัะบะพะผ ะผะฝะพะณะพ ะฟัะพัะตััะพะฒ (ะดะพะปะถะฝะพ ะฑััั 3: nodemon + tsx + node)"
  echo ""
  echo "๐ ะกะฟะธัะพะบ ะฒัะตั Node ะฟัะพัะตััะพะฒ:"
  ps aux | grep -E "[n]ode.*server|[n]odemon" | awk '{print "   PID " $2 ": " $11 " " $12 " " $13}'
  echo ""
  echo "๐ง ะะะจะะะะ: ะะฐะฟัััะธ ./scripts/start-clean.sh"
elif [ "$NODE_PROCESSES" -eq 0 ]; then
  echo "โ๏ธ  ะกะตัะฒะตั ะฝะต ะทะฐะฟััะตะฝ"
  echo ""
  echo "๐ง ะะะจะะะะ: ะะฐะฟัััะธ ./scripts/start-clean.sh"
else
  echo "โ ะัะพัะตััะพะฒ ะฝะพัะผะฐะปัะฝะพะต ะบะพะปะธัะตััะฒะพ ($NODE_PROCESSES)"
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# 2. ะัะพะฒะตััะตะผ ะฟะพัั 3000
PORT_PROCESSES=$(lsof -ti:3000 2>/dev/null | wc -l | tr -d ' ')
echo "๐ ะัะพัะตััะพะฒ ะฝะฐ ะฟะพััั 3000: $PORT_PROCESSES"

if [ "$PORT_PROCESSES" -gt 1 ]; then
  echo "โ ะะะะะะะะ! ะะตัะบะพะปัะบะพ ะฟัะพัะตััะพะฒ ะฝะฐ ะพะดะฝะพะผ ะฟะพััั!"
  echo ""
  echo "๐ ะกะฟะธัะพะบ ะฟัะพัะตััะพะฒ ะฝะฐ ะฟะพััั 3000:"
  lsof -ti:3000 | xargs -I {} ps -p {} -o pid,command 2>/dev/null
  echo ""
  echo "๐ง ะะะจะะะะ: ะะฐะฟัััะธ ./scripts/start-clean.sh"
elif [ "$PORT_PROCESSES" -eq 0 ]; then
  echo "โ๏ธ  ะะพัั 3000 ะฝะต ะทะฐะฝัั (ัะตัะฒะตั ะฝะต ัะฐะฑะพัะฐะตั)"
else
  echo "โ ะขะพะปัะบะพ 1 ะฟัะพัะตัั ะฝะฐ ะฟะพััั 3000"
  PID=$(lsof -ti:3000)
  echo "   PID: $PID"
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# 3. ะัะพะฒะตััะตะผ ะฐะบัะธะฒะฝัะต ะณััะฟะฟั Telegram
echo "๐ฑ Telegram ะฐะบัะธะฒะฝัะต ะณััะฟะฟั:"
if [ -f ".env" ] || [ -f "env.env" ]; then
  # ะะพะถะฝะพ ะดะพะฑะฐะฒะธัั SQL ะทะฐะฟัะพั ะตัะปะธ ะฝัะถะฝะพ
  echo "   (ะัะพะฒะตัั ะฒ Supabase: SELECT * FROM telegram_groups WHERE is_active = true)"
else
  echo "   (env ัะฐะนะป ะฝะต ะฝะฐะนะดะตะฝ)"
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ะัะพะณะพะฒัะน ัะตะทัะปััะฐั
if [ "$NODE_PROCESSES" -le 3 ] && [ "$PORT_PROCESSES" -eq 1 ]; then
  echo "โ ะะกะ ะฅะะะะจะ! ะัะฑะปะธะบะฐัะพะฒ ะฝะตั, ัะตัะฒะตั ัะฐะฑะพัะฐะตั ะฝะพัะผะฐะปัะฝะพ"
  exit 0
elif [ "$NODE_PROCESSES" -eq 0 ]; then
  echo "โ๏ธ  ะะะะะะะะ: ะกะตัะฒะตั ะฝะต ะทะฐะฟััะตะฝ"
  exit 1
else
  echo "โ ะะะะะะะะ ะะะะะะฃะะะะ! ะััั ัะธัะบ ะดัะฑะปะธะบะฐัะพะฒ!"
  echo ""
  echo "๐ง ะะฐะฟัััะธ: ./scripts/start-clean.sh"
  exit 1
fi










