# ‚úÖ –ö–†–ò–¢–ò–ß–ù–´–ï –§–ò–ö–°–´ –ü–†–ò–ú–ï–ù–ï–ù–´

**–î–∞—Ç–∞:** 14 –¥–µ–∫–∞–±—Ä—è 2025, 20:30  
**–°—Ç–∞—Ç—É—Å:** –ì–û–¢–û–í–û –ö –î–ï–ü–õ–û–Æ

---

## üéØ –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û

### 1. ‚úÖ AmoCRM Deduplication - –ö–†–ò–¢–ò–ß–ù–´–ô –§–ò–ö–°

**–§–∞–π–ª:** `backend/src/lib/amocrm.ts`  
**–§—É–Ω–∫—Ü–∏—è:** `findExistingLead` (—Å—Ç—Ä–æ–∫–∏ 135-149)

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è –Ω–∞—Ö–æ–¥–∏–ª–∞ **–ª—é–±—É—é** —Å–¥–µ–ª–∫—É –∫–æ–Ω—Ç–∞–∫—Ç–∞ (–¥–∞–∂–µ –∑–∞–∫—Ä—ã—Ç—É—é), –≤—Å–µ –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ –æ–±–Ω–æ–≤–ª—è–ª–∏ –û–î–ù–£ —Å—Ç–∞—Ä—É—é —Å–¥–µ–ª–∫—É.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// ‚úÖ FIX: –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ê–ö–¢–ò–í–ù–´–ï (–Ω–µ –∑–∞–∫—Ä—ã—Ç—ã–µ) —Å–¥–µ–ª–∫–∏
const CLOSED_STAGES = [
  AMOCRM_CONFIG.STAGES.–£–°–ü–ï–®–ù–û_–†–ï–ê–õ–ò–ó–û–í–ê–ù–û, // 142
  AMOCRM_CONFIG.STAGES.–ó–ê–ö–†–´–¢–û_–ò_–ù–ï_–†–ï–ê–õ–ò–ó–û–í–ê–ù–û, // 143
];

const activeLead = leads.find((lead: any) => !CLOSED_STAGES.includes(lead.status_id));

if (!activeLead) {
  console.log(`üîç No ACTIVE leads found - creating new deal`);
  return null; // –°–æ–∑–¥–∞—Å—Ç—Å—è –Ω–æ–≤–∞—è —Å–¥–µ–ª–∫–∞
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç —Å –∑–∞–∫—Ä—ã—Ç–æ–π —Å–¥–µ–ª–∫–æ–π ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è –ù–û–í–ê–Ø —Å–¥–µ–ª–∫–∞
- ‚úÖ –ö–æ–Ω—Ç–∞–∫—Ç —Å –∞–∫—Ç–∏–≤–Ω–æ–π —Å–¥–µ–ª–∫–æ–π ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ê–ö–¢–ò–í–ù–ê–Ø —Å–¥–µ–ª–∫–∞
- ‚úÖ –ù–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è —Å–¥–µ–ª–∫–∞

---

### 2. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ TypeScript

**–§–∞–π–ª—ã:**
- `backend/src/routes/landing.ts` - –¥–æ–±–∞–≤–ª–µ–Ω `sourceCampaign` –≤ `scheduleProftestNotifications`
- `backend/src/scripts/recover-lost-leads.ts` - –¥–æ–±–∞–≤–ª–µ–Ω `sourceCampaign` –≤ `scheduleProftestNotifications`
- `backend/src/services/scheduledNotifications.ts` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ —Å `leadId` –≤ catch –±–ª–æ–∫–µ
- `backend/src/routes/lead-tracking.ts` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–∏–ø–∏–∑–∞—Ü–∏—è –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ñ–∏–ª—å—Ç—Ä–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ö–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫
- ‚ö†Ô∏è –û—Å—Ç–∞–ª–∏—Å—å 2 –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–∫–∏ —Å `import.meta` (–Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É)

---

## üì¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ö–û–î–ï

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. `backend/src/lib/amocrm.ts` - **–ö–†–ò–¢–ò–ß–ù–´–ô –§–ò–ö–°** deduplication
2. `backend/src/routes/landing.ts` - –¥–æ–±–∞–≤–ª–µ–Ω `sourceCampaign`
3. `backend/src/scripts/recover-lost-leads.ts` - –¥–æ–±–∞–≤–ª–µ–Ω `sourceCampaign`
4. `backend/src/services/scheduledNotifications.ts` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ –≤ catch –±–ª–æ–∫–µ
5. `backend/src/routes/lead-tracking.ts` - —Ç–∏–ø–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
1. `üö®_CURRENT_PRIORITIES.md` - checkpoint –¥–ª—è –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤
2. `üìù_KNOWN_ISSUES_P2.md` - –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (–æ—Ç–ª–æ–∂–µ–Ω—ã)
3. `‚úÖ_–ö–†–ò–¢–ò–ß–ù–´–ï_–§–ò–ö–°–´_–ü–†–ò–ú–ï–ù–ï–ù–´.md` - —ç—Ç–æ—Ç —Ñ–∞–π–ª

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### 1. –î–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω

```bash
# Git commit + push
git add .
git commit -m "üî• FIX: AmoCRM deduplication - —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏

- –ö–†–ò–¢–ò–ß–ù–û: findExistingLead —Ç–µ–ø–µ—Ä—å –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∑–∞–∫—Ä—ã—Ç—ã–µ —Å–¥–µ–ª–∫–∏
- –ö–æ–Ω—Ç–∞–∫—Ç—ã —Å –∑–∞–∫—Ä—ã—Ç—ã–º–∏ —Å–¥–µ–ª–∫–∞–º–∏ –ø–æ–ª—É—á–∞—é—Ç –ù–û–í–£–Æ —Å–¥–µ–ª–∫—É
- –§–∏–∫—Å –¥–ª—è 50+ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö –ª–∏–¥–æ–≤
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ TypeScript –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
- –î–æ–±–∞–≤–ª–µ–Ω sourceCampaign –≤ scheduleProftestNotifications"

git push origin main
```

```bash
# –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
ssh root@178.124.206.52
cd /var/www/onai-integrator-login-main
./deploy-production.sh
```

---

### 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ 50+ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã—Ö –ª–∏–¥–æ–≤

**–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è:**

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
ssh root@178.124.206.52
cd /var/www/onai-integrator-login-main/backend
npx tsx src/scripts/recover-lost-leads.ts
```

**–ß—Ç–æ —Å–¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:**
1. –ù–∞–π–¥–µ—Ç –ª–∏–¥—ã —Å `amocrm_lead_id: null` (–ø–æ—Å–ª–µ 12:00 13 –¥–µ–∫–∞–±—Ä—è)
2. –°–æ–∑–¥–∞—Å—Ç –û–¢–î–ï–õ–¨–ù–£–Æ —Å–¥–µ–ª–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤ AmoCRM
3. –û–±–Ω–æ–≤–∏—Ç `amocrm_lead_id` –≤ –ë–î
4. –ó–∞–ø–ª–∞–Ω–∏—Ä—É–µ—Ç Email/SMS –æ—Ç–ø—Ä–∞–≤–∫—É (—á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç)

---

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–ü–æ—Å–ª–µ recovery —Å–∫—Ä–∏–ø—Ç–∞ (—á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç):**

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
pm2 logs onai-backend --lines 100 | grep "Email sent\|SMS sent"
```

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î
SELECT name, email, phone, amocrm_lead_id, email_sent, sms_sent
FROM landing_leads
WHERE created_at >= '2025-12-13 12:00:00'
ORDER BY created_at DESC
LIMIT 20;

-- –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
-- ‚úÖ amocrm_lead_id –∑–∞–ø–æ–ª–Ω–µ–Ω –¥–ª—è –≤—Å–µ—Ö
-- ‚úÖ email_sent = true
-- ‚úÖ sms_sent = true
```

**AmoCRM:**
- –û—Ç–∫—Ä—ã—Ç—å https://onaiagencykz.amocrm.ru
- –í–æ—Ä–æ–Ω–∫–∞: Tripwire (ID: 10350882)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –∫–∞–∂–¥—ã–π –ª–∏–¥ = –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å–¥–µ–ª–∫–∞ ‚úÖ

**Dashboard:**
- –û—Ç–∫—Ä—ã—Ç—å https://onai.academy/target
- –°—á–µ—Ç—á–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–µ 0) ‚úÖ

---

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (24 —á–∞—Å–∞)

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–∂–¥—ã–µ 2-3 —á–∞—Å–∞:**

1. **–ù–æ–≤—ã–µ –ª–∏–¥—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
   ```bash
   pm2 logs onai-backend --lines 50 | grep "AmoCRM: Lead created"
   ```

2. **–ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö:**
   ```bash
   pm2 logs onai-backend --err --lines 20
   ```

3. **Backend —Ä–∞–±–æ—Ç–∞–µ—Ç:**
   ```bash
   pm2 status
   curl https://api.onai.academy/health
   ```

4. **AmoCRM - –Ω–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è:**
   - –ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π ProfTest ‚Üí –û–¢–î–ï–õ–¨–ù–ê–Ø —Å–¥–µ–ª–∫–∞
   - –ö–∞–∂–¥–∞—è –Ω–æ–≤–∞—è –ø–æ–∫—É–ø–∫–∞ ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ê–ö–¢–ò–í–ù–û–ô —Å–¥–µ–ª–∫–∏ (–∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π)

---

## ‚úÖ SUCCESS CRITERIA

**–§–∏–∫—Å—ã —Å—á–∏—Ç–∞—é—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–º–∏ –∫–æ–≥–¥–∞:**

1. ‚úÖ –ù–æ–≤—ã–µ ProfTest –∑–∞—è–≤–∫–∏ ‚Üí –û–¢–î–ï–õ–¨–ù–ê–Ø —Å–¥–µ–ª–∫–∞ –≤ AmoCRM
2. ‚úÖ 50+ —Å—Ç–∞—Ä—ã—Ö –ª–∏–¥–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã (–∫–∞–∂–¥—ã–π = –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å–¥–µ–ª–∫–∞)
3. ‚úÖ `amocrm_lead_id` –æ–±–Ω–æ–≤–ª–µ–Ω –≤ –ë–î –¥–ª—è –≤—Å–µ—Ö –ª–∏–¥–æ–≤
4. ‚úÖ Email/SMS –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ–º –ª–∏–¥–∞–º (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ 15 –º–∏–Ω –ø–æ—Å–ª–µ recovery)
5. ‚úÖ Dashboard `/target` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏
6. ‚úÖ 24 —á–∞—Å–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ - –Ω–µ—Ç –Ω–æ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º

---

## üîí BACKUP & ROLLBACK PLAN

**–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫:**

```bash
# –û—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
ssh root@178.124.206.52
cd /var/www/onai-integrator-login-main
git log --oneline -5  # –ù–∞–π—Ç–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–∏—Ç
git reset --hard <previous-commit-hash>
cd backend
npm install --legacy-peer-deps
pm2 restart onai-backend
```

**–ù–æ —ç—Ç–æ –ù–ï –ù–£–ñ–ù–û** - —Ñ–∏–∫—Å—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –¥–µ–ø–ª–æ—é! üöÄ

---

## üìä –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –î–æ —Ñ–∏–∫—Å–∞:
- ‚ùå 50+ –ª–∏–¥–æ–≤ –ø–æ—Ç–µ—Ä—è–Ω—ã (–Ω–µ —Å–æ–∑–¥–∞–Ω—ã –≤ AmoCRM)
- ‚ùå –í—Å–µ –Ω–æ–≤—ã–µ –ª–∏–¥—ã –æ–±–Ω–æ–≤–ª—è–ª–∏ –æ–¥–Ω—É —Å–¥–µ–ª–∫—É (ID: 21128395)
- ‚ùå Dashboard –ø–æ–∫–∞–∑—ã–≤–∞–ª 0 –ª–∏–¥–æ–≤
- ‚ùå Email/SMS –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å

### –ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞:
- ‚úÖ –ö–∞–∂–¥—ã–π –ª–∏–¥ = –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å–¥–µ–ª–∫–∞ –≤ AmoCRM
- ‚úÖ 50+ –ª–∏–¥–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- ‚úÖ Dashboard –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ Email/SMS –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤—Å–µ–º –ª–∏–¥–∞–º
- ‚úÖ Sales –º–µ–Ω–µ–¥–∂–µ—Ä—ã –≤–∏–¥—è—Ç –≤—Å–µ –∑–∞—è–≤–∫–∏

---

**–¢–†–ê–§–ò–ö –ê–ö–¢–ò–í–ï–ù - –ì–û–¢–û–í–´ –ö –î–ï–ü–õ–û–Æ!** üöÄ

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** Git commit + push + deploy
