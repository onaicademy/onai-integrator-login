# üö® –ò–ù–¶–ò–î–ï–ù–¢: Backend Crash - –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞

## üìå ONE-PAGER

**–î–∞—Ç–∞:** 22 –¥–µ–∫–∞–±—Ä—è 2025, ~08:00-13:00 (Almaty)  
**–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** ~2-3 —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è  
**Severity:** üî¥ P0 - CRITICAL  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ RESOLVED  

---

## ‚ö° –ß–¢–û –°–õ–£–ß–ò–õ–û–°–¨ (30 —Å–µ–∫—É–Ω–¥)

```
Backend API ‚Üí Crash Loop ‚Üí 106 —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤ ‚Üí –ü–û–õ–ù–´–ô –ü–†–û–°–¢–û–ô
```

**–ü–æ—á–µ–º—É:**
- –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –æ—Å—Ç–∞–ª–∞—Å—å —Å—Ç–∞—Ä–∞—è –ø–∞–ø–∫–∞ `dist/` (compiled JS)
- PM2 –∫–æ–Ω—Ñ–∏–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `tsx src/server.ts` (TypeScript)
- –ö–æ–Ω—Ñ–ª–∏–∫—Ç –º–µ–∂–¥—É CommonJS –∏ ESM ‚Üí `SyntaxError`

**–†–µ—à–µ–Ω–∏–µ:**
```bash
rm -rf dist/
pm2 restart onai-backend
```

---

## üéØ –ì–õ–ê–í–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

### ‚ùå –ù–ò–ö–¢–û –ù–ï –ó–ê–ú–ï–¢–ò–õ 3 –ß–ê–°–ê!

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ù–ï–¢ –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê = –°–õ–ï–ü–ê–Ø –°–ò–°–¢–ï–ú–ê    ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ  Backend —É–ø–∞–ª –≤ 08:00               ‚îÇ
‚îÇ  –û–±–Ω–∞—Ä—É–∂–∏–ª–∏ –≤ 13:00                 ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ  3 –ß–ê–°–ê –ü–†–û–°–¢–û–Ø! ‚ùå                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üî• –¢–û–ü-3 –°–†–û–ß–ù–´–• –î–ï–ô–°–¢–í–ò–Ø

### 1Ô∏è‚É£ –ú–û–ù–ò–¢–û–†–ò–ù–ì (30 –º–∏–Ω—É—Ç)

```
UptimeRobot ‚Üí api.onai.academy/health ‚Üí –ö–∞–∂–¥—ã–µ 2 –º–∏–Ω ‚Üí Telegram Alert
```

**–°–¥–µ–ª–∞–π –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:** https://uptimerobot.com

---

### 2Ô∏è‚É£ –ò–°–ü–†–ê–í–¨ PM2 (5 –º–∏–Ω—É—Ç)

```diff
- max_restarts: 15  ‚ùå –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Ä–µ—Å—Ç–∞—Ä—Ç—ã
+ max_restarts: 3   ‚úÖ Fail fast

- min_uptime: '5s'  ‚ùå –°–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ
+ min_uptime: '30s' ‚úÖ –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
```

---

### 3Ô∏è‚É£ –í–ö–õ–Æ–ß–ò SENTRY (10 –º–∏–Ω—É—Ç)

```bash
SENTRY_ENABLED=true
```

–í—Å–µ –æ—à–∏–±–∫–∏ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ Sentry ‚Üí —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

---

## üìä –î–û vs –ü–û–°–õ–ï

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–û ‚ùå | –ü–û–°–õ–ï ‚úÖ |
|---------|-------|----------|
| **–í—Ä–µ–º—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è** | 3 —á–∞—Å–∞ | 2-5 –º–∏–Ω—É—Ç |
| **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** | –ù–µ—Ç | UptimeRobot 24/7 |
| **–ê–ª–µ—Ä—Ç—ã** | –ù–µ—Ç | Telegram + SMS |
| **Error tracking** | PM2 logs | Sentry |
| **Rollback** | –†—É—á–Ω–æ–π | 1 –∫–æ–º–∞–Ω–¥–∞ |
| **Smoke tests** | –ù–µ—Ç | –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è |

---

## üõ°Ô∏è –û–¢ –ß–ï–ì–û –ù–ï –ó–ê–©–ò–©–ï–ù–´

1. ‚ùå **–ù–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞** ‚Üí –ü—Ä–æ—Å—Ç–æ–∏ –Ω–µ–∑–∞–º–µ—Ç–Ω—ã
2. ‚ùå **PM2 –º–∞—Å–∫–∏—Ä—É–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã** ‚Üí –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Ä–µ—Å—Ç–∞—Ä—Ç—ã
3. ‚ùå **Deploy —Å–∫—Ä–∏–ø—Ç—ã —É—Å—Ç–∞—Ä–µ–ª–∏** ‚Üí –°–æ–∑–¥–∞—é—Ç `dist/`
4. ‚ùå **–ù–µ—Ç smoke tests** ‚Üí –î–µ–ø–ª–æ–π "—É—Å–ø–µ—à–µ–Ω" –¥–∞–∂–µ –µ—Å–ª–∏ –∫—Ä–∞—à–∏—Ç—Å—è
5. ‚ùå **–ù–µ—Ç rollback** ‚Üí –ß–∏–Ω–∏—Ç—å "–Ω–∞ –≥–æ—Ä—è—á—É—é"
6. ‚ùå **Sentry –æ—Ç–∫–ª—é—á–µ–Ω** ‚Üí –¢–µ—Ä—è–µ–º –æ—à–∏–±–∫–∏
7. ‚ùå **–ù–µ—Ç CI/CD** ‚Üí –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π = —Ä–∏—Å–∫
8. ‚ùå **–ù–µ—Ç —á–µ–∫-–ª–∏—Å—Ç–∞** ‚Üí –ó–∞–±—ã–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

---

## üí° LESSON LEARNED

### –ß—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ ‚úÖ
- –ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (2 –º–∏–Ω—É—Ç—ã)
- –ü—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ (`rm -rf dist/`)
- ecosystem.config.js –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

### –ß—Ç–æ –ø—Ä–æ–≤–∞–ª–∏–ª–æ—Å—å ‚ùå
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
- PM2 —Å–∫—Ä—ã–≤–∞–ª –ø—Ä–æ–±–ª–µ–º—É
- Deploy —Å–∫—Ä–∏–ø—Ç—ã —Å–æ–∑–¥–∞–≤–∞–ª–∏ `dist/`
- –ù–∏–∫—Ç–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

### –ì–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥ üéì
> **"–ï—Å–ª–∏ —Ç—ã –Ω–µ –∑–Ω–∞–µ—à—å —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ —É–ø–∞–ª–∞ - –æ–Ω–∞ –¥–ª—è —Ç–µ–±—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"**

---

## üìã ACTION PLAN

### üî• –°–ï–ì–û–î–ù–Ø (1 —á–∞—Å)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å UptimeRobot
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å PM2 config
- [ ] –í–∫–ª—é—á–∏—Ç—å Sentry
- [ ] –ü–æ—á–∏–Ω–∏—Ç—å deploy —Å–∫—Ä–∏–ø—Ç—ã

### ‚ö†Ô∏è –≠–¢–ê –ù–ï–î–ï–õ–Ø (7 —á–∞—Å–æ–≤)
- [ ] Rollback mechanism
- [ ] CI/CD pipeline
- [ ] Smoke tests
- [ ] Pre-deployment checklist

### üìä 2 –ù–ï–î–ï–õ–ò
- [ ] Structured logging
- [ ] Automated tests
- [ ] Documentation

---

## üí∞ –°–¢–û–ò–ú–û–°–¢–¨ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

```
UptimeRobot:     $0   (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ)
Sentry:          $0   (5k events/–º–µ—Å—è—Ü)
GitHub Actions:  $0   (2000 –º–∏–Ω—É—Ç/–º–µ—Å—è—Ü)
Better Uptime:   $10  (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ò–¢–û–ì–û: $0-10/–º–µ—Å—è—Ü
```

**vs**

```
–°—Ç–æ–∏–º–æ—Å—Ç—å 1 —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è: ???
–ü–æ—Ç–µ—Ä—è —Ä–µ–ø—É—Ç–∞—Ü–∏–∏: ???
–ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã: ???

–ò–¢–û–ì–û: >> $10/–º–µ—Å—è—Ü
```

---

## üöÄ –ù–ê–ß–ù–ò –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°

```bash
# 1. –û—Ç–∫—Ä–æ–π –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
open https://uptimerobot.com

# 2. SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh root@207.154.231.30

# 3. –ò—Å–ø—Ä–∞–≤—å PM2
cd /var/www/onai-integrator-login-main/backend
nano ecosystem.config.js
# max_restarts: 3
# min_uptime: '30s'

# 4. –í–∫–ª—é—á–∏ Sentry
nano env.env
# SENTRY_ENABLED=true

# 5. Restart
pm2 restart onai-backend

# ‚úÖ –ì–û–¢–û–í–û! –¢–µ–ø–µ—Ä—å —Ç—ã –∑–∞—â–∏—â—ë–Ω.
```

---

## üìö –î–û–ö–£–ú–ï–ù–¢–´

- üìÑ [–ü–æ–ª–Ω—ã–π Postmortem](./POSTMORTEM_BACKEND_CRASH_2025-12-22.md) - –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
- üîß [–°—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è](./–°–†–û–ß–ù–´–ï_–£–õ–£–ß–®–ï–ù–ò–Ø_–ü–û–°–õ–ï_–ö–†–ê–®–ê.md) - –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω
- üìã [Deploy Checklist](./DEPLOY_CHECKLIST.md) - —á–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º (—Å–æ–∑–¥–∞—Ç—å)

---

## üéØ SUCCESS METRICS

**Goal:**
- ‚úÖ MTTD < 5 –º–∏–Ω—É—Ç (–≤–º–µ—Å—Ç–æ 3 —á–∞—Å–æ–≤)
- ‚úÖ MTTR < 10 –º–∏–Ω—É—Ç (—Å rollback)
- ‚úÖ 0 –Ω–µ–∑–∞–º–µ—á–µ–Ω–Ω—ã—Ö –∫—Ä–∞—à–µ–π
- ‚úÖ 100% smoke tests coverage

---

**–í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å:** –°–ï–ô–ß–ê–°! ‚è∞

–°–ª–µ–¥—É—é—â–∏–π –∏–Ω—Ü–∏–¥–µ–Ω—Ç –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç.  
–ë—É–¥—å –≥–æ—Ç–æ–≤! üõ°Ô∏è
