# üß™ –ü–õ–ê–ù –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø: –í–∏–¥–µ–æ-—Ç—Ä–µ–∫–∏–Ω–≥ –∏ AI Mentor

## üìã –¶–µ–ª—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤–∏–¥–µ–æ-—Ç—Ä–µ–∫–∏–Ω–≥ **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç** –∏ AI Mentor **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á–∏** –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å—Ç—É–¥–µ–Ω—Ç–∞.

---

## ‚úÖ –ß–¢–û –ú–´ –í–ù–ï–î–†–ò–õ–ò

### Frontend (`src/pages/Lesson.tsx`)
- ‚úÖ `seeksCount` - —Å—á–µ—Ç—á–∏–∫ –ø–µ—Ä–µ–º–æ—Ç–æ–∫ –≤–∏–¥–µ–æ
- ‚úÖ `pausesCount` - —Å—á–µ—Ç—á–∏–∫ –ø–∞—É–∑
- ‚úÖ `maxSecondReached` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Ç—Ä–∏–∫ –≤ Backend –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ—Ç—Ä–∏–∫ —á–µ—Ä–µ–∑ `navigator.sendBeacon`

### Backend (`backend/src/routes/analytics.ts`)
- ‚úÖ Endpoint: `POST /api/analytics/video-session/end`
- ‚úÖ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç: `seeks_count`, `pauses_count`, `max_second_reached`
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `video_watch_sessions`

### Database (Supabase)
- ‚úÖ –¢—Ä–∏–≥–≥–µ—Ä `on_video_struggle` ‚Üí —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ INSERT/UPDATE –≤ `video_watch_sessions`
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `detect_video_struggle()` ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `seeks_count >= 5`
- ‚úÖ –§—É–Ω–∫—Ü–∏—è `create_mentor_task_from_video_struggle()` ‚Üí —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É –≤ `ai_mentor_tasks`

---

## üéØ –¢–ï–°–¢ 1: –ë–∞–∑–æ–≤—ã–π –≤–∏–¥–µ–æ-—Ç—Ä–µ–∫–∏–Ω–≥ (15 –º–∏–Ω—É—Ç)

### –®–∞–≥–∏:
1. **–ó–∞–ø—É—Å—Ç–∏—Ç—å localhost:**
   ```bash
   npm run dev
   ```

2. **–û—Ç–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä:**
   - URL: `http://localhost:8080`
   - Login: `saint@onaiacademy.kz`

3. **–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —É—Ä–æ–∫ —Å –≤–∏–¥–µ–æ:**
   - –û—Ç–∫—Ä—ã—Ç—å –ª—é–±–æ–π –∫—É—Ä—Å ‚Üí –º–æ–¥—É–ª—å ‚Üí —É—Ä–æ–∫ —Å –≤–∏–¥–µ–æ
   - –ù–∞–ø—Ä–∏–º–µ—Ä: `/course/1/module/1/lesson/1`

4. **–î–µ–π—Å—Ç–≤–∏—è —Å –≤–∏–¥–µ–æ (–í–ê–ñ–ù–û!):**
   - ‚ñ∂Ô∏è –ù–∞–∂–∞—Ç—å Play (–Ω–∞—á–∞—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä)
   - ‚è∏Ô∏è –ù–∞–∂–∞—Ç—å Pause (–ø–∞—É–∑–∞) - **3 —Ä–∞–∑–∞**
   - ‚è© –ü–µ—Ä–µ–º–æ—Ç–∞—Ç—å –≤–ø–µ—Ä–µ–¥ (drag progress bar) - **6 —Ä–∞–∑**
   - ‚è™ –ü–µ—Ä–µ–º–æ—Ç–∞—Ç—å –Ω–∞–∑–∞–¥ - **2 —Ä–∞–∑–∞**
   - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–∏–Ω–∏–º—É–º **30 —Å–µ–∫—É–Ω–¥**

5. **–ó–∞–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É** (–∏–ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É)

6. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞:**
   ```
   üì° sendBeacon: –ú–µ—Ç—Ä–∏–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã { seeksCount: 8, pausesCount: 3 }
   ```

### ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –í –∫–æ–Ω—Å–æ–ª–∏ –≤–∏–¥–Ω–æ –æ—Ç–ø—Ä–∞–≤–∫—É –º–µ—Ç—Ä–∏–∫
- –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏

---

## üéØ –¢–ï–°–¢ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î (5 –º–∏–Ω—É—Ç)

### –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –∑–∞–ø—Ä–æ—Å –≤ Supabase:

```sql
-- –°–º–æ—Ç—Ä–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–µ—Å—Å–∏—é –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
SELECT 
  vws.id,
  vws.user_id,
  vws.lesson_id,
  vws.seeks_count,      -- ‚úÖ –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 8
  vws.pauses_count,     -- ‚úÖ –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 3
  vws.max_second_reached,
  vws.duration_seconds,
  vws.playback_speed,
  vws.created_at,
  l.title as lesson_title
FROM video_watch_sessions vws
JOIN lessons l ON l.id = vws.lesson_id
ORDER BY vws.created_at DESC
LIMIT 1;
```

### ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- **1 –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å** –≤ —Ç–∞–±–ª–∏—Ü–µ
- `seeks_count` = **8** (6 –≤–ø–µ—Ä–µ–¥ + 2 –Ω–∞–∑–∞–¥)
- `pauses_count` = **3**
- `max_second_reached` > 0
- `duration_seconds` > 0

### ‚ùå –ï—Å–ª–∏ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Backend –ª–æ–≥–∏ (PM2 –∏–ª–∏ terminal)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Network tab –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–µ—Å—Ç—å –ª–∏ POST –∑–∞–ø—Ä–æ—Å?)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

---

## üéØ –¢–ï–°–¢ 3: AI Mentor - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á (5 –º–∏–Ω—É—Ç)

### –£—Å–ª–æ–≤–∏–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–∞:
**`seeks_count >= 5`** ‚Üí AI Mentor —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É "–°—Ç—É–¥–µ–Ω—Ç –∏—Å–ø—ã—Ç—ã–≤–∞–µ—Ç —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏"

### –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –∑–∞–ø—Ä–æ—Å:

```sql
-- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ AI Mentor –∑–∞–¥–∞—á–∏
SELECT 
  amt.id,
  amt.task_type,
  amt.description,
  amt.priority,
  amt.status,
  amt.context_data,
  amt.created_at,
  u.email as student_email
FROM ai_mentor_tasks amt
JOIN users u ON u.id = amt.student_id
WHERE amt.triggered_by = 'video_struggle'
ORDER BY amt.created_at DESC
LIMIT 1;
```

### ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```json
{
  "task_type": "offer_help",
  "description": "–°—Ç—É–¥–µ–Ω—Ç –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ–ª —É—Ä–æ–∫ \"–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–∫–∞\" 8 —Ä–∞–∑(–∞). –í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å.",
  "priority": "high",  // –ø–æ—Ç–æ–º—É —á—Ç–æ seeks_count >= 5
  "status": "pending",
  "context_data": {
    "lesson_id": 1,
    "lesson_title": "...",
    "rewatch_count": 8,
    "struggling_at_second": 30
  }
}
```

### ‚ùå –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –ù–ï —Å–æ–∑–¥–∞–Ω–∞:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `seeks_count >= 5` –≤ `video_watch_sessions`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä:
   ```sql
   SELECT trigger_name, event_manipulation, action_statement
   FROM information_schema.triggers
   WHERE event_object_table = 'video_watch_sessions'
   AND trigger_name = 'on_video_struggle';
   ```
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `detect_video_struggle()` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

---

## üéØ –¢–ï–°–¢ 4: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ (5 –º–∏–Ω—É—Ç)

### –®–∞–≥–∏:
1. –û—Ç–∫—Ä—ã—Ç—å `/neurohub`
2. –ù–∞–ø–∏—Å–∞—Ç—å –≤ —á–∞—Ç: **"–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–µ–±—Ö—É–∫ –≤ n8n?"**
3. –î–æ–∂–¥–∞—Ç—å—Å—è –æ—Ç–≤–µ—Ç–∞ AI
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î

### SQL –∑–∞–ø—Ä–æ—Å:
```sql
SELECT 
  sql.id,
  sql.question_text,
  LEFT(sql.ai_response, 100) as ai_response_preview,
  sql.ai_model_used,
  sql.response_time_ms,
  sql.created_at,
  u.email
FROM student_questions_log sql
JOIN users u ON u.id = sql.user_id
ORDER BY sql.created_at DESC
LIMIT 1;
```

### ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å —Å –≤–æ–ø—Ä–æ—Å–æ–º –∏ –æ—Ç–≤–µ—Ç–æ–º
- `ai_model_used` = "gpt-4o"
- `response_time_ms` > 0

---

## üéØ –¢–ï–°–¢ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (5 –º–∏–Ω—É—Ç)

### SQL –∑–∞–ø—Ä–æ—Å—ã:

```sql
-- 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ RLS –≤–∫–ª—é—á–µ–Ω
SELECT 
  tablename,
  rowsecurity as rls_enabled
FROM pg_tables
WHERE schemaname = 'public'
  AND tablename IN ('profiles', 'student_profiles', 'user_statistics')
ORDER BY tablename;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ 3 —Ç–∞–±–ª–∏—Ü—ã —Å `rls_enabled = true`

```sql
-- 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è user_statistics
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd
FROM pg_policies
WHERE tablename = 'user_statistics'
ORDER BY policyname;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–∏–Ω–∏–º—É–º 4-5 –ø–æ–ª–∏—Ç–∏–∫

---

## üìä –ò–¢–û–ì–û–í–ê–Ø CHECKLIST

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- [ ] –¢–µ—Å—Ç 1: –í–∏–¥–µ–æ-—Ç—Ä–µ–∫–∏–Ω–≥ (seeks, pauses) - –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Å–æ–ª–∏
- [ ] –¢–µ—Å—Ç 2: –î–∞–Ω–Ω—ã–µ –≤ `video_watch_sessions` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
- [ ] –¢–µ—Å—Ç 3: AI Mentor –∑–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- [ ] –¢–µ—Å—Ç 4: –í–æ–ø—Ä–æ—Å—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `student_questions_log`
- [ ] –¢–µ—Å—Ç 5: RLS –≤–∫–ª—é—á–µ–Ω –Ω–∞ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
- [x] –í–∏–¥–µ–æ-—Ç—Ä–µ–∫–∏–Ω–≥: seeks_count ‚úÖ
- [x] –í–∏–¥–µ–æ-—Ç—Ä–µ–∫–∏–Ω–≥: pauses_count ‚úÖ
- [x] –í–∏–¥–µ–æ-—Ç—Ä–µ–∫–∏–Ω–≥: max_second_reached ‚úÖ
- [x] –°–∫–æ—Ä–æ—Å—Ç—å –≤–∏–¥–µ–æ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
- [ ] –ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ (—Ç—Ä–µ–±—É–µ—Ç —Ä–∞–∑–Ω—ã–µ URL –æ—Ç Cloudflare)

---

## üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

### –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
1. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
2. üìù –°–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç –æ –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ
3. üé§ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –î–æ–±–∞–≤–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
4. üîê –í–∫–ª—é—á–∏—Ç—å leaked password protection –≤ Supabase Dashboard

### –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Backend –ª–æ–≥–∏
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Network tab –≤ –±—Ä–∞—É–∑–µ—Ä–µ
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã –≤ –ë–î
4. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç—ã

---

## üé¨ –ì–û–¢–û–í –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ!

–ó–∞–ø—É—Å–∫–∞–π localhost –∏ –≤—ã–ø–æ–ª–Ω—è–π —Ç–µ—Å—Ç—ã –ø–æ –ø–æ—Ä—è–¥–∫—É! üí™







