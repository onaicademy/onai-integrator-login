<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .log {
            background: #000;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .error {
            color: #ff6b6b;
        }
        .success {
            color: #51cf66;
        }
        .info {
            color: #74c0fc;
        }
        .warning {
            color: #ffd43b;
        }
    </style>
</head>
<body>
    <h1>üé§ –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</h1>
    
    <div class="test-section">
        <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–∞—É–∑–µ—Ä–µ</h2>
        <div id="browser-info" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>–¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ API</h2>
        <button onclick="checkSupport()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É</button>
        <div id="support-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>–¢–µ—Å—Ç 2: –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</h2>
        <button onclick="requestMicrophone()">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
        <button onclick="stopRecording()" id="stop-btn" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <div id="request-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>–¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π</h2>
        <button onclick="checkPermissions()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è</button>
        <div id="permissions-log" class="log"></div>
    </div>

    <script>
        let mediaStream = null;
        let mediaRecorder = null;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—Ä–∞—É–∑–µ—Ä–µ
        function showBrowserInfo() {
            const info = document.getElementById('browser-info');
            info.innerHTML = `
<span class="info">User Agent:</span> ${navigator.userAgent}
<span class="info">–ü—Ä–æ—Ç–æ–∫–æ–ª:</span> ${window.location.protocol}
<span class="info">Hostname:</span> ${window.location.hostname}
<span class="info">Port:</span> ${window.location.port}
<span class="info">navigator.mediaDevices:</span> ${navigator.mediaDevices ? '‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}
<span class="info">navigator.mediaDevices?.getUserMedia:</span> ${navigator.mediaDevices?.getUserMedia ? '‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}
<span class="info">navigator.getUserMedia:</span> ${navigator.getUserMedia ? '‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}
<span class="info">navigator.webkitGetUserMedia:</span> ${navigator.webkitGetUserMedia ? '‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}
<span class="info">navigator.mozGetUserMedia:</span> ${navigator.mozGetUserMedia ? '‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}
            `;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
        function checkSupport() {
            const log = document.getElementById('support-log');
            log.innerHTML = '<span class="info">–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É...</span>\n';
            
            const checks = [];
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                checks.push('<span class="success">‚úÖ navigator.mediaDevices.getUserMedia - –¥–æ—Å—Ç—É–ø–µ–Ω</span>');
            } else {
                checks.push('<span class="error">‚ùå navigator.mediaDevices.getUserMedia - –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</span>');
            }
            
            if (navigator.getUserMedia) {
                checks.push('<span class="success">‚úÖ navigator.getUserMedia - –¥–æ—Å—Ç—É–ø–µ–Ω</span>');
            } else {
                checks.push('<span class="error">‚ùå navigator.getUserMedia - –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</span>');
            }
            
            if (navigator.webkitGetUserMedia) {
                checks.push('<span class="success">‚úÖ navigator.webkitGetUserMedia - –¥–æ—Å—Ç—É–ø–µ–Ω</span>');
            } else {
                checks.push('<span class="error">‚ùå navigator.webkitGetUserMedia - –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</span>');
            }
            
            if (navigator.mozGetUserMedia) {
                checks.push('<span class="success">‚úÖ navigator.mozGetUserMedia - –¥–æ—Å—Ç—É–ø–µ–Ω</span>');
            } else {
                checks.push('<span class="error">‚ùå navigator.mozGetUserMedia - –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</span>');
            }
            
            log.innerHTML += checks.join('\n');
        }

        // –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
        async function requestMicrophone() {
            const log = document.getElementById('request-log');
            const stopBtn = document.getElementById('stop-btn');
            
            log.innerHTML = '<span class="info">üé§ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...</span>\n';
            log.innerHTML += `<span class="info">–ü—Ä–æ—Ç–æ–∫–æ–ª: ${window.location.protocol}</span>\n`;
            log.innerHTML += `<span class="info">Hostname: ${window.location.hostname}</span>\n\n`;
            
            try {
                let stream;
                
                // –ü—Ä–æ–±—É–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π API
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    log.innerHTML += '<span class="info">‚úÖ –ü—Ä–æ–±—É–µ–º navigator.mediaDevices.getUserMedia...</span>\n';
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            audio: {
                                echoCancellation: true,
                                noiseSuppression: true,
                                sampleRate: 16000,
                                channelCount: 1,
                                autoGainControl: true,
                            } 
                        });
                        log.innerHTML += '<span class="success">‚úÖ –£—Å–ø–µ—Ö! Stream –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ navigator.mediaDevices.getUserMedia</span>\n';
                    } catch (err) {
                        log.innerHTML += `<span class="error">‚ùå –û—à–∏–±–∫–∞: ${err.name} - ${err.message}</span>\n`;
                        throw err;
                    }
                } else if (navigator.webkitGetUserMedia) {
                    log.innerHTML += '<span class="info">‚úÖ –ü—Ä–æ–±—É–µ–º navigator.webkitGetUserMedia...</span>\n';
                    stream = await new Promise((resolve, reject) => {
                        navigator.webkitGetUserMedia({ audio: true }, resolve, reject);
                    });
                    log.innerHTML += '<span class="success">‚úÖ –£—Å–ø–µ—Ö! Stream –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ webkitGetUserMedia</span>\n';
                } else if (navigator.mozGetUserMedia) {
                    log.innerHTML += '<span class="info">‚úÖ –ü—Ä–æ–±—É–µ–º navigator.mozGetUserMedia...</span>\n';
                    stream = await new Promise((resolve, reject) => {
                        navigator.mozGetUserMedia({ audio: true }, resolve, reject);
                    });
                    log.innerHTML += '<span class="success">‚úÖ –£—Å–ø–µ—Ö! Stream –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ mozGetUserMedia</span>\n';
                } else if (navigator.getUserMedia) {
                    log.innerHTML += '<span class="info">‚úÖ –ü—Ä–æ–±—É–µ–º navigator.getUserMedia...</span>\n';
                    stream = await new Promise((resolve, reject) => {
                        navigator.getUserMedia({ audio: true }, resolve, reject);
                    });
                    log.innerHTML += '<span class="success">‚úÖ –£—Å–ø–µ—Ö! Stream –ø–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ getUserMedia</span>\n';
                } else {
                    log.innerHTML += '<span class="error">‚ùå –ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ getUserMedia</span>\n';
                    return;
                }
                
                mediaStream = stream;
                log.innerHTML += '<span class="success">‚úÖ –ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞! –ì–æ–≤–æ—Ä–∏—Ç–µ –≤ –º–∏–∫—Ä–æ—Ñ–æ–Ω...</span>\n';
                stopBtn.disabled = false;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—Ä–µ–∫–∞—Ö
                const tracks = stream.getAudioTracks();
                log.innerHTML += `<span class="info">–ù–∞–π–¥–µ–Ω–æ –∞—É–¥–∏–æ-—Ç—Ä–µ–∫–æ–≤: ${tracks.length}</span>\n`;
                tracks.forEach((track, index) => {
                    log.innerHTML += `<span class="info">–¢—Ä–µ–∫ ${index + 1}: ${track.label} (${track.kind})</span>\n`;
                });
                
            } catch (err) {
                log.innerHTML += `\n<span class="error">‚ùå === –û–®–ò–ë–ö–ê ===</span>\n`;
                log.innerHTML += `<span class="error">–ò–º—è –æ—à–∏–±–∫–∏: ${err.name}</span>\n`;
                log.innerHTML += `<span class="error">–°–æ–æ–±—â–µ–Ω–∏–µ: ${err.message}</span>\n`;
                log.innerHTML += `<span class="error">–ö–æ–¥: ${err.code || 'N/A'}</span>\n`;
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    log.innerHTML += `\n<span class="warning">‚ö†Ô∏è –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –ù—É–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.</span>\n`;
                } else if (err.name === 'NotFoundError') {
                    log.innerHTML += `\n<span class="warning">‚ö†Ô∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.</span>\n`;
                } else if (err.name === 'NotReadableError') {
                    log.innerHTML += `\n<span class="warning">‚ö†Ô∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.</span>\n`;
                } else {
                    log.innerHTML += `\n<span class="warning">‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.</span>\n`;
                }
            }
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏
        function stopRecording() {
            const log = document.getElementById('request-log');
            const stopBtn = document.getElementById('stop-btn');
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
                log.innerHTML += '\n<span class="info">‚èπÔ∏è –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</span>\n';
                stopBtn.disabled = true;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        async function checkPermissions() {
            const log = document.getElementById('permissions-log');
            log.innerHTML = '<span class="info">–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è...</span>\n';
            
            if (navigator.permissions && navigator.permissions.query) {
                try {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    log.innerHTML += `<span class="info">–°—Ç–∞—Ç—É—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: ${result.state}</span>\n`;
                    
                    result.onchange = () => {
                        log.innerHTML += `<span class="info">–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è: ${result.state}</span>\n`;
                    };
                } catch (err) {
                    log.innerHTML += `<span class="warning">‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: ${err.message}</span>\n`;
                }
            } else {
                log.innerHTML += '<span class="warning">‚ö†Ô∏è API —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</span>\n';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        showBrowserInfo();
    </script>
</body>
</html>

