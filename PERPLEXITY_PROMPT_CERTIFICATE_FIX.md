# üî• –ü–†–û–ú–ü–¢ –î–õ–Ø PERPLEXITY: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

## üìã –ö–û–ù–¢–ï–ö–°–¢

–ú—ã —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –Ω–∞ **Next.js (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥) + Express.js (–±—ç–∫–µ–Ω–¥) + Supabase (–±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)**. 

–£ –Ω–∞—Å –µ—Å—Ç—å –∫—É—Ä—Å Tripwire —Å 3 –º–æ–¥—É–ª—è–º–∏. –ü–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –≤—Å–µ—Ö 3 –º–æ–¥—É–ª–µ–π —Å—Ç—É–¥–µ–Ω—Ç –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å PDF-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç.

---

## ‚ùå –¢–ï–ö–£–©–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1. **–û—à–∏–±–∫–∞ 406 –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ Supabase**
```
pjmvxecykysfrzppdcto.supabase.co/rest/v1/tripwire_certificates?select=*&user_id=eq.UUID
Failed to load resource: the server responded with a status of 406 ()
```

- –ó–∞–ø—Ä–æ—Å—ã –∫ —Ç–∞–±–ª–∏—Ü–µ `tripwire_certificates` –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –æ—à–∏–±–∫—É 406
- –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–∞–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞, —Ç–∞–∫ –∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–∞–ª–∏—á–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

### 2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤**
–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ **Supabase Storage** –ø–æ –∞–¥—Ä–µ—Å—É:
```
https://supabase.com/dashboard/project/pjmvxecykysfrzppdcto/storage/files
```

–í –±–∞–∫–µ—Ç–µ `certificates` (PUBLIC bucket, –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ):
- **Bucket name**: `certificates`
- **Public**: ‚úÖ YES
- **File size limit**: 50 MB
- **Allowed MIME types**: `application/pdf`

### 3. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ UI**
**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç"
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–µ–∫—Å—Ç "–°–æ–∑–¥–∞–µ–º...", "–ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º..."
- –ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –†–ï–î–ò–†–ï–ö–¢ –Ω–∞ `/tripwire/certificate/${certificateNumber}` (‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û!)

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç **"–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç"**
2. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è **–ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä** —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º (0% ‚Üí 100%)
3. –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –æ—Ç—Ä–∞–∂–∞–µ—Ç —ç—Ç–∞–ø—ã:
   - 0-25%: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞
   - 25-50%: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF
   - 50-75%: –ó–∞–≥—Ä—É–∑–∫–∞ –≤ Supabase Storage
   - 75-100%: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
4. –ö–æ–≥–¥–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≥–æ—Ç–æ–≤ (100%), –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ **"–°–∫–∞—á–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç"**
5. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ "–°–∫–∞—á–∞—Ç—å" - —Ñ–∞–π–ª **—Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é**, –ë–ï–ó —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

---

## üìÇ –¢–ï–ö–£–©–ò–ô –ö–û–î

### Backend: `tripwireCertificateService.ts`

```typescript
// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PDF –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤ Supabase Storage
export async function issueCertificate(userId: string, fullName?: string): Promise<Certificate> {
  // ... –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–æ–¥—É–ª–µ–π ...
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF
  const pdfBuffer = await certificatePDFService.generatePDF({
    userName: studentName,
    courseTitle: '–ò–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä (–±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç)',
    completionDate: new Date().toLocaleDateString('ru-RU'),
    certificateNumber,
  });
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ Supabase Storage
  const fileName = `${certificateNumber}-${uuidv4()}.pdf`;
  const storagePath = `users/${userId}/certificates/${fileName}`;
  
  await supabase.storage
    .from('certificates')
    .upload(storagePath, pdfBuffer, {
      contentType: 'application/pdf',
      cacheControl: '3600',
    });
  
  // –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É
  const { data: urlData } = supabase.storage
    .from('certificates')
    .getPublicUrl(storagePath);
  
  const certificateUrl = urlData?.publicUrl;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
  await supabase
    .from('tripwire_certificates')
    .insert({
      user_id: userId,
      certificate_number: certificateNumber,
      full_name: studentName,
      pdf_url: certificateUrl,  // ‚úÖ URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
      issued_at: new Date().toISOString(),
      metadata: { storage_path: storagePath },
    });
  
  return newCert;
}
```

### Frontend: `CertificateSection.tsx`

```typescript
const handleGeneratePDF = async () => {
  setIsGenerating(true);
  setGenerationStep('–°–æ–∑–¥–∞–µ–º –≤–∞—à —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç...');
  
  // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è UI
  await new Promise(resolve => setTimeout(resolve, 1000));
  setGenerationStep('–ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –≤–∞—à —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç...');
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  // –í—ã–∑—ã–≤–∞–µ–º API –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  await onGenerateCertificate();  // –í—ã–∑—ã–≤–∞–µ—Ç POST /api/tripwire/certificates/issue
  
  setIsGenerating(false);
};

const handleDownload = () => {
  if (certificate?.pdf_url) {
    // –°–∫–∞—á–∏–≤–∞–µ–º PDF –Ω–∞–ø—Ä—è–º—É—é
    const link = document.createElement('a');
    link.href = certificate.pdf_url;
    link.download = `Certificate-${profile.full_name}.pdf`;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } else {
    // ‚ùå –ü–†–û–ë–õ–ï–ú–ê –ó–î–ï–°–¨: –§–æ–ª–ª–±—ç–∫ - —Ä–µ–¥–∏—Ä–µ–∫—Ç!
    window.open(`/tripwire/certificate/${certificateNumber}`, '_blank');
  }
};
```

### API Client: `apiClient.ts`

```typescript
export const apiClient = {
  async post(endpoint: string, body: any) {
    const response = await fetch(`${API_URL}${endpoint}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,  // JWT token
      },
      body: JSON.stringify(body),
    });
    return response.json();
  }
};
```

---

## üéØ –ó–ê–î–ê–ß–ê

–ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:

### 1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É 406 –≤ Supabase**
- –ü–æ—á–µ–º—É –∑–∞–ø—Ä–æ—Å—ã –∫ `tripwire_certificates` –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 406?
- –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Supabase –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—Ü–µ–π?
- –ù—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏?

### 2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä**
- –ö–∞–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF –Ω–∞ –±—ç–∫–µ–Ω–¥–µ?
- –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WebSocket / Server-Sent Events / Long Polling?
- –ò–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞–∑–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ —ç—Ç–∞–ø—ã –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å UI?

### 3. **–£–±—Ä–∞—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç, –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä—è–º–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ**
- PDF –¥–æ–ª–∂–µ–Ω —Å–∫–∞—á–∏–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ `certificate.pdf_url` (–ø—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –∏–∑ Supabase Storage)
- –ï—Å–ª–∏ `pdf_url` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫—É, –∞ –Ω–µ –¥–µ–ª–∞—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç

### 4. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è**
–ü—Ä–µ–¥–ª–æ–∂–∏—Ç–µ 2-3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ä–µ—à–µ–Ω–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º:
- –ü–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
- –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (1-10)
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –Ω–∞—à–∏–º —Å—Ç–µ–∫–æ–º (Next.js + Express + Supabase)

---

## üõ† –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –°–¢–ï–ö

- **Frontend**: Next.js 14, React 18, TypeScript, TailwindCSS
- **Backend**: Express.js, TypeScript, Node.js
- **Database**: Supabase (PostgreSQL)
- **Storage**: Supabase Storage (S3-compatible)
- **PDF Generation**: PDFKit (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥)
- **Auth**: Supabase Auth (JWT tokens)

---

## ‚úÖ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

1. ‚úÖ –ó–∞–ø—Ä–æ—Å—ã –∫ `tripwire_certificates` —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –æ—à–∏–±–∫–∏ 406
2. ‚úÖ PDF —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Supabase Storage (`certificates` bucket)
3. ‚úÖ –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç":
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ (0-100%)
   - –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç—Ä–∞–∂–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
   - –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "–°–∫–∞—á–∞—Ç—å"
4. ‚úÖ –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–°–∫–∞—á–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç":
   - –§–∞–π–ª —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ Supabase Storage
   - –ù–∏–∫–∞–∫–∏—Ö —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤ –Ω–∞ –¥—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
   - –ò–º—è —Ñ–∞–π–ª–∞: `Certificate-–ò–ú–Ø-–§–ê–ú–ò–õ–ò–Ø.pdf`

---

## üîç –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –í–û–ü–†–û–°–´

1. –ö–∞–∫ –ª—É—á—à–µ –≤—Å–µ–≥–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ?
2. –ù—É–∂–Ω–æ –ª–∏ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑ –∑–∞–Ω–æ–≤–æ?
3. –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é, –∫–æ–≥–¥–∞ Storage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω?
4. –°—Ç–æ–∏—Ç –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å fallback –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ blob URL –µ—Å–ª–∏ –ø—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?

---

**–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∫–æ–¥–∞ –¥–ª—è Production-–æ–∫—Ä—É–∂–µ–Ω–∏—è.**
