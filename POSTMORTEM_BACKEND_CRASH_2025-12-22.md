# üö® POSTMORTEM: Backend API Crash - 22 –¥–µ–∫–∞–±—Ä—è 2025

**–°—Ç–∞—Ç—É—Å:** RESOLVED  
**Incident Start:** ~08:00 UTC (Almaty morning)  
**Incident End:** 10:52 UTC  
**Duration:** ~2-3 —á–∞—Å–∞  
**Severity:** CRITICAL (P0)

---

## üìã EXECUTIVE SUMMARY

Backend API –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (207.154.231.30) –Ω–∞—Ö–æ–¥–∏–ª—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ **crash loop** —Å 106 –Ω–µ—É–¥–∞—á–Ω—ã–º–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–∞–º–∏ PM2. –°–µ—Ä–≤–∏—Å –±—ã–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**Root Cause:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç –º–µ–∂–¥—É —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–∞–ø–∫–æ–π `dist/` (CommonJS) –∏ TypeScript –∏—Å—Ö–æ–¥–Ω–∏–∫–∞–º–∏ (ESM), –≤—ã–∑—ã–≤–∞—é—â–∏–π `SyntaxError: Identifier '__dirname' has already been declared`.

**Impact:**
- ‚ùå Backend API –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- ‚ùå Tripwire Sales Manager –Ω–µ —Ä–∞–±–æ—Ç–∞–ª
- ‚ùå Traffic Dashboard –Ω–µ —Ä–∞–±–æ—Ç–∞–ª
- ‚ùå Webhook endpoints –Ω–µ –æ—Ç–≤–µ—á–∞–ª–∏
- ‚ùå ~2-3 —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üîç TIMELINE (UTC+5 Almaty Time)

| Time | Event |
|------|-------|
| ~**08:00** | Backend –Ω–∞—á–∞–ª –ø–∞–¥–∞—Ç—å –ø–æ—Å–ª–µ –æ—á–µ—Ä–µ–¥–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |
| ~**08:00-13:00** | PM2 –ø—ã—Ç–∞–ª—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend 106 —Ä–∞–∑ (crash loop) |
| **13:52** | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–∞—Ä—É–∂–∏–ª –ø—Ä–æ–±–ª–µ–º—É –∏ —Å–æ–æ–±—â–∏–ª –æ –∫—Ä–∞—à–∞—Ö |
| **13:53** | –ù–∞—á–∞—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ - –æ–±–Ω–∞—Ä—É–∂–µ–Ω —Å—Ç–∞—Ç—É—Å "errored" |
| **13:54** | –ù–∞–π–¥–µ–Ω–∞ –æ—à–∏–±–∫–∞: `SyntaxError: __dirname already declared` |
| **13:55** | –û–±–Ω–∞—Ä—É–∂–µ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å –ø–∞–ø–∫–æ–π `dist/` |
| **13:56** | PM2 –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø–∞–ø–∫–∞ `dist/` —É–¥–∞–ª–µ–Ω–∞ |
| **13:57** | Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ `tsx src/server.ts` |
| **13:58** | ‚úÖ Backend –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, —Å—Ç–∞—Ç—É—Å: online |

**Total Resolution Time:** 6 –º–∏–Ω—É—Ç (–ø–æ—Å–ª–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è)

---

## üïµÔ∏è ROOT CAUSE ANALYSIS

### –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?

1. **–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:**
   - –î–æ 21 –¥–µ–∫–∞–±—Ä—è backend –¥–µ–ø–ª–æ–∏–ª—Å—è —á–µ—Ä–µ–∑ **compiled code** (`npm run build` ‚Üí `dist/server.js`)
   - –í –∫–∞–∫–æ–π-—Ç–æ –º–æ–º–µ–Ω—Ç –±—ã–ª–æ —Ä–µ—à–µ–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ **direct TypeScript execution** (`tsx src/server.ts`)

2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π:**
   - `ecosystem.config.js` –±—ã–ª **–û–ë–ù–û–í–õ–ï–ù** 21 –¥–µ–∫–∞–±—Ä—è 13:34:
     ```js
     script: 'tsx',
     args: 'src/server.ts'  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!
     ```
   - –ù–û –ø–∞–ø–∫–∞ `dist/` **–û–°–¢–ê–õ–ê–°–¨** –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –¥–µ–ø–ª–æ–µ–≤

3. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:**
   - Node.js –∑–∞–≥—Ä—É–∂–∞–ª –º–æ–¥—É–ª–∏ –∫–∞–∫ –∏–∑ `src/`, —Ç–∞–∫ –∏ –∏–∑ `dist/`
   - –í `dist/server.js` (line 51) –±—ã–ª–∞ —Å—Ç—Ä–æ–∫–∞:
     ```js
     const __dirname = __filename ? path.dirname(__filename) : process.cwd();
     ```
   - –ù–æ `__dirname` –£–ñ–ï —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª –≤ CommonJS –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: `SyntaxError: Identifier '__dirname' has already been declared`

4. **PM2 Crash Loop:**
   - PM2 –ø—ã—Ç–∞–ª—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å backend
   - Backend –ø–∞–¥–∞–ª —á–µ—Ä–µ–∑ 1-2 —Å–µ–∫—É–Ω–¥—ã
   - PM2 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª (106 —Ä–∞–∑!)
   - –°–∏—Å—Ç–µ–º–∞ –ù–ï –†–ê–ë–û–¢–ê–õ–ê, –Ω–æ PM2 –¥—É–º–∞–ª —á—Ç–æ "–ø—ã—Ç–∞–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"

### Bash History (–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞):

```bash
# –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± –¥–µ–ø–ª–æ—è (—Å–æ–∑–¥–∞–≤–∞–ª dist/):
npm run build
pm2 start dist/server.js --name onai-backend

# –≠—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –±—ã–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –†–ê–ù–¨–®–ï –∏ —Å–æ–∑–¥–∞–ª–∏ dist/
cd /var/www/onai-integrator-login-main/backend && npm run build && pm2 restart all
```

### Deploy Scripts (–∫–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã):

**`deploy-backend-final.sh`** (—Å—Ç—Ä–æ–∫–∏ 54-63):
```bash
echo "–®–ê–ì 4: –°–ë–û–†–ö–ê TYPESCRIPT (npm run build)"
npm run build  # ‚ùå –°–û–ó–î–ê–Å–¢ dist/
```

**`scripts/deploy-backend.sh`** (—Å—Ç—Ä–æ–∫–∏ 38-43):
```bash
echo "2Ô∏è‚É£  Building backend..."
npm run build || {  # ‚ùå –°–û–ó–î–ê–Å–¢ dist/
    echo "‚ö†Ô∏è  Build completed with warnings"
}
```

---

## üõ°Ô∏è –û–¢ –ß–ï–ì–û –ú–´ –ù–ï –ë–´–õ–ò –ó–ê–©–ò–©–ï–ù–´?

### 1. ‚ùå **–ù–µ—Ç Health Check Monitoring**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- Backend –ø–∞–¥–∞–ª 106 —Ä–∞–∑, –Ω–æ –ù–ò –û–î–ò–ù –ê–õ–ï–†–¢ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
- –ù–∏–∫—Ç–æ –Ω–µ –∑–Ω–∞–ª –æ –ø—Ä–æ–±–ª–µ–º–µ –ø–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–∂–∞–ª–æ–≤–∞–ª—Å—è

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- ~2-3 —á–∞—Å–∞ –ø—Ä–æ—Å—Ç–æ—è –æ—Å—Ç–∞–ª–∏—Å—å –Ω–µ–∑–∞–º–µ—á–µ–Ω–Ω—ã–º–∏
- –ü–æ—Ç–µ—Ä—è —Ä–µ–ø—É—Ç–∞—Ü–∏–∏, –ø–æ—Ç–µ—Ä—è –∫–ª–∏–µ–Ω—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å **UptimeRobot** –∏–ª–∏ **Better Uptime**
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ `/health` –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
- [ ] Telegram –∞–ª–µ—Ä—Ç—ã –≤ admin –≥—Ä—É–ø–ø—É
- [ ] SMS –∞–ª–µ—Ä—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

---

### 2. ‚ùå **PM2 –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω**
**–ü—Ä–æ–±–ª–µ–º–∞:**
```js
max_restarts: 15,  // ‚ùå –°–õ–ò–®–ö–û–ú –ú–ù–û–ì–û!
```
- PM2 –ø—ã—Ç–∞–ª—Å—è —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ç—å 106 —Ä–∞–∑ (–ø—Ä–µ–≤—ã—Å–∏–ª –ª–∏–º–∏—Ç)
- –ù–û –ø—Ä–æ–¥–æ–ª–∂–∞–ª –∫—Ä–∞—à–∏—Ç—å—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑
- –≠—Ç–æ –º–∞—Å–∫–∏—Ä–æ–≤–∞–ª–æ –ø—Ä–æ–±–ª–µ–º—É –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –ê–õ–ï–†–¢–ò–¢–¨

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –°–∏—Å—Ç–µ–º–∞ "–¥—É–º–∞–ª–∞" —á—Ç–æ –≤—Å—ë –û–ö (PM2 —Å—Ç–∞—Ä–∞–µ—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å)
- –†–µ–∞–ª—å–Ω–æ: backend –ù–ï –†–ê–ë–û–¢–ê–õ –≤–æ–æ–±—â–µ

**–†–µ—à–µ–Ω–∏–µ:**
```js
max_restarts: 3,  // ‚úÖ –ü–æ—Å–ª–µ 3 –Ω–µ—É–¥–∞—á - STOP
min_uptime: '10s', // ‚úÖ –ú–∏–Ω–∏–º—É–º 10 —Å–µ–∫—É–Ω–¥ —Ä–∞–±–æ—Ç—ã
```
- [ ] –ï—Å–ª–∏ 3 –∫—Ä–∞—à–∞ –ø–æ–¥—Ä—è–¥ ‚Üí **STOP** –∏ **ALERT**
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è PM2 ‚Üí Telegram webhook

---

### 3. ‚ùå **–î–µ–ø–ª–æ–π —Å–∫—Ä–∏–ø—Ç—ã —É—Å—Ç–∞—Ä–µ–ª–∏**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- `deploy-backend-final.sh` –¥–µ–ª–∞–µ—Ç `npm run build` ‚Üí —Å–æ–∑–¥–∞—ë—Ç `dist/`
- `deploy-production.sh` –∫–æ–ø–∏—Ä—É–µ—Ç `dist/` –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- –ù–û `ecosystem.config.js` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `tsx src/server.ts`

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –î—Ä–∏—Ñ—Ç –º–µ–∂–¥—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –∏ –¥–µ–ø–ª–æ–µ–º
- –ù–∏–∫—Ç–æ –Ω–µ –∑–∞–º–µ—Ç–∏–ª —á—Ç–æ –¥–µ–ø–ª–æ–π —Å–æ–∑–¥–∞—ë—Ç –Ω–µ–Ω—É–∂–Ω—É—é –ø–∞–ø–∫—É

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –í–°–ï deploy —Å–∫—Ä–∏–ø—Ç—ã:
  ```bash
  # –£–î–ê–õ–ò–¢–¨ npm run build
  # –£–î–ê–õ–ò–¢–¨ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ dist/
  ```
- [ ] –î–æ–±–∞–≤–∏—Ç—å **pre-deploy validation**:
  ```bash
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
  if [ -d "dist/" ]; then
    echo "‚ùå ERROR: dist/ should not exist!"
    exit 1
  fi
  ```

---

### 4. ‚ùå **–ù–µ—Ç Smoke Tests –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- Deploy —Å–∫—Ä–∏–ø—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç PM2 status (`online`)
- –ù–û –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–µ–∞–ª—å–Ω—É—é —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å API

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –î–µ–ø–ª–æ–π —Å—á–∏—Ç–∞–µ—Ç—Å—è "—É—Å–ø–µ—à–Ω—ã–º" –¥–∞–∂–µ –µ—Å–ª–∏ backend –ø–∞–¥–∞–µ—Ç —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å smoke tests:
  ```bash
  # –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
  sleep 10
  curl -f http://localhost:3000/health || {
    echo "‚ùå Health check failed!"
    # Rollback
    exit 1
  }
  ```

---

### 5. ‚ùå **–ù–µ—Ç Rollback Mechanism**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –î–µ–ø–ª–æ–π –ø—Ä–æ—à—ë–ª
- Backend –Ω–∞—á–∞–ª –∫—Ä–∞—à–∏—Ç—å—Å—è
- –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –±—ã—Å—Ç—Ä–æ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å "–Ω–∞ –≥–æ—Ä—è—á—É—é"
- –†–∏—Å–∫ —É—Å—É–≥—É–±–∏—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] Blue-Green Deployment:
  ```
  /var/www/backend-v1/  (—Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è)
  /var/www/backend-v2/  (–Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è)
  ```
- [ ] Symlink –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ:
  ```bash
  ln -sfn /var/www/backend-v2 /var/www/backend
  pm2 restart onai-backend
  ```
- [ ] Rollback –∑–∞ 10 —Å–µ–∫—É–Ω–¥:
  ```bash
  ln -sfn /var/www/backend-v1 /var/www/backend
  pm2 restart onai-backend
  ```

---

### 6. ‚ùå **–ù–µ—Ç Structured Logging & Alerting**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- PM2 –ª–æ–≥–∏ –µ—Å—Ç—å, –Ω–æ –Ω–∏–∫—Ç–æ –∏—Ö –Ω–µ —á–∏—Ç–∞–µ—Ç
- –û—à–∏–±–∫–∏ —Ç–µ—Ä—è—é—Ç—Å—è –≤ —Ç—ã—Å—è—á–∞—Ö —Å—Ç—Ä–æ–∫
- –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∞–ª–µ—Ä—Ç–æ–≤ –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- `SyntaxError` –ª–æ–≥–∏—Ä–æ–≤–∞–ª—Å—è 106 —Ä–∞–∑
- –ù–û –Ω–∏–∫—Ç–æ –Ω–µ —É–≤–∏–¥–µ–ª

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å **Sentry** (—É–∂–µ –µ—Å—Ç—å –≤ –∫–æ–¥–µ, –Ω–æ DISABLED):
  ```env
  SENTRY_ENABLED=true
  ```
- [ ] –õ–æ–≥–∏ –≤ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É (Loki, CloudWatch)
- [ ] –ê–ª–µ—Ä—Ç—ã –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:
  - `SyntaxError` ‚Üí CRITICAL
  - `ECONNREFUSED` ‚Üí WARNING
  - Restart > 3 —Ä–∞–∑ ‚Üí CRITICAL

---

### 7. ‚ùå **–ù–µ—Ç CI/CD Pipeline —Å Validation**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –î–µ–ø–ª–æ–π –¥–µ–ª–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SSH
- –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
- –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- Human error - –ª–µ–≥–∫–æ —á—Ç–æ-—Ç–æ –∑–∞–±—ã—Ç—å
- –°–ª–æ–º–∞—Ç—å production

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] GitHub Actions CI/CD:
  ```yaml
  jobs:
    test:
      - npm install
      - npm run lint
      - npm run test
    deploy:
      needs: test  # ‚úÖ –î–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏
      - ssh deploy
      - smoke tests
      - rollback on failure
  ```

---

### 8. ‚ùå **–ù–µ—Ç Pre-Deployment Checklist**
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –î–µ–ø–ª–æ–π –¥–µ–ª–∞–µ—Ç—Å—è "–Ω–∞ –ª–µ—Ç—É"
- –ù–µ—Ç —á–µ–∫-–ª–∏—Å—Ç–∞ —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ó–∞–±—ã–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `dist/` –Ω–µ –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å

**–†–µ—à–µ–Ω–∏–µ:**
```markdown
## Pre-Deployment Checklist

- [ ] –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] Backend –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ
- [ ] .gitignore –∞–∫—Ç—É–∞–ª–µ–Ω (dist/ –≤ ignore)
- [ ] ecosystem.config.js —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å deploy —Å–∫—Ä–∏–ø—Ç–æ–º
- [ ] ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã
- [ ] PM2 –∫–æ–Ω—Ñ–∏–≥ –ø—Ä–æ–≤–µ—Ä–µ–Ω
- [ ] Smoke tests –≥–æ—Ç–æ–≤—ã
- [ ] Rollback –ø–ª–∞–Ω –≥–æ—Ç–æ–≤
- [ ] Monitoring –Ω–∞—Å—Ç—Ä–æ–µ–Ω
```

---

## üîß IMMEDIATE FIXES (DONE)

‚úÖ **1. Backend –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω**
```bash
pm2 stop onai-backend && pm2 delete onai-backend
rm -rf dist/ dist.tar.gz
pm2 start ecosystem.config.js --env production
```

‚úÖ **2. –ü—Ä–æ–≤–µ—Ä–µ–Ω —Å—Ç–∞—Ç—É—Å**
- Status: online ‚úÖ
- Restarts: 0 ‚úÖ
- Uptime: 100+ —Å–µ–∫—É–Ω–¥ ‚úÖ
- Health endpoint: HTTP 200 ‚úÖ

---

## üìù ACTION ITEMS (TODO)

### üî• P0 - CRITICAL (–°–¥–µ–ª–∞—Ç—å –°–ï–ì–û–î–ù–Ø)

- [ ] **Health Check Monitoring**
  - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å UptimeRobot
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
  - –ê–ª–µ—Ä—Ç—ã –≤ Telegram + SMS

- [ ] **–ò—Å–ø—Ä–∞–≤–∏—Ç—å PM2 –∫–æ–Ω—Ñ–∏–≥**
  ```js
  max_restarts: 3,  // –≤–º–µ—Å—Ç–æ 15
  min_uptime: '10s',
  ```

- [ ] **–í–∫–ª—é—á–∏—Ç—å Sentry**
  ```env
  SENTRY_ENABLED=true
  ```

### ‚ö†Ô∏è P1 - HIGH (–°–¥–µ–ª–∞—Ç—å —ç—Ç—É –Ω–µ–¥–µ–ª—é)

- [ ] **–û–±–Ω–æ–≤–∏—Ç—å deploy —Å–∫—Ä–∏–ø—Ç—ã**
  - –£–¥–∞–ª–∏—Ç—å `npm run build` –∏–∑ –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
  - –î–æ–±–∞–≤–∏—Ç—å validation —á—Ç–æ `dist/` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

- [ ] **–î–æ–±–∞–≤–∏—Ç—å smoke tests**
  - Health check –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
  - Rollback on failure

- [ ] **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Structured Logging**
  - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
  - Alert patterns

### üìä P2 - MEDIUM (–°–ª–µ–¥—É—é—â–∏–µ 2 –Ω–µ–¥–µ–ª–∏)

- [ ] **Rollback Mechanism**
  - Blue-Green Deployment
  - Symlink switching

- [ ] **CI/CD Pipeline**
  - GitHub Actions
  - Automated tests
  - Automated deployment

- [ ] **Pre-Deployment Checklist**
  - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
  - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

---

## üí° LESSONS LEARNED

### ‚úÖ –ß—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–ª–æ –•–û–†–û–®–û:
1. **–ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** - –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞ –∑–∞ 2 –º–∏–Ω—É—Ç—ã
2. **–ü—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ** - —É–¥–∞–ª–∏—Ç—å `dist/` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
3. **ecosystem.config.js –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π** - –ø—Ä–æ—Å—Ç–æ –º–µ—à–∞–ª–∞ —Å—Ç–∞—Ä–∞—è –ø–∞–ø–∫–∞

### ‚ùå –ß—Ç–æ –ù–ï —Å—Ä–∞–±–æ—Ç–∞–ª–æ:
1. **–ù–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞** - –ø–∞–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–ª–æ—Å—å –Ω–µ–∑–∞–º–µ—á–µ–Ω–Ω—ã–º
2. **PM2 –º–∞—Å–∫–∏—Ä–æ–≤–∞–ª –ø—Ä–æ–±–ª–µ–º—É** - –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Ä–µ—Å—Ç–∞—Ä—Ç—ã –≤–º–µ—Å—Ç–æ –∞–ª–µ—Ä—Ç–∞
3. **Deploy —Å–∫—Ä–∏–ø—Ç—ã —É—Å—Ç–∞—Ä–µ–ª–∏** - –¥—Ä–∏—Ñ—Ç —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
4. **–ù–µ—Ç rollback** - –ø—Ä–∏—à–ª–æ—Å—å —á–∏–Ω–∏—Ç—å "–Ω–∞ –≥–æ—Ä—è—á—É—é"

### üéì –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ò–ù–ê–ß–ï:
1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù** - —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å "—Å–ª–µ–ø–æ–π"
2. **Fail fast** - –ª—É—á—à–µ —É–ø–∞—Å—Ç—å —Å—Ä–∞–∑—É —á–µ–º –∫—Ä–∞—à–∏—Ç—å—Å—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–µ–ø–ª–æ—è** - smoke tests –¥–æ–ª–∂–Ω—ã –ª–æ–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞** - deploy —Å–∫—Ä–∏–ø—Ç—ã = source of truth

---

## üìà METRICS

**MTTR (Mean Time To Recovery):** 6 –º–∏–Ω—É—Ç (–ø–æ—Å–ª–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è)  
**MTTD (Mean Time To Detect):** ~2-3 —á–∞—Å–∞ ‚ùå (–ù–ï–î–û–ü–£–°–¢–ò–ú–û!)  
**Impact:** 100% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
**Severity:** P0 - Critical  

**Target:**
- MTTD < 5 –º–∏–Ω—É—Ç (—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º)
- MTTR < 10 –º–∏–Ω—É—Ç (—Å rollback)

---

## üîê SECURITY NOTES

–ò–Ω—Ü–∏–¥–µ–Ω—Ç –Ω–µ —Å–≤—è–∑–∞–Ω —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é.  
–ù–∏–∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –±—ã–ª–∏ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω—ã.

---

## üë• INCIDENT RESPONSE TEAM

- **Reporter:** User (Miso)
- **Incident Commander:** AI Assistant
- **Resolution:** AI Assistant
- **Review:** Pending

---

## üìö REFERENCES

- PM2 Logs: `/var/www/onai-integrator-login-main/backend/logs/pm2-error.log`
- Bash History: Root user bash history
- Deploy Scripts:
  - `deploy-backend-final.sh`
  - `scripts/deploy-backend.sh`
  - `deploy-production.sh`

---

**Document Status:** DRAFT  
**Last Updated:** 2025-12-22 16:00 UTC+5  
**Reviewers:** Pending  
**Approval:** Pending  

---

## ‚è≠Ô∏è NEXT STEPS

1. ‚úÖ Review —ç—Ç–æ–≥–æ postmortem —Å –∫–æ–º–∞–Ω–¥–æ–π
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å GitHub Issues –¥–ª—è –≤—Å–µ—Ö ACTION ITEMS
3. ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å P0 items
4. ‚úÖ Schedule follow-up —á–µ—Ä–µ–∑ 1 –Ω–µ–¥–µ–ª—é
5. ‚úÖ Update runbooks –∏ documentation

**–ë—É–¥—É—â–∏–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã –º–æ–∂–Ω–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å!** üõ°Ô∏è
