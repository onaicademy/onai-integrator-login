# üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ –ø—Ä–æ–¥–∞–∫—à–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ Traffic Dashboard

**–î–∞—Ç–∞:** 27 –¥–µ–∫–∞–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–û

---

## üìã –†–µ–∑—é–º–µ

Traffic Dashboard —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω. –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. Traffic Dashboard Endpoints

#### ‚úÖ GET /api/traffic-dashboard/leads/total
**–°—Ç–∞—Ç—É—Å:** WORKING  
**–û–ø–∏—Å–∞–Ω–∏–µ:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ª–∏–¥–∞–º  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "data": {
    "total": 20,
    "express": 10,
    "flagship": 10,
    "new": 0,
    "in_progress": 0,
    "qualified": 0,
    "proposal": 0,
    "negotiation": 0,
    "success": 20
  }
}
```

#### ‚úÖ GET /api/traffic-dashboard/leads/by-funnel
**–°—Ç–∞—Ç—É—Å:** WORKING  
**–û–ø–∏—Å–∞–Ω–∏–µ:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–∏–¥—ã, —Ä–∞–∑–±–∏—Ç—ã–µ –ø–æ –≤–æ—Ä–æ–Ω–∫–∞–º  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 10 –ª–∏–¥–æ–≤ Express Course –∏ 10 –ª–∏–¥–æ–≤ Flagship Course

#### ‚úÖ GET /api/traffic-dashboard/sales/total
**–°—Ç–∞—Ç—É—Å:** WORKING  
**–û–ø–∏—Å–∞–Ω–∏–µ:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "data": {
    "total_sales": 20,
    "total_revenue": 4950000,
    "express_sales": 10,
    "express_revenue": 50000,
    "flagship_sales": 10,
    "flagship_revenue": 4900000,
    "sales_with_utm": 18,
    "sales_without_utm": 2
  }
}
```

---

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

#### ‚úÖ POST /api/admin/integrations/diagnostics
**–°—Ç–∞—Ç—É—Å:** WORKING  
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –≤—Å–µ—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "data": {
    "overall_status": "error",
    "diagnostics": [
      {
        "name": "Express Course Webhook",
        "status": "ok",
        "message": "Webhook working: 10 sales found"
      },
      {
        "name": "Flagship Course Webhook",
        "status": "ok",
        "message": "Webhook working: 10 sales found"
      },
      {
        "name": "Landing BD Sync",
        "status": "ok",
        "message": "Sync working: 10 leads, 10 synced"
      },
      {
        "name": "Express Course Sales",
        "status": "ok",
        "message": "10 sales found"
      },
      {
        "name": "Flagship Course Sales",
        "status": "ok",
        "message": "10 sales found"
      },
      {
        "name": "All Sales Tracking",
        "status": "error",
        "message": "Database error: Invalid API key"
      }
    ],
    "summary": {
      "total": 6,
      "ok": 5,
      "warning": 0,
      "error": 1
    }
  }
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –û—à–∏–±–∫–∞ —Å "All Sales Tracking" –æ–∂–∏–¥–∞–µ–º–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è placeholder API –∫–ª—é—á –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π Supabase –ë–î.

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚ùå ‚Üí ‚úÖ AmoCRM Domain Configuration
**–ü—Ä–æ–±–ª–µ–º–∞:** `amocrm-leads-fetcher.ts` –∏–º–µ–ª —Ö–∞—Ä–¥–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–æ–º–µ–Ω  
**–†–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `AMOCRM_DOMAIN` –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Traffic Dashboard —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### 2. ‚ùå ‚Üí ‚úÖ Integrations Diagnostics Route
**–ü—Ä–æ–±–ª–µ–º–∞:** –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–ª 404  
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø—É—Ç—å –º–∞—Ä—à—Ä—É—Ç–∞ —Å `/diagnostics` –Ω–∞ `/`  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç

### 3. ‚ùå ‚Üí ‚úÖ Integrations Diagnostics File
**–ü—Ä–æ–±–ª–µ–º–∞:** –§–∞–π–ª –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏–º–µ–ª —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (–Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ JSDoc –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏)  
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã JSDoc –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§–∞–π–ª –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

---

## üìä –°—Ç–∞—Ç—É—Å –±—ç–∫–µ–Ω–¥–∞

### PM2 Status
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ id ‚îÇ name            ‚îÇ status  ‚îÇ pid    ‚îÇ uptime   ‚îÇ mem    ‚îÇ cpu   ‚îÇ restarts  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 0  ‚îÇ onai-backend    ‚îÇ online  ‚îÇ 488284 ‚îÇ 3s      ‚îÇ 61.5mb ‚îÇ 0%    ‚îÇ 68        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Backend URL
- **URL:** https://onai.academy
- **Port:** 3000
- **Server:** DigitalOcean droplet (207.154.231.30)

---

## üîë API Keys (Verified)

### Traffic Dashboard Supabase
- **URL:** https://oetodaexnjcunklkdlkv.supabase.co
- **Anon Key:** ‚úÖ Valid
- **Service Key:** ‚úÖ Valid

### Tripwire Supabase
- **URL:** https://pjmvxecykysfrzppdcto.supabase.co
- **Anon Key:** ‚úÖ Valid

### Landing Supabase
- **URL:** https://xikaiavwqinamgolmtcy.supabase.co
- **Service Key:** ‚úÖ Valid

### AmoCRM
- **Domain:** onaiagencykz
- **Access Token:** ‚úÖ Valid (expires 2028-07-01)
- **Base URL:** https://onaiagencykz.amocrm.ru/api/v4

---

## üìà –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### Phase 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
1. ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è AmoCRM webhook (Map-based cache —Å 5-–º–∏–Ω—É—Ç–Ω—ã–º TTL)
2. ‚úÖ –ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ —Ç–∞—Ä–≥–µ—Ç–æ–ª–æ–≥–æ–≤ (`targetologist-mapper.ts`)
3. ‚úÖ Circuit Breaker –∏ Retry Logic –¥–ª—è Facebook API
4. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Circuit Breaker –≤ Facebook Ads API

### Phase 2: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
5. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã (Tripwire BD, ProofTest)
6. ‚úÖ Middleware –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (Zod)
7. ‚úÖ Centralized error handler
8. ‚úÖ AmoCRM Leads Fetcher —Å–µ—Ä–≤–∏—Å
9. ‚úÖ Traffic Dashboard —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
10. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

---

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. Redis Connection (Local Only)
**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–∫–∞–ª—å–Ω—ã–π –±—ç–∫–µ–Ω–¥ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Redis  
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ - —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏  
**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç—å Redis –ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –≤ .env

### 2. All Sales Tracking Error
**–ü—Ä–æ–±–ª–µ–º–∞:** "All Sales Tracking" –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç "Invalid API key"  
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è placeholder –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π Supabase –ë–î  
**–†–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç—å `SUPABASE_URL` –∏ `SUPABASE_SERVICE_ROLE_KEY` –≤ .env

### 3. Facebook Token Health
**–ü—Ä–æ–±–ª–µ–º–∞:** Facebook —Ç–æ–∫–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ  
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ - —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω (54 –¥–Ω—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è)  
**–†–µ—à–µ–Ω–∏–µ:** –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ

### 4. OpenAI API Key
**–ü—Ä–æ–±–ª–µ–º–∞:** OpenAI API key –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫ invalid  
**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è placeholder  
**–†–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç—å `OPENAI_API_KEY` –≤ .env

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

Traffic Dashboard —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è.

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- Traffic Dashboard API (–ª–∏–¥—ã, –ø—Ä–æ–¥–∞–∂–∏, –≤–æ—Ä–æ–Ω–∫–∏)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
- AmoCRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (Express Course, Flagship Course)
- Landing BD —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- Webhooks –¥–ª—è –ø—Ä–æ–¥–∞–∂

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è:
- –û–±–Ω–æ–≤–∏—Ç—å API –∫–ª—é—á–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π Supabase –ë–î (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
- –ó–∞–ø—É—Å—Ç–∏—Ç—å Redis –ª–æ–∫–∞–ª—å–Ω–æ (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –±—ç–∫–µ–Ω–¥–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤
2. **API Keys:** –û–±–Ω–æ–≤–∏—Ç—å placeholder –∫–ª—é—á–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
3. **Redis:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Redis –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é —Å —É—á–µ—Ç–æ–º –Ω–æ–≤—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª:** Kilo Code  
**–î–∞—Ç–∞:** 27 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0.0
