<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Subtitles - Lesson 29</title>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0a0a0a;
      color: white;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #00FF88;
      margin-bottom: 30px;
    }
    .video-container {
      max-width: 800px;
      margin: 0 auto 30px;
    }
    .info {
      background: rgba(0, 255, 136, 0.1);
      border: 1px solid #00FF88;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .info h3 {
      margin-top: 0;
      color: #00FF88;
    }
    .success {
      color: #00FF88;
    }
    .error {
      color: #ff4444;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé¨ Test: Groq Whisper Subtitles</h1>
    
    <div class="info">
      <h3>‚úÖ Transcription Status</h3>
      <p><strong>Video ID:</strong> 48e82664-1fe9-4a71-9519-ae89b667ab68</p>
      <p><strong>Status:</strong> <span class="success">‚úÖ Completed</span></p>
      <p><strong>Language:</strong> Russian (ru)</p>
      <p><strong>VTT Length:</strong> 18,457 characters</p>
      <p><strong>Generated by:</strong> Groq Whisper large-v3</p>
    </div>

    <div class="video-container">
      <video id="player" controls crossorigin playsinline>
        <source src="https://video.onai.academy/48e82664-1fe9-4a71-9519-ae89b667ab68/playlist.m3u8" type="application/x-mpegURL">
        <track
          kind="captions"
          label="–†—É—Å—Å–∫–∏–π (–∞–≤—Ç–æ)"
          srclang="ru"
          src="subtitles.vtt"
          default>
      </video>
    </div>

    <div class="info">
      <h3>üìä How to Test:</h3>
      <ol>
        <li>–ù–∞–∂–º–∏ Play ‚ñ∂Ô∏è –Ω–∞ –≤–∏–¥–µ–æ</li>
        <li>–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É CC (—Å—É–±—Ç–∏—Ç—Ä—ã) –≤ –ø–ª–µ–µ—Ä–µ</li>
        <li>–í—ã–±–µ—Ä–∏ "–†—É—Å—Å–∫–∏–π (–∞–≤—Ç–æ)"</li>
        <li>–°—É–±—Ç–∏—Ç—Ä—ã –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–∞ –≤–∏–¥–µ–æ!</li>
      </ol>
    </div>
  </div>

  <script>
    // Fetch subtitles from Supabase
    const videoId = '48e82664-1fe9-4a71-9519-ae89b667ab68';
    const supabaseUrl = 'https://arqhkacellqbhjhbebfh.supabase.co';
    
    async function loadSubtitles() {
      try {
        // –≠—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –ë–ï–ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ø—É–±–ª–∏—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞)
        const response = await fetch(`${supabaseUrl}/rest/v1/video_transcriptions?video_id=eq.${videoId}&status=eq.completed&order=created_at.desc&limit=1`, {
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFycWhrYWNlbGxxYmhqaGJlYmZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA0NzI3ODksImV4cCI6MjA0NjA0ODc4OX0.8rn8T6WpTnkRDlUYFR9BZCq8sOvl_S84hCvPeZm4dFI',
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data && data.length > 0 && data[0].transcript_vtt) {
          const vttContent = data[0].transcript_vtt;
          
          // Create Blob URL for VTT
          const blob = new Blob([vttContent], { type: 'text/vtt' });
          const vttUrl = URL.createObjectURL(blob);
          
          // Get track element and update src
          const track = document.querySelector('track');
          track.src = vttUrl;
          
          console.log('‚úÖ Subtitles loaded:', vttContent.substring(0, 200));
          
          // Show success message
          document.querySelector('.info:last-child').innerHTML += `
            <p class="success">‚úÖ Subtitles successfully loaded from database!</p>
            <p>First 200 chars: <code style="color: #888;">${vttContent.substring(0, 200)}...</code></p>
          `;
        } else {
          console.error('‚ùå No subtitles found');
        }
      } catch (error) {
        console.error('‚ùå Error loading subtitles:', error);
        document.querySelector('.info:last-child').innerHTML += `
          <p class="error">‚ùå Failed to load subtitles: ${error.message}</p>
        `;
      }
    }

    // Initialize Plyr
    const player = new Plyr('#player', {
      controls: ['play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'fullscreen'],
      settings: ['captions', 'quality', 'speed'],
      captions: {
        active: false,
        language: 'ru',
        update: true
      },
      i18n: {
        restart: '–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å',
        rewind: '–ù–∞–∑–∞–¥',
        play: '–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏',
        pause: '–ü–∞—É–∑–∞',
        fastForward: '–í–ø–µ—Ä–µ–¥',
        seek: '–ü–µ—Ä–µ–º–æ—Ç–∫–∞',
        volume: '–ì—Ä–æ–º–∫–æ—Å—Ç—å',
        mute: '–ë–µ–∑ –∑–≤—É–∫–∞',
        unmute: '–í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫',
        enableCaptions: '–í–∫–ª—é—á–∏—Ç—å —Å—É–±—Ç–∏—Ç—Ä—ã',
        disableCaptions: '–í—ã–∫–ª—é—á–∏—Ç—å —Å—É–±—Ç–∏—Ç—Ä—ã',
        enterFullscreen: '–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω',
        exitFullscreen: '–í—ã–π—Ç–∏',
        captions: '–°—É–±—Ç–∏—Ç—Ä—ã',
        settings: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
        speed: '–°–∫–æ—Ä–æ—Å—Ç—å',
        normal: '–û–±—ã—á–Ω–∞—è',
        quality: '–ö–∞—á–µ—Å—Ç–≤–æ'
      }
    });

    // Initialize HLS
    if (Hls.isSupported()) {
      const hls = new Hls();
      hls.loadSource('https://video.onai.academy/48e82664-1fe9-4a71-9519-ae89b667ab68/playlist.m3u8');
      hls.attachMedia(document.getElementById('player'));
      
      hls.on(Hls.Events.MANIFEST_PARSED, function() {
        console.log('‚úÖ HLS manifest loaded');
      });
    }

    // Load subtitles
    loadSubtitles();
  </script>
</body>
</html>

