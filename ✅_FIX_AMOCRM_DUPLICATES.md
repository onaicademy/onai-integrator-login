# ‚úÖ FIX: AmoCRM Duplicates Issue - COMPLETE SOLUTION

## üîç –ü–†–û–ë–õ–ï–ú–ê (Root Cause Analysis)

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:
–£ –Ω–∞—Å —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å **–¥—É–±–ª–∏–∫–∞—Ç—ã –ª–∏–¥–æ–≤** –≤ AmoCRM –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –∑–∞—è–≤–∫–∏ —Å –ø—É–±–ª–∏—á–Ω—ã—Ö –ª–µ–Ω–¥–∏–Ω–≥–æ–≤ (–ø—Ä–æ—Ñ—Ç–µ—Å—Ç, —ç–∫—Å–ø—Ä–µ—Å—Å-–∫—É—Ä—Å).

### –ü—Ä–∏—á–∏–Ω–∞:
**RACE CONDITION** - –∫–æ–≥–¥–∞ –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```
–í—Ä–µ–º—è  ‚îÇ –ó–∞–ø—Ä–æ—Å 1                    ‚îÇ –ó–∞–ø—Ä–æ—Å 2
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
0ms     ‚îÇ –ò—â–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–∏–¥...   ‚îÇ
100ms   ‚îÇ –ù–µ –Ω–∞—Ö–æ–¥–∏—Ç (–µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω) ‚îÇ –ò—â–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–∏–¥...
200ms   ‚îÇ –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ª–∏–¥ ‚Üí ID 123 ‚îÇ –ù–µ –Ω–∞—Ö–æ–¥–∏—Ç (–µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω)
300ms   ‚îÇ ‚úÖ –ì–æ—Ç–æ–≤–æ                   ‚îÇ –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ª–∏–¥ ‚Üí ID 124
400ms   ‚îÇ                             ‚îÇ ‚úÖ –ì–æ—Ç–æ–≤–æ
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–†–ï–ó–£–õ–¨–¢–ê–¢: –î–í–ê –î–£–ë–õ–ò–ö–ê–¢–ê! üò±
```

### –ö–∞–∫ —ç—Ç–æ –º–æ–≥–ª–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:

1. **–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫** –Ω–∞ –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
2. **–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å** –æ—Ç –±—Ä–∞—É–∑–µ—Ä–∞ –ø—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
3. **Webhook-–∏** —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
4. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry** –æ—Ç frontend –ø—Ä–∏ timeout

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:

#### 1. üîí **Distributed Lock (–ú—å—é—Ç–µ–∫—Å —á–µ—Ä–µ–∑ Redis)**

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `backend/src/lib/amocrmLock.ts` —Å —Ñ—É–Ω–∫—Ü–∏–µ–π `withAmoCrmLock()`:

```typescript
// –¢–µ–ø–µ—Ä—å –ö–ê–ñ–î–û–ï —Å–æ–∑–¥–∞–Ω–∏–µ –ª–∏–¥–∞ –∑–∞—â–∏—â–µ–Ω–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π:
export async function createOrUpdateLead(data) {
  // üîí Acquire lock by email+phone
  return withAmoCrmLock(data.email, data.phone, async () => {
    // ‚úÖ –¢–û–õ–¨–ö–û –û–î–ò–ù –ø—Ä–æ—Ü–µ—Å—Å –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å —ç—Ç–æ—Ç –∫–æ–¥ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
    const existingLead = await findExistingLead(...);
    // ...
  });
}
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ü–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –ª–∏–¥–∞ ‚Üí **–∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É** –ø–æ –∫–ª—é—á—É `amocrm:lead:{email}:{phone}`
- –ï—Å–ª–∏ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí **–∂–¥–µ–º** (max 5 —Å–µ–∫—É–Ω–¥)
- –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è ‚Üí **–æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É**

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–í—Ä–µ–º—è  ‚îÇ –ó–∞–ø—Ä–æ—Å 1                       ‚îÇ –ó–∞–ø—Ä–æ—Å 2
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
0ms     ‚îÇ üîí LOCK acquired               ‚îÇ
100ms   ‚îÇ –ò—â–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–∏–¥...       ‚îÇ ‚è≥ Waiting for lock...
200ms   ‚îÇ –ù–µ –Ω–∞—Ö–æ–¥–∏—Ç                     ‚îÇ ‚è≥ Waiting for lock...
300ms   ‚îÇ –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ª–∏–¥ ‚Üí ID 123    ‚îÇ ‚è≥ Waiting for lock...
400ms   ‚îÇ üîì LOCK released               ‚îÇ
500ms   ‚îÇ ‚úÖ –ì–æ—Ç–æ–≤–æ                       ‚îÇ üîí LOCK acquired
600ms   ‚îÇ                                 ‚îÇ –ò—â–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–∏–¥...
700ms   ‚îÇ                                 ‚îÇ ‚úÖ –ù–ê–•–û–î–ò–¢ ID 123!
800ms   ‚îÇ                                 ‚îÇ –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–∏–¥
900ms   ‚îÇ                                 ‚îÇ üîì LOCK released
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–†–ï–ó–£–õ–¨–¢–ê–¢: –û–î–ò–ù –õ–ò–î! ‚úÖ –ù–∏–∫–∞–∫–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤!
```

#### 2. üìä **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ö–ê–ñ–î–û–ì–û —à–∞–≥–∞:

```
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üöÄ [AmoCRM] Starting lead creation/update
   Email: user@example.com
   Phone: +77771234567
   Name: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤
   Payment: kaspi
   Campaign: proftest_main
   UTM Source: facebook
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîê [LOCK] Attempting to acquire lock for lead
   Request ID: req_1234567890_abc123
   Lock Key: amocrm:lead:user@example.com:77771234567
üîí Lock ACQUIRED

üîç [DEDUP] Starting duplicate check:
   Email: user@example.com
   Phone: +77771234567
   ‚Üí Searching for existing contact...
      ‚Üí AmoCRM API: Searching contact by "user@example.com"...
      ‚úì Contact found: ID 98765 (234ms)
   ‚Üí Searching for leads associated with this contact...
   ‚úÖ Found ACTIVE lead:
      Lead ID: 12345
      Lead Name: –ü—Ä–æ—Ñ—Ç–µ—Å—Ç: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤
      Stage: –ó–ê–Ø–í–ö–ê_–°_–ü–†–û–§–¢–ï–°–¢–ê (ID: 63881318)
      Pipeline: 10350882
      Contact: 98765
üîÑ [DEDUP] Existing ACTIVE lead found (456ms) ‚Üí Will UPDATE existing lead

üîÑ Updating existing lead 12345 ‚Üí –í–´–ë–†–ê–ù_–ú–ï–¢–û–î_–û–ü–õ–ê–¢–´_–ö–ê–°–ü–ò

‚úÖ [LOCK] Lock acquired, executing operation...
‚úÖ [LOCK] Operation completed successfully
üîì Lock RELEASED: amocrm:lead:user@example.com:77771234567
```

–¢–µ–ø–µ—Ä—å –≤ –ª–æ–≥–∞—Ö **–ß–ï–¢–ö–û –í–ò–î–ù–û**:
- ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞—Ö–≤–∞—á–µ–Ω–∞
- ‚úÖ –ü–æ–∏—Å–∫ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
- ‚úÖ –ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–∏–¥ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π
- ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∞

#### 3. üõ†Ô∏è **Admin API –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**

–°–æ–∑–¥–∞–Ω —Ä–æ—É—Ç `backend/src/routes/amocrm-locks-admin.ts` —Å —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏:

**GET /api/admin/amocrm-locks/status**
```json
{
  "success": true,
  "system": {
    "redis_connected": true,
    "redis_available": true,
    "locks_enabled": true,
    "active_locks": 2
  },
  "message": "‚úÖ Lock system operational"
}
```

**GET /api/admin/amocrm-locks**
```json
{
  "success": true,
  "redis": { "connected": true, "available": true },
  "locks": {
    "count": 2,
    "items": [
      {
        "key": "amocrm:lead:user1@example.com:77771234567",
        "ttl_ms": 28500,
        "ttl_seconds": 28,
        "expires_in": "28s"
      },
      {
        "key": "amocrm:lead:user2@example.com:77779876543",
        "ttl_ms": 15200,
        "ttl_seconds": 15,
        "expires_in": "15s"
      }
    ]
  }
}
```

**DELETE /api/admin/amocrm-locks** (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–∞—Å—Ç—Ä—è–ª–∏)
```json
{
  "success": true,
  "message": "Cleared 5 AmoCRM locks",
  "deleted": 5
}
```

#### 4. ‚öôÔ∏è **–í–∫–ª—é—á–µ–Ω Redis**

–û–±–Ω–æ–≤–ª–µ–Ω `backend/env.env`:
```bash
# –ë–´–õ–û:
REDIS_ENABLED=false

# –°–¢–ê–õ–û:
REDIS_ENABLED=true
```

## üìù –§–ê–ô–õ–´ –ö–û–¢–û–†–´–ï –ë–´–õ–ò –ò–ó–ú–ï–ù–ï–ù–´/–°–û–ó–î–ê–ù–´

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- ‚úÖ `backend/src/lib/amocrmLock.ts` - Distributed Lock —Å–∏—Å—Ç–µ–º–∞
- ‚úÖ `backend/src/routes/amocrm-locks-admin.ts` - Admin API –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- ‚úÖ `‚úÖ_FIX_AMOCRM_DUPLICATES.md` - –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- ‚úÖ `backend/src/lib/amocrm.ts` - –î–æ–±–∞–≤–ª–µ–Ω distributed lock + –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ `backend/src/server.ts` - –ü–æ–¥–∫–ª—é—á–µ–Ω –Ω–æ–≤—ã–π admin —Ä–æ—É—Ç
- ‚úÖ `backend/env.env` - –í–∫–ª—é—á–µ–Ω Redis (`REDIS_ENABLED=true`)

## üöÄ –î–ï–ü–õ–û–ô –ù–ê –ü–†–û–î–ê–ö–®–ù

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ Redis —Ä–∞–±–æ—Ç–∞–µ—Ç:

```bash
ssh your-server

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Redis —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω
redis-cli ping
# –î–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å: PONG

# –ï—Å–ª–∏ Redis –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:
sudo apt update
sudo apt install redis-server -y
sudo systemctl start redis
sudo systemctl enable redis
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞:

```bash
cd /path/to/onai-integrator-login/backend

# Pull latest changes
git pull origin main

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ REDIS_ENABLED=true –≤ env.env
grep "REDIS_ENABLED" env.env
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: REDIS_ENABLED=true

# –ï—Å–ª–∏ REDIS_ENABLED=false, –∏—Å–ø—Ä–∞–≤–∏—Ç—å:
sed -i 's/REDIS_ENABLED=false/REDIS_ENABLED=true/' env.env

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞
grep "REDIS_ENABLED" env.env

# Restart backend (PM2)
pm2 restart onai-backend

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
pm2 logs onai-backend --lines 50
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Redis –ø–æ–¥–∫–ª—é—á–µ–Ω
curl -s http://localhost:3000/api/admin/amocrm-locks/status | jq

# –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
# {
#   "success": true,
#   "system": {
#     "redis_connected": true,
#     "locks_enabled": true
#   },
#   "message": "‚úÖ Lock system operational"
# }
```

–ï—Å–ª–∏ `redis_connected: false` - –∑–Ω–∞—á–∏—Ç Redis –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ backend –Ω–µ –º–æ–∂–µ—Ç –∫ –Ω–µ–º—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è.

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:

```bash
# –°–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
pm2 logs onai-backend

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞—è–≤–∫—É –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤–ª—è–µ—Ç—Å—è:
# üîí Lock ACQUIRED
# üîç [DEDUP] Starting duplicate check
# üîì Lock RELEASED
```

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
curl http://localhost:3000/api/admin/amocrm-locks/status

# –û–∂–∏–¥–∞–µ–º–æ–µ:
# "locks_enabled": true
```

### –¢–µ—Å—Ç 2: –û—Ç–ø—Ä–∞–≤–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞ (–¥–æ–ª–∂–µ–Ω –æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–∏–¥)

```bash
# 1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ—Ç–µ—Å—Ç
curl -X POST http://localhost:3000/api/landing/proftest \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User Duplicate",
    "email": "test-duplicate@onai.academy",
    "phone": "+77771112233",
    "source": "proftest_main",
    "proftestAnswers": [
      {"questionNumber": 1, "question": "Q1", "answer": "A1"}
    ]
  }'

# –ó–∞–ø–æ–º–Ω–∏—Ç—å leadId –∏–∑ –æ—Ç–≤–µ—Ç–∞

# 2. –ü–æ–¥–æ–∂–¥–∞—Ç—å 2 —Å–µ–∫—É–Ω–¥—ã

# 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–æ—Ç –∂–µ –ø—Ä–æ—Ñ—Ç–µ—Å—Ç —Å–Ω–æ–≤–∞ (—Å –¥—Ä—É–≥–∏–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏)
curl -X POST http://localhost:3000/api/landing/proftest \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User Duplicate",
    "email": "test-duplicate@onai.academy",
    "phone": "+77771112233",
    "source": "proftest_main",
    "proftestAnswers": [
      {"questionNumber": 1, "question": "Q1", "answer": "A2 UPDATED"}
    ]
  }'

# 4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å expresscourse —Å —Ç–µ–º–∏ –∂–µ –¥–∞–Ω–Ω—ã–º–∏
curl -X POST http://localhost:3000/api/landing/submit \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test User Duplicate",
    "email": "test-duplicate@onai.academy",
    "phone": "+77771112233",
    "source": "expresscourse",
    "paymentMethod": "kaspi"
  }'

# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
pm2 logs onai-backend --lines 100 | grep "test-duplicate@onai.academy"

# –û–ñ–ò–î–ê–ï–ú–û–ï –ü–û–í–ï–î–ï–ù–ò–ï:
# - –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å: "Will create NEW lead" ‚Üí —Å–æ–∑–¥–∞–µ—Ç –ª–∏–¥
# - –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å: "Will UPDATE existing lead" ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ—Ç –∂–µ –ª–∏–¥
# - –¢—Ä–µ—Ç–∏–π –∑–∞–ø—Ä–æ—Å: "Will UPDATE existing lead" ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ—Ç –∂–µ –ª–∏–¥ (–º–µ–Ω—è–µ—Ç —ç—Ç–∞–ø –Ω–∞ –ö–ê–°–ü–ò)

# 6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ AmoCRM —á—Ç–æ —Å–æ–∑–¥–∞–Ω –¢–û–õ–¨–ö–û –û–î–ò–ù –ª–∏–¥
# –ó–∞–π—Ç–∏ –≤ AmoCRM ‚Üí –ü–æ–∏—Å–∫ –ø–æ email "test-duplicate@onai.academy"
# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –¢–û–õ–¨–ö–û –û–î–ò–ù –ª–∏–¥ —Å —ç—Ç–∏–º email
```

### –¢–µ—Å—Ç 3: Race Condition (–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)

```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å 3 –∑–∞–ø—Ä–æ—Å–∞ –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
# (–∫–∞–∂–¥—ã–π –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)

# –¢–µ—Ä–º–∏–Ω–∞–ª 1:
curl -X POST http://localhost:3000/api/landing/proftest \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Race Test User",
    "email": "race-test@onai.academy",
    "phone": "+77779998877",
    "source": "proftest_main",
    "proftestAnswers": []
  }' &

# –¢–µ—Ä–º–∏–Ω–∞–ª 2 (–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ):
curl -X POST http://localhost:3000/api/landing/proftest \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Race Test User",
    "email": "race-test@onai.academy",
    "phone": "+77779998877",
    "source": "proftest_main",
    "proftestAnswers": []
  }' &

# –¢–µ—Ä–º–∏–Ω–∞–ª 3 (–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—Ç–æ—Ä–æ–≥–æ):
curl -X POST http://localhost:3000/api/landing/proftest \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Race Test User",
    "email": "race-test@onai.academy",
    "phone": "+77779998877",
    "source": "proftest_main",
    "proftestAnswers": []
  }' &

# –ü–æ–¥–æ–∂–¥–∞—Ç—å 5 —Å–µ–∫—É–Ω–¥

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
pm2 logs onai-backend --lines 200 | grep "race-test@onai.academy"

# –û–ñ–ò–î–ê–ï–ú–û–ï –ü–û–í–ï–î–ï–ù–ò–ï:
# –ó–∞–ø—Ä–æ—Å 1: üîí Lock ACQUIRED ‚Üí —Å–æ–∑–¥–∞–µ—Ç –ª–∏–¥
# –ó–∞–ø—Ä–æ—Å 2: ‚è≥ Waiting for lock... ‚Üí –∂–¥–µ—Ç ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–∏–¥
# –ó–∞–ø—Ä–æ—Å 3: ‚è≥ Waiting for lock... ‚Üí –∂–¥–µ—Ç ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–∏–¥

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ AmoCRM —á—Ç–æ —Å–æ–∑–¥–∞–Ω –¢–û–õ–¨–ö–û –û–î–ò–ù –ª–∏–¥
```

## üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì –í PRODUCTION

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫:

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
curl http://localhost:3000/api/admin/amocrm-locks

# –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –º–Ω–æ–≥–æ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è:
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
pm2 logs onai-backend | grep "ERROR"

# –í –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ - –æ—á–∏—Å—Ç–∏—Ç—å –∑–∞—Å—Ç—Ä—è–≤—à–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:
curl -X DELETE http://localhost:3000/api/admin/amocrm-locks
```

### Dashboard –≤ AmoCRM:

–ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ **–±–æ–ª—å—à–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å** –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ª–∏–¥–æ–≤:

**–î–æ —Ñ–∏–∫—Å–∞:**
```
–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ - ivan@test.com - –õ–∏–¥ #12345 - –ó–∞—è–≤–∫–∞ —Å –ø—Ä–æ—Ñ—Ç–µ—Å—Ç–∞
–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ - ivan@test.com - –õ–∏–¥ #12346 - –ó–∞—è–≤–∫–∞ —Å –ø—Ä–æ—Ñ—Ç–µ—Å—Ç–∞ (–î–£–ë–õ–ò–ö–ê–¢!)
–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ - ivan@test.com - –õ–∏–¥ #12347 - –ö–∞—Å–ø–∏ –æ–ø–ª–∞—Ç–∞ (–î–£–ë–õ–ò–ö–ê–¢!)
```

**–ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞:**
```
–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ - ivan@test.com - –õ–∏–¥ #12345 - –ö–∞—Å–ø–∏ –æ–ø–ª–∞—Ç–∞ (–æ–±–Ω–æ–≤–ª–µ–Ω)
```

## ‚ö†Ô∏è TROUBLESHOOTING

### –ü—Ä–æ–±–ª–µ–º–∞: Redis not connected

**–°–∏–º–ø—Ç–æ–º—ã:**
```json
{
  "redis_connected": false,
  "message": "‚ö†Ô∏è Redis not connected - locks disabled"
}
```

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Redis –∑–∞–ø—É—â–µ–Ω
sudo systemctl status redis

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ backend –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
redis-cli -h localhost -p 6379 ping

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ env.env
grep "REDIS" backend/env.env

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
# REDIS_ENABLED=true
# REDIS_HOST=localhost
# REDIS_PORT=6379

# 4. Restart backend
pm2 restart onai-backend
```

### –ü—Ä–æ–±–ª–µ–º–∞: Locks stuck (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–∞—Å—Ç—Ä—è–ª–∏)

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ó–∞–ø—Ä–æ—Å—ã –≤–∏—Å—è—Ç –¥–æ–ª–≥–æ (>30 —Å–µ–∫—É–Ω–¥)
- –í –ª–æ–≥–∞—Ö: `Failed to acquire lock after 10 attempts`
- `/api/admin/amocrm-locks` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–Ω–æ–≥–æ —Å—Ç–∞—Ä—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
curl http://localhost:3000/api/admin/amocrm-locks

# 2. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç–∞—Ä—à–µ 30 —Å–µ–∫—É–Ω–¥ - –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
curl -X DELETE http://localhost:3000/api/admin/amocrm-locks

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ backend –Ω–µ –∫—Ä–∞—à–∏—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏–¥–æ–≤
pm2 logs onai-backend | grep "ERROR"
```

### –ü—Ä–æ–±–ª–µ–º–∞: –î—É–±–ª–∏–∫–∞—Ç—ã –≤—Å–µ –µ—â–µ —Å–æ–∑–¥–∞—é—Ç—Å—è

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Redis –≤–∫–ª—é—á–µ–Ω
curl http://localhost:3000/api/admin/amocrm-locks/status
# locks_enabled –î–û–õ–ñ–ï–ù –±—ã—Ç—å true!

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
pm2 logs onai-integrator-login --lines 100 | grep "LOCK"

# –î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å:
# üîí Lock ACQUIRED
# üîì Lock RELEASED

# 3. –ï—Å–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –Ω–µ—Ç –≤ –ª–æ–≥–∞—Ö:
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–æ–≤—ã–π –∫–æ–¥ –∑–∞–¥–µ–ø–ª–æ–µ–Ω
cd /path/to/backend
git log -1 --oneline

# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç —Å "FIX: AmoCRM duplicates"
```

## ‚úÖ –ò–¢–û–ì–û–í–´–ô CHECKLIST

–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ —Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Ä–µ—à–µ–Ω–Ω–æ–π:

- [ ] Redis —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [ ] `REDIS_ENABLED=true` –≤ `backend/env.env`
- [ ] Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω (PM2)
- [ ] `/api/admin/amocrm-locks/status` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `locks_enabled: true`
- [ ] –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω—ã `üîí Lock ACQUIRED` –∏ `üîì Lock RELEASED`
- [ ] –¢–µ—Å—Ç —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ (2 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–∞) ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è –û–î–ò–ù –ª–∏–¥
- [ ] –¢–µ—Å—Ç race condition (3 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞) ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è –û–î–ò–ù –ª–∏–¥
- [ ] –í AmoCRM –±–æ–ª—å—à–µ –Ω–µ—Ç –Ω–æ–≤—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –ª–∏–¥–æ–≤

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —ç—Ç–æ–≥–æ —Ñ–∏–∫—Å–∞:

‚úÖ **–ù–∏–∫–∞–∫–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** - –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å = –æ–¥–∏–Ω –ª–∏–¥ –≤ AmoCRM
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞—è–≤–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–∏–¥
‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç race condition** - –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ —Å–æ–∑–¥–∞—é—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã
‚úÖ **–î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏** - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–æ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
‚úÖ **Admin –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

## üìû –ü–û–î–î–ï–†–ñ–ö–ê

–ï—Å–ª–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –≤–æ–∑–Ω–∏–∫–∞—é—Ç –ø—Ä–æ–±–ª–µ–º—ã:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏** –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –æ—à–∏–±–æ–∫
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å Redis** —á–µ—Ä–µ–∑ admin API
3. **–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã** –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ AmoCRM** —á—Ç–æ –¥—É–±–ª–∏–∫–∞—Ç—ã –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è

**–í—Å–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–ª–∏—á–Ω–æ!** üöÄ‚úÖ
